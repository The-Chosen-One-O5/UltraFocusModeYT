<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Focus Mode</title>

    <!-- Favicon Links (Added as requested) -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <!-- End Favicon Links -->

    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4169e1; /* Royal Blue */
            --primary-dark: #1e3a8a; /* Darker Blue */
            --secondary: #8e2de2; /* Purple */
            --accent: #ff4500; /* OrangeRed */
            --accent-alt: #ff8c00; /* DarkOrange */
            --bg-dark: #0f0f1b; /* Very Dark Blue/Purple */
            --bg-medium: #1a1a2e; /* Dark Blue/Purple */
            --bg-light: #252538; /* Medium Dark Blue/Purple */
            --text: #e0e0ff; /* Light Lavender */
            --text-dim: #9090b0; /* Grayish Lavender */
            --gold: #ffd700;
            --success: #28a745; /* Green */
            --danger: #dc3545; /* Red */
            --info: #17a2b8; /* Teal */
            --warning: #ffc107; /* Yellow */
        }

        html {
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) var(--bg-medium);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-medium);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 0;
            border: 2px solid var(--bg-medium);
        }

        body {
            background-color: var(--bg-dark);
            min-height: 100vh;
            font-family: 'Roboto Mono', monospace;
            color: var(--text);
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Game Container and Background */
        .game-container {
            width: 100%;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(142, 45, 226, 0.1) 0%, transparent 25%),
                            radial-gradient(circle at 90% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 25%),
                            linear-gradient(to bottom, var(--bg-dark) 0%, var(--bg-medium) 100%);
            display: flex;
            flex-direction: column; /* Stack nav and content */
            z-index: 1;
        }

        .game-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='8' height='8' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.04' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1h1z'/%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 2;
            opacity: 0.5;
        }

        /* Page/View Containers */
        .page-view {
            width: 100%;
            flex-grow: 1; /* Allow view to take remaining space */
            display: none; /* Hidden by default */
            flex-direction: column;
            padding: 20px;
            position: relative;
            z-index: 10;
            overflow-y: auto;
            pointer-events: auto;
        }

        /* Landing Page & Signin Form Styles */
        #landingPageContainer, #signinFormContainer {
            text-align: center;
            width: 100%;
            max-width: 700px;
            margin: auto;
            padding: 40px 30px;
            background-color: rgba(15, 15, 27, 0.85);
            border: 2px solid var(--secondary);
            border-radius: 12px;
            box-shadow: 0 0 25px rgba(142, 45, 226, 0.4);
            backdrop-filter: blur(4px);
            pointer-events: auto;
        }

         #landingPage, #signinForm {
             justify-content: center;
             align-items: center;
         }


        /* Titles and Subtitles */
        .title {
            font-family: 'Press Start 2P', cursive;
            font-size: 28px;
            font-weight: 400;
            color: var(--text);
            margin-bottom: 25px;
            text-shadow: 2px 2px 0px var(--primary-dark), 4px 4px 0px rgba(0,0,0,0.3);
            letter-spacing: 1px;
            line-height: 1.3;
        }

        .title span {
            color: var(--secondary);
            position: relative;
            display: inline-block;
        }

        .title span::after {
            content: "";
            position: absolute;
            bottom: -6px;
            left: 5%;
            width: 90%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.8;
        }

        .subtitle {
            font-size: 18px;
            color: var(--text-dim);
            margin-bottom: 35px;
            font-family: 'Roboto Mono', monospace;
        }

        /* Buttons */
        button {
            display: inline-block;
            padding: 10px 25px;
            font-size: 14px;
            font-family: 'Roboto Mono', monospace;
            font-weight: 600;
            background: var(--secondary);
            border: none;
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 8px 15px;
            transition: all 0.2s ease-in-out;
            position: relative;
            box-shadow: 3px 3px 0 var(--primary-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 11;
            pointer-events: auto;
            outline: none;
        }

        button:hover:not(:disabled) {
            background: var(--primary);
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--primary-dark);
        }

        button:active:not(:disabled) {
            transform: translate(3px, 3px);
            box-shadow: none;
        }

        button:disabled {
            background: var(--bg-light);
            color: var(--text-dim);
            cursor: not-allowed;
            box-shadow: 2px 2px 0 var(--bg-medium);
            transform: none;
            opacity: 0.7;
        }

        .github-btn {
            background: var(--bg-light);
            box-shadow: 3px 3px 0 var(--bg-medium);
        }

        .github-btn:hover:not(:disabled) {
            background: var(--bg-medium);
            box-shadow: 2px 2px 0 var(--bg-medium);
        }

        .accent-btn {
            background: var(--accent);
            box-shadow: 3px 3px 0 #b33000;
        }

        .accent-btn:hover:not(:disabled) {
            background: var(--accent-alt);
             box-shadow: 2px 2px 0 #b33000;
        }

        .primary-btn {
            background: var(--primary);
            box-shadow: 3px 3px 0 var(--primary-dark);
        }
        .primary-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            box-shadow: 2px 2px 0 var(--primary-dark);
        }


        /* Landing Page Features */
        #features {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 40px;
            flex-wrap: wrap;
            z-index: 10;
        }

        .feature {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 8px;
            width: 220px;
            box-shadow: 4px 4px 0 var(--bg-medium);
            border: 1px solid var(--primary);
            position: relative;
            overflow: hidden;
            z-index: 10;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
             text-align: center;
        }
         .feature:hover {
            transform: translateY(-3px);
            box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.3);
        }


        .feature::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .feature i {
            font-size: 28px;
            color: var(--secondary);
            margin-bottom: 12px;
            display: block;
        }

        .feature p {
            font-size: 15px;
            color: var(--text);
            text-align: center;
        }

        /* Input Fields */
        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="time"],
        select {
            display: block;
            width: 100%;
            max-width: 350px;
            margin: 15px auto;
            padding: 12px 15px;
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Roboto Mono', monospace;
            background: var(--bg-light);
            border: 2px solid var(--primary);
            color: var(--text);
            outline: none;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2);
            transition: border-color 0.3s, box-shadow 0.3s;
            z-index: 11;
            pointer-events: auto;
        }

        input:focus,
        select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(142, 45, 226, 0.3), inset 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Top Navigation Bar */
        #topNavBar {
            width: 100%;
            height: 60px;
            background-color: rgba(15, 15, 27, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            border-bottom: 1px solid rgba(65, 105, 225, 0.3);
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
            display: none;
            flex-shrink: 0;
            order: -1;
        }

        #navLogo {
            /* font-family: 'Press Start 2P', cursive; */
            /* font-size: 18px; */
            /* color: var(--text); */
            text-decoration: none;
            white-space: nowrap;
            display: flex; /* Allow vertical centering of image */
            align-items: center;
            height: 100%; /* Take full nav height */
        }
        #navLogo img { /* Style for the logo image */
             height: 40px; /* Adjust height as needed */
             width: auto; /* Maintain aspect ratio */
             object-fit: contain; /* Ensure image fits well */
             filter: brightness(0.9) saturate(1.2); /* Optional: Adjust image appearance */
         }
        /* #navLogo span { color: var(--secondary); } */ /* Removed as text is replaced */

        #navClockContainer {
            font-family: 'Roboto Mono', monospace;
            font-size: 16px;
            color: var(--text-dim);
            text-align: center;
            flex-grow: 1;
            flex-shrink: 0;
            margin: 0 20px;
            white-space: nowrap;
        }
        #navClockTime {
            color: var(--primary);
            font-weight: 600;
            letter-spacing: 1px;
        }
         #navClockPeriod {
            color: var(--secondary);
            font-weight: 600;
            margin-left: 5px;
        }

        #navButtons {
            display: flex;
            align-items: center;
            gap: 20px;
            white-space: nowrap;
        }

        /* Simple text display for streak */
        #navStreakDisplay {
            font-family: 'Roboto Mono', monospace;
            font-size: 15px;
            color: var(--accent);
            font-weight: 600;
            padding: 5px 10px;
            background-color: rgba(255, 69, 0, 0.1);
            border-radius: 4px;
            cursor: default;
        }
         #navStreakDisplay i {
            margin-right: 5px;
            font-style: normal;
            display: inline-block;
         }


        /* Simple buttons for Profile in nav */
         #navProfileBtn {
             background: none;
             border: none;
             color: var(--text-dim);
             font-size: 24px;
             cursor: pointer;
             padding: 5px;
             margin: 0;
             box-shadow: none;
             transition: color 0.2s ease, transform 0.2s ease;
         }
          #navProfileBtn:hover {
             color: var(--primary);
             transform: scale(1.1);
             box-shadow: none;
         }


        /* Home Page Styles (Simplified) */
        #homePage {
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #homePageContent {
            max-width: 600px;
            width: 90%;
        }

        #welcomeMessage {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--text);
            font-weight: 600;
        }
        #welcomeMessage span {
            font-weight: bold;
            color: var(--secondary);
        }

        #dateTimeDisplay {
            font-size: 18px;
            color: var(--text-dim);
            margin-bottom: 30px;
        }

        #focusStatus {
            font-size: 20px;
            color: var(--accent-alt);
            margin-bottom: 40px;
            font-weight: 600;
            min-height: 25px;
            padding: 10px;
            background-color: rgba(26, 26, 46, 0.5);
            border-radius: 6px;
            display: inline-block;
        }

        #motivationQuote {
            margin-top: 40px;
            font-size: 18px;
            color: var(--text-dim);
            font-style: italic;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }


        /* YouTube Lecture Page Styles */
        #youtubeLecturePage {
             justify-content: flex-start;
             align-items: center;
             padding: 20px;
             gap: 20px;
        }

        #youtubeInputContainer {
            background-color: rgba(26, 26, 46, 0.7);
            padding: 20px 30px;
            border-radius: 10px;
            border: 1px solid var(--primary-dark);
            max-width: 800px;
            width: 95%;
            margin: 0 auto 20px auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
             text-align: center;
             pointer-events: auto;
             display: block; /* Show input section initially */
        }
         #youtubeInputContainer .subtitle {
            font-size: 18px; color: var(--text-dim); margin-bottom: 20px;
            font-family: 'Roboto Mono', monospace;
        }

        #urlInputs {
            margin-bottom: 15px;
            pointer-events: auto;
        }
        .url-container {
            display: flex; align-items: center; margin-bottom: 10px; gap: 10px;
        }
        .url-container input { margin: 0; flex-grow: 1; pointer-events: auto; }
        .url-container button {
            padding: 8px 12px; margin: 0; background: var(--danger); font-size: 12px;
            box-shadow: 2px 2px 0 rgba(167, 29, 42, 0.8); min-width: 35px; pointer-events: auto;
        }
        .url-container button:hover:not(:disabled) { background: #c82333; box-shadow: 1px 1px 0 rgba(167, 29, 42, 0.8); }

        #youtubeInputContainer button[data-action="add-url"] {
    font-size: 12px;
    padding: 8px 15px;
    margin-bottom: 15px; /* Keep vertical spacing */
    pointer-events: auto;
    /* display: inline-block; /* This is likely the default from the base button style, so it might not be needed */
    /* No margin-left/right: auto needed */
    /* No max-width needed for centering via text-align */
        }

        #playlistManagement {
            display: flex; gap: 10px; justify-content: center; align-items: center;
            margin-top: 15px; flex-wrap: wrap; pointer-events: auto;
        }
         #playlistManagement select, #playlistManagement input { margin: 0; max-width: 180px; pointer-events: auto; }
         #playlistManagement button { margin: 0; padding: 10px 15px; font-size: 12px; pointer-events: auto; }
         #youtubeInputContainer button[data-action="start-playback"] { margin-top: 25px; padding: 12px 30px; display: block; margin-left: auto; margin-right: auto; pointer-events: auto; }


        #playerContainer {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9; position: relative;
            margin: 0 auto; pointer-events: auto;
             display: none; /* Hidden initially */
        }

        #player {
            width: 100%; height: 100%; border-radius: 0; overflow: hidden; background: #000;
            border: 4px solid var(--primary); box-shadow: 0 0 25px rgba(65, 105, 225, 0.6);
            z-index: 5; position: absolute; top: 0; left: 0;
        }

        #timerDisplay {
            position: fixed; top: 70px; left: 10px; color: var(--text); z-index: 101; cursor: move;
            padding: 10px 15px; background: rgba(26, 26, 46, 0.85); border: 1px solid var(--primary);
            border-radius: 4px; font-family: 'Roboto Mono', monospace; font-size: 16px;
            pointer-events: auto; box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);
            display: none;
        }
         #timerText { display: block; margin-bottom: 5px; }

        #progressBar {
            width: 180px; height: 8px; background: var(--bg-light); border: 1px solid var(--primary);
            border-radius: 2px; overflow: hidden; margin-top: 5px; z-index: 101; display: block;
        }

        #progressFill { height: 100%; width: 0; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.5s linear; border-radius: 1px; }

         #youtubeLecturePageControls {
            position: fixed; top: 70px; right: 10px; display: flex; flex-direction: column;
            gap: 10px; z-index: 103; display: none; pointer-events: auto;
         }

        #restartBtn {
            background: var(--danger); box-shadow: 3px 3px 0 #a71d2a; padding: 8px 15px;
            font-size: 12px; margin: 0; pointer-events: auto;
        }
         #restartBtn:hover:not(:disabled) { background: #c82333; box-shadow: 2px 2px 0 #a71d2a; }

        #videoSidebar {
            position: fixed; right: -320px; top: 60px; width: 300px; height: calc(100vh - 60px);
            background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(8px); transition: right 0.3s ease;
            padding: 20px; overflow-y: auto; z-index: 102; border-left: 3px solid var(--primary);
            pointer-events: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.3); display: none;
        }
        #videoSidebar.open { right: 0; }

         #videoSidebarToggleBtn {
            position: fixed; top: 130px; right: 10px; z-index: 103; background: var(--secondary);
            padding: 8px 10px; font-size: 18px; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin: 0; display: none; pointer-events: auto;
         }
          #videoSidebarToggleBtn:hover:not(:disabled) { background: var(--primary); }

        .thumbnail {
            width: 100%; margin-bottom: 15px; cursor: pointer; border: 2px solid transparent;
            border-radius: 4px; transition: all 0.2s ease; image-rendering: auto;
            pointer-events: auto; display: block;
        }
        .thumbnail:hover { border-color: var(--secondary); transform: scale(1.03); box-shadow: 0 0 10px rgba(142, 45, 226, 0.5); }
         .thumbnail.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(255, 69, 0, 0.6); }
         #videoSidebar h3 { color: var(--secondary); margin-bottom: 15px; text-align: center; font-size: 16px; }

        /* Profile Page Styles */
        #profile { /* Changed ID */
            justify-content: center; align-items: center;
        }
        #profileContainer {
            background-color: rgba(26, 26, 46, 0.8); padding: 40px; border-radius: 12px;
            border: 1px solid var(--primary); max-width: 500px; width: 90%; text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); pointer-events: auto;
        }
        #profileIcon {
            font-size: 60px; color: var(--secondary); margin-bottom: 15px; display: inline-block;
            background: var(--bg-light); width: 100px; height: 100px; line-height: 100px;
            border-radius: 50%; border: 3px solid var(--primary);
        }
         #profileUsername { font-size: 24px; font-weight: bold; color: var(--text); margin-bottom: 10px; }
         .profile-stat { font-size: 18px; color: var(--text-dim); margin-bottom: 12px; border-bottom: 1px dashed var(--bg-light); padding-bottom: 8px; }
         .profile-stat span { font-weight: bold; color: var(--primary); margin-left: 8px; }
          .profile-stat .level { color: var(--gold); }
          .profile-stat .streak { color: var(--accent); }
          .profile-stat .xp { color: var(--secondary); }
           #profile button[data-action="show-view"] { /* Target button inside profile view */
                margin-top: 20px; background: var(--bg-light); font-size: 12px;
            }

        /* Focus Stats Page Styles */
        #focusStats { /* Changed ID */
            justify-content: center; align-items: center;
        }
         #focusStatsContainer {
             background-color: rgba(26, 26, 46, 0.8); padding: 30px; border-radius: 12px;
             border: 1px solid var(--primary); max-width: 700px; width: 90%;
             box-shadow: 0 5px 20px rgba(0,0,0,0.3); pointer-events: auto;
         }
         #focusStatsContainer h3 { text-align: center; font-family: 'Press Start 2P', cursive; font-size: 20px; color: var(--secondary); margin-bottom: 30px; }
         #statsDisplay { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 25px; margin-bottom: 30px; }
         .stat-item { background: var(--bg-light); padding: 20px; border-radius: 6px; border: 1px solid var(--primary-dark); text-align: center; }
         .stat-item .label { font-size: 14px; color: var(--text-dim); margin-bottom: 10px; display: block; }
          .stat-item .value { font-size: 24px; font-weight: bold; color: var(--primary); }
          .stat-item .value.streak { color: var(--accent); }
          .stat-item .value.videos { color: var(--secondary); }
          .stat-item .value.distractions { color: var(--warning); }
         #focusCalendar { margin-top: 30px; background: var(--bg-light); padding: 20px; border-radius: 8px; border: 1px solid var(--primary-dark); }
          #focusCalendar h4 { text-align: center; margin-bottom: 15px; color: var(--text-dim); }
           #calendarGrid { min-height: 150px; display: flex; justify-content: center; align-items: center; color: var(--text-dim); font-style: italic; }
           #focusStats button[data-action="show-view"] { /* Target button inside focusStats view */
                margin-top: 30px; background: var(--bg-light); font-size: 12px; display: block; margin-left: auto; margin-right: auto;
            }

        /* Sidebar Styles */
        .sidebar-trigger { position: fixed; left: 0; top: 50%; transform: translateY(-50%); width: 25px; height: 100px; background: var(--primary); z-index: 199; border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text); font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; font-size: 14px; letter-spacing: 2px; pointer-events: auto; transition: background-color 0.2s ease, left 0.3s ease; box-shadow: 3px 0 8px rgba(0,0,0,0.3); }
         .sidebar-trigger:hover { background: var(--secondary); }
        .game-sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100vh; background: rgba(26, 26, 46, 0.98); backdrop-filter: blur(5px); border-right: 3px solid var(--primary); z-index: 200; transition: left 0.3s ease; padding: 70px 0 20px 0; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.4); overflow-y: auto; pointer-events: auto; }
        .game-sidebar.open { left: 0; }
         .game-sidebar.open + .sidebar-trigger { left: 280px; }
        .sidebar-section { padding: 15px 20px; border-bottom: 1px solid var(--bg-light); }
        .sidebar-section:last-child { border-bottom: none; }
        .sidebar-section h3 { color: var(--secondary); font-size: 16px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1.5px; padding-bottom: 5px; border-bottom: 1px dashed var(--primary-dark); }
        .sidebar-section a, .sidebar-section button { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; margin: 8px 0; background: var(--bg-light); color: var(--text); border: 1px solid var(--primary); border-radius: 4px; text-align: left; font-size: 14px; font-family: 'Roboto Mono', monospace; cursor: pointer; transition: all 0.2s ease; pointer-events: auto; z-index: 201; text-transform: none; box-shadow: none; letter-spacing: 0.5px; }
         .sidebar-section button i, .sidebar-section a i { width: 18px; text-align: center; color: var(--primary); }
        .sidebar-section a:hover, .sidebar-section button:hover:not(:disabled) { background: var(--primary); color: white; transform: translateX(5px); border-color: var(--secondary); box-shadow: none; }
         .sidebar-section a:hover i, .sidebar-section button:hover:not(:disabled) i { color: white; }
        .sidebar-section a { text-decoration: none; }
         #logoutBtn { background: var(--danger); border-color: #a71d2a; color: white; }
          #logoutBtn i { color: white; }
          #logoutBtn:hover:not(:disabled) { background: #c82333; border-color: #a71d2a; }

        /* Shared Components (Points, Lofi, AI, Dialogs, Overlays) */
        #pointsDisplay { position: fixed; top: 70px; left: 10px; font-size: 16px; color: var(--text); font-family: 'Roboto Mono', monospace; font-weight: 600; z-index: 101; background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(5px); padding: 8px 12px; border: 1px solid var(--secondary); border-radius: 4px; box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); pointer-events: none; display: none; }
        #achievementLevel { position: fixed; top: 120px; left: 10px; font-size: 14px; font-weight: bold; z-index: 101; font-family: 'Press Start 2P', cursive; background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(5px); padding: 6px 10px; border: 2px solid var(--secondary); box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); border-radius: 4px; pointer-events: none; text-transform: uppercase; letter-spacing: 1px; display: none; }
        .rainbow { background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 3s infinite linear; border-color: transparent !important; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .level-glow { text-shadow: 0 0 10px var(--text); }
        .level-box-glow { box-shadow: 0 0 10px var(--gold); }
        #lofiPlayer { position: fixed; bottom: 10px; right: 10px; z-index: 101; background: rgba(26, 26, 46, 0.9); backdrop-filter: blur(5px); padding: 12px; border: 1px solid var(--primary); border-radius: 6px; box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.3); pointer-events: auto; display: none; }
        #lofiPlayer .lofi-title { text-align: center; margin-bottom: 8px; font-size: 12px; color: var(--text-dim); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        #lofiPlayer button { background: var(--secondary); border: none; color: var(--text); padding: 6px 12px; margin: 0 3px; cursor: pointer; font-size: 14px; border-radius: 4px; box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3); font-family: 'Roboto Mono', monospace; z-index: 102; min-width: 35px; pointer-events: auto; }
        #lofiPlayer button:hover:not(:disabled) { background: var(--primary); }
        #lofiPlayer #lofiPause { display: none; }
        #fireBox { position: fixed; bottom: 10px; left: 10px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 26px; cursor: pointer; z-index: 100; box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.4); border: 2px solid var(--secondary); pointer-events: auto; transition: all 0.2s ease; display: none; }
        #fireBox:hover { background: var(--secondary); transform: translateY(-3px) scale(1.05); box-shadow: 4px 4px 15px rgba(0, 0, 0, 0.5); }
        #aiPopup { position: fixed; bottom: 70px; left: 10px; width: 320px; height: 450px; background: var(--bg-medium); border-radius: 8px; padding: 5px; display: none; z-index: 101; box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.4); border: 3px solid var(--primary); pointer-events: auto; overflow: hidden; }
        #aiPopup iframe { width: 100%; height: 100%; border: none; border-radius: 5px; }
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(6px); display: flex; justify-content: center; align-items: center; z-index: 105; display: none; pointer-events: auto; padding: 15px; }
        .dialog-box { background: var(--bg-medium); padding: 25px 30px; border: 3px solid var(--accent); box-shadow: 0 0 30px rgba(255, 69, 0, 0.5); border-radius: 10px; text-align: center; pointer-events: auto; font-family: 'Roboto Mono', monospace; max-width: 450px; width: 90%; }
        .dialog-box h3 { color: var(--accent); font-size: 20px; margin-bottom: 15px; font-family: 'Press Start 2P', cursive; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .dialog-box h3 i { font-size: 18px; }
        .dialog-box p { font-size: 16px; margin-bottom: 25px; color: var(--text); line-height: 1.5; }
        .dialog-box .dialog-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .dialog-box button { padding: 10px 25px; margin: 0; font-size: 14px; pointer-events: auto; z-index: 106; }
        #confirmBtn, #streakShieldConfirmBtn, #doublePointsConfirmBtn, #deadlineConfirmBtn, #sessionContinueBtn, #openMysteryBox { background: var(--accent); box-shadow: 3px 3px 0 #b33000; }
        #confirmBtn:hover:not(:disabled), #streakShieldConfirmBtn:hover:not(:disabled), #doublePointsConfirmBtn:hover:not(:disabled), #deadlineConfirmBtn:hover:not(:disabled), #sessionContinueBtn:hover:not(:disabled), #openMysteryBox:hover:not(:disabled) { background: var(--accent-alt); box-shadow: 2px 2px 0 #b33000; }
        #cancelBtn, #streakShieldCancelBtn, #doublePointsCancelBtn, #deadlineCancelBtn, #sessionEndBtn, #closeAudioStore, #closeMysteryBoxBtn { background: var(--bg-light); box-shadow: 3px 3px 0 var(--bg-medium); }
        #cancelBtn:hover:not(:disabled), #streakShieldCancelBtn:hover:not(:disabled), #doublePointsCancelBtn:hover:not(:disabled), #deadlineCancelBtn:hover:not(:disabled), #sessionEndBtn:hover:not(:disabled), #closeAudioStore:hover:not(:disabled), #closeMysteryBoxBtn:hover:not(:disabled) { background: var(--bg-medium); box-shadow: 2px 2px 0 var(--bg-medium); }
        #deadlineDialog input, #deadlineDialog select { margin: 15px auto; }
        #mysteryBoxPopup .dialog-box { border-color: var(--gold); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
        #mysteryBoxPopup h3 { color: var(--gold); }
        #mysteryRewardText { font-weight: bold; color: var(--accent-alt); min-height: 40px;}
        #audioTracksStore .dialog-box { border-color: var(--secondary); box-shadow: 0 0 30px rgba(142, 45, 226, 0.5); max-width: 500px; max-height: 80vh; overflow-y: auto; }
        #audioTracksStore h3 { color: var(--secondary); }
        #audioTracksList { margin-top: 20px; }
        .audio-track-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; margin-bottom: 10px; background: var(--bg-light); border: 1px solid var(--primary); border-radius: 4px; transition: background-color 0.2s; pointer-events: auto; }
        .audio-track-item:hover { background-color: var(--bg-medium); }
        .audio-track-item .track-info { text-align: left; }
        .audio-track-item .track-name { font-weight: bold; }
        .audio-track-item.locked .track-name { color: var(--text-dim); }
        .audio-track-item.unlocked .track-name { color: var(--accent-alt); }
        .audio-track-item .track-cost { font-size: 12px; color: var(--text-dim); }
        .unlock-track-btn { padding: 6px 12px; background: var(--secondary); font-size: 12px; margin: 0; flex-shrink: 0; pointer-events: auto; }
        .unlock-track-btn:disabled { background: var(--bg-light); color: var(--text-dim); cursor: not-allowed; opacity: 0.7; }
        .unlock-track-btn.unlocked { background: var(--success); color: white; cursor: default; }
        .unlock-track-btn.unlocked:hover:not(:disabled) { background: var(--success); }
        #achievementOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(15, 15, 27, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; color: gold; font-size: 36px; font-weight: bold; z-index: 104; display: none; font-family: 'Press Start 2P', cursive; text-align: center; text-shadow: 3px 3px 0 var(--primary-dark), 5px 5px 10px rgba(0,0,0,0.5); background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23FFD700' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E"); pointer-events: none; padding: 20px; line-height: 1.4; }
        #todoList { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 450px; max-height: 75vh; background: var(--bg-medium); padding: 20px; border: 2px solid var(--secondary); border-radius: 8px; display: none; z-index: 100; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4); pointer-events: auto; display: flex; flex-direction: column; }
        #todoList h3 { font-size: 18px; margin-bottom: 15px; color: var(--secondary); font-family: 'Roboto Mono', monospace; text-align: center; flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #tasks { overflow-y: auto; margin-bottom: 15px; background: none; padding-right: 5px; flex-grow: 1; pointer-events: auto; }
        .task-line { display: flex; align-items: center; margin-bottom: 10px; background: var(--bg-light); padding: 8px 10px; border: 1px solid var(--primary-dark); border-radius: 4px; pointer-events: auto; transition: background-color 0.2s, opacity 0.2s; }
        .task-line:hover { background-color: rgba(37, 37, 56, 0.8); }
        .task-line input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; appearance: none; border: 2px solid var(--primary); background: var(--bg-medium); position: relative; cursor: pointer; pointer-events: auto; z-index: 11; border-radius: 3px; transition: background-color 0.2s, border-color 0.2s; flex-shrink: 0; }
        .task-line input[type="checkbox"]:checked { background: var(--secondary); border-color: var(--secondary); }
        .task-line input[type="checkbox"]:checked::after { content: "âœ”"; position: absolute; color: var(--text); font-size: 14px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .task-line input[type="checkbox"]:hover { border-color: var(--secondary); }
        .task-line input[type="text"] { flex-grow: 1; font-size: 15px; font-family: 'Roboto Mono', monospace; color: var(--text); background: transparent; border: none; border-bottom: 1px solid transparent; padding: 5px 0; outline: none; box-shadow: none; margin: 0; pointer-events: auto; z-index: 11; transition: border-color 0.2s; }
        .task-line input[type="text"]:focus { border-bottom: 1px solid var(--secondary); box-shadow: none; }
        .task-line input[type="text"][readonly] { text-decoration: line-through; color: var(--text-dim); }
        .task-line .task-buttons { display: flex; align-items: center; margin-left: 10px; flex-shrink: 0; pointer-events: auto; }
        .task-line .set-deadline, .task-line .remove-task { color: var(--text-dim); font-size: 16px; cursor: pointer; background: none; border: none; padding: 5px; line-height: 1; pointer-events: auto; z-index: 11; transition: color 0.2s; margin: 0 2px; }
        .task-line .set-deadline:hover:not(:disabled) { color: var(--primary); }
        .task-line .set-deadline:disabled { opacity: 0.5; cursor: not-allowed;}
        .task-line .remove-task:hover { color: var(--danger); }
        .task-line .deadline-info, .task-line .points-info { margin-left: 8px; font-size: 11px; padding: 2px 5px; border-radius: 3px; white-space: nowrap; pointer-events: none; }
        .task-line .deadline-info { color: var(--accent-alt); background-color: rgba(255, 140, 0, 0.1); }
        .task-line .points-info { color: var(--secondary); background-color: rgba(142, 45, 226, 0.1); }
        #todoList .dialog-buttons { margin-top: 15px; flex-shrink: 0; pointer-events: auto; }
        #todoList .dialog-buttons button { pointer-events: auto; }
        #pomodoroOverlay { background: rgba(15, 15, 27, 0.95); backdrop-filter: blur(12px); z-index: 1000; }
        #pomodoroContainer { width: 90%; max-width: 420px; background: transparent; padding: 30px; border: none; box-shadow: none; text-align: center; pointer-events: auto; }
        #pomodoroContainer h3 { font-family: 'Press Start 2P', cursive; font-size: 22px; color: var(--secondary); margin-bottom: 15px; text-shadow: 2px 2px 0px var(--primary-dark); display: flex; align-items: center; justify-content: center; gap: 10px; }
        #pomodoroContainer p { font-size: 16px; color: var(--text-dim); margin-bottom: 30px; }
        #pomodoroTimer { font-size: 90px; font-weight: bold; color: var(--text); margin: 25px 0;font-family: 'Press Start 2P', cursive; text-shadow: 0 0 15px rgba(65, 105, 225, 0.5), 0 0 25px rgba(142, 45, 226, 0.4); }
        #pomodoroStatus { font-size: 18px; color: var(--accent-alt); margin-top: 20px; min-height: 25px; font-weight: 600; }
        #pomodoroControls { display: flex; justify-content: center; gap: 25px; margin-top: 35px; pointer-events: auto; }
        #pomodoroControls button { padding: 12px 30px; font-size: 16px; pointer-events: auto; }
        #pomodoroStartBtn { background: var(--success); border: none; box-shadow: 3px 3px 0 #1c7430;}
        #pomodoroStartBtn:hover:not(:disabled) { background: #218838; box-shadow: 2px 2px 0 #1c7430;}
        #pomodoroResetBtn { background: var(--accent); box-shadow: 3px 3px 0 #b33000;}
        #pomodoroResetBtn:hover:not(:disabled) { background: var(--accent-alt); box-shadow: 2px 2px 0 #b33000;}
        #pomodoroCloseBtn { background: var(--bg-light); box-shadow: 3px 3px 0 var(--bg-medium);}
        #pomodoroCloseBtn:hover:not(:disabled) { background: var(--bg-medium); box-shadow: 2px 2px 0 var(--bg-medium);}

        /* Responsive Adjustments */
        @media (max-width: 800px) { body { font-size: 14px; } .title { font-size: 22px; margin-bottom: 20px;} .subtitle { font-size: 16px; margin-bottom: 25px; } button { padding: 8px 18px; font-size: 12px; margin: 5px 5px 12px; } #landingPageContainer, #signinFormContainer { padding: 30px 20px; } #features { gap: 15px; } .feature { width: 180px; padding: 15px; } .feature i { font-size: 24px; } .feature p { font-size: 14px; } input[type="text"], input[type="password"], input[type="date"], input[type="time"], select { padding: 10px 12px; font-size: 14px; } #topNavBar { height: 50px; padding: 0 15px; } #navLogo img { height: 35px; } #navClockContainer { font-size: 14px; margin: 0 10px; } #navButtons { gap: 15px; } #navStreakDisplay { font-size: 13px; padding: 4px 8px; } #navProfileBtn { font-size: 22px; } .page-view { padding: 15px; } #welcomeMessage { font-size: 20px; } #dateTimeDisplay { font-size: 16px; } #focusStatus { font-size: 18px; margin-bottom: 30px; } #motivationQuote { font-size: 16px; } #youtubeInputContainer { padding: 15px 20px; } #youtubeInputContainer .subtitle { font-size: 16px; } #timerDisplay { top: 60px; font-size: 14px; padding: 8px 12px; } #progressBar { width: 150px; height: 6px; } #pointsDisplay { top: 60px; font-size: 14px; padding: 6px 10px; } #achievementLevel { top: 105px; font-size: 12px; padding: 5px 8px; } #youtubeLecturePageControls { top: 60px; } #restartBtn, #videoSidebarToggleBtn { padding: 6px 10px; font-size: 10px; } #videoSidebarToggleBtn { top: 110px; font-size: 16px; } #videoSidebar { width: 250px; right: -270px; top: 50px; height: calc(100vh - 50px); } #lofiPlayer { padding: 10px; } #lofiPlayer button { padding: 5px 10px; font-size: 12px; min-width: 30px;} #fireBox { width: 45px; height: 45px; font-size: 22px; } #aiPopup { width: 90%; max-width: 300px; height: 400px; bottom: 65px; } .dialog-box { padding: 20px; } .dialog-box h3 { font-size: 18px; } .dialog-box p { font-size: 14px; margin-bottom: 20px; } .dialog-box button { padding: 8px 20px; font-size: 12px; } #pomodoroContainer { padding: 20px; } #pomodoroTimer { font-size: 60px; margin: 20px 0;} #pomodoroControls { gap: 15px; margin-top: 25px;} #pomodoroControls button { padding: 10px 20px; font-size: 14px; } #profileContainer { padding: 30px; } #profileIcon { font-size: 50px; width: 80px; height: 80px; line-height: 80px;} #profileUsername { font-size: 20px; } .profile-stat { font-size: 16px; } #focusStatsContainer { padding: 20px; } #focusStatsContainer h3 { font-size: 18px; margin-bottom: 25px; } .stat-item .value { font-size: 20px; } #todoList { max-width: 90%; } .task-line input[type="text"] { font-size: 14px; } .task-line .task-buttons { margin-left: 5px;} .task-line .set-deadline, .task-line .remove-task { font-size: 14px; padding: 3px;} .task-line .deadline-info, .task-line .points-info { font-size: 10px; margin-left: 4px;} .sidebar-trigger { left: -25px; } .game-sidebar.open + .sidebar-trigger { left: 240px; } }
         @media (max-width: 480px) { .title { font-size: 18px; } .subtitle { font-size: 14px; } #navLogo { display: none; } #navClockContainer { flex-grow: 1; text-align: left; margin-left: -10px;} #topNavBar { padding: 0 10px; } #navButtons { gap: 10px; } #navStreakDisplay { font-size: 12px; padding: 3px 6px; } #navProfileBtn { font-size: 20px; } #welcomeMessage { font-size: 18px; } #dateTimeDisplay { font-size: 14px; } #focusStatus { font-size: 16px; margin-bottom: 25px; padding: 8px;} #motivationQuote { font-size: 14px; } #youtubeInputContainer { padding: 10px 15px; } #youtubeInputContainer .subtitle { font-size: 14px; } .url-container { flex-direction: column; align-items: stretch; gap: 5px; } .url-container button { width: 100%; margin-top: 5px; } #playlistManagement { flex-direction: column; gap: 8px; align-items: stretch;} #playlistManagement select, #playlistManagement input { max-width: 100%; } #timerDisplay { font-size: 12px; padding: 6px 8px; } #progressBar { width: 120px; } #pointsDisplay { font-size: 12px; padding: 5px 8px; } #achievementLevel { font-size: 10px; padding: 4px 6px; top: 100px;} #videoSidebar { width: 200px; right: -220px; padding: 15px; } .game-sidebar.open + .sidebar-trigger { left: 200px; } #pomodoroTimer { font-size: 48px; } #pomodoroControls { gap: 10px; } #pomodoroControls button { padding: 8px 15px; font-size: 12px; } .dialog-box button { padding: 8px 15px; } .sidebar-trigger { width: 20px; height: 80px; font-size: 12px;} .game-sidebar { width: 200px; left: -220px; padding-top: 60px;} .sidebar-section { padding: 10px 15px; } .sidebar-section h3 { font-size: 14px; margin-bottom: 10px;} .sidebar-section a, .sidebar-section button { padding: 8px 10px; font-size: 13px; gap: 8px;} .sidebar-section button i, .sidebar-section a i { width: 16px; } #todoList { max-width: 95%; padding: 15px;} #todoList h3 { font-size: 16px;} .task-line { padding: 6px 8px;} .task-line input[type="checkbox"] { width: 16px; height: 16px; margin-right: 8px;} .task-line input[type="text"] { font-size: 13px;} }

    </style>
    <!-- Include Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Press+Start+2P&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Canvas Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

</head>
<body>

    <!-- Main Game Container -->
    <div class="game-container">

        <!-- Top Navigation Bar -->
        <nav id="topNavBar">
             <!-- Logo Image -->
            <a href="#" id="navLogo" title="Quest for Focus" data-action="show-view" data-view="homePage">
                <img src="logo.png" alt="Quest for Focus Logo">
            </a>
            <div id="navClockContainer"> <span id="navClockTime">00:00:00</span> <span id="navClockPeriod">AM</span> </div>
            <div id="navButtons">
                <span id="navStreakDisplay"><i class="fas fa-fire"></i> 0 days focus</span>
                <button id="navProfileBtn" title="Profile" data-action="show-view" data-view="profile"> <i class="fas fa-user-circle"></i> </button>
            </div>
        </nav>

        <!-- == Page Views == -->
        <div id="landingPage" class="page-view" style="display: flex;"> <div id="landingPageContainer"> <div class="title">QUEST FOR <span>FOCUS</span></div> <div class="subtitle">Embark on your learning adventure! Conquer distractions, master knowledge.</div> <button data-action="show-view" data-view="signinForm" class="primary-btn">START QUEST</button> <button class="github-btn" data-action="github"><i class="fab fa-github"></i> GITHUB</button> <div id="features"> <div class="feature"> <i class="fas fa-ban"></i> <p>Ad-Free Zone<br>Focus!</p> </div> <div class="feature"> <i class="fas fa-moon"></i> <p>Dark Mode<br>Easy on eyes</p> </div> <div class="feature"> <i class="fas fa-gamepad"></i> <p>Gamified<br>Level up!</p> </div> </div> </div> </div>
        <div id="signinForm" class="page-view"> <div id="signinFormContainer"> <div class="title">ENTER <span>REALM</span></div> <div class="subtitle">Log in or create hero profile.</div> <input type="text" id="username" placeholder="Hero Name" required /> <input type="password" id="password" placeholder="Secret Code" required /> <button data-action="sign-in" class="primary-btn">SIGN IN</button> <p style="color: var(--text-dim); margin-top: 15px;">New? <button data-action="create-account" class="accent-btn" style="margin-left: 5px; background: var(--secondary); box-shadow: 3px 3px 0 var(--primary-dark);">CREATE</button> </p> <button data-action="show-view" data-view="landingPage" style="margin-top: 20px; background: var(--bg-light); font-size: 12px;"> <i class="fas fa-arrow-left"></i> Back</button> </div> </div>
        <div id="homePage" class="page-view"> <div id="homePageContent"> <div id="welcomeMessage">Welcome, <span id="homeUsername">Hero</span>!</div> <div id="dateTimeDisplay">Loading...</div> <div id="focusStatus">Ready to focus?</div> <div id="motivationQuote">"Loading motivation..."</div> </div> </div>
        <div id="youtubeLecturePage" class="page-view"> <div id="youtubeInputContainer"> <div class="subtitle">Prepare Focus Session</div> <select id="playlistSelect"> <option value="">Load Playlist</option> </select> <div id="urlInputs"> <div class="url-container"> <input type="text" class="youtube-url" placeholder="YouTube URL" required /> </div> </div> <button data-action="add-url"><i class="fas fa-plus"></i> Add URL</button> <div id="playlistManagement"> <input type="text" id="playlistName" placeholder="Save As..." /> <button data-action="save-playlist" class="primary-btn"><i class="fas fa-save"></i> Save</button> <button data-action="remove-playlist" class="accent-btn" style="background: var(--danger); box-shadow: 3px 3px 0 #a71d2a;"><i class="fas fa-trash"></i> Delete</button> </div> <button data-action="start-playback" class="primary-btn"><i class="fas fa-play-circle"></i> BEGIN FOCUS</button> </div> <div id="playerContainer"> <div id="player"></div> </div> <button id="videoSidebarToggleBtn" title="Toggle List (T)"> <i class="fas fa-list"></i> </button> <div id="youtubeLecturePageControls"> <button id="restartBtn" title="Exit Session"><i class="fas fa-times-circle"></i> Exit</button> </div> <div id="videoSidebar"> <h3><i class="fas fa-video"></i> Playlist</h3> <div id="videoThumbnailList"></div> </div> </div>
        <div id="profile" class="page-view"> <div id="profileContainer"> <div id="profileIcon"><i class="fas fa-user-shield"></i></div> <div id="profileUsername">Hero Name</div> <div class="profile-stat">Level: <span id="profileLevel" class="level">Mortal</span></div> <div class="profile-stat">XP: <span id="profileXP" class="xp">0</span></div> <div class="profile-stat">Streak: <span id="profileStreak" class="streak">0 days</span></div> <button data-action="show-view" data-view="homePage" style="margin-top: 20px; background: var(--bg-light); font-size: 12px;"> <i class="fas fa-arrow-left"></i> Home</button> </div> </div>
        <div id="focusStats" class="page-view"> <div id="focusStatsContainer"> <h3><i class="fas fa-chart-line"></i> Hero <span>Stats</span></h3> <div id="statsDisplay"> <div class="stat-item"> <span class="label"><i class="fas fa-stopwatch"></i> Focus Time</span> <span id="statsTotalFocusTime" class="value">0m</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-eye-slash"></i> Distractions</span> <span id="statsTotalDistractions" class="value distractions">0</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-film"></i> Videos Done</span> <span id="statsTotalVideosWatched" class="value videos">0</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-fire"></i> Current Streak</span> <span id="statsCurrentStreak" class="value streak">0 days</span> </div> </div> <div id="focusCalendar"> <h4><i class="fas fa-calendar-alt"></i> Calendar (Soon)</h4> <div id="calendarGrid"> Calendar planned. </div> </div> <button data-action="show-view" data-view="homePage" style="margin-top: 30px; background: var(--bg-light); font-size: 12px; display: block; margin-left: auto; margin-right: auto;"> <i class="fas fa-arrow-left"></i> Home</button> </div> </div>

        <!-- == Shared Components == -->
        <div class="sidebar-trigger" title="Open Menu">MENU</div>
        <div class="game-sidebar"> <div class="sidebar-section"> <h3>Navigation</h3> <button data-action="show-view" data-view="homePage"><i class="fas fa-home"></i> Home</button> <button data-action="show-view" data-view="youtubeLecturePage"><i class="fab fa-youtube"></i> Lectures</button> <button data-action="toggle-todo"><i class="fas fa-list-check"></i> To-Do</button> </div> <div class="sidebar-section"> <h3>Progress</h3> <button data-action="show-view" data-view="focusStats"><i class="fas fa-chart-line"></i> Stats</button> <a href="https://room.examgoal.com/" target="_blank" rel="noreferrer"><i class="fas fa-dumbbell"></i> PYQs</a> </div> <div class="sidebar-section"> <h3>Self Study</h3> <button id="quietPomodoroBtn"><i class="fas fa-brain"></i> Pomodoro</button> </div> <div class="sidebar-section"> <h3>Shops & Realms</h3> <button id="streakShieldBtn"><i class="fas fa-shield-alt"></i> Shield</button> <button id="doublePointsBtn"><i class="fas fa-bolt"></i> Double XP</button> <button id="audioStoreBtn"><i class="fas fa-music"></i> Audio</button> <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer"><i class="fas fa-tree"></i> Forest</a> <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer"><i class="fas fa-clock"></i> Pomodoro Realm</a> <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer"><i class="fas fa-calendar-alt"></i> Planner</a> </div> <div class="sidebar-section"> <h3>Account</h3> <button data-action="show-view" data-view="profile"><i class="fas fa-user"></i> Profile</button> <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button> </div> </div>
        <div id="timerDisplay"> <span id="timerText">Focus: 00:00</span> <div id="progressBar"> <div id="progressFill"></div> </div> </div>
        <div id="pointsDisplay"><span style="color: var(--secondary);">â­</span> XP: 0</div>
        <div id="achievementLevel">Mortal</div>
        <div id="todoList"> <h3><i class="fas fa-tasks"></i> Quests</h3> <div id="tasks"></div> <div class="dialog-buttons"> <button data-action="save-tasks" class="primary-btn"><i class="fas fa-save"></i> Save</button> <button data-action="add-task-line" style="background: var(--bg-light);"><i class="fas fa-plus"></i> Add</button> <button data-action="close-todo" class="accent-btn" style="background: var(--danger); box-shadow: 3px 3px 0 #a71d2a;"><i class="fas fa-times"></i> Close</button> </div> </div>
        <div id="lofiPlayer"> <div class="lofi-title">LOFI â™¬</div> <button id="lofiPrev" title="Prev"><i class="fas fa-backward-step"></i></button> <button id="lofiPlay" title="Play"><i class="fas fa-play"></i></button> <button id="lofiPause" title="Pause"><i class="fas fa-pause"></i></button> <button id="lofiNext" title="Next"><i class="fas fa-forward-step"></i></button> </div>
        <div id="fireBox" title="AI Assistant"><i class="fas fa-robot"></i></div>
        <div id="aiPopup"> <iframe src="https://www.chatbase.co/chatbot-iframe/3dSdpryiYZlWipHUL8dNK" frameBorder="0"></iframe> </div>
        <div id="achievementOverlay">LEVEL UP!</div>
        <div id="confirmationDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-question-circle"></i> Confirm</h3> <p id="confirmationDialogText">Are you sure?</p> <div class="dialog-buttons"> <button id="confirmBtn">YES</button> <button id="cancelBtn">NO</button> </div> </div> </div>
        <div id="streakShieldDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-shield-alt"></i> Shield</h3> <p>Protect streak (1 week)? Costs 800 XP.</p> <div class="dialog-buttons"> <button id="streakShieldConfirmBtn">Buy</button> <button id="streakShieldCancelBtn">Cancel</button> </div> </div> </div>
        <div id="doublePointsDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-bolt"></i> Double XP</h3> <p>Activate Double XP (24h)? Costs 800 XP.</p> <div class="dialog-buttons"> <button id="doublePointsConfirmBtn">Activate</button> <button id="doublePointsCancelBtn">Cancel</button> </div> </div> </div>
        <div id="deadlineDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-calendar-check"></i> Deadline</h3> <p>Set deadline & difficulty for bonus XP!</p> <input type="date" id="deadlineDate" /> <input type="time" id="deadlineTime" /> <select id="taskDifficulty"> <option value="50">Easy (+50)</option> <option value="100">Medium (+100)</option> <option value="200">Hard (+200)</option> <option value="300">Very Hard (+300)</option> </select> <div class="dialog-buttons"> <button id="deadlineConfirmBtn">Set</button> <button id="deadlineCancelBtn">Cancel</button> </div> </div> </div>
        <div id="sessionCompleteDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-check-circle"></i> Session Done!</h3> <p>Great focus!</p> <p>Continue for +100 XP bonus?</p> <div class="dialog-buttons"> <button id="sessionContinueBtn">Continue</button> <button id="sessionEndBtn">End</button> </div> </div> </div>
        <div id="mysteryBoxPopup" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-gift"></i> Mystery Box</h3> <p id="mysteryRewardText">Mystery box earned!</p> <div class="dialog-buttons"> <button id="openMysteryBox">Open</button> <button id="closeMysteryBoxBtn">Later</button> </div> </div> </div>
        <div id="audioTracksStore" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-store"></i> Audio Store</h3> <p>Unlock Lo-Fi tracks!</p> <div id="audioTracksList"></div> <div class="dialog-buttons" style="margin-top: 20px;"> <button id="closeAudioStore">Close</button> </div> </div> </div>
        <div id="pomodoroOverlay" class="dialog-overlay"> <div id="pomodoroContainer"> <h3><i class="fas fa-brain"></i> POMODORO</h3> <p>Earn 1 XP per minute.</p> <div id="pomodoroTimer">60:00</div> <div id="pomodoroStatus">Ready</div> <div id="pomodoroControls"> <button id="pomodoroStartBtn"><i class="fas fa-play"></i> START</button> <button id="pomodoroResetBtn"><i class="fas fa-redo"></i> RESET</button> <button id="pomodoroCloseBtn"><i class="fas fa-times"></i> CLOSE</button> </div> </div> </div>

        <!-- Audio Elements -->
        <audio id="focusAudio" preload="metadata" src="https://the-chosen-one-o5.github.io/UltraFocusModeYT/focus.mp3"></audio>
        <audio id="lofiAudio" preload="metadata" loop></audio>
        <audio id="pomodoroCompleteAudio" preload="none" src="https://www.dropbox.com/scl/fi/ihrcv1s3o4m4abhn6oa5z/level-up-4-243762.mp3?rlkey=qkaf4zrhipxtxpu51an0do45r&st=boipxpb5&dl=1"></audio>
        <audio id="levelUpAudio" preload="none" src="https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1"></audio>
        <audio id="achievementAudio" preload="none" src="https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1"></audio>

    </div> <!-- End Game Container -->


    <script>
        // Wrap entire script in IIFE
        ;(() => {
            // --- State Variables ---
            let currentView = 'landingPage';
            let player; let videoIds = []; let currentVideoIndex = 0;
            let isFocusModeActive = false; let countdownInterval;
            let points = 0; let isSignedIn = false; let currentUser = null;
            const focusDuration = 50 * 60 * 1000; const firstBreakDuration = 15 * 60 * 1000; const secondBreakDuration = 10 * 60 * 1000;
            let timerMode = "Focus Time"; let timerRemaining = focusDuration / 1000;
            let completedVideos = new Set(); let allVideosCompleted = false;
            let totalFocusTime = 0; let totalDistractions = 0; let totalVideosWatched = 0;
            let playlists = []; let tasks = [];
            let previousPoints = 0; let streakDays = 0; let lastFocusDate = null;
            let isYouTubeAPILoaded = false;
            let lofiAudio, focusAudioElement;
            let currentLofiIndex = 0; let currentTaskForDeadline = null;
            let isSidebarOpen = false; let isVideoSidebarOpen = false;
            let pomodoroInterval; let pomodoroTimeRemaining = 60 * 60; let isPomodoroActive = false;
            let mysteryBoxCount = 0;
            let activePowerUps = { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, };
            const STREAK_SHIELD_COST = 800; const STREAK_SHIELD_DURATION = 7 * 24 * 60 * 60 * 1000;
            const DOUBLE_POINTS_COST = 800; const DOUBLE_POINTS_DURATION = 24 * 60 * 60 * 1000;
            const MYSTERY_BOX_STREAK_INTERVAL = 14;
            const mysteryBoxRewards = [ { type: "points", value: () => Math.floor(Math.random() * 451) + 50, message: (val) => `+${val} XP` }, { type: "doublePoints", value: DOUBLE_POINTS_DURATION, message: () => "Double XP (24h)" }, { type: "streakShield", value: STREAK_SHIELD_DURATION, message: () => "Streak Shield (1w)" }, { type: "lofiTrack", message: () => "Unlock Lofi Track" }, ];
            const baseLofiSongs = [ "https://www.dropbox.com/scl/fi/7qrgbk6vpej7x0ih7vev2/1-6_XRwBX7NX-1.mp3?rlkey=m3gntnys7az2hoq0iokkajucj&st=bmrhzjy8&dl=1", "https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1", "https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1", ];
            let premiumLofiTracks = [ { id: "track1", name: "Celestial", url: "https://www.dropbox.com/scl/fi/3xkks3j4tcmnloz46o03m/Kyle-Dixon-Michael-Stei-Kids.mp3?rlkey=6w97eurecqph68b8f2r7zn5pf&st=epeucz72&dl=1", unlocked: false, cost: 150 }, { id: "track2", name: "Midnight", url: "https://www.dropbox.com/scl/fi/7vikjhsay7xayyab0tlvt/enchanted-metamorphosis-chronicles-264087.mp3?rlkey=mrdncvjr3g5bo8dksxywh9zxh&st=ui3kdsq5&dl=1", unlocked: false, cost: 150 }, { id: "track3", name: "Rainy", url: "https://www.dropbox.com/scl/fi/iaouozc1osse7h5ea9lon/thunder-chosic.com.mp3?rlkey=o7u0rarnh4kk657qhmcgyiolz&st=2r9f625j&dl=1", unlocked: false, cost: 200 }, { id: "track4", name: "Dark Academia âœ¨", url: "https://www.dropbox.com/scl/fi/6gbti0c7ka2e3lc1kj895/Toxic-Drunker-a-playlist-to-romanticize-studying-physics-dark-academia-playlist.mp3?rlkey=xfo51y00j6tbuozey81c5cfub&st=lvu3uvvp&dl=1", unlocked: false, cost: 1000 }, { id: "track5", name: "Aria Math", url: "https://www.dropbox.com/scl/fi/nqgmray2um9mjtm9stjk9/aria_math_credit_to_c4.mp3?rlkey=99e4kgsulvy1k738piy17iiye&st=uj9t230p&dl=1", unlocked: false, cost: 800 }, { id: "track6", name: "Apollo 11", url: "https://www.dropbox.com/scl/fi/6gl1bhdz9pe8ymjyh0jgd/RevenantEntertainment-kataruma-dont-worry-ill-always-be-here-for-you.mp3?rlkey=ntodkwanh7by2r2nyuw7cht1x&st=mbs2fozn&dl=1", unlocked: false, cost: 800 }, { id: "track7", name: "Aatma rama lofi", url: "https://www.dropbox.com/scl/fi/55vg6j03lwhlmi4eoqual/Aatma-Rama-_-Raghu-X-Stereo-India.mp3?rlkey=25klv8ao9wtg63wq65ol33oub&st=w68o3ka6&dl=1", unlocked: false, cost: 500 }, { id: "track8", name: "The greatest song ever made ðŸ‘¾", url: "https://www.dropbox.com/scl/fi/hrbitky0j4l92zya0gvrg/If-You-re-A-Gamer-This-Song-FOUND-You-4.mp3?rlkey=4kevn083g6iz20bcmh5o6kizw&st=jp2zojra&dl=1", unlocked: false, cost: 1000 } ];
            let availableLofiSongs = [...baseLofiSongs];
            const achievementLevels = [ { points: 0, level: "Mortal", color: "white" }, { points: 1000, level: "Soldier", color: "#4169E1" }, { points: 2000, level: "Knight", color: "#e0e0ff", glow: true }, { points: 3000, level: "KING", color: "#ff8c00", glow: true }, { points: 4000, level: "GIGACHAD", color: "#ff4500", glow: true }, { points: 5000, level: "Demigod", color: "gold", glow: true }, { points: 6000, level: "Titan", color: "gold", glow: true, box: true }, { points: 7000, level: "Immortal", color: "gold", glow: true, box: true, boxGlow: true }, { points: 8000, level: "Celestial", color: "#00BFFF", glow: true, box: true, boxGlow: true }, { points: 9000, level: "Divine", color: "rainbow" }, { points: 10000, level: "Omnipotent", color: "rainbow", glow: true }, ];
            const motivationalQuotes = [ "Focus is key.", "Step by step.", "Progress > perfection.", "You got this!", "Stay sharp.", "Embrace challenge." ];

            // --- DOM References ---
            let topNavBar, landingPage, signinForm, homePage, youtubeLecturePage, profilePage, focusStatsPage;
            let playerContainer, playerDiv, timerDisplay, timerText, progressBar, progressFill, pointsDisplay;
            let achievementLevelDiv, lofiPlayer, aiPopup, fireBox, videoSidebar, videoThumbnailList;
            let usernameInput, passwordInput, homeUsernameSpan, dateTimeDisplaySpan, focusStatusSpan;
            let playlistSelect, urlInputsContainer, playlistNameInput, youtubeInputContainer;
            let todoListPopup, tasksContainer;
            let confirmationDialog, streakShieldDialog, doublePointsDialog, deadlineDialog, sessionCompleteDialog, mysteryBoxPopup, audioTracksStore, pomodoroOverlay;
            let gameSidebar, sidebarTrigger;
            let navClockTime, navClockPeriod, navStreakDisplay, videoSidebarToggleBtn, navProfileBtn;


            // --- Core Functions ---

            function showView(viewId) {
                console.log("Show View:", viewId);
                if (!document.getElementById(viewId)) { console.error(`View "${viewId}" missing!`); viewId = 'landingPage'; }
                const protectedViews = ['homePage', 'youtubeLecturePage', 'profile', 'focusStats'];
                if (protectedViews.includes(viewId) && !isSignedIn) { console.warn(`Access denied to "${viewId}".`); showView('signinForm'); return; }
                document.querySelectorAll('.page-view').forEach(v => v.style.display = 'none');
                const targetView = document.getElementById(viewId); targetView.style.display = 'flex'; currentView = viewId;
                const showNav = isSignedIn && (viewId !== 'landingPage' && viewId !== 'signinForm');
                const showShared = isSignedIn && (viewId === 'homePage' || viewId === 'youtubeLecturePage');
                if(topNavBar) topNavBar.style.display = showNav ? 'flex' : 'none';
                if(pointsDisplay) pointsDisplay.style.display = showNav ? 'block' : 'none';
                if(achievementLevelDiv) achievementLevelDiv.style.display = showNav ? 'block' : 'none';
                if(lofiPlayer) lofiPlayer.style.display = showShared ? 'block' : 'none';
                if(fireBox) fireBox.style.display = showShared ? 'flex' : 'none';

                // YT Page UI Logic
                if (viewId === 'youtubeLecturePage') {
                    const showInput = !isFocusModeActive; const showPlayerArea = isFocusModeActive; const showMultiVideoUI = showPlayerArea && videoIds.length > 1;
                    if(youtubeInputContainer) youtubeInputContainer.style.display = showInput ? 'block' : 'none';
                    if(playerContainer) playerContainer.style.display = showPlayerArea ? 'block' : 'none';
                    if(videoSidebar) videoSidebar.style.display = showMultiVideoUI ? 'block' : 'none';
                    if(videoSidebarToggleBtn) videoSidebarToggleBtn.style.display = showMultiVideoUI ? 'block' : 'none';
                    if(timerDisplay) timerDisplay.style.display = showPlayerArea ? 'block' : 'none';
                    const controls = document.getElementById('youtubeLecturePageControls'); if(controls) controls.style.display = showPlayerArea ? 'flex' : 'none';
                    if (showInput) { if (isSignedIn) { populatePlaylistSelect(); restoreUrlInputs(); } }
                    if (showPlayerArea) { highlightCurrentThumbnail(); } else { closeVideoSidebar(); }
                } else {
                    if(timerDisplay) timerDisplay.style.display = 'none'; if(videoSidebar) videoSidebar.style.display = 'none'; if(videoSidebarToggleBtn) videoSidebarToggleBtn.style.display = 'none'; const controls = document.getElementById('youtubeLecturePageControls'); if(controls) controls.style.display = 'none'; if(playerContainer) playerContainer.style.display = 'none'; closeVideoSidebar();
                    if (player && typeof player.pauseVideo === 'function' && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) { player.pauseVideo(); console.log("Paused video: view change."); }
                }

                // View Specific Updates
                if (viewId === 'homePage') { updateHomePageInfo(); displayRandomMotivation(); }
                else if (viewId === 'profile') { displayProfileInfo(); }
                else if (viewId === 'focusStats') { displayFocusStatsInfo(); }

                closeSidebar(); saveState();
            }

            function updateHomePageInfo() { if (homeUsernameSpan) homeUsernameSpan.textContent = currentUser || "Hero"; updateDateTimeDisplay(); updateFocusStatus(); }
            function updateDateTimeDisplay() { const dateEl = dateTimeDisplaySpan; if (!dateEl) return; const now = new Date(); const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; dateEl.textContent = `${now.toLocaleDateString(undefined, optionsDate)}`; }
            function updateFocusStatus() { if (!focusStatusSpan) return; const incompleteTasks = tasks.filter(task => !task.completed).length; if (isFocusModeActive) { focusStatusSpan.textContent = `Focusing on ${timerMode}...`; focusStatusSpan.style.color = 'var(--success)'; } else if (incompleteTasks > 0) { focusStatusSpan.textContent = `${incompleteTasks} quest${incompleteTasks > 1 ? 's' : ''} remaining!`; focusStatusSpan.style.color = 'var(--accent-alt)'; } else if (tasks.length > 0) { focusStatusSpan.textContent = "All quests complete!"; focusStatusSpan.style.color = 'var(--success)'; } else { focusStatusSpan.textContent = "Ready to add quests?"; focusStatusSpan.style.color = 'var(--text-dim)'; } }
            function displayRandomMotivation() { const quoteElement = document.getElementById('motivationQuote'); if (quoteElement) { const randomIndex = Math.floor(Math.random() * motivationalQuotes.length); quoteElement.textContent = `"${motivationalQuotes[randomIndex]}"`; } }

            function displayProfileInfo() {
                const usernameEl = document.getElementById('profileUsername'); const levelEl = document.getElementById('profileLevel'); const xpEl = document.getElementById('profileXP'); const streakEl = document.getElementById('profileStreak'); const iconEl = document.getElementById('profileIcon');
                if (!usernameEl || !levelEl || !xpEl || !streakEl || !iconEl) { console.error("Profile elements missing!"); return; }
                usernameEl.textContent = currentUser || 'Guest';
                const levelInfo = getAchievementLevel(points);
                levelEl.textContent = levelInfo.level; levelEl.className = 'level'; levelEl.style.color = ''; if (levelInfo.color === 'rainbow') { levelEl.classList.add('rainbow'); } else { levelEl.style.color = levelInfo.color; } if (levelInfo.glow) levelEl.classList.add('level-glow');
                xpEl.textContent = points;
                streakEl.textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`;
                let iconClass = 'fa-user'; if (levelInfo.points >= 8000) iconClass = 'fa-gem'; else if (levelInfo.points >= 5000) iconClass = 'fa-crown'; else if (levelInfo.points >= 2000) iconClass = 'fa-user-shield'; iconEl.innerHTML = `<i class="fas ${iconClass}"></i>`;
            }

            function displayFocusStatsInfo() {
                const focusTimeEl = document.getElementById('statsTotalFocusTime'); const distractionsEl = document.getElementById('statsTotalDistractions'); const videosEl = document.getElementById('statsTotalVideosWatched'); const streakEl = document.getElementById('statsCurrentStreak');
                if (!focusTimeEl || !distractionsEl || !videosEl || !streakEl) { console.error("Stats elements missing!"); return; }
                const hours = Math.floor(totalFocusTime / 3600); const minutes = Math.floor((totalFocusTime % 3600) / 60); let focusTimeString = ""; if (hours > 0) focusTimeString += `${hours}h `; focusTimeString += `${minutes}m`; if(hours === 0 && minutes === 0) focusTimeString = "0m";
                focusTimeEl.textContent = focusTimeString;
                distractionsEl.textContent = totalDistractions;
                videosEl.textContent = totalVideosWatched;
                streakEl.textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`;
                const calendarGrid = document.getElementById('calendarGrid'); if (calendarGrid) { calendarGrid.innerHTML = '<i>Calendar planned.</i>'; }
            }

            function initAudio() {
                 lofiAudio = document.getElementById("lofiAudio");
                 focusAudioElement = document.getElementById("focusAudio");
                 updateAvailableLofiTracks();
                 if (lofiAudio && availableLofiSongs.length > 0) {
                     currentLofiIndex = Math.floor(Math.random() * availableLofiSongs.length);
                     lofiAudio.src = availableLofiSongs[currentLofiIndex];
                     const playBtn = document.getElementById('lofiPlay');
                     const pauseBtn = document.getElementById('lofiPause');
                     if(playBtn) playBtn.style.display = 'inline-block';
                     if(pauseBtn) pauseBtn.style.display = 'none';
                     lofiAudio.load(); // Preload metadata
                 } else {
                     console.warn("Lofi audio init failed.");
                     document.querySelectorAll('#lofiPlayer button').forEach(btn => btn.disabled = true);
                 }
                 if (focusAudioElement) { focusAudioElement.loop = true; focusAudioElement.load(); /* Preload */ }
                 else { console.error("Focus audio element missing!"); }
            }

            function updateAvailableLofiTracks() { const unlockedPremiumUrls = premiumLofiTracks.filter(track => track.unlocked).map(track => track.url); availableLofiSongs = [...new Set([...baseLofiSongs, ...unlockedPremiumUrls])]; if (lofiAudio && !availableLofiSongs.includes(lofiAudio.src)) { currentLofiIndex = 0; if (availableLofiSongs.length > 0) { lofiAudio.src = availableLofiSongs[currentLofiIndex]; lofiAudio.load(); } else { lofiAudio.removeAttribute('src'); } } console.log("Available Lofi:", availableLofiSongs.length); document.querySelectorAll('#lofiPlayer button').forEach(btn => btn.disabled = availableLofiSongs.length === 0); }
            function getAchievementLevel(currentPoints) { let currentLevel = achievementLevels[0]; for (const level of achievementLevels) { if (currentPoints >= level.points) { currentLevel = level; } else { break; } } return currentLevel; }
            function updateAchievementLevel() { if (!achievementLevelDiv || !isSignedIn) return; const level = getAchievementLevel(points); achievementLevelDiv.textContent = level.level; achievementLevelDiv.className = 'level-default'; achievementLevelDiv.removeAttribute('style'); achievementLevelDiv.classList.remove('rainbow', 'level-glow', 'level-box-glow'); achievementLevelDiv.style.border = '2px solid var(--secondary)'; if (level.color === 'rainbow') { achievementLevelDiv.classList.add('rainbow'); } else { achievementLevelDiv.style.color = level.color; } if (level.glow) achievementLevelDiv.classList.add('level-glow'); if (level.box) achievementLevelDiv.style.border = '2px solid var(--gold)'; if (level.boxGlow) achievementLevelDiv.classList.add('level-box-glow'); if (currentView === 'profile') displayProfileInfo(); }
            function playSound(soundId) { const audio = document.getElementById(soundId); if (audio) { audio.currentTime = 0; audio.play().catch(err => console.warn(`Audio error (${soundId}):`, err.message)); } }
            function showAchievementOverlay(message) { const overlay = document.getElementById("achievementOverlay"); if (!overlay) return; overlay.textContent = message; overlay.style.display = "flex"; playSound('levelUpAudio'); setTimeout(() => { overlay.style.display = "none"; }, 5000); }
            function updateClock() { if (!navClockTime || !navClockPeriod) return; const now = new Date(); let hours = now.getHours(); const minutes = now.getMinutes().toString().padStart(2, "0"); const seconds = now.getSeconds().toString().padStart(2, "0"); const period = hours >= 12 ? "PM" : "AM"; hours = hours % 12 || 12; hours = hours.toString().padStart(2, "0"); navClockTime.textContent = `${hours}:${minutes}:${seconds}`; navClockPeriod.textContent = period; if (currentView === 'homePage') { updateDateTimeDisplay(); } }
            function playLofi() { if (!lofiAudio || availableLofiSongs.length === 0 || lofiAudio.readyState < 3) { console.warn("Lofi not ready/available. State:", lofiAudio?.readyState); return; } lofiAudio.play().then(() => { if (document.getElementById('lofiPlay')) document.getElementById('lofiPlay').style.display = 'none'; if (document.getElementById('lofiPause')) document.getElementById('lofiPause').style.display = 'inline-block'; }).catch((err) => console.error("Lofi play error:", err, "ReadyState:", lofiAudio.readyState)); }
            function pauseLofi() { if (!lofiAudio) return; lofiAudio.pause(); if (document.getElementById('lofiPlay')) document.getElementById('lofiPlay').style.display = 'inline-block'; if (document.getElementById('lofiPause')) document.getElementById('lofiPause').style.display = 'none'; }
            function nextLofi() { if (!lofiAudio || availableLofiSongs.length <= 1) return; currentLofiIndex = (currentLofiIndex + 1) % availableLofiSongs.length; lofiAudio.src = availableLofiSongs[currentLofiIndex]; lofiAudio.load(); playLofi(); }
            function prevLofi() { if (!lofiAudio || availableLofiSongs.length <= 1) return; currentLofiIndex = (currentLofiIndex - 1 + availableLofiSongs.length) % availableLofiSongs.length; lofiAudio.src = availableLofiSongs[currentLofiIndex]; lofiAudio.load(); playLofi(); }
            function updateStreak() { if (!isSignedIn) return; const today = new Date().toDateString(); if (lastFocusDate) { const last = new Date(lastFocusDate); const todayDate = new Date(today); const diffTime = todayDate - last; const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); if (diffDays === 1) { streakDays++; checkMysteryBoxMilestone(); console.log("Streak++:", streakDays); } else if (diffDays > 1) { if (activePowerUps.streakShield.active && Date.now() < activePowerUps.streakShield.expiry && !activePowerUps.streakShield.used) { activePowerUps.streakShield.used = true; showConfirmation("Shield Used!", "Shield protected streak!", false); console.log("Shield used."); } else { console.log("Streak broken."); streakDays = 1; activePowerUps.streakShield.used = false; } } else if (diffDays !== 0) { console.warn("Date anomaly:", diffDays); streakDays = 1; } } else { streakDays = 1; console.log("First streak day."); } lastFocusDate = today; updateStreakDisplay(); saveState(); }
            function updateStreakDisplay() { if (!navStreakDisplay) return; navStreakDisplay.innerHTML = `<i class="fas fa-fire"></i> ${streakDays} ${streakDays === 1 ? 'day' : 'days'} focus`; const profileStreakEl = document.getElementById('profileStreak'); if (profileStreakEl && currentView === 'profile') profileStreakEl.textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`; const statsStreakEl = document.getElementById('statsCurrentStreak'); if (statsStreakEl && currentView === 'focusStats') statsStreakEl.textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`; }
            function checkMysteryBoxMilestone() { if (streakDays > 0 && streakDays % MYSTERY_BOX_STREAK_INTERVAL === 0) { mysteryBoxCount++; showMysteryBoxPopup(); playSound('achievementAudio'); saveState(); } }
            function showMysteryBoxPopup() { const popup = document.getElementById("mysteryBoxPopup"); const rewardText = document.getElementById("mysteryRewardText"); const openButton = document.getElementById("openMysteryBox"); if (!popup || !rewardText || !openButton) return; if (mysteryBoxCount > 0) { rewardText.textContent = `You have ${mysteryBoxCount} Box${mysteryBoxCount > 1 ? 'es' : ''}! Open?`; openButton.disabled = false; openButton.textContent = "Open"; popup.style.display = "flex"; } else { console.log("No boxes."); } }
            function openMysteryBox() { if (mysteryBoxCount <= 0) return; const popup = document.getElementById("mysteryBoxPopup"); const rewardText = document.getElementById("mysteryRewardText"); const openButton = document.getElementById("openMysteryBox"); if (!popup || !rewardText || !openButton) return; mysteryBoxCount--; const rewardIndex = Math.floor(Math.random() * mysteryBoxRewards.length); const reward = mysteryBoxRewards[rewardIndex]; let rewardValue = null; let rewardMessageText = ""; switch (reward.type) { case "points": rewardValue = reward.value(); points += rewardValue; rewardMessageText = `Found ${reward.message(rewardValue)}!`; break; case "doublePoints": if (!activePowerUps.doublePoints.active || (activePowerUps.doublePoints.expiry && Date.now() > activePowerUps.doublePoints.expiry)) { activePowerUps.doublePoints.active = true; activePowerUps.doublePoints.expiry = Date.now() + DOUBLE_POINTS_DURATION; rewardMessageText = `Activated: ${reward.message()}!`; setTimeout(() => { activePowerUps.doublePoints.active = false; activePowerUps.doublePoints.expiry = null; saveState(); showConfirmation("Expired", "Double XP ended.", false); }, DOUBLE_POINTS_DURATION); } else { rewardValue = 200; points += rewardValue; rewardMessageText = `Double XP active! +${rewardValue} XP!`; } break; case "streakShield": if (!activePowerUps.streakShield.active || (activePowerUps.streakShield.expiry && Date.now() > activePowerUps.streakShield.expiry)) { activePowerUps.streakShield.active = true; activePowerUps.streakShield.expiry = Date.now() + STREAK_SHIELD_DURATION; activePowerUps.streakShield.used = false; rewardMessageText = `Activated: ${reward.message()}!`; setTimeout(() => { activePowerUps.streakShield.active = false; activePowerUps.streakShield.expiry = null; saveState(); showConfirmation("Expired", "Shield faded.", false); }, STREAK_SHIELD_DURATION); } else { rewardValue = 200; points += rewardValue; rewardMessageText = `Shield active! +${rewardValue} XP!`; } break; case "lofiTrack": const lockedTracks = premiumLofiTracks.filter(t => !t.unlocked); if (lockedTracks.length > 0) { const trackToUnlock = lockedTracks[Math.floor(Math.random() * lockedTracks.length)]; trackToUnlock.unlocked = true; updateAvailableLofiTracks(); rewardMessageText = `Audio Unlocked: "${trackToUnlock.name}"!`; playSound('achievementAudio'); } else { rewardValue = 100; points += rewardValue; rewardMessageText = `All tracks unlocked! +${rewardValue} XP!`; } break; } rewardText.textContent = rewardMessageText; if (pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; openButton.textContent = "Awesome!"; openButton.disabled = true; saveState(); checkLevelUp(); setTimeout(() => { openButton.disabled = mysteryBoxCount <= 0; openButton.textContent = "Open"; if (mysteryBoxCount > 0) { rewardText.textContent = `Have ${mysteryBoxCount} Box${mysteryBoxCount > 1 ? 'es' : ''} left! Open?`; } else { rewardText.textContent = "No more boxes."; } }, 2500); }
            function closeMysteryBoxPopup() { const popup = document.getElementById("mysteryBoxPopup"); if (popup) popup.style.display = "none"; const rewardText = document.getElementById("mysteryRewardText"); const openButton = document.getElementById("openMysteryBox"); if(rewardText) rewardText.textContent = "Mystery box earned!"; if(openButton) { openButton.disabled = mysteryBoxCount <= 0; openButton.textContent = "Open"; } }
            function applyPowerUps(basePoints) { let finalPoints = basePoints; if (activePowerUps.doublePoints.active && Date.now() < activePowerUps.doublePoints.expiry) { finalPoints *= 2; console.log("Double pts!"); } return Math.floor(finalPoints); }
            function checkLevelUp() { const oldLevel = getAchievementLevel(previousPoints); const newLevel = getAchievementLevel(points); if (newLevel.points > oldLevel.points) { showAchievementOverlay(`LEVEL UP! ${newLevel.level.toUpperCase()}!`); updateAchievementLevel(); } previousPoints = points; if (currentView === 'profile') displayProfileInfo(); if (currentView === 'focusStats') displayFocusStatsInfo(); }
            function showStreakShieldDialog() { if (points < STREAK_SHIELD_COST) { showConfirmation("Need XP", `Need ${STREAK_SHIELD_COST} XP.`, false); return; } if (activePowerUps.streakShield.active && Date.now() < activePowerUps.streakShield.expiry) { showConfirmation("Active", "Shield active!", false); return; } const dialog = document.getElementById("streakShieldDialog"); if (dialog) dialog.style.display = "flex"; }
            function handleStreakShieldConfirmation(choice) { const dialog = document.getElementById("streakShieldDialog"); if (dialog) dialog.style.display = "none"; if (choice === "yes" && points >= STREAK_SHIELD_COST) { points -= STREAK_SHIELD_COST; activePowerUps.streakShield.active = true; activePowerUps.streakShield.expiry = Date.now() + STREAK_SHIELD_DURATION; activePowerUps.streakShield.used = false; if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; showConfirmation("Success", "Shield activated!", false); playSound('achievementAudio'); saveState(); checkLevelUp(); setTimeout(() => { activePowerUps.streakShield.active = false; activePowerUps.streakShield.expiry = null; saveState(); if(isSignedIn) showConfirmation("Expired", "Shield faded.", false); }, STREAK_SHIELD_DURATION); } }
            function showDoublePointsDialog() { if (points < DOUBLE_POINTS_COST) { showConfirmation("Need XP", `Need ${DOUBLE_POINTS_COST} XP.`, false); return; } if (activePowerUps.doublePoints.active && Date.now() < activePowerUps.doublePoints.expiry) { showConfirmation("Active", "Double XP active!", false); return; } const dialog = document.getElementById("doublePointsDialog"); if (dialog) dialog.style.display = "flex"; }
            function handleDoublePointsConfirmation(choice) { const dialog = document.getElementById("doublePointsDialog"); if (dialog) dialog.style.display = "none"; if (choice === "yes" && points >= DOUBLE_POINTS_COST) { points -= DOUBLE_POINTS_COST; activePowerUps.doublePoints.active = true; activePowerUps.doublePoints.expiry = Date.now() + DOUBLE_POINTS_DURATION; if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; showConfirmation("Success", "Double XP activated!", false); playSound('achievementAudio'); saveState(); checkLevelUp(); setTimeout(() => { activePowerUps.doublePoints.active = false; activePowerUps.doublePoints.expiry = null; saveState(); if(isSignedIn) showConfirmation("Expired", "Double XP ended.", false); }, DOUBLE_POINTS_DURATION); } }
            function showAudioTracksStore() { const store = document.getElementById("audioTracksStore"); const tracksList = document.getElementById("audioTracksList"); if (!store || !tracksList) return; tracksList.innerHTML = ""; premiumLofiTracks.sort((a, b) => a.name.localeCompare(b.name)); premiumLofiTracks.forEach(track => { const trackItem = document.createElement("div"); trackItem.className = `audio-track-item ${track.unlocked ? 'unlocked' : 'locked'}`; const trackInfo = document.createElement("div"); trackInfo.className = "track-info"; const trackName = document.createElement("div"); trackName.className = "track-name"; trackName.textContent = track.name; const trackCost = document.createElement("div"); trackCost.className = "track-cost"; trackCost.textContent = track.unlocked ? "Owned" : `${track.cost} XP`; trackInfo.appendChild(trackName); trackInfo.appendChild(trackCost); const unlockBtn = document.createElement("button"); unlockBtn.className = "unlock-track-btn"; unlockBtn.dataset.trackId = track.id; if (track.unlocked) { unlockBtn.textContent = "âœ“ OWNED"; unlockBtn.disabled = true; unlockBtn.classList.add('unlocked'); } else { unlockBtn.textContent = "UNLOCK"; unlockBtn.disabled = points < track.cost; unlockBtn.onclick = () => unlockAudioTrack(track.id); } trackItem.appendChild(trackInfo); trackItem.appendChild(unlockBtn); tracksList.appendChild(trackItem); }); store.style.display = "flex"; }
            function closeAudioTracksStore() { const store = document.getElementById("audioTracksStore"); if (store) store.style.display = "none"; }
            function unlockAudioTrack(trackId) { const track = premiumLofiTracks.find(t => t.id === trackId); if (!track || track.unlocked || points < track.cost) return; points -= track.cost; track.unlocked = true; updateAvailableLofiTracks(); if (pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; showConfirmation("Unlocked!", `"${track.name}" available!`, false); playSound('achievementAudio'); showAudioTracksStore(); saveState(); checkLevelUp(); }
            function showPomodoroOverlay() { clearInterval(pomodoroInterval); isPomodoroActive = false; pomodoroTimeRemaining = 60 * 60; updatePomodoroDisplay(); const statusEl = document.getElementById("pomodoroStatus"); if (statusEl) statusEl.textContent = "Ready"; const startBtn = document.getElementById('pomodoroStartBtn'); if(startBtn) startBtn.disabled = false; const resetBtn = document.getElementById('pomodoroResetBtn'); if(resetBtn) resetBtn.disabled = true; const overlay = document.getElementById("pomodoroOverlay"); if (overlay) overlay.style.display = "flex"; }
            function startPomodoro() { if (isPomodoroActive) return; isPomodoroActive = true; const statusEl = document.getElementById("pomodoroStatus"); if (statusEl) statusEl.textContent = "Focusing..."; const startBtn = document.getElementById('pomodoroStartBtn'); if(startBtn) startBtn.disabled = true; const resetBtn = document.getElementById('pomodoroResetBtn'); if(resetBtn) resetBtn.disabled = false; pomodoroInterval = setInterval(() => { pomodoroTimeRemaining--; updatePomodoroDisplay(); if (pomodoroTimeRemaining % 60 === 0 && pomodoroTimeRemaining > 0) { const earned = applyPowerUps(1); points += earned; totalFocusTime++; if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; checkLevelUp();} if (pomodoroTimeRemaining <= 0) { completePomodoroSession(); } }, 1000); }
            function resetPomodoro() { clearInterval(pomodoroInterval); isPomodoroActive = false; pomodoroTimeRemaining = 60 * 60; updatePomodoroDisplay(); const statusEl = document.getElementById("pomodoroStatus"); if (statusEl) statusEl.textContent = "Reset"; const startBtn = document.getElementById('pomodoroStartBtn'); if(startBtn) startBtn.disabled = false; const resetBtn = document.getElementById('pomodoroResetBtn'); if(resetBtn) resetBtn.disabled = true; }
            function closePomodoroOverlay() { const overlay = document.getElementById("pomodoroOverlay"); if (!overlay) return; if (isPomodoroActive) { showConfirmation( "Exit?", "Session active. Stop?", true, () => { clearInterval(pomodoroInterval); isPomodoroActive = false; saveState(); overlay.style.display = "none"; }, () => {} ); } else { overlay.style.display = "none"; } }
            function updatePomodoroDisplay() { const timerElement = document.getElementById("pomodoroTimer"); if (!timerElement) return; const minutes = Math.floor(pomodoroTimeRemaining / 60); const seconds = pomodoroTimeRemaining % 60; timerElement.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`; }
            function completePomodoroSession() { clearInterval(pomodoroInterval); isPomodoroActive = false; playSound("pomodoroCompleteAudio"); if (pomodoroTimeRemaining === 0) { const earned = applyPowerUps(1); points += earned; totalFocusTime++; if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; } const statusEl = document.getElementById("pomodoroStatus"); if (statusEl) statusEl.textContent = `Complete!`; const startBtn = document.getElementById('pomodoroStartBtn'); if(startBtn) startBtn.disabled = false; const resetBtn = document.getElementById('pomodoroResetBtn'); if(resetBtn) resetBtn.disabled = true; saveState(); checkLevelUp(); }
            function toggleTodo() { if (!todoListPopup) return; const isVisible = todoListPopup.style.display === "flex"; if (isVisible) { saveTasks(); todoListPopup.style.display = "none"; } else { restoreTasks(); todoListPopup.style.display = "flex"; } }
            function addTaskLine(taskData = { text: "", completed: false, deadline: null, points: null }) { if (!tasksContainer) return null; const line = document.createElement("div"); line.className = "task-line"; const checkbox = document.createElement("input"); checkbox.type = "checkbox"; checkbox.className = "task-check"; checkbox.checked = taskData.completed; checkbox.onchange = handleTaskCompletionChange; const input = document.createElement("input"); input.type = "text"; input.className = "task-text"; input.placeholder = "Add quest..."; input.value = taskData.text; input.readOnly = taskData.completed; input.onkeydown = handleTaskInputKeydown; input.onchange = () => { line.dataset.text = input.value; }; line.dataset.text = taskData.text; line.dataset.completed = taskData.completed; if(taskData.deadline) line.dataset.deadline = taskData.deadline; if(taskData.points) line.dataset.points = taskData.points; if(taskData.deadlineChecked) line.dataset.deadlineChecked = taskData.deadlineChecked; const buttonsContainer = document.createElement('div'); buttonsContainer.className = 'task-buttons'; const deadlineBtn = document.createElement("button"); deadlineBtn.className = "set-deadline"; deadlineBtn.innerHTML = '<i class="fas fa-stopwatch"></i>'; deadlineBtn.title = "Deadline"; deadlineBtn.onclick = () => showDeadlineDialog(line); deadlineBtn.disabled = taskData.completed; const removeBtn = document.createElement("button"); removeBtn.className = "remove-task"; removeBtn.innerHTML = '<i class="fas fa-times"></i>'; removeBtn.title = "Remove"; removeBtn.onclick = () => removeTask(line); buttonsContainer.appendChild(deadlineBtn); buttonsContainer.appendChild(removeBtn); line.appendChild(checkbox); line.appendChild(input); line.appendChild(buttonsContainer); updateTaskDeadlineDisplay(line, taskData.deadline, taskData.points); tasksContainer.appendChild(line); if (taskData.completed) { line.style.opacity = '0.7'; } return input; }
            function handleTaskInputKeydown(event) { if (event.key === "Enter") { event.preventDefault(); const currentInput = event.target; const currentLine = currentInput.closest('.task-line'); if (currentLine) currentLine.dataset.text = currentInput.value; const allLines = tasksContainer?.querySelectorAll('.task-line'); if (!allLines) return; if (currentLine === allLines[allLines.length - 1]) { const newFocusTarget = addTaskLine(); if (newFocusTarget) newFocusTarget.focus(); } else { let nextLine = currentLine.nextElementSibling; while (nextLine && !nextLine.classList.contains('task-line')) { nextLine = nextLine.nextElementSibling; } if (nextLine) { const nextInput = nextLine.querySelector('.task-text'); if (nextInput) nextInput.focus(); } else { const newFocusTarget = addTaskLine(); if (newFocusTarget) newFocusTarget.focus(); } } } }
            function removeTask(taskElement) { if (!tasksContainer || !taskElement) return; if (tasksContainer.children.length > 1 || tasksContainer.children[0] !== taskElement) { tasksContainer.removeChild(taskElement); } else { const input = taskElement.querySelector('.task-text'); if (input) input.value = ''; taskElement.dataset.text = ''; taskElement.removeAttribute('data-deadline'); taskElement.removeAttribute('data-points'); updateTaskDeadlineDisplay(taskElement, null, null); } }
            function restoreTasks() { if (!tasksContainer) return; tasksContainer.innerHTML = ""; if (tasks.length === 0) { addTaskLine(); } else { tasks.forEach(taskData => addTaskLine(taskData)); } checkTaskDeadlines(); }
            function saveTasks() { if (!tasksContainer) return; const taskLines = tasksContainer.querySelectorAll(".task-line"); tasks = Array.from(taskLines).map(line => ({ text: line.querySelector(".task-text")?.value.trim() || (line.dataset.text || ""), completed: line.querySelector(".task-check")?.checked || (line.dataset.completed === 'true'), deadline: line.dataset.deadline ? parseInt(line.dataset.deadline) : null, points: line.dataset.points ? parseInt(line.dataset.points) : null, deadlineChecked: line.dataset.deadlineChecked === 'true' })).filter(task => task.text !== ""); localStorage.setItem("tasks", JSON.stringify(tasks)); if (isSignedIn && currentUser) { try { const users = JSON.parse(localStorage.getItem("users") || "{}"); if(users[currentUser]) { users[currentUser].tasks = tasks; localStorage.setItem("users", JSON.stringify(users)); } } catch (err) { console.error("Error saving tasks:", err); } } console.log("Tasks saved:", tasks); updateFocusStatus(); }

            function handleTaskCompletionChange(event) {
                 const checkbox = event.target; const taskLine = checkbox.closest('.task-line'); if (!taskLine) return;
                 const input = taskLine.querySelector('.task-text'); const deadlineBtn = taskLine.querySelector('.set-deadline');
                 taskLine.dataset.completed = checkbox.checked;
                 if (checkbox.checked) {
                     if(input) input.readOnly = true; taskLine.style.opacity = '0.7'; if(deadlineBtn) deadlineBtn.disabled = true;
                     checkSingleTaskDeadline(taskLine);
                     // --- Confetti Trigger ---
                     if (typeof confetti === 'function') {
                         const rect = checkbox.getBoundingClientRect();
                         const origin = { x: (rect.left + rect.right) / 2 / window.innerWidth, y: (rect.top + rect.bottom) / 2 / window.innerHeight };
                         confetti({ particleCount: 80, spread: 60, origin: origin, colors: ['#a855f7', '#9333ea', '#c084fc', '#6b21a8'] });
                     }
                 } else {
                     if(input) input.readOnly = false; taskLine.style.opacity = '1'; if(deadlineBtn) deadlineBtn.disabled = false;
                 }
            }

            function checkSingleTaskDeadline(taskLine) { if (!taskLine) return; const deadlineTimestamp = taskLine.dataset.deadline ? parseInt(taskLine.dataset.deadline) : null; const deadlineChecked = taskLine.dataset.deadlineChecked === 'true'; const taskPoints = taskLine.dataset.points ? parseInt(taskLine.dataset.points) : null; const taskText = taskLine.dataset.text || "Untitled"; if (!deadlineTimestamp || deadlineChecked || !taskPoints) return; const now = Date.now(); let earnedPoints = 0; let message = ""; if (now <= deadlineTimestamp) { earnedPoints = applyPowerUps(taskPoints); points += earnedPoints; message = `Quest "${taskText}" on time! +${earnedPoints} XP`; playSound('achievementAudio'); } else { message = `Quest "${taskText}" completed late.`; } showConfirmation("Quest Update", message, false); if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; taskLine.dataset.deadlineChecked = 'true'; saveState(); checkLevelUp(); }
            function checkTaskDeadlines() { const now = Date.now(); let tasksUpdated = false; let totalPenalty = 0; tasks.forEach((task, index) => { if (!task.deadline || task.completed || task.deadlineChecked) return; if (now > task.deadline) { const penaltyPoints = Math.floor((task.points || 50) / 2); totalPenalty += penaltyPoints; tasks[index].deadlineChecked = true; tasksUpdated = true; const taskLines = tasksContainer?.querySelectorAll('.task-line'); if (taskLines && taskLines[index]) { taskLines[index].dataset.deadlineChecked = 'true'; const deadlineInfo = taskLines[index].querySelector('.deadline-info'); if (deadlineInfo) deadlineInfo.textContent += " (Missed)"; taskLines[index].style.backgroundColor = 'rgba(220, 53, 69, 0.1)'; } } }); if (totalPenalty > 0) { points = Math.max(0, points - totalPenalty); showConfirmation("Deadline Missed!", `Missed deadline(s)! -${totalPenalty} XP.`, false); if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; saveState(); } if (tasksUpdated) { saveTasks(); } }
            function showDeadlineDialog(taskElement) { const dialog = document.getElementById("deadlineDialog"); const dateInput = document.getElementById("deadlineDate"); const timeInput = document.getElementById("deadlineTime"); const difficultySelect = document.getElementById("taskDifficulty"); if (!dialog || !dateInput || !timeInput || !difficultySelect || !taskElement) return; currentTaskForDeadline = taskElement; const existingDeadline = taskElement.dataset.deadline ? parseInt(taskElement.dataset.deadline) : null; const existingPoints = taskElement.dataset.points ? parseInt(taskElement.dataset.points) : null; if (existingDeadline) { const d = new Date(existingDeadline); dateInput.value = d.toISOString().split('T')[0]; timeInput.value = d.toTimeString().substring(0, 5); } else { const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); dateInput.value = tomorrow.toISOString().split('T')[0]; const now = new Date(); timeInput.value = now.toTimeString().substring(0, 5); } difficultySelect.value = existingPoints || "100"; dialog.style.display = "flex"; }
            function handleDeadlineConfirmation(choice) { const dialog = document.getElementById("deadlineDialog"); if (!dialog || !currentTaskForDeadline) return; dialog.style.display = "none"; if (choice === "yes") { const dateValue = document.getElementById("deadlineDate").value; const timeValue = document.getElementById("deadlineTime").value; const selectedPoints = document.getElementById("taskDifficulty").value; if (!dateValue || !timeValue) { showConfirmation("Invalid", "Select date & time.", false); currentTaskForDeadline = null; return; } const deadlineTimestamp = new Date(`${dateValue}T${timeValue}`).getTime(); if (deadlineTimestamp <= Date.now()) { showConfirmation("Invalid", "Deadline must be future.", false); currentTaskForDeadline = null; return; } currentTaskForDeadline.dataset.deadline = deadlineTimestamp; currentTaskForDeadline.dataset.points = selectedPoints; currentTaskForDeadline.dataset.deadlineChecked = 'false'; updateTaskDeadlineDisplay(currentTaskForDeadline, deadlineTimestamp, selectedPoints); console.log(`Deadline set for "${currentTaskForDeadline.dataset.text}"`); } currentTaskForDeadline = null; }
            function updateTaskDeadlineDisplay(taskLine, deadlineTimestamp, pointsValue) { const existingDeadlineSpan = taskLine.querySelector(".deadline-info"); if (existingDeadlineSpan) existingDeadlineSpan.remove(); const existingPointsSpan = taskLine.querySelector(".points-info"); if (existingPointsSpan) existingPointsSpan.remove(); if (deadlineTimestamp && pointsValue) { const deadlineDate = new Date(deadlineTimestamp); const deadlineInfo = document.createElement("span"); deadlineInfo.className = "deadline-info"; const dateOptions = { month: 'short', day: 'numeric' }; const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true }; deadlineInfo.textContent = `Due: ${deadlineDate.toLocaleDateString(undefined, dateOptions)} ${deadlineDate.toLocaleTimeString(undefined, timeOptions)}`; deadlineInfo.title = deadlineDate.toLocaleString(); const pointsInfo = document.createElement("span"); pointsInfo.className = "points-info"; pointsInfo.textContent = `+${pointsValue} XP`; const buttonsContainer = taskLine.querySelector('.task-buttons'); if (buttonsContainer) { taskLine.insertBefore(pointsInfo, buttonsContainer); taskLine.insertBefore(deadlineInfo, pointsInfo); } else { taskLine.appendChild(deadlineInfo); taskLine.appendChild(pointsInfo); } } }
            function extractVideoId(url) { if (!url) return null; try { let match = url.match(/[?&]v=([^&]+)/); if (match) return match[1]; match = url.match(/youtu\.be\/([^?&]+)/); if (match) return match[1]; match = url.match(/\/live\/([^?&/]+)/); if (match) return match[1]; match = url.match(/\/embed\/([^?&]+)/); if (match) return match[1]; match = url.match(/\/shorts\/([^?&]+)/); if (match) return match[1]; console.warn("Could not extract ID:", url); return null; } catch (e) { console.error("URL parse error:", url, e); return null; } }
            function prepareAndStartPlayback() { try { if (!urlInputsContainer) { console.error("URL input missing"); return; } const urlElements = urlInputsContainer.querySelectorAll(".youtube-url"); const urls = Array.from(urlElements).map(input => input.value.trim()).filter(url => url); if (urls.length === 0) { showConfirmation("No URLs", "Enter YouTube URL(s).", false); return; } videoIds = urls.map(extractVideoId).filter(id => id); if (videoIds.length === 0) { showConfirmation("Invalid URLs", "No valid URLs found.", false); return; } currentVideoIndex = 0; completedVideos.clear(); allVideosCompleted = false; if(playerContainer) playerContainer.style.display = 'block'; if(youtubeInputContainer) youtubeInputContainer.style.display = 'none'; initializeYouTubeView(); saveState(); requestFullscreen(document.documentElement); } catch (err) { console.error("Playback prep error:", err); showConfirmation("Playback Error", "Error starting.", false); } }
            function loadYouTubeAPI() { return new Promise((resolve, reject) => { if (isYouTubeAPILoaded) { resolve(); return; } console.log("Loading YT API..."); const tag = document.createElement("script"); tag.src = "https://www.youtube.com/iframe_api"; tag.async = true; window.onYouTubeIframeAPIReady = () => { console.log("YT API Ready."); isYouTubeAPILoaded = true; if (typeof YT !== 'undefined' && YT.Player) { resolve(); } else { setTimeout(() => { if (typeof YT !== 'undefined' && YT.Player) { resolve(); } else { console.error("YT.Player unavailable."); reject(new Error("YT Player missing.")); } }, 500); } }; tag.onerror = (error) => { console.error("YT API load failed:", error); reject(new Error("YT API script load failed.")); }; document.head.appendChild(tag); setTimeout(() => { if (!isYouTubeAPILoaded) { console.error("YT API timeout."); reject(new Error("YT API load timeout.")); } }, 15000); }); }
            function initializeYouTubeView() { if (videoIds.length === 0) { console.warn("No video IDs"); showView('homePage'); return; } const controls = document.getElementById('youtubeLecturePageControls'); if(controls) controls.style.display = 'flex'; loadYouTubeAPI().then(() => { console.log("API loaded, setup player."); setupYouTubePlayer(); updateStreak(); startTimer(focusDuration, "Focus Time"); if(timerDisplay) timerDisplay.style.display = 'block'; setupVideoSidebar(); updateFocusStatus(); }).catch((err) => { console.error("YT View Init Error:", err); showConfirmation("Player Error", "Cannot load YT player.", false); showView('youtubeLecturePage'); isFocusModeActive = false; if(controls) controls.style.display = 'none'; }); }
            function setupYouTubePlayer() { if (!isYouTubeAPILoaded || typeof YT === 'undefined' || !YT.Player) { console.error("YT API not ready."); return; } if (!playerDiv) { console.error("Player div missing."); return; } if (videoIds.length === 0) { console.warn("No video IDs."); return; } if (player && typeof player.destroy === 'function') { console.log("Destroying prev player."); player.destroy(); player = null; } console.log("Creating YT.Player:", videoIds[currentVideoIndex]); try { player = new YT.Player("player", { height: "100%", width: "100%", videoId: videoIds[currentVideoIndex], playerVars: { autoplay: 1, controls: 1, modestbranding: 1, rel: 0, showinfo: 0, iv_load_policy: 3, fs: 1 }, events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange, onError: onPlayerError }, }); } catch (error) { console.error("YT.Player error:", error); showConfirmation("Player Fail", "Error creating player.", false); showView('youtubeLecturePage'); } }
            function onPlayerReady(event) { console.log("Player Ready:", videoIds[currentVideoIndex]); event.target.playVideo(); isFocusModeActive = true; highlightCurrentThumbnail(); }
            function onPlayerStateChange(event) { console.log("Player State:", event.data); if (event.data === YT.PlayerState.ENDED) { console.log("Video ended:", videoIds[currentVideoIndex]); completedVideos.add(videoIds[currentVideoIndex]); totalVideosWatched++; const earnedPoints = applyPowerUps(50); points += earnedPoints; if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; checkLevelUp(); saveState(); if (currentView === 'focusStats') displayFocusStatsInfo(); currentVideoIndex++; if (currentVideoIndex < videoIds.length) { console.log("Loading next:", videoIds[currentVideoIndex]); player.loadVideoById(videoIds[currentVideoIndex]); highlightCurrentThumbnail(); } else { console.log("Playlist complete."); allVideosCompleted = true; showConfirmation("Playlist Done!", "All videos watched.", false); player.stopVideo(); } } else if (event.data === YT.PlayerState.PLAYING) { console.log("Playing."); isFocusModeActive = true; highlightCurrentThumbnail(); } else if (event.data === YT.PlayerState.PAUSED) { console.log("Paused."); } }
            function onPlayerError(event) { console.error("YT Player Error:", event.data); let errorMsg = "Unknown YT error."; switch (event.data) { case 2: errorMsg = "Invalid parameter."; break; case 5: errorMsg = "HTML5 error."; break; case 100: errorMsg = "Not found."; break; case 101: case 150: errorMsg = "Embedding disallowed."; break; } showConfirmation("Video Error", `${errorMsg} Skipping. (Code: ${event.data})`, false); setTimeout(() => { currentVideoIndex++; if (currentVideoIndex < videoIds.length) { console.log("Attempt next:", videoIds[currentVideoIndex]); player.loadVideoById(videoIds[currentVideoIndex]); } else { console.log("All videos attempted."); allVideosCompleted = true; endFocusSession("Error playing videos."); } }, 2000); }
            function setupVideoSidebar() { if (!videoThumbnailList || !videoSidebar) return; videoThumbnailList.innerHTML = ''; const showSidebar = videoIds.length > 1; videoSidebar.style.display = showSidebar ? 'block' : 'none'; if(videoSidebarToggleBtn) videoSidebarToggleBtn.style.display = showSidebar ? 'block' : 'none'; if (!showSidebar) { closeVideoSidebar(); return; } videoIds.forEach((id, index) => { const thumbnail = document.createElement("img"); thumbnail.src = `https://img.youtube.com/vi/${id}/mqdefault.jpg`; thumbnail.alt = `Video ${index + 1}`; thumbnail.className = "thumbnail"; thumbnail.dataset.index = index; thumbnail.title = `Play Video ${index + 1}`; thumbnail.onclick = () => { if (index !== currentVideoIndex) { currentVideoIndex = index; player.loadVideoById(videoIds[currentVideoIndex]); highlightCurrentThumbnail(); closeVideoSidebar(); } }; thumbnail.onerror = () => { thumbnail.alt = `Thumb unavailable`; thumbnail.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; thumbnail.style.cssText = 'border: 1px dashed var(--text-dim); height: 70px; object-fit: cover;'; }; videoThumbnailList.appendChild(thumbnail); }); highlightCurrentThumbnail(); }
            function toggleVideoSidebar() { if (!videoSidebar) return; isVideoSidebarOpen = !isVideoSidebarOpen; videoSidebar.classList.toggle('open', isVideoSidebarOpen); if(videoSidebarToggleBtn) videoSidebarToggleBtn.innerHTML = isVideoSidebarOpen ? '<i class="fas fa-times"></i>' : '<i class="fas fa-list"></i>'; }
            function closeVideoSidebar() { if (!videoSidebar || !isVideoSidebarOpen) return; isVideoSidebarOpen = false; videoSidebar.classList.remove('open'); if(videoSidebarToggleBtn) videoSidebarToggleBtn.innerHTML = '<i class="fas fa-list"></i>'; }
            function highlightCurrentThumbnail() { if (!videoThumbnailList) return; const thumbnails = videoThumbnailList.querySelectorAll('.thumbnail'); thumbnails.forEach((thumb, index) => { thumb.classList.toggle('active', index === currentVideoIndex); }); }
            function startTimer(duration, mode) { if (!timerDisplay || !progressFill || !progressBar) { console.error("Timer elements missing!"); return; } clearInterval(countdownInterval); isFocusModeActive = true; timerMode = mode; let timeRemainingSeconds = Math.max(0, Math.floor(duration / 1000)); timerRemaining = timeRemainingSeconds; const totalDurationSeconds = Math.floor(duration / 1000); progressBar.style.display = "block"; progressFill.style.width = '0%'; timerDisplay.style.display = 'block'; console.log(`Timer: ${mode} for ${totalDurationSeconds}s`); countdownInterval = setInterval(() => { const minutes = Math.floor(timeRemainingSeconds / 60); const seconds = Math.floor(timeRemainingSeconds % 60); if(timerText) timerText.textContent = `${mode}: ${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`; const progress = totalDurationSeconds > 0 ? ((totalDurationSeconds - timeRemainingSeconds) / totalDurationSeconds) * 100 : 0; progressFill.style.width = `${Math.min(100, progress)}%`; if (mode === "Focus Time") { totalFocusTime++; } timerRemaining = timeRemainingSeconds; timeRemainingSeconds--; if (timeRemainingSeconds < 0) { clearInterval(countdownInterval); progressFill.style.width = '100%'; progressBar.style.display = "none"; if (mode === "Focus Time") { console.log("Focus finished."); const earnedPoints = applyPowerUps(100); points += earnedPoints; if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; checkLevelUp(); playSound("achievementAudio"); showSessionCompleteDialog(); } else if (mode === "Break Time") { console.log("Long break done."); startTimer(secondBreakDuration, "Short Break"); } else { console.log("Short break done."); startTimer(focusDuration, "Focus Time"); } saveState(); } }, 1000); }
            function endFocusSession(reason = "Session ended.") { console.log("Ending focus:", reason); clearInterval(countdownInterval); isFocusModeActive = false; timerRemaining = focusDuration / 1000; timerMode = "Focus Time"; if (player && typeof player.destroy === 'function') { player.destroy(); player = null; console.log("Player destroyed."); } videoIds = []; currentVideoIndex = 0; completedVideos.clear(); allVideosCompleted = false; if(timerDisplay) timerDisplay.style.display = 'none'; if(progressBar) progressBar.style.display = 'none'; if(progressFill) progressFill.style.width = '0%'; closeVideoSidebar(); if(videoSidebarToggleBtn) videoSidebarToggleBtn.style.display = 'none'; const controls = document.getElementById('youtubeLecturePageControls'); if(controls) controls.style.display = 'none'; if(playerContainer) playerContainer.style.display = 'none'; if(youtubeInputContainer) youtubeInputContainer.style.display = 'block'; exitFullscreen(); saveState(); if (currentView === 'focusStats') displayFocusStatsInfo(); updateFocusStatus(); showView('homePage'); }
            function showSessionCompleteDialog() { const dialog = document.getElementById("sessionCompleteDialog"); if (dialog) dialog.style.display = "flex"; }
            function handleSessionContinue(choice) { const dialog = document.getElementById("sessionCompleteDialog"); if (dialog) dialog.style.display = "none"; if (choice === "continue") { const bonusPoints = applyPowerUps(100); points += bonusPoints; if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; showConfirmation("Bonus!", `+${bonusPoints} XP!`, false); playSound('achievementAudio'); checkLevelUp(); saveState(); startTimer(focusDuration, "Focus Time"); } else { endFocusSession("User ended."); } }
            function requestExitSession() { showConfirmation( "Exit?", "End session?", true, () => { endFocusSession("User exited."); }, () => {} ); }
            function toggleAIPopup() { if (!aiPopup) return; const isVisible = aiPopup.style.display === "block"; aiPopup.style.display = isVisible ? "none" : "block"; }
            function toggleSidebar() { if (!gameSidebar || !sidebarTrigger) return; isSidebarOpen = !isSidebarOpen; gameSidebar.classList.toggle('open', isSidebarOpen); sidebarTrigger.style.left = isSidebarOpen ? '280px' : '0px'; }
            function closeSidebar() { if (!gameSidebar || !sidebarTrigger || !isSidebarOpen) return; isSidebarOpen = false; gameSidebar.classList.remove('open'); sidebarTrigger.style.left = '0px'; }
            function showSignInForm() { showView('signinForm'); if(usernameInput) usernameInput.value = ''; if(passwordInput) passwordInput.value = ''; }
            function signIn() { if(!usernameInput || !passwordInput) return; const username = usernameInput.value.trim(); const password = passwordInput.value; if (!username || !password) { showConfirmation("Missing", "Enter Name & Code.", false); return; } try { const users = JSON.parse(localStorage.getItem("users") || "{}"); if (users[username] && users[username].password === password) { isSignedIn = true; currentUser = username; points = users[username].points || 0; previousPoints = points; totalFocusTime = users[username].totalFocusTime || 0; totalDistractions = users[username].totalDistractions || 0; totalVideosWatched = users[username].totalVideosWatched || 0; tasks = users[username].tasks || []; streakDays = users[username].streakDays || 0; lastFocusDate = users[username].lastFocusDate || null; mysteryBoxCount = users[username].mysteryBoxCount || 0; activePowerUps = users[username].activePowerUps || { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, }; if (!activePowerUps.doublePoints) activePowerUps.doublePoints = { active: false, expiry: null }; if (!activePowerUps.streakShield) activePowerUps.streakShield = { active: false, used: false, expiry: null }; playlists = users[username].playlists || []; const savedTracks = users[username].premiumLofiTracks || []; premiumLofiTracks.forEach(track => { const saved = savedTracks.find(st => st.id === track.id); track.unlocked = saved ? saved.unlocked : false; }); updateAvailableLofiTracks(); if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; updateAchievementLevel(); updateStreakDisplay(); showView('homePage'); restoreTasks(); checkExpiredPowerups(); console.log(`Signed in: ${currentUser}.`); } else { showConfirmation("Login Failed", "Invalid credentials.", false); isSignedIn = false; currentUser = null; } } catch (err) { console.error("Sign-in error:", err); showConfirmation("Sign-in Error", "Error during sign-in.", false); } }
            function createAccount() { if(!usernameInput || !passwordInput) return; const username = usernameInput.value.trim(); const password = passwordInput.value; if (!username || !password) { showConfirmation("Missing", "Enter Name & Code.", false); return; } if (password.length < 4) { showConfirmation("Weak Code", "Code needs 4+ chars.", false); return; } try { const users = JSON.parse(localStorage.getItem("users") || "{}"); if (users[username]) { showConfirmation("Taken", "Name registered.", false); } else { users[username] = { password: password, points: 0, totalFocusTime: 0, totalDistractions: 0, totalVideosWatched: 0, tasks: [], streakDays: 0, lastFocusDate: null, mysteryBoxCount: 0, activePowerUps: { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, }, playlists: [], premiumLofiTracks: premiumLofiTracks.map(track => ({ id: track.id, unlocked: false })) }; localStorage.setItem("users", JSON.stringify(users)); isSignedIn = true; currentUser = username; points = 0; previousPoints = 0; totalFocusTime = 0; totalDistractions = 0; totalVideosWatched = 0; tasks = []; streakDays = 0; lastFocusDate = null; mysteryBoxCount = 0; activePowerUps = { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, }; playlists = []; premiumLofiTracks.forEach(t => t.unlocked = false); updateAvailableLofiTracks(); if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; updateAchievementLevel(); updateStreakDisplay(); showView('homePage'); restoreTasks(); console.log(`Created: ${currentUser}.`); showConfirmation("Success!", `Welcome, ${currentUser}!`, false); } } catch (err) { console.error("Creation error:", err); showConfirmation("Creation Error", "Error creating.", false); } }
            function logout() { showConfirmation( "Logout?", "Log out?", true, () => { console.log(`Logging out ${currentUser}`); isSignedIn = false; currentUser = null; points = 0; previousPoints = 0; totalFocusTime = 0; totalDistractions = 0; totalVideosWatched = 0; tasks = []; streakDays = 0; lastFocusDate = null; mysteryBoxCount = 0; activePowerUps = { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, }; playlists = []; premiumLofiTracks.forEach(t => t.unlocked = false); updateAvailableLofiTracks(); if(isFocusModeActive) { clearInterval(countdownInterval); isFocusModeActive = false; if (player && typeof player.destroy === 'function') { player.destroy(); player = null; } videoIds = []; currentVideoIndex = 0; completedVideos.clear(); allVideosCompleted = false; } if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: 0`; updateAchievementLevel(); updateStreakDisplay(); populatePlaylistSelect(); restoreTasks(); if(timerDisplay) timerDisplay.style.display = 'none'; showView('landingPage'); }, () => {} ); }
            function addUrlInput() { if (!urlInputsContainer) return; const container = document.createElement("div"); container.className = "url-container"; const newInput = document.createElement("input"); newInput.type = "text"; newInput.className = "youtube-url"; newInput.placeholder = "Another YouTube URL"; const removeBtn = document.createElement("button"); removeBtn.innerHTML = '<i class="fas fa-times"></i>'; removeBtn.title = "Remove URL"; removeBtn.onclick = () => { if (urlInputsContainer.querySelectorAll(".url-container").length > 1) { urlInputsContainer.removeChild(container); } else { newInput.value = ''; } }; container.appendChild(newInput); container.appendChild(removeBtn); urlInputsContainer.appendChild(container); newInput.focus(); }
            function restoreUrlInputs(ids = []) { if (!urlInputsContainer) return; urlInputsContainer.innerHTML = ''; if (ids.length === 0) { addUrlInput(); const firstRemoveBtn = urlInputsContainer.querySelector('.url-container button'); if(firstRemoveBtn) firstRemoveBtn.remove(); } else { ids.forEach((id, index) => { const container = document.createElement("div"); container.className = "url-container"; const input = document.createElement("input"); input.type = "text"; input.className = "youtube-url"; input.placeholder = "YouTube URL"; input.value = id ? `https://www.youtube.com/watch?v=${id}` : ''; container.appendChild(input); if (index > 0 || ids.length > 1) { const removeBtn = document.createElement("button"); removeBtn.innerHTML = '<i class="fas fa-times"></i>'; removeBtn.title = "Remove URL"; removeBtn.onclick = () => { if (urlInputsContainer.querySelectorAll(".url-container").length > 1) { urlInputsContainer.removeChild(container); } else { input.value = ''; } }; container.appendChild(removeBtn); } urlInputsContainer.appendChild(container); }); if (ids.length === 1) { const singleRemoveBtn = urlInputsContainer.querySelector('.url-container button'); if(singleRemoveBtn) singleRemoveBtn.remove(); } } }
            function savePlaylist() { if (!playlistNameInput || !urlInputsContainer) return; const name = playlistNameInput.value.trim(); if (!name) { showConfirmation("Missing", "Enter name.", false); return; } const urlElements = urlInputsContainer.querySelectorAll(".youtube-url"); const currentVideoIds = Array.from(urlElements).map(input => extractVideoId(input.value)).filter(id => id); if (currentVideoIds.length === 0) { showConfirmation("No Videos", "Add URLs.", false); return; } const existingIndex = playlists.findIndex(p => p.name === name); if (existingIndex !== -1) { showConfirmation( "Overwrite?", `Overwrite "${name}"?`, true, () => { playlists[existingIndex] = { name: name, videoIds: currentVideoIds }; savePlaylistsToUserData(); populatePlaylistSelect(); playlistNameInput.value = ""; showConfirmation("Saved", `"${name}" updated.`, false); }, () => {} ); } else { playlists.push({ name: name, videoIds: currentVideoIds }); savePlaylistsToUserData(); populatePlaylistSelect(); playlistNameInput.value = ""; showConfirmation("Saved", `"${name}" saved.`, false); } }
            function removePlaylist() { if (!playlistSelect) return; const selectedName = playlistSelect.value; if (!selectedName) { showConfirmation("No Select", "Select playlist.", false); return; } showConfirmation( "Delete?", `Delete "${selectedName}"?`, true, () => { playlists = playlists.filter(p => p.name !== selectedName); savePlaylistsToUserData(); populatePlaylistSelect(); playlistSelect.value = ""; restoreUrlInputs(); showConfirmation("Deleted", `"${selectedName}" removed.`, false); }, () => {} ); }
            function savePlaylistsToUserData() { if (isSignedIn && currentUser) { try { const users = JSON.parse(localStorage.getItem("users") || "{}"); if(users[currentUser]) { users[currentUser].playlists = playlists; localStorage.setItem("users", JSON.stringify(users)); console.log("Playlists saved:", currentUser); } } catch (err) { console.error("Err saving playlists:", err); } } }
            function populatePlaylistSelect() { if (!playlistSelect) return; const currentSelection = playlistSelect.value; playlistSelect.innerHTML = '<option value="">Load Playlist</option>'; playlists.sort((a, b) => a.name.localeCompare(b.name)); playlists.forEach(playlist => { const option = document.createElement("option"); option.value = playlist.name; option.textContent = playlist.name; playlistSelect.appendChild(option); }); playlistSelect.value = currentSelection; if (!playlistSelect.onchange) { playlistSelect.onchange = handlePlaylistSelection; } }
            function handlePlaylistSelection() { if (!playlistSelect) return; const selectedName = playlistSelect.value; if (selectedName) { const selectedPlaylist = playlists.find(p => p.name === selectedName); if (selectedPlaylist) { console.log("Loading playlist:", selectedName); restoreUrlInputs(selectedPlaylist.videoIds); if(playlistNameInput) playlistNameInput.value = selectedName; } } else { restoreUrlInputs(); if(playlistNameInput) playlistNameInput.value = ""; } }

            function saveState() {
                 if (!isSignedIn || !currentUser) return;
                 const stateToSave = {
                      videoIds: isFocusModeActive ? videoIds : [], currentVideoIndex: isFocusModeActive ? currentVideoIndex : 0, timerMode: isFocusModeActive ? timerMode : "Focus Time", timerRemaining: isFocusModeActive ? timerRemaining : focusDuration / 1000, isFocusModeActive: isFocusModeActive, completedVideos: isFocusModeActive ? Array.from(completedVideos) : [], allVideosCompleted: isFocusModeActive ? allVideosCompleted : false,
                      points: points, totalFocusTime: totalFocusTime, totalDistractions: totalDistractions, totalVideosWatched: totalVideosWatched, streakDays: streakDays, lastFocusDate: lastFocusDate, mysteryBoxCount: mysteryBoxCount, activePowerUps: activePowerUps, premiumLofiTrackState: premiumLofiTracks.map(t => ({ id: t.id, unlocked: t.unlocked })),
                      currentView: currentView, isSignedIn: isSignedIn, currentUser: currentUser
                 };
                 try {
                      localStorage.setItem("focusModeState_v3", JSON.stringify(stateToSave));
                      const users = JSON.parse(localStorage.getItem("users") || "{}");
                      if (users[currentUser]) {
                           users[currentUser].points = points; users[currentUser].totalFocusTime = totalFocusTime; users[currentUser].totalDistractions = totalDistractions; users[currentUser].totalVideosWatched = totalVideosWatched; users[currentUser].streakDays = streakDays; users[currentUser].lastFocusDate = lastFocusDate; users[currentUser].mysteryBoxCount = mysteryBoxCount; users[currentUser].activePowerUps = activePowerUps; users[currentUser].premiumLofiTracks = premiumLofiTracks.map(t => ({ id: t.id, unlocked: t.unlocked }));
                           localStorage.setItem("users", JSON.stringify(users));
                      }
                 } catch (err) { console.error("Error saving state:", err); }
            }

            function loadSavedState() {
                console.log("Loading state...");
                let loadedState = null;
                try {
                    loadedState = JSON.parse(localStorage.getItem("focusModeState_v3") || "{}");
                } catch(e) { console.error("Error parsing state:", e); localStorage.removeItem("focusModeState_v3"); loadedState = {}; }

                if (loadedState.isSignedIn && loadedState.currentUser) {
                     console.log("Attempting restore for:", loadedState.currentUser);
                     const users = JSON.parse(localStorage.getItem("users") || "{}");
                     if (users[loadedState.currentUser]) {
                         const userData = users[loadedState.currentUser];
                         isSignedIn = true; currentUser = loadedState.currentUser; points = userData.points || 0; previousPoints = points; totalFocusTime = userData.totalFocusTime || 0; totalDistractions = userData.totalDistractions || 0; totalVideosWatched = userData.totalVideosWatched || 0; tasks = userData.tasks || []; streakDays = userData.streakDays || 0; lastFocusDate = userData.lastFocusDate || null; mysteryBoxCount = userData.mysteryBoxCount || 0; activePowerUps = userData.activePowerUps || { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, }; if (!activePowerUps.doublePoints) activePowerUps.doublePoints = { active: false, expiry: null }; if (!activePowerUps.streakShield) activePowerUps.streakShield = { active: false, used: false, expiry: null }; playlists = userData.playlists || []; const savedTracks = userData.premiumLofiTracks || []; premiumLofiTracks.forEach(track => { const saved = savedTracks.find(st => st.id === track.id); track.unlocked = saved ? saved.unlocked : false; }); updateAvailableLofiTracks();
                         if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`; updateAchievementLevel(); updateStreakDisplay(); restoreTasks(); checkExpiredPowerups();

                         if (loadedState.isFocusModeActive && loadedState.videoIds && loadedState.videoIds.length > 0 && loadedState.currentView === 'youtubeLecturePage') {
                             console.log("Restoring active focus session...");
                             isFocusModeActive = true; videoIds = loadedState.videoIds; currentVideoIndex = loadedState.currentVideoIndex || 0; timerMode = loadedState.timerMode || "Focus Time"; timerRemaining = loadedState.timerRemaining || (focusDuration / 1000); completedVideos = new Set(loadedState.completedVideos || []); allVideosCompleted = loadedState.allVideosCompleted || false;
                             loadYouTubeAPI().then(() => { showView('youtubeLecturePage'); setTimeout(() => { console.log("Re-init player."); setupYouTubePlayer(); startTimer(timerRemaining * 1000, timerMode); }, 100); }).catch(err => { console.error("YT API load fail on restore:", err); isFocusModeActive = false; showView('homePage'); });
                         } else { isFocusModeActive = false; showView(loadedState.currentView || 'homePage'); }
                         console.log("Session restored for", currentUser);
                         return;
                     } else { console.warn("User data mismatch:", loadedState.currentUser); localStorage.removeItem("focusModeState_v3"); }
                }
                console.log("No active session found. Showing landing.");
                showView('landingPage'); updateClock(); initAudio(); updateAchievementLevel(); updateStreakDisplay();
            }


            function checkExpiredPowerups() { let stateChanged = false; const now = Date.now(); if (activePowerUps.doublePoints.active && activePowerUps.doublePoints.expiry && now > activePowerUps.doublePoints.expiry) { console.log("Double XP expired."); activePowerUps.doublePoints.active = false; activePowerUps.doublePoints.expiry = null; stateChanged = true; } if (activePowerUps.streakShield.active && activePowerUps.streakShield.expiry && now > activePowerUps.streakShield.expiry) { console.log("Shield expired."); activePowerUps.streakShield.active = false; activePowerUps.streakShield.expiry = null; activePowerUps.streakShield.used = false; stateChanged = true; } if (stateChanged) { saveState(); } }
            function requestFullscreen(element) { try { if (element.requestFullscreen) element.requestFullscreen(); else if (element.mozRequestFullScreen) element.mozRequestFullScreen(); else if (element.webkitRequestFullscreen) element.webkitRequestFullscreen(); else if (element.msRequestFullscreen) element.msRequestFullscreen(); } catch(e){ console.warn("Fullscreen fail:", e.message)} }
            function exitFullscreen() { try { if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) { if (document.exitFullscreen) document.exitFullscreen(); else if (document.mozCancelFullScreen) document.mozCancelFullScreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); else if (document.msExitFullscreen) document.msExitFullscreen(); } } catch(e){ console.warn("Exit fullscreen fail:", e.message)} }
            function showConfirmation(title, message, isCancellable = false, onConfirm = () => {}, onCancel = () => {}) { const dialog = document.getElementById("confirmationDialog"); const titleEl = dialog?.querySelector("h3"); const messageEl = dialog?.querySelector("p"); const confirmBtn = document.getElementById("confirmBtn"); const cancelBtn = document.getElementById("cancelBtn"); if (!dialog || !titleEl || !messageEl || !confirmBtn || !cancelBtn) { console.error("Confirm dialog missing."); return; } titleEl.innerHTML = `<i class="fas ${isCancellable ? 'fa-question-circle' : 'fa-info-circle'}"></i> ${title}`; messageEl.textContent = message; cancelBtn.style.display = isCancellable ? "inline-block" : "none"; const newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn); const newCancelBtn = cancelBtn.cloneNode(true); cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn); newConfirmBtn.textContent = isCancellable ? "YES" : "OK"; newConfirmBtn.onclick = () => { dialog.style.display = 'none'; onConfirm(); }; if (isCancellable) { newCancelBtn.onclick = () => { dialog.style.display = 'none'; onCancel(); }; } dialog.style.display = "flex"; }

            // --- Event Listener Setup ---
            function setupEventListeners() {
                console.log("Setting up listeners...");
                document.querySelectorAll('button[data-action="show-view"]').forEach(button => { button.addEventListener('click', () => { const viewId = button.dataset.view; if (viewId) { showView(viewId); } else { console.warn("Btn missing data-view:", button); } }); });
                if(sidebarTrigger) sidebarTrigger.addEventListener('click', toggleSidebar);
                document.addEventListener('click', (event) => { if (gameSidebar && !gameSidebar.contains(event.target) && sidebarTrigger && !sidebarTrigger.contains(event.target) && isSidebarOpen) { closeSidebar(); } });
                document.querySelector('button[data-action="sign-in"]')?.addEventListener('click', signIn);
                document.querySelector('button[data-action="create-account"]')?.addEventListener('click', createAccount);
                document.getElementById('logoutBtn')?.addEventListener('click', logout);
                document.querySelector('button[data-action="github"]')?.addEventListener('click', () => window.open("https://github.com/The-Chosen-One-o5/UltraFocusModeYT", "_blank"));
                document.querySelector('#youtubeLecturePage button[data-action="add-url"]')?.addEventListener('click', addUrlInput);
                document.querySelector('#youtubeLecturePage button[data-action="save-playlist"]')?.addEventListener('click', savePlaylist);
                document.querySelector('#youtubeLecturePage button[data-action="remove-playlist"]')?.addEventListener('click', removePlaylist);
                document.querySelector('#youtubeLecturePage button[data-action="start-playback"]')?.addEventListener('click', prepareAndStartPlayback);
                document.getElementById('restartBtn')?.addEventListener('click', requestExitSession);
                if(videoSidebarToggleBtn) videoSidebarToggleBtn.addEventListener('click', toggleVideoSidebar);
                document.addEventListener('keydown', (e) => { if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return; if (currentView === 'youtubeLecturePage' && (e.key === 't' || e.key === 'T')) { toggleVideoSidebar(); } });
                document.querySelector('button[data-action="toggle-todo"]')?.addEventListener('click', toggleTodo);
                document.querySelector('#todoList button[data-action="save-tasks"]')?.addEventListener('click', saveTasks);
                document.querySelector('#todoList button[data-action="close-todo"]')?.addEventListener('click', toggleTodo);
                document.querySelector('#todoList button[data-action="add-task-line"]')?.addEventListener('click', () => { const newInp = addTaskLine(); if(newInp) newInp.focus(); });
                document.getElementById('streakShieldBtn')?.addEventListener('click', showStreakShieldDialog);
                document.getElementById('doublePointsBtn')?.addEventListener('click', showDoublePointsDialog);
                document.getElementById('audioStoreBtn')?.addEventListener('click', showAudioTracksStore);
                document.getElementById('quietPomodoroBtn')?.addEventListener('click', showPomodoroOverlay);
                document.getElementById('streakShieldConfirmBtn')?.addEventListener('click', () => handleStreakShieldConfirmation('yes')); document.getElementById('streakShieldCancelBtn')?.addEventListener('click', () => handleStreakShieldConfirmation('no'));
                document.getElementById('doublePointsConfirmBtn')?.addEventListener('click', () => handleDoublePointsConfirmation('yes')); document.getElementById('doublePointsCancelBtn')?.addEventListener('click', () => handleDoublePointsConfirmation('no'));
                document.getElementById('deadlineConfirmBtn')?.addEventListener('click', () => handleDeadlineConfirmation('yes')); document.getElementById('deadlineCancelBtn')?.addEventListener('click', () => handleDeadlineConfirmation('no'));
                document.getElementById('sessionContinueBtn')?.addEventListener('click', () => handleSessionContinue('continue')); document.getElementById('sessionEndBtn')?.addEventListener('click', () => handleSessionContinue('end'));
                document.getElementById('openMysteryBox')?.addEventListener('click', openMysteryBox); document.getElementById('closeMysteryBoxBtn')?.addEventListener('click', closeMysteryBoxPopup);
                document.getElementById('closeAudioStore')?.addEventListener('click', closeAudioTracksStore);
                document.getElementById('pomodoroStartBtn')?.addEventListener('click', startPomodoro); document.getElementById('pomodoroResetBtn')?.addEventListener('click', resetPomodoro); document.getElementById('pomodoroCloseBtn')?.addEventListener('click', closePomodoroOverlay);
                document.getElementById('lofiPlay')?.addEventListener('click', playLofi); document.getElementById('lofiPause')?.addEventListener('click', pauseLofi); document.getElementById('lofiPrev')?.addEventListener('click', prevLofi); document.getElementById('lofiNext')?.addEventListener('click', nextLofi);
                if(fireBox) fireBox.addEventListener('click', toggleAIPopup);
                if (timerDisplay) { let isDragging = false; let initialX, initialY; timerDisplay.addEventListener("mousedown", (e) => { if (e.target.tagName === 'BUTTON') return; isDragging = true; initialX = e.clientX - timerDisplay.offsetLeft; initialY = e.clientY - timerDisplay.offsetTop; timerDisplay.style.cursor = 'grabbing'; e.preventDefault(); }); document.addEventListener("mousemove", (e) => { if (isDragging) { e.preventDefault(); let currentX = e.clientX - initialX; let currentY = e.clientY - initialY; const maxX = window.innerWidth - timerDisplay.offsetWidth - 10; const maxY = window.innerHeight - timerDisplay.offsetHeight - 10; currentX = Math.max(10, Math.min(currentX, maxX)); currentY = Math.max(65, Math.min(currentY, maxY)); timerDisplay.style.left = `${currentX}px`; timerDisplay.style.top = `${currentY}px`; } }); document.addEventListener("mouseup", () => { if (isDragging) { isDragging = false; timerDisplay.style.cursor = 'move'; } }); }

                 // Visibility Change Listener for Distraction Audio
                 document.addEventListener("visibilitychange", () => {
                     if (isFocusModeActive && currentView === 'youtubeLecturePage') {
                         if (document.hidden) {
                             pauseLofi();
                             if (focusAudioElement && focusAudioElement.readyState >= 2) { // Check canplay or higher
                                 focusAudioElement.play().catch(e => console.warn("Focus audio play fail:", e.message));
                             } else if (focusAudioElement) { focusAudioElement.load(); }
                             totalDistractions++;
                             console.log("Tab hidden. Distractions:", totalDistractions);
                             // Update stats display immediately if visible (unlikely but possible)
                             if(currentView === 'focusStats') displayFocusStatsInfo();
                             saveState();
                         } else {
                             if (focusAudioElement && !focusAudioElement.paused) {
                                 focusAudioElement.pause();
                                 focusAudioElement.currentTime = 0;
                             }
                             playLofi();
                             console.log("Tab visible.");
                         }
                     } else {
                         if (focusAudioElement && !focusAudioElement.paused) {
                             focusAudioElement.pause();
                             focusAudioElement.currentTime = 0;
                         }
                     }
                 });
                 window.addEventListener('beforeunload', () => { if (isSignedIn && currentUser) { saveState(); console.log("State saved before unload."); } });
                console.log("Event listeners ready.");
            }

                        // --- Initialization ---
            document.addEventListener("DOMContentLoaded", () => {
                console.log("DOM Loaded.");
                 // Cache DOM elements first
                 topNavBar = document.getElementById('topNavBar'); landingPage = document.getElementById('landingPage'); signinForm = document.getElementById('signinForm'); homePage = document.getElementById('homePage'); youtubeLecturePage = document.getElementById('youtubeLecturePage'); profilePage = document.getElementById('profile'); focusStatsPage = document.getElementById('focusStats'); // Use correct IDs
                 playerContainer = document.getElementById('playerContainer'); playerDiv = document.getElementById('player'); timerDisplay = document.getElementById('timerDisplay'); timerText = document.getElementById('timerText'); progressBar = document.getElementById('progressBar'); progressFill = document.getElementById('progressFill'); pointsDisplay = document.getElementById('pointsDisplay'); achievementLevelDiv = document.getElementById('achievementLevel'); lofiPlayer = document.getElementById('lofiPlayer'); aiPopup = document.getElementById('aiPopup'); fireBox = document.getElementById('fireBox'); videoSidebar = document.getElementById('videoSidebar'); videoThumbnailList = document.getElementById('videoThumbnailList'); usernameInput = document.getElementById('username'); passwordInput = document.getElementById('password'); homeUsernameSpan = document.getElementById('homeUsername'); dateTimeDisplaySpan = document.getElementById('dateTimeDisplay'); focusStatusSpan = document.getElementById('focusStatus'); youtubeInputContainer = document.getElementById('youtubeInputContainer'); playlistSelect = document.getElementById('playlistSelect'); urlInputsContainer = document.getElementById('urlInputs'); playlistNameInput = document.getElementById('playlistName'); todoListPopup = document.getElementById('todoList'); tasksContainer = document.getElementById('tasks'); confirmationDialog = document.getElementById('confirmationDialog'); streakShieldDialog = document.getElementById('streakShieldDialog'); doublePointsDialog = document.getElementById('doublePointsDialog'); deadlineDialog = document.getElementById('deadlineDialog'); sessionCompleteDialog = document.getElementById('sessionCompleteDialog'); mysteryBoxPopup = document.getElementById('mysteryBoxPopup'); audioTracksStore = document.getElementById('audioTracksStore'); pomodoroOverlay = document.getElementById('pomodoroOverlay'); gameSidebar = document.querySelector('.game-sidebar'); sidebarTrigger = document.querySelector('.sidebar-trigger'); navClockTime = document.getElementById('navClockTime'); navClockPeriod = document.getElementById('navClockPeriod'); navStreakDisplay = document.getElementById('navStreakDisplay'); videoSidebarToggleBtn = document.getElementById('videoSidebarToggleBtn'); navProfileBtn = document.getElementById('navProfileBtn');
                 focusAudioElement = document.getElementById('focusAudio');
                 lofiAudio = document.getElementById("lofiAudio"); // Assign lofiAudio element reference here

                // Initialize Audio *before* loading state or setting listeners
                initAudio();

                // Load State *after* basic elements/audio are referenced
                loadSavedState(); // Tries to restore session

                // Setup Listeners *after* state potentially shows UI
                setupEventListeners();

                // Start intervals etc.
                setInterval(updateClock, 1000);
                setInterval(checkTaskDeadlines, 60000);
                displayRandomMotivation();
                if(todoListPopup) todoListPopup.style.display = 'none'; // Ensure hidden initially

                console.log("Initialization complete.");
            });

        })();
    </script>
</body>
</html>
