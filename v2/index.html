<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Focus Mode YouTube Player</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4169e1;
      --primary-dark: #1e3a8a;
      --secondary: #8e2de2;
      --accent: #ff4500;
      --accent-alt: #ff8c00;
      --bg-dark: #0f0f1b;
      --bg-medium: #1a1a2e;
      --bg-light: #252538;
      --text: #e0e0ff;
      --text-dim: #9090b0;
      --calendar-blue-1: #0a1a3f;
      --calendar-blue-2: #1e3a8a;
      --calendar-blue-3: #3b5dc9;
      --calendar-blue-4: #4169e1;
      --calendar-blue-5: #6384e8;
    }

    body {
      background-color: var(--bg-dark);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: monospace;
      color: var(--text);
      overflow: hidden;
      font-size: 18px;
      line-height: 1.4;
    }

    .game-container {
      width: 100%;
      height: 100vh;
      position: relative;
      overflow: hidden;
      background-image: radial-gradient(circle at 10% 20%, rgba(142, 45, 226, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 20%),
        linear-gradient(to bottom, var(--bg-dark), var(--bg-medium));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1;
    }

    .game-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1h1z'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 2;
    }

    /* Top Navigation Bar */
    .top-navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: var(--bg-medium);
      border-bottom: 2px solid var(--secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .navbar-logo {
      display: flex;
      align-items: center;
      font-size: 22px;
      font-weight: bold;
      color: var(--text);
    }

    .navbar-logo span {
      color: var(--secondary);
      margin-left: 5px;
    }

    .navbar-clock {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
      text-shadow: 2px 2px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    .navbar-actions {
      display: flex;
      gap: 15px;
    }

    .navbar-btn {
      background: var(--bg-light);
      border: 1px solid var(--primary);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: monospace;
      font-size: 14px;
    }

    .navbar-btn:hover {
      background: var(--primary);
      transform: translateY(-2px);
    }

    .streak-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      position: relative;
    }

    .streak-btn .fire-icon {
      color: #ff6b00;
      font-size: 18px;
    }

    .streak-tooltip {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-dark);
      border: 1px solid var(--secondary);
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 1001;
    }

    .streak-btn:hover .streak-tooltip {
      opacity: 1;
      visibility: visible;
      top: calc(100% + 5px);
    }

    /* Logout Button */
    .Btn {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition-duration: .3s;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
      background-color: rgb(255, 65, 65);
    }

    /* plus sign */
    .sign {
      width: 100%;
      transition-duration: .3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sign svg {
      width: 17px;
    }

    .sign svg path {
      fill: white;
    }
    /* text */
    .text {
      position: absolute;
      right: 0%;
      width: 0%;
      opacity: 0;
      color: white;
      font-size: 1.2em;
      font-weight: 600;
      transition-duration: .3s;
    }
    /* hover effect on button width */
    .Btn:hover {
      width: 125px;
      border-radius: 40px;
      transition-duration: .3s;
    }

    .Btn:hover .sign {
      width: 30%;
      transition-duration: .3s;
      padding-left: 20px;
    }
    /* hover effect button's text */
    .Btn:hover .text {
      opacity: 1;
      width: 70%;
      transition-duration: .3s;
      padding-right: 10px;
    }
    /* button click effect*/
    .Btn:active {
      transform: translate(2px ,2px);
    }

    /* Home Page Content */
    .home-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-top: 80px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .welcome-message {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 20px;
      color: var(--text);
      text-shadow: 2px 2px 0px var(--primary-dark);
    }

    .welcome-message span {
      color: var(--secondary);
    }

    .current-date {
      font-size: 18px;
      color: var(--text-dim);
      margin-bottom: 30px;
    }

    .focus-status {
      font-size: 20px;
      color: var(--accent-alt);
      margin-bottom: 40px;
      padding: 10px 20px;
      background: var(--bg-light);
      border: 1px solid var(--primary);
      border-radius: 4px;
    }

    .home-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      width: 100%;
      max-width: 600px;
    }

    .home-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px;
      background: var(--bg-light);
      border: 2px solid var(--primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .home-action-btn:hover {
      transform: translateY(-5px);
      border-color: var(--secondary);
      box-shadow: 0 5px 15px rgba(142, 45, 226, 0.3);
    }

    .home-action-btn i {
      font-size: 36px;
      color: var(--secondary);
      margin-bottom: 15px;
    }

    .home-action-btn span {
      font-size: 18px;
      font-weight: bold;
      color: var(--text);
    }

    /* Profile Page */
    .profile-page {
      display: none;
      padding-top: 80px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .profile-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .profile-header h2 {
      font-size: 28px;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      background: var(--primary);
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      color: var(--text);
      border: 3px solid var(--secondary);
    }

    .profile-info {
      background: var(--bg-light);
      border: 2px solid var(--primary);
      border-radius: 8px;
      padding: 20px;
    }

    .profile-info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--bg-medium);
    }

    .profile-info-item:last-child {
      border-bottom: none;
    }

    .profile-info-label {
      font-weight: bold;
      color: var(--primary);
    }

    .profile-info-value {
      color: var(--text);
    }

    /* Focus Stats Page */
    .focus-stats-page {
      display: none;
      padding-top: 80px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .focus-stats-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .focus-stats-header h2 {
      font-size: 28px;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-light);
      border: 2px solid var(--primary);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: bold;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 16px;
      color: var(--text-dim);
    }

    .calendar-container {
      background: var(--bg-light);
      border: 2px solid var(--primary);
      border-radius: 8px;
      padding: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calendar-title {
      font-size: 18px;
      font-weight: bold;
      color: var(--text);
    }

    .calendar-nav {
      display: flex;
      gap: 10px;
    }

    .calendar-nav-btn {
      background: var(--bg-medium);
      border: 1px solid var(--primary);
      color: var(--text);
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-nav-btn:hover {
      background: var(--primary);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .calendar-day-header {
      text-align: center;
      font-weight: bold;
      color: var(--secondary);
      padding: 5px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-medium);
      border: 1px solid var(--primary);
      border-radius: 4px;
      font-size: 14px;
    }

    .calendar-day.level-0 {
      background: var(--calendar-blue-1);
    }

    .calendar-day.level-1 {
      background: var(--calendar-blue-2);
    }

    .calendar-day.level-2 {
      background: var(--calendar-blue-3);
    }

    .calendar-day.level-3 {
      background: var(--calendar-blue-4);
    }

    .calendar-day.level-4 {
      background: var(--calendar-blue-5);
    }

    .calendar-day.today {
      border: 2px solid var(--accent);
    }

    .calendar-day .date {
      font-weight: bold;
    }

    .calendar-day .points {
      font-size: 10px;
      color: var(--text-dim);
    }

    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }

    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
    }

    /* Todo List Page */
    .todo-page {
      display: none;
      padding-top: 80px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .todo-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .todo-header h2 {
      font-size: 28px;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .todo-container {
      background: var(--bg-light);
      border: 2px solid var(--primary);
      border-radius: 8px;
      padding: 20px;
    }

    .todo-form {
      display: flex;
      margin-bottom: 20px;
    }

    .todo-input {
      flex-grow: 1;
      padding: 10px;
      background: var(--bg-medium);
      border: 1px solid var(--primary);
      border-radius: 4px 0 0 4px;
      color: var(--text);
      font-family: monospace;
    }

    .todo-add-btn {
      background: var(--secondary);
      border: none;
      color: var(--text);
      padding: 10px 15px;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
    }

    .todo-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .todo-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--bg-medium);
    }

    .todo-item:last-child {
      border-bottom: none;
    }

    /* Neon Checkbox Styles */
    .neon-checkbox {
      --primary: #00ffaa;
      --primary-dark: #00cc88;
      --primary-light: #88ffdd;
      --size: 30px;
      position: relative;
      width: var(--size);
      height: var(--size);
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      margin-right: 10px;
    }

    .neon-checkbox input {
      display: none;
    }

    .neon-checkbox__frame {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .neon-checkbox__box {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 4px;
      border: 2px solid var(--primary-dark);
      transition: all 0.4s ease;
    }

    .neon-checkbox__check-container {
      position: absolute;
      inset: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .neon-checkbox__check {
      width: 80%;
      height: 80%;
      fill: none;
      stroke: var(--primary);
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 40;
      stroke-dashoffset: 40;
      transform-origin: center;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .neon-checkbox__glow {
      position: absolute;
      inset: -2px;
      border-radius: 6px;
      background: var(--primary);
      opacity: 0;
      filter: blur(8px);
      transform: scale(1.2);
      transition: all 0.4s ease;
    }

    .neon-checkbox__borders {
      position: absolute;
      inset: 0;
      border-radius: 4px;
      overflow: hidden;
    }

    .neon-checkbox__borders span {
      position: absolute;
      width: 40px;
      height: 1px;
      background: var(--primary);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .neon-checkbox__borders span:nth-child(1) {
      top: 0;
      left: -100%;
      animation: borderFlow1 2s linear infinite;
    }

    .neon-checkbox__borders span:nth-child(2) {
      top: -100%;
      right: 0;
      width: 1px;
      height: 40px;
      animation: borderFlow2 2s linear infinite;
    }

    .neon-checkbox__borders span:nth-child(3) {
      bottom: 0;
      right: -100%;
      animation: borderFlow3 2s linear infinite;
    }

    .neon-checkbox__borders span:nth-child(4) {
      bottom: -100%;
      left: 0;
      width: 1px;
      height: 40px;
      animation: borderFlow4 2s linear infinite;
    }

    .neon-checkbox__particles span {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0;
      pointer-events: none;
      top: 50%;
      left: 50%;
      box-shadow: 0 0 6px var(--primary);
    }

    .neon-checkbox__rings {
      position: absolute;
      inset: -20px;
      pointer-events: none;
    }

    .neon-checkbox__rings .ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 1px solid var(--primary);
      opacity: 0;
      transform: scale(0);
    }

    .neon-checkbox__sparks span {
      position: absolute;
      width: 20px;
      height: 1px;
      background: linear-gradient(90deg, var(--primary), transparent);
      opacity: 0;
    }

    /* Hover Effects */
    .neon-checkbox:hover .neon-checkbox__box {
      border-color: var(--primary);
      transform: scale(1.05);
    }

    /* Checked State */
    .neon-checkbox input:checked ~ .neon-checkbox__frame .neon-checkbox__box {
      border-color: var(--primary);
      background: rgba(0, 255, 170, 0.1);
    }

    .neon-checkbox input:checked ~ .neon-checkbox__frame .neon-checkbox__check {
      stroke-dashoffset: 0;
      transform: scale(1.1);
    }

    .neon-checkbox input:checked ~ .neon-checkbox__frame .neon-checkbox__glow {
      opacity: 0.2;
    }

    .neon-checkbox
      input:checked
      ~ .neon-checkbox__frame
      .neon-checkbox__borders
      span {
      opacity: 1;
    }

    /* Particle Animations */
    .neon-checkbox
      input:checked
      ~ .neon-checkbox__frame
      .neon-checkbox__particles
      span {
      animation: particleExplosion 0.6s ease-out forwards;
    }

    .neon-checkbox
      input:checked
      ~ .neon-checkbox__frame
      .neon-checkbox__rings
      .ring {
      animation: ringPulse 0.6s ease-out forwards;
    }

    .neon-checkbox
      input:checked
      ~ .neon-checkbox__frame
      .neon-checkbox__sparks
      span {
      animation: sparkFlash 0.6s ease-out forwards;
    }

    /* Animations */
    @keyframes borderFlow1 {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(200%);
      }
    }

    @keyframes borderFlow2 {
      0% {
        transform: translateY(0);
      }
      100% {
        transform: translateY(200%);
      }
    }

    @keyframes borderFlow3 {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(-200%);
      }
    }

    @keyframes borderFlow4 {
      0% {
        transform: translateY(0);
      }
      100% {
        transform: translateY(-200%);
      }
    }

    @keyframes particleExplosion {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
      }
      20% {
        opacity: 1;
      }
      100% {
        transform: translate(
            calc(-50% + var(--x, 20px)),
            calc(-50% + var(--y, 20px))
          )
          scale(0);
        opacity: 0;
      }
    }

    @keyframes ringPulse {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    @keyframes sparkFlash {
      0% {
        transform: rotate(var(--r, 0deg)) translateX(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: rotate(var(--r, 0deg)) translateX(30px) scale(0);
        opacity: 0;
      }
    }

    /* Particle Positions */
    .neon-checkbox__particles span:nth-child(1) {
      --x: 25px;
      --y: -25px;
    }
    .neon-checkbox__particles span:nth-child(2) {
      --x: -25px;
      --y: -25px;
    }
    .neon-checkbox__particles span:nth-child(3) {
      --x: 25px;
      --y: 25px;
    }
    .neon-checkbox__particles span:nth-child(4) {
      --x: -25px;
      --y: 25px;
    }
    .neon-checkbox__particles span:nth-child(5) {
      --x: 35px;
      --y: 0px;
    }
    .neon-checkbox__particles span:nth-child(6) {
      --x: -35px;
      --y: 0px;
    }
    .neon-checkbox__particles span:nth-child(7) {
      --x: 0px;
      --y: 35px;
    }
    .neon-checkbox__particles span:nth-child(8) {
      --x: 0px;
      --y: -35px;
    }
    .neon-checkbox__particles span:nth-child(9) {
      --x: 20px;
      --y: -30px;
    }
    .neon-checkbox__particles span:nth-child(10) {
      --x: -20px;
      --y: 30px;
    }
    .neon-checkbox__particles span:nth-child(11) {
      --x: 30px;
      --y: 20px;
    }
    .neon-checkbox__particles span:nth-child(12) {
      --x: -30px;
      --y: -20px;
    }

    /* Spark Rotations */
    .neon-checkbox__sparks span:nth-child(1) {
      --r: 0deg;
      top: 50%;
      left: 50%;
    }
    .neon-checkbox__sparks span:nth-child(2) {
      --r: 90deg;
      top: 50%;
      left: 50%;
    }
    .neon-checkbox__sparks span:nth-child(3) {
      --r: 180deg;
      top: 50%;
      left: 50%;
    }
    .neon-checkbox__sparks span:nth-child(4) {
      --r: 270deg;
      top: 50%;
      left: 50%;
    }

    /* Ring Delays */
    .neon-checkbox__rings .ring:nth-child(1) {
      animation-delay: 0s;
    }
    .neon-checkbox__rings .ring:nth-child(2) {
      animation-delay: 0.1s;
    }
    .neon-checkbox__rings .ring:nth-child(3) {
      animation-delay: 0.2s;
    }

    .todo-text {
      flex-grow: 1;
      color: var(--text);
    }

    .todo-text.completed {
      text-decoration: line-through;
      color: var(--text-dim);
    }

    .todo-actions {
      display: flex;
      gap: 10px;
    }

    .todo-action-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      padding: 0;
      margin: 0;
      font-size: 16px;
    }

    .todo-action-btn:hover {
      color: var(--secondary);
    }

    .todo-action-btn.delete {
      color: var(--accent);
    }

    /* YouTube Lecture Page */
    .youtube-page {
      display: none;
      padding-top: 80px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    .youtube-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .youtube-header h2 {
      font-size: 28px;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .youtube-container {
      width: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      border: 4px solid var(--primary);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    /* Improved Lofi Player */
    .card {
      position: relative;
      width: 260px;
      height: 130px;
      background: #151515;
      border-radius: 10px;
      padding: 10px;
      margin: 0 auto 10px;
    }

    .top {
      position: relative;
      width: 100%;
      display: flex;
      gap: 10px;
    }

    .pfp {
      position: relative;
      top: 5px;
      left: 5px;
      height: 40px;
      width: 40px;
      background-color: #d2d2d2;
      border-radius: 5px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .title-1 {
      color: white;
      font-size: 25px;
      font-weight: bolder;
      margin-left: 5px;
    }

    .title-2 {
      color: lightgrey;
      font-size: 12px;
      font-weight: bold;
      margin-top: -7px;
      margin-left: 5px;
    }

    .time {
      width: 90%;
      background-color: #5e5e5e;
      height: 6px;
      border-radius: 3px;
      position: absolute;
      left: 5%;
      bottom: 21px;
    }

    .elapsed {
      width: 42%;
      background-color: #1db954;
      height: 100%;
      border-radius: 3px;
    }

    .controls {
      color: white;
      display: flex;
      position: absolute;
      bottom: 30px;
      left: 0;
      width: 100%;
      justify-content: center;
    }

    .volume {
      height: 100%;
      width: 50px;
      margin-right: 2px;
    }

    .air {
      height: 100%;
      width: 54px;
    }

    .controls svg {
      cursor: pointer;
      transition: 0.1s;
      margin-bottom: 5px;
    }

    .controls svg:hover {
      color: #1db954;
    }

    .volume {
      opacity: 0;
      position: relative;
      transition: 0.2s;
    }

    .volume .slider {
      height: 4px;
      background-color: #5e5e5e;
      width: 80%;
      border-radius: 2px;
      margin-top: 8px;
      margin-left: 10%;
    }

    .volume .slider .green {
      background-color: #1db954;
      height: 100%;
      width: 80%;
      border-radius: 3px;
    }

    .volume .circle {
      background-color: white;
      height: 6px;
      width: 6px;
      border-radius: 3px;
      position: absolute;
      right: 20%;
      top: 60%;
    }

    .volume_button:hover ~ .volume {
      opacity: 1;
    }

    .timetext {
      color: white;
      font-size: 8px;
      position: absolute;
    }

    .time_now {
      bottom: 8px;
      left: 15px;
    }

    .time_full {
      bottom: 8px;
      right: 14px;
    }

    .playing {
      display: flex;
      position: relative;
      justify-content: center;
      gap: 1px;
      width: 30px;
      height: 20px;
    }

    .greenline {
      background-color: #1db954;
      height: 20px;
      width: 2px;
      position: relative;
      transform-origin: bottom;
    }

    .line-1 {
      animation: infinite playing 1s ease-in-out;
      animation-delay: 0.2s;
    }

    .line-2 {
      animation: infinite playing 1s ease-in-out;
      animation-delay: 0.5s;
    }

    .line-3 {
      animation: infinite playing 1s ease-in-out;
      animation-delay: 0.6s;
    }

    .line-4 {
      animation: infinite playing 1s ease-in-out;
      animation-delay: 0s;
    }

    .line-5 {
      animation: infinite playing 1s ease-in-out;
      animation-delay: 0.4s;
    }

    @keyframes playing {
      0% {
        transform: scaleY(0.1);
      }

      33% {
        transform: scaleY(0.6);
      }

      66% {
        transform: scaleY(0.9);
      }

      100% {
        transform: scaleY(0.1);
      }
    }

    /* Improved Pomodoro */
    #pomodoroOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 15, 27, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      pointer-events: auto;
    }

    #pomodoroContainer {
      width: 400px;
      background: var(--bg-medium);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(142, 45, 226, 0.5);
      text-align: center;
      pointer-events: auto;
    }

    #pomodoroTimer {
      font-size: 80px;
      font-weight: bold;
      color: var(--text);
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 10px rgba(142, 45, 226, 0.5);
    }

    #pomodoroControls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    #pomodoroControls button {
      padding: 10px 25px;
      font-size: 16px;
      border-radius: 30px;
    }

    #pomodoroStatus {
      font-size: 18px;
      color: var(--accent-alt);
      margin-top: 15px;
    }

    #landingPage,
    #signinForm,
    #inputForm {
      text-align: center;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
      z-index: 10;
      background-color: rgba(15, 15, 27, 0.8);
      border: 2px solid var(--secondary);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(142, 45, 226, 0.3);
      pointer-events: auto;
    }

    .title {
      font-family: monospace;
      font-size: 32px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 20px;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    .title span {
      color: var(--secondary);
      position: relative;
      display: inline-block;
    }

    .title span::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .subtitle {
      font-size: 20px;
      color: var(--text-dim);
      margin-bottom: 30px;
    }

    button {
      display: inline-block;
      padding: 12px 30px;
      font-size: 18px;
      font-family: monospace;
      font-weight: 600;
      background: var(--secondary);
      border: none;
      color: var(--text);
      border-radius: 0;
      cursor: pointer;
      margin: 0 10px 15px;
      transition: all 0.3s;
      position: relative;
      box-shadow: 4px 4px 0 var(--primary-dark);
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 1px;
      z-index: 11;
      pointer-events: auto;
    }

    button:hover {
      background: var(--primary);
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--primary-dark);
    }

    button:active {
      transform: translate(4px, 4px);
      box-shadow: none;
    }

    .github-btn {
      background: var(--bg-light);
      box-shadow: 4px 4px 0 var(--bg-medium);
    }

    .github-btn:hover {
      background: var(--bg-medium);
      box-shadow: 2px 2px 0 var(--bg-medium);
    }

    #features {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
      z-index: 10;
    }

    .feature {
      background: var(--bg-light);
      padding: 15px 20px;
      border-radius: 0;
      width: 200px;
      box-shadow: 4px 4px 0 var(--bg-medium);
      border: 2px solid var(--primary);
      position: relative;
      overflow: hidden;
      z-index: 10;
    }

    .feature::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .feature i {
      font-size: 24px;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .feature p {
      font-size: 16px;
      color: var(--text);
    }

    input,
    select {
      display: block;
      width: 100%;
      max-width: 320px;
      margin: 10px auto;
      padding: 12px;
      border-radius: 0;
      font-size: 16px;
      font-family: monospace;
      background: var(--bg-light);
      border: 2px solid var(--primary);
      color: var(--text);
      outline: none;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
      z-index: 11;
      pointer-events: auto;
    }

    input:focus,
    select:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(142, 45, 226, 0.3);
    }

    #inputForm {
      max-height: 80vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--secondary) var(--bg-medium);
    }

    #inputForm::-webkit-scrollbar {
      width: 8px;
    }

    #inputForm::-webkit-scrollbar-track {
      background: var(--bg-medium);
    }

    #inputForm::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 0;
      border: 2px solid var(--bg-medium);
    }

    #player {
      width: 100%;
      max-width: 1200px;
      aspect-ratio: 16 / 9;
      border-radius: 0;
      overflow: hidden;
      display: none;
      background: #000;
      border: 4px solid var(--primary);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      z-index: 5;
    }

    #timerDisplay {
      position: fixed;
      top: 10px;
      left: 10px;
      color: var(--text);
      font-size: 24px;
      z-index: 101;
      cursor: move;
      padding: 10px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      font-family: monospace;
      font-size: 16px;
      pointer-events: auto;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
    }

    #timerDisplay button {
      pointer-events: auto;
      padding: 5px 10px;
      margin: 0 5px;
      font-size: 12px;
      z-index: 102;
    }

    #pointsDisplay {
      position: fixed;
      top: 50px;
      left: 10px;
      font-size: 18px;
      color: var(--text);
      font-family: monospace;
      font-weight: 600;
      z-index: 101;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    #clockDisplay {
      position: fixed;
      top: 90px;
      left: 10px;
      font-size: 20px;
      font-family: monospace;
      font-weight: bold;
      z-index: 101;
      padding: 8px 12px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      display: none;
      pointer-events: none;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
    }

    #clockDisplay .time {
      color: var(--primary);
      font-weight: 600;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    #clockDisplay .period {
      color: var(--secondary);
      font-weight: 600;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    #progressBar {
      width: 200px;
      height: 10px;
      background: var(--bg-light);
      display: none;
      margin-top: 5px;
      border: 2px solid var(--primary);
      z-index: 101;
    }

    #progressFill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    #sitesBox {
      display: none;
      position: fixed;
      top: 130px;
      left: 10px;
      z-index: 101;
      padding: 8px 12px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      cursor: pointer;
      pointer-events: auto;
    }

    #sitesPopup {
      position: fixed;
      top: 170px;
      left: 10px;
      width: 250px;
      background: var(--bg-medium);
      padding: 15px;
      border: 2px solid var(--secondary);
      display: none;
      z-index: 102;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #sitesPopup a {
      display: block;
      color: var(--primary);
      text-decoration: none;
      margin: 10px 0;
      font-size: 14px;
      font-family: monospace;
      padding: 5px;
      border: 1px solid var(--primary);
      transition: all 0.3s;
      pointer-events: auto;
    }

    #sitesPopup a:hover {
      color: var(--text);
      background: var(--primary);
      transform: translate(2px, 2px);
    }

    #closeSitesPopup {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--accent);
      border: none;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      padding: 2px 6px;
      margin: 0;
      z-index: 103;
    }

    #restartBtn {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--accent);
      z-index: 103;
      pointer-events: auto;
    }

    #videoSidebar {
      position: fixed;
      right: -320px;
      top: 0;
      width: 300px;
      height: 100%;
      background: var(--bg-medium);
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
      z-index: 102;
      border-left: 4px solid var(--primary);
      pointer-events: auto;
    }

    .thumbnail {
      width: 100%;
      margin-bottom: 15px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 0;
      transition: all 0.3s;
      image-rendering: pixelated;
      pointer-events: auto;
    }

    .thumbnail:hover {
      border-color: var(--secondary);
      transform: scale(1.05);
    }

    #minimizeBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--accent);
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 6px;
      margin: 0;
      box-shadow: none;
      z-index: 102;
    }

    .url-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .url-container button {
      margin-left: 10px;
      padding: 5px 10px;
      background: var(--accent);
      font-size: 14px;
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
      z-index: 11;
    }

    #statsBtn,
    #todoBtn,
    #pyqBtn {
      padding: 8px 16px;
      font-size: 12px;
      margin: 0 5px 15px;
      z-index: 11;
    }

    #analytics,
    #todoList {
      position: absolute;
      left: 10px;
      background: var(--bg-medium);
      padding: 15px;
      border: 2px solid var(--secondary);
      display: none;
      z-index: 100;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #analytics {
      top: 90px;
    }

    #todoList {
      top: 50px;
      width: 300px;
      max-height: 400px;
    }

    #tasks {
      overflow-y: auto;
      max-height: 320px;
      margin-bottom: 10px;
      background: none;
    }

    #analytics h3,
    #todoList h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--secondary);
      font-family: monospace;
      font-size: 16px;
      text-align: center;
    }

    #analytics p {
      font-size: 16px;
      margin: 5px 0;
      border-bottom: 1px solid var(--bg-light);
      padding-bottom: 5px;
    }

    .task-line {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      background: var(--bg-light);
      padding: 5px;
      border: 1px solid var(--primary);
      pointer-events: auto;
    }

    .task-line input[type="text"] {
      flex-grow: 1;
      font-size: 16px;
      font-family: monospace;
      color: var(--text);
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--text-dim);
      padding: 2px 0;
      outline: none;
      box-shadow: none;
      margin: 0;
      pointer-events: auto;
      z-index: 11;
    }

    .task-line input[type="text"]:focus {
      border-bottom: 1px solid var(--secondary);
      box-shadow: none;
    }

    .task-line .remove-task {
      margin-left: 10px;
      color: var(--accent);
      font-size: 16px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
      pointer-events: auto;
      z-index: 11;
    }

    .task-line .set-deadline {
      margin-left: 5px;
      color: var(--primary);
      font-size: 14px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 2px 5px;
      border: 1px solid var(--primary);
      pointer-events: auto;
      z-index: 11;
    }

    .task-line .set-deadline:hover {
      background: var(--primary);
      color: var(--text);
    }

    .task-line .deadline-info {
      margin-left: 5px;
      font-size: 12px;
      color: var(--accent-alt);
    }

    .task-line .points-info {
      margin-left: 5px;
      font-size: 12px;
      color: var(--secondary);
    }

    #lofiPlayer {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 101;
      display: none;
      background: var(--bg-medium);
      padding: 10px;
      border: 2px solid var(--primary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #achievementOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      color: gold;
      font-size: 32px;
      font-weight: bold;
      z-index: 104;
      display: none;
      font-family: monospace;
      text-align: center;
      text-shadow: 3px 3px 0 var(--primary-dark);
      background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
    }

    #achievementLevel {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 20px;
      font-weight: bold;
      z-index: 101;
      font-family: monospace;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    #streakDisplay {
      position: fixed;
      top: 60px;
      right: 10px;
      font-size: 16px;
      color: var(--text);
      z-index: 101;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
      font-family: monospace;
    }

    .glow {
      text-shadow: 0 0 10px var(--text);
      animation: pulse 2s infinite;
    }

    .box-glow {
      border: 2px solid gold;
      padding: 5px;
      box-shadow: 0 0 10px gold;
      animation: pulse 2s infinite;
    }

    .rainbow {
      background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s infinite;
    }

    @keyframes rainbow {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    #confirmationDialog,
    #streakShieldDialog,
    #doublePointsDialog,
    #deadlineDialog,
    #sessionCompleteDialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-medium);
      padding: 20px;
      border: 4px solid var(--accent);
      box-shadow: 0 0 20px rgba(255, 69, 0, 0.5);
      z-index: 105;
      display: none;
      text-align: center;
      pointer-events: auto;
      font-family: monospace;
    }

    #confirmationDialog p,
    #streakShieldDialog p,
    #doublePointsDialog p,
    #deadlineDialog p,
    #sessionCompleteDialog p {
      font-size: 16px;
      margin-bottom: 20px;
    }

    #confirmationDialog button,
    #streakShieldDialog button,
    #doublePointsDialog button,
    #deadlineDialog button,
    #sessionCompleteDialog button {
      padding: 8px 20px;
      margin: 0 10px;
      font-size: 14px;
      pointer-events: auto;
      z-index: 106;
    }

    #confirmBtn,
    #streakShieldConfirmBtn,
    #doublePointsConfirmBtn,
    #deadlineConfirmBtn,
    #sessionContinueBtn {
      background: var(--accent);
    }

    #cancelBtn,
    #streakShieldCancelBtn,
    #doublePointsCancelBtn,
    #deadlineCancelBtn,
    #sessionEndBtn {
      background: var(--primary);
    }

    #deadlineDialog input,
    #deadlineDialog select {
      margin: 10px auto;
      width: 100%;
      max-width: 250px;
    }

    #pdfToggle {
      display: none;
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: var(--primary);
      z-index: 101;
      cursor: pointer;
      pointer-events: auto;
    }

    #pdfViewer {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 500px;
      background: var(--bg-medium);
      padding: 15px;
      border: 4px solid var(--primary);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      z-index: 101;
      pointer-events: auto;
    }

    #pdfInput {
      margin-bottom: 10px;
      width: 100%;
      pointer-events: auto;
      z-index: 102;
    }

    #pdfFrame {
      width: 100%;
      height: 90%;
      border: none;
      background: #fff;
    }

    #fireBox {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      border: 2px solid var(--secondary);
      pointer-events: auto;
    }

    #fireBox:hover {
      background: var(--secondary);
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
    }

    #aiPopup {
      position: fixed;
      bottom: 60px;
      left: 10px;
      width: 300px;
      height: 400px;
      background: var(--bg-medium);
      border-radius: 0;
      padding: 5px;
      display: none;
      z-index: 101;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      border: 4px solid var(--primary);
      pointer-events: auto;
    }

    #aiPopup iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .game-sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      width: 250px;
      height: 100vh;
      background: var(--bg-medium);
      border-right: 4px solid var(--primary);
      z-index: 200;
      transition: left 0.3s ease;
      padding: 20px 0;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
      pointer-events: auto;
    }

    .sidebar-trigger:hover + .game-sidebar,
    .game-sidebar:hover {
      left: 0;
    }

    .sidebar-trigger {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 80px;
      background: var(--primary);
      z-index: 199;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      font-weight: bold;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 12px;
      letter-spacing: 1px;
      pointer-events: auto;
    }

    .sidebar-section {
      padding: 15px;
      border-bottom: 2px solid var(--bg-dark);
    }

    .sidebar-section h3 {
      color: var(--secondary);
      font-size: 16px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-section a,
    .sidebar-section button {
      display: block;
      width: 100%;
      padding: 8px 10px;
      margin: 5px 0;
      background: var(--bg-light);
      color: var(--text);
      border: 1px solid var(--primary);
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      pointer-events: auto;
      z-index: 201;
    }

    .sidebar-section a:hover,
    .sidebar-section button:hover {
      background: var(--primary);
      transform: translateX(5px);
    }

    .dashboard-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dashboard-info p {
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }

    .dashboard-info p span:first-child {
      font-weight: bold;
      color: var(--primary);
    }

    #mysteryBoxPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-medium);
      padding: 20px;
      border: 4px solid gold;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      z-index: 105;
      display: none;
      text-align: center;
      pointer-events: auto;
      font-family: monospace;
      width: 300px;
    }

    #mysteryBoxPopup h3 {
      color: gold;
      font-size: 20px;
      margin-bottom: 15px;
    }

    #mysteryBoxPopup p {
      font-size: 16px;
      margin-bottom: 20px;
    }

    #mysteryBoxPopup button {
      padding: 8px 20px;
      background: var(--accent);
      font-size: 14px;
      pointer-events: auto;
    }

    /* Audio tracks store styles */
    #audioTracksStore {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      max-height: 500px;
      background: var(--bg-medium);
      padding: 20px;
      border: 4px solid var(--secondary);
      box-shadow: 0 0 20px rgba(142, 45, 226, 0.5);
      z-index: 105;
      display: none;
      text-align: center;
      pointer-events: auto;
      font-family: monospace;
      overflow-y: auto;
    }

    #audioTracksStore h3 {
      color: var(--secondary);
      font-size: 20px;
      margin-bottom: 15px;
    }

    .audio-track-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 10px;
      background: var(--bg-light);
      border: 1px solid var(--primary);
    }

    .audio-track-item.locked .track-name {
      color: var(--text-dim);
    }

    .audio-track-item.unlocked .track-name {
      color: var(--accent-alt);
    }

    .unlock-track-btn {
      padding: 5px 10px;
      background: var(--secondary);
      font-size: 12px;
      margin: 0;
    }

    .unlock-track-btn:disabled {
      background: var(--bg-light);
      color: var(--text-dim);
      cursor: not-allowed;
    }

    @media (max-width: 800px) {
      .title { font-size: 24px; }
      button { padding: 8px 16px; font-size: 12px; margin: 0 5px 10px; }
      #features { flex-direction: column; align-items: center; }
      .feature { width: 90%; max-width: 250px; }
      #timerDisplay, #pointsDisplay, #clockDisplay, #sitesBox { font-size: 14px; padding: 5px 8px; }
      #achievementLevel, #streakDisplay { font-size: 14px; padding: 5px 8px; }
      #videoSidebar { width: 250px; }
      #lofiPlayer button { padding: 3px 6px; font-size: 10px; }
      #confirmationDialog, #streakShieldDialog, #doublePointsDialog { width: 90%; max-width: 300px; }
      #confirmationDialog p, #streakShieldDialog p, #doublePointsDialog p { font-size: 14px; }
      #pdfViewer { width: 90%; height: 80%; max-height: 500px; }
      #aiPopup { width: 90%; max-width: 300px; height: 350px; }
      #mysteryBoxPopup { width: 90%; max-width: 280px; }
      #audioTracksStore { width: 90%; max-width: 350px; }
      #pomodoroContainer { width: 90%; max-width: 350px; padding: 20px; }
      #pomodoroTimer { font-size: 60px; }
      #detailedStatsContainer { width: 95%; padding: 15px; }
      .calendar-day { font-size: 10px; }
      .calendar-day .points { font-size: 8px; }
      .card { width: 220px; height: 110px; }
      .title-1 { font-size: 20px; }
      .top-navbar { padding: 0 10px; }
      .navbar-logo { font-size: 18px; }
      .navbar-clock { font-size: 16px; }
      .navbar-actions { gap: 5px; }
      .navbar-btn { padding: 5px 8px; font-size: 12px; }
      .home-content { padding-top: 70px; }
      .welcome-message { font-size: 22px; }
      .home-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- Top Navigation Bar -->
    <div class="top-navbar">
      <div class="navbar-logo">QUEST FOR <span>FOCUS</span></div>
      <div class="navbar-clock" id="navbarClock"></div>
      <div class="navbar-actions">
        <button class="navbar-btn" id="profileBtn">Profile</button>
        <button class="navbar-btn streak-btn" id="streakBtn">
          <span class="fire-icon"></span> <span id="streakCount">0</span>
          <span class="streak-tooltip">0-day focus streak</span>
        </button>
        <button class="Btn" id="logoutBtnTop">
          <div class="sign">
            <svg viewBox="0 0 512 512">
              <path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"></path>
            </svg>
          </div>
          <div class="text">Logout</div>
        </button>
      </div>
    </div>

    <!-- Home Page Content -->
    <div class="home-content" id="homePage">
      <div class="welcome-message">Welcome back, <span id="welcomeUsername">Hero</span>!</div>
      <div class="current-date" id="currentDate"></div>
      <div class="focus-status" id="focusStatus">Ready to get in the zone?</div>
      
      <div class="home-actions">
        <div class="home-action-btn" id="watchLecturesBtn">
          <i></i>
          <span>Watch Lectures</span>
        </div>
        <div class="home-action-btn" id="todoPageBtn">
          <i></i>
          <span>To-Do List</span>
        </div>
        <div class="home-action-btn" id="focusStatsBtn">
          <i></i>
          <span>Focus Stats</span>
        </div>
        <div class="home-action-btn" id="pyqsBtn">
          <i></i>
          <span>PYQs Practice</span>
        </div>
      </div>
    </div>

    <!-- Profile Page -->
    <div class="profile-page" id="profilePage">
      <div class="profile-header">
        <h2>Profile Settings</h2>
        <div class="profile-avatar" id="profileAvatar">H</div>
      </div>
      <div class="profile-info">
        <div class="profile-info-item">
          <div class="profile-info-label">Username:</div>
          <div class="profile-info-value" id="profileUsername">Hero</div>
        </div>
        <div class="profile-info-item">
          <div class="profile-info-label">Level:</div>
          <div class="profile-info-value" id="profileLevel">Mortal</div>
        </div>
        <div class="profile-info-item">
          <div class="profile-info-label">XP:</div>
          <div class="profile-info-value" id="profileXP">0</div>
        </div>
        <div class="profile-info-item">
          <div class="profile-info-label">Streak:</div>
          <div class="profile-info-value" id="profileStreak">0 days</div>
        </div>
        <div class="profile-info-item">
          <div class="profile-info-label">Focus Time:</div>
          <div class="profile-info-value" id="profileFocusTime">0 minutes</div>
        </div>
        <div class="profile-info-item">
          <div class="profile-info-label">Videos Watched:</div>
          <div class="profile-info-value" id="profileVideosWatched">0</div>
        </div>
      </div>
    </div>

    <!-- Focus Stats Page -->
    <div class="focus-stats-page" id="focusStatsPage">
      <div class="focus-stats-header">
        <h2>Focus Statistics</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statsFocusTime">0</div>
          <div class="stat-label">Minutes Focused</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statsVideosWatched">0</div>
          <div class="stat-label">Videos Completed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statsStreak">0</div>
          <div class="stat-label">Day Streak</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statsDistractions">0</div>
          <div class="stat-label">Distractions Defeated</div>
        </div>
      </div>
      <div class="calendar-container">
        <div class="calendar-header">
          <div class="calendar-title">Focus Calendar</div>
          <div class="calendar-nav">
            <button class="calendar-nav-btn" id="prevMonthBtn"></button>
            <button class="calendar-nav-btn" id="nextMonthBtn"></button>
          </div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <!-- Calendar days will be generated here -->
        </div>
        <div class="calendar-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-1);"></div>
            <span>0-50 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-2);"></div>
            <span>51-100 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-3);"></div>
            <span>101-200 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-4);"></div>
            <span>201-300 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-5);"></div>
            <span>300+ XP</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Todo List Page -->
    <div class="todo-page" id="todoPage">
      <div class="todo-header">
        <h2>To-Do List</h2>
      </div>
      <div class="todo-container">
        <div class="todo-form">
          <input type="text" class="todo-input" id="todoInput" placeholder="Add a new task...">
          <button class="todo-add-btn" id="todoAddBtn">Add</button>
        </div>
        <div class="todo-list" id="todoListContainer">
          <!-- Todo items will be generated here -->
        </div>
      </div>
    </div>

    <!-- YouTube Lecture Page -->
    <div class="youtube-page" id="youtubePage">
      <div class="youtube-header">
        <h2>Watch Lectures</h2>
      </div>
      <div class="youtube-container" id="youtubeContainer">
        <!-- YouTube player will be embedded here -->
      </div>
      <div id="urlInputs">
        <div class="url-container">
          <input type="text" class="youtube-url" placeholder="YouTube URL (Videos or Live Streams)" required />
        </div>
      </div>
      <button data-action="add-url">ADD URL</button>
      <button data-action="start-playback">BEGIN FOCUS</button>
    </div>

    <div class="sidebar-trigger">MENU</div>
    <div class="game-sidebar">
      <div class="sidebar-section">
        <h3>Allied Realms</h3>
        <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer">FOREST QUEST - TASK MANAGEMENT</a>
        <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer">POMODORO REALM</a>
        <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer">DAILY QUEST PLANNER</a>
      </div>
      <div class="sidebar-section">
        <h3>Self Study</h3>
        <button id="quietPomodoroBtn">QUIET POMODORO</button>
      </div>
      <div class="sidebar-section">
        <h3>Shops</h3>
        <button id="streakShieldBtn">STREAK SHIELD</button>
        <button id="doublePointsBtn">DOUBLE POINTS POWER-UP</button>
        <button id="audioStoreBtn">AUDIO TRACKS STORE</button>
      </div>
    </div>

    <div id="landingPage" style="display: none;">
      <div class="title">QUEST FOR <span>FOCUS</span></div>
      <div class="subtitle">Begin your learning adventure!</div>
      <button data-action="start-game">START GAME</button>
      <button class="github-btn" data-action="github">GITHUB REPO</button>
      <div id="features">
        <div class="feature">
          <i class="fas fa-ad"></i>
          <p>Ad Free<br>No distractions on your quest</p>
        </div>
        <div class="feature">
          <i class="fas fa-moon"></i>
          <p>Dark Mode<br>Save your vision for the final boss</p>
        </div>
      </div>
    </div>

    <div id="signinForm" style="display: none;">
      <div class="title">CREATE YOUR <span>ACCOUNT</span></div>
      <div class="subtitle">Sign in to track your progress</div>
      <input type="text" id="username" placeholder="Hero Name" required />
      <input type="password" id="password" placeholder="Secret Code" required />
      <button data-action="sign-in">ENTER REALM</button>
      <p>New adventurer? <button data-action="create-account">CREATE ACCOUNT</button></p>
    </div>

    <div id="inputForm" style="display: none;">
      <div id="achievementLevel"></div>
      <div id="streakDisplay"></div>
      <button id="todoBtn">TO-DO</button>
      <button id="statsBtn">HERO STATS</button>
      <button id="pyqBtn">TRAINING GROUNDS</button>

      <div id="todoList">
        <h3>TO-DO</h3>
        <div id="tasks">
          <div class="task-line">
            <!-- Neon Checkbox -->
            <label class="neon-checkbox">
              <input type="checkbox" class="task-check" />
              <div class="neon-checkbox__frame">
                <div class="neon-checkbox__box">
                  <div class="neon-checkbox__check-container">
                    <svg viewBox="0 0 24 24" class="neon-checkbox__check">
                      <path d="M3,12.5l7,7L21,5"></path>
                    </svg>
                  </div>
                  <div class="neon-checkbox__glow"></div>
                  <div class="neon-checkbox__borders">
                    <span></span><span></span><span></span><span></span>
                  </div>
                </div>
                <div class="neon-checkbox__effects">
                  <div class="neon-checkbox__particles">
                    <span></span><span></span><span></span><span></span> <span></span
                    ><span></span><span></span><span></span> <span></span><span></span
                    ><span></span><span></span>
                  </div>
                  <div class="neon-checkbox__rings">
                    <div class="ring"></div>
                    <div class="ring"></div>
                    <div class="ring"></div>
                  </div>
                  <div class="neon-checkbox__sparks">
                    <span></span><span></span><span></span><span></span>
                  </div>
                </div>
              </div>
            </label>
            <input type="text" class="task-text" placeholder="Add a quest..." />
            <button class="set-deadline"></button>
            <span class="remove-task">x</span>
          </div>
        </div>
        <button data-action="save-tasks">SAVE QUESTS</button>
      </div>

      <div id="analytics">
        <h3>HERO STATS</h3>
        <p>Focus Time: <span id="totalFocusTime">0</span> min</p>
        <p>Distractions Defeated: <span id="totalDistractions">0</span></p>
        <p>Videos Completed: <span id="totalVideosWatched">0</span></p>
      </div>

      <div class="title">ENTER YOUR <span>YOUTUBE URL</span></div>
      <div class="subtitle"></div>
      <select id="playlistSelect">
        <option value="">Select a Playlist</option>
      </select>
      <input type="text" id="playlistName" placeholder="Save Path As..." />
      <button data-action="save-playlist">SAVE PLAYLIST</button>
      <button data-action="remove-playlist">DELETE PLAYLIST</button>

      <div id="urlInputs">
        <div class="url-container">
          <input type="text" class="youtube-url" placeholder="YouTube URL (Videos or Live Streams)" required />
        </div>
      </div>

      <button data-action="add-url">ADD URL</button>
      <button data-action="start-playback">BEGIN FOCUS</button>
    </div>

    <div id="player" style="display: none;"></div>

    <div id="timerDisplay">
      <span id="timerText"></span>
      <div id="progressBar">
        <div id="progressFill"></div>
      </div>
    </div>

    <div id="pointsDisplay"><span style="color: #8e2de2;"></span> XP: 0</div>
    <div id="clockDisplay"></div>

    <div id="sitesBox" style="display: none;">ALLIED REALMS </div>
    <div id="sitesPopup">
      <button id="closeSitesPopup">X</button>
      <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer">FOREST QUEST - TASK MANAGEMENT</a>
      <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer">POMODORO REALM</a>
      <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer">DAILY QUEST PLANNER</a>
    </div>

    <button id="restartBtn" style="display: none;">EXIT</button>

    <div id="videoSidebar"></div>

    <div id="lofiPlayer">
      <!-- Improved Lofi Player -->
      <div class="card">
        <div class="top">
          <div class="pfp">
            <div class="playing">
              <div class="greenline line-1"></div>
              <div class="greenline line-2"></div>
              <div class="greenline line-3"></div>
              <div class="greenline line-4"></div>
              <div class="greenline line-5"></div>
            </div>
          </div>
          <div class="texts">
            <p class="title-1">Soldiers Rage</p>
            <p class="title-2">Tha Mechanic</p>
          </div>
        </div>

        <div class="controls">
          <svg
            class="volume_button"
            width="24"
            height="20"
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              fill-rule="evenodd"
              d="M11.26 3.691A1.2 1.2 0 0 1 12 4.8v14.4a1.199 1.199 0 0 1-2.048.848L5.503 15.6H2.4a1.2 1.2 0 0 1-1.2-1.2V9.6a1.2 1.2 0 0 1 1.2-1.2h3.103l4.449-4.448a1.2 1.2 0 0 1 1.308-.26Zm6.328-.176a1.2 1.2 0 0 1 1.697 0A11.967 11.967 0 0 1 22.8 12a11.966 11.966 0 0 1-3.515 8.485 1.2 1.2 0 0 1-1.697-1.697A9.563 9.563 0 0 0 20.4 12a9.565 9.565 0 0 0-2.812-6.788 1.2 1.2 0 0 1 0-1.697Zm-3.394 3.393a1.2 1.2 0 0 1 1.698 0A7.178 7.178 0 0 1 18 12a7.18 7.18 0 0 1-2.108 5.092 1.2 1.2 0 1 1-1.698-1.698A4.782 4.782 0 0 0 15.6 12a4.78 4.78 0 0 0-1.406-3.394 1.2 1.2 0 0 1 0-1.698Z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <div class="volume">
            <div class="slider">
              <div class="green"></div>
            </div>
            <div class="circle"></div>
          </div>
          <svg
            width="24"
            height="24"
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            id="lofiPrev"
          >
            <path
              fill-rule="evenodd"
              d="M12 21.6a9.6 9.6 0 1 0 0-19.2 9.6 9.6 0 0 0 0 19.2Zm.848-12.352a1.2 1.2 0 0 0-1.696-1.696l-3.6 3.6a1.2 1.2 0 0 0 0 1.696l3.6 3.6a1.2 1.2 0 0 0 1.696-1.696L11.297 13.2H15.6a1.2 1.2 0 1 0 0-2.4h-4.303l1.551-1.552Z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <svg
            width="24"
            height="24"
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            id="lofiPause"
          >
            <path
              fill-rule="evenodd"
              d="M21.6 12a9.6 9.6 0 1 1-19.2 0 9.6 9.6 0 0 1 19.2 0ZM8.4 9.6a1.2 1.2 0 1 1 2.4 0v4.8a1.2 1.2 0 1 1-2.4 0V9.6Zm6-1.2a1.2 1.2 0 0 0-1.2 1.2v4.8a1.2 1.2 0 1 1 2.4 0V9.6a1.2 1.2 0 0 0-1.2-1.2Z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <svg
            width="24"
            height="24"
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            id="lofiPlay"
          >
            <path
              fill-rule="evenodd"
              d="M12 21.6a9.6 9.6 0 1 0 0-19.2 9.6 9.6 0 0 0 0 19.2Zm4.448-10.448-3.6-3.6a1.2 1.2 0 0 0-1.696 1.696l1.551 1.552H8.4a1.2 1.2 0 1 0 0 2.4h4.303l-1.551 1.552a1.2 1.2 0 1 0 1.696 1.696l3.6-3.6a1.2 1.2 0 0 0 0-1.696Z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <svg
            width="24"
            height="24"
            fill="currentColor"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            id="lofiNext"
          >
            <path
              fill-rule="evenodd"
              d="M12 21.6a9.6 9.6 0 1 0 0-19.2 9.6 9.6 0 0 0 0 19.2Zm4.448-10.448-3.6-3.6a1.2 1.2 0 0 0-1.696 1.696l1.551 1.552H8.4a1.2 1.2 0 1 0 0 2.4h4.303l-1.551 1.552a1.2 1.2 0 1 0 1.696 1.696l3.6-3.6a1.2 1.2 0 0 0 0-1.696Z"
              clip-rule="evenodd"
            ></path>
          </svg>
          <div class="air"></div>
          <svg
            width="24"
            height="20"
            fill="none"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M3.343 7.778a4.5 4.5 0 0 1 7.339-1.46L12 7.636l1.318-1.318a4.5 4.5 0 1 1 6.364 6.364L12 20.364l-7.682-7.682a4.501 4.501 0 0 1-.975-4.904Z"
            ></path>
          </svg>
        </div>
        <div class="time">
          <div class="elapsed"></div>
        </div>
        <p class="timetext time_now">1:31</p>
        <p class="timetext time_full">3:46</p>
      </div>
    </div>

    <div id="achievementOverlay"></div>

    <div id="confirmationDialog" style="display: none;">
      <p>Are you sure you want to abandon your quest?</p>
      <button id="confirmBtn">YES</button>
      <button id="cancelBtn">NO</button>
    </div>

    <div id="streakShieldDialog" style="display: none;">
      <p>Are you sure you want to buy Streak Shield for 800 XP? (Protects streak for 1 week)</p>
      <button id="streakShieldConfirmBtn">YES</button>
      <button id="streakShieldCancelBtn">NO</button>
    </div>

    <div id="doublePointsDialog" style="display: none;">
      <p>Are you sure you want to buy Double Points Power-Up for 800 XP? (Doubles points for 24 hours)</p>
      <button id="doublePointsConfirmBtn">YES</button>
      <button id="doublePointsCancelBtn">NO</button>
    </div>

    <div id="deadlineDialog" style="display: none;">
      <h3>Set Task Deadline</h3>
      <p>Set a deadline for your task to earn points!</p>
      <input type="date" id="deadlineDate" />
      <input type="time" id="deadlineTime" />
      <select id="taskDifficulty">
        <option value="50">Easy (50 points)</option>
        <option value="100">Medium (100 points)</option>
        <option value="200">Hard (200 points)</option>
        <option value="300">Very Hard (300 points)</option>
      </select>
      <button id="deadlineConfirmBtn">SET DEADLINE</button>
      <button id="deadlineCancelBtn">CANCEL</button>
    </div>

    <div id="sessionCompleteDialog" style="display: none;">
      <h3>Session Complete!</h3>
      <p>Great work! You've completed a focus session.</p>
      <p>One more session for +100 bonus points?</p>
      <button id="sessionContinueBtn">CONTINUE (+100 XP)</button>
      <button id="sessionEndBtn">END SESSION</button>
    </div>

    <div id="pomodoroOverlay" style="display: none;">
      <div id="pomodoroContainer">
        <h3>QUIET POMODORO</h3>
        <p>Focus in silence, earn points with each minute</p>
        <div id="pomodoroTimer">60:00</div>
        <div id="pomodoroStatus">Ready to begin</div>
        <div id="pomodoroControls">
          <button id="pomodoroStartBtn">START</button>
          <button id="pomodoroResetBtn">RESET</button>
          <button id="pomodoroCloseBtn">CLOSE</button>
        </div>
      </div>
    </div>

    <div id="mysteryBoxPopup" style="display: none;">
      <h3>Focus Mystery Box</h3>
      <p id="mysteryRewardText">Click to reveal your reward!</p>
      <button id="openMysteryBox">OPEN</button>
    </div>

    <div id="audioTracksStore" style="display: none;">
      <h3>AUDIO TRACKS STORE</h3>
      <p>Unlock exclusive Lo-Fi tracks to enhance your focus sessions!</p>
      <div id="audioTracksList"></div>
      <button id="closeAudioStore" style="background: #ff4444; margin-top: 15px;">CLOSE</button>
    </div>

    <div id="fireBox"></div>
    <div id="aiPopup">
      <iframe src="https://www.chatbase.co/chatbot-iframe/3dSdpryiYZlWipHUL8dNK" frameBorder="0"></iframe>
    </div>

    <audio id="focusAudio" preload="none" src="https://the-chosen-one-o5.github.io/UltraFocusModeYT/focus.mp3"></audio>
    <audio id="lofiAudio" preload="none" loop></audio>
    <audio id="pomodoroCompleteAudio" preload="none" src="https://www.dropbox.com/scl/fi/ihrcv1s3o4m4abhn6oa5z/level-up-4-243762.mp3?rlkey=qkaf4zrhipxtxpu51an0do45r&st=boipxpb5&dl=1"></audio>
  </div>

  <script>
    ;(() => {
      let currentVideoIndex = 0
      let player
      let videoIds = []
      let isFocusModeActive = false
      let countdownInterval
      let distractionCount = 0
      let points = 0
      let isSignedIn = false
      let currentUser = null
      const focusDuration = 50 * 60 * 1000
      const firstBreakDuration = 15 * 60 * 1000
      const secondBreakDuration = 10 * 60 * 1000
      let timerMode = "Focus Time"
      let timerRemaining = focusDuration / 1000
      let completedVideos = new Set()
      let allVideosCompleted = false
      let totalFocusTime = 0
      let totalDistractions = 0
      let totalVideosWatched = 0
      let playlists = JSON.parse(localStorage.getItem("playlists") || "[]")
      let tasks = JSON.parse(localStorage.getItem("tasks") || "[]")
      let previousPoints = 0
      let streakDays = 0
      let lastFocusDate = null
      let isYouTubeAPILoaded = false
      let lofiAudio
      const lofiSongs = [
        "https://www.dropbox.com/scl/fi/7qrgbk6vpej7x0ih7vev2/1-6_XRwBX7NX-1.mp3?rlkey=m3gntnys7az2hoq0iokkajucj&st=bmrhzjy8&dl=1",
        "https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1",
        "https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1",
        "https://www.dropbox.com/scl/fi/lb5f47widcz8mwhg79jiz/Kate-Grove-SKYRIM-THEME-skyrim-elderscrolls-ocarina.mp3?rlkey=f8kpm1ipyowc1wv998myu06us&st=bm9qmodf&dl=1",
        "https://www.dropbox.com/scl/fi/8wf64nv0rwubt7hbs5x20/Kurate-Music-Best-of-Gibran-Alcocer-Beautiful-Piano-Mix.mp3?rlkey=i776feuxag0ebullqe0kjo0gp&st=bb3uyo3h&dl=1",
        "https://www.dropbox.com/scl/fi/7xoemzmrgq0wzbxc9i9tp/Jumping-_brick-Sidewalks-and-skeletons-goth-slowed-reverb-best-part-loop.mp3?rlkey=d4dt6rv6sdzteextqek29geug&st=4umnyp0c&dl=1",
        "https://www.dropbox.com/scl/fi/macw47c2kvur0yfi4r9up/St3phen-If-Youre-A-Gamer-This-Song-FOUND-You.mp3?rlkey=qudky54311tppavhvnpra89ff&st=7dgshk5k&dl=1",
        "https://www.dropbox.com/scl/fi/c1iy5yjmf3d57jrb1aokc/KestrelTapes-what-nostalgia-sounds-like...mp3?rlkey=qcdj1vpdnzwdb03fxp0vk0661&st=fyqrl6ge&dl=1",
        "https://www.dropbox.com/scl/fi/p303xk68pvu8sfrmtwzj2/rhawn-there-is-hopecore.mp3?rlkey=m6tva7g4dsva39ii1l0e8tnu0&st=6z218pii&dl=1",
        "https://www.dropbox.com/scl/fi/bw4n0ne8nli4dkp7p26po/Jaob-not-just-another-hopecore-playlist.mp3?rlkey=jy0umwkadkxj9cju1yf2wz7hw&st=yjxhzw0s&dl=1",
        "https://www.dropbox.com/scl/fi/evhrjdri6a9n9bk05qhcu/Kyle-Dixon-Michael-Stei-Kids.mp3?rlkey=lauo50rz3indg5n3to5gfks1y&st=gcqmonsf&dl=1",
      ]
      
      // Premium audio tracks that can be unlocked
      const premiumLofiTracks = [
        { id: "track1", name: "Celestial Dreams", url: "https://www.dropbox.com/scl/fi/3xkks3j4tcmnloz46o03m/Kyle-Dixon-Michael-Stei-Kids.mp3?rlkey=6w97eurecqph68b8f2r7zn5pf&st=epeucz72&dl=1", unlocked: false, cost: 100 },
        { id: "track2", name: "Midnight Study", url: "https://www.dropbox.com/scl/fi/7vikjhsay7xayyab0tlvt/enchanted-metamorphosis-chronicles-264087.mp3?rlkey=mrdncvjr3g5bo8dksxywh9zxh&st=ui3kdsq5&dl=1", unlocked: false, cost: 100 },
        { id: "track3", name: "Rainy Day Focus", url: "https://www.dropbox.com/scl/fi/iaouozc1osse7h5ea9lon/thunder-chosic.com.mp3?rlkey=o7u0rarnh4kk657qhmcgyiolz&st=2r9f625j&dl=1", unlocked: false, cost: 100 },
        { id: "track4", name: "Epic Concentration", url: "https://www.dropbox.com/scl/fi/7vikjhsay7xayyab0tlvt/enchanted-metamorphosis-chronicles-264087.mp3?rlkey=mrdncvjr3g5bo8dksxywh9zxh&st=cq8j3dij&dl=1", unlocked: false, cost: 100 },
        { id: "track5", name: "Zen Garden", url: "https://www.dropbox.com/scl/fi/8wf64nv0rwubt7hbs5x20/Kurate-Music-Best-of-Gibran-Alcocer-Beautiful-Piano-Mix.mp3?rlkey=i776feuxag0ebullqe0kjo0gp&st=bb3uyo3h&dl=1", unlocked: false, cost: 100 },
      ]
      
      // Daily points tracking for calendar
      let dailyPointsData = {}
      let currentCalendarMonth = new Date().getMonth()
      let currentCalendarYear = new Date().getFullYear()
      
      let currentLofiIndex = 0
      let currentTaskForDeadline = null

      // Pomodoro variables
      let pomodoroInterval
      let pomodoroTimeRemaining = 60 * 60 // 60 minutes in seconds
      let isPomodoroActive = false
      let pomodoroStartTime = null
      let pomodoroPoints = 0

      // Reminder feature variables
      let reminderInterval
      let timeOnInputForm = 0
      const reminderIntervalTime = 20 * 60 * 1000 // 20 minutes in milliseconds
      const reminderThreshold = 20 * 60 * 1000 // 20 minutes threshold

      // Mystery Box and Power-Up feature variables
      let mysteryBoxCount = 0
      let activePowerUps = {
        doublePoints: { active: false, expiry: null },
        streakShield: { active: false, used: false, expiry: null },
      }
      const STREAK_SHIELD_COST = 800
      const STREAK_SHIELD_DURATION = 7 * 24 * 60 * 60 * 1000 // 1 week in milliseconds
      const DOUBLE_POINTS_COST = 800
      const DOUBLE_POINTS_DURATION = 24 * 60 * 60 * 1000 // 24 hours in milliseconds
      const MYSTERY_BOX_STREAK_INTERVAL = 14
      const mysteryBoxRewards = [
        { type: "points", value: () => Math.floor(Math.random() * 451) + 50, message: (val) => `+${val} XP` },
        { type: "doublePoints", value: DOUBLE_POINTS_DURATION, message: () => "Double Points for 24 Hours" },
        { type: "streakShield", value: 1, message: () => "1-Day Streak Shield" },
      ]

      const achievementLevels = [
        { points: 0, level: "Mortal", color: "white" },
        { points: 1000, level: "Soldier", color: "#4169E1" },
        { points: 2000, level: "Knight", color: "white", glow: true },
        { points: 3000, level: "KING", color: "#FF8C00", glow: true },
        { points: 4000, level: "GIGACHAD", color: "#FF4500", glow: true },
        { points: 5000, level: "Demigod", color: "gold", glow: true },
        { points: 6000, level: "Titan", color: "gold", glow: true, box: true },
        { points: 7000, level: "Immortal", color: "gold", glow: true, box: true, boxGlow: true },
        { points: 8000, level: "Celestial", color: "gold", glow: true, box: true, boxGlow: true },
        { points: 9000, level: "Divine", color: "rainbow" },
        { points: 10000, level: "Omnipotent", color: "rainbow", glow: true },
      ]

      // Function to update the navbar clock
      function updateNavbarClock() {
        const clockDisplay = document.getElementById("navbarClock")
        if (!clockDisplay) return

        const now = new Date()
        let hours = now.getHours()
        const minutes = now.getMinutes().toString().padStart(2, "0")
        const seconds = now.getSeconds().toString().padStart(2, "0")
        const period = hours >= 12 ? "PM" : "AM"
        hours = hours % 12 || 12
        hours = hours.toString().padStart(2, "0")
        clockDisplay.textContent = `${hours}:${minutes}:${seconds} ${period}`
      }

      // Function to update the current date
      function updateCurrentDate() {
        const dateDisplay = document.getElementById("currentDate")
        if (!dateDisplay) return

        const now = new Date()
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
        dateDisplay.textContent = now.toLocaleDateString('en-US', options)
      }

      // Function to update focus status
      function updateFocusStatus() {
        const focusStatus = document.getElementById("focusStatus")
        if (!focusStatus) return

        const incompleteTasks = tasks.filter(task => !task.completed).length
        
        if (incompleteTasks > 0) {
          focusStatus.textContent = `${incompleteTasks} task${incompleteTasks === 1 ? '' : 's'} left today`
        } else {
          focusStatus.textContent = "Ready to get in the zone?"
        }
      }

      // Function to update profile information
      function updateProfileInfo() {
        document.getElementById("profileUsername").textContent = currentUser || "Guest"
        document.getElementById("profileAvatar").textContent = currentUser ? currentUser.charAt(0).toUpperCase() : "G"
        document.getElementById("welcomeUsername").textContent = currentUser || "Hero"
        
        const level = getAchievementLevel(points)
        document.getElementById("profileLevel").textContent = level.level
        document.getElementById("profileXP").textContent = points
        document.getElementById("profileStreak").textContent = `${streakDays} day${streakDays === 1 ? "" : "s"}`
        document.getElementById("profileFocusTime").textContent = `${Math.floor(totalFocusTime / 60)} minutes`
        document.getElementById("profileVideosWatched").textContent = totalVideosWatched
        
        // Update streak tooltip and count
        document.getElementById("streakCount").textContent = streakDays
        document.querySelector(".streak-tooltip").textContent = `${streakDays}-day focus streak`
      }

      // Function to update focus stats
      function updateFocusStats() {
        document.getElementById("statsFocusTime").textContent = Math.floor(totalFocusTime / 60)
        document.getElementById("statsVideosWatched").textContent = totalVideosWatched
        document.getElementById("statsStreak").textContent = streakDays
        document.getElementById("statsDistractions").textContent = totalDistractions
        
        // Render calendar
        renderCalendar()
      }

      // Function to render calendar
      function renderCalendar() {
        const calendarGrid = document.getElementById("calendarGrid")
        if (!calendarGrid) return
        
        calendarGrid.innerHTML = ""
        
        // Add day headers
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]
        dayNames.forEach(day => {
          const dayHeader = document.createElement("div")
          dayHeader.className = "calendar-day-header"
          dayHeader.textContent = day
          calendarGrid.appendChild(dayHeader)
        })
        
        // Get first day of month and total days
        const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1)
        const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0)
        const totalDays = lastDay.getDate()
        const startingDayOfWeek = firstDay.getDay()
        
        // Add empty cells for days before first day of month
        for (let i = 0; i < startingDayOfWeek; i++) {
          const emptyDay = document.createElement("div")
          emptyDay.className = "calendar-day empty"
          calendarGrid.appendChild(emptyDay)
        }
        
        // Add days of the month
        const today = new Date()
        const isCurrentMonth = today.getMonth() === currentCalendarMonth && today.getFullYear() === currentCalendarYear
        
        for (let day = 1; day <= totalDays; day++) {
          const dayElement = document.createElement("div")
          dayElement.className = "calendar-day"
          
          // Check if this is today
          if (isCurrentMonth && today.getDate() === day) {
            dayElement.classList.add("today")
          }
          
          // Add date number
          const dateSpan = document.createElement("div")
          dateSpan.className = "date"
          dateSpan.textContent = day
          dayElement.appendChild(dateSpan)
          
          // Check if we have points data for this day
          const dateString = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`
          const dayPoints = dailyPointsData[dateString] || 0
          
          // Add points info
          const pointsSpan = document.createElement("div")
          pointsSpan.className = "points"
          pointsSpan.textContent = `${dayPoints} XP`
          dayElement.appendChild(pointsSpan)
          
          // Color based on points level
          const level = getPointsLevel(dayPoints)
          dayElement.classList.add(`level-${level}`)
          
          calendarGrid.appendChild(dayElement)
        }
      }

      // Function to get points level for calendar coloring
      function getPointsLevel(points) {
        if (points === 0) return 0
        if (points <= 50) return 0
        if (points <= 100) return 1
        if (points <= 200) return 2
        if (points <= 300) return 3
        return 4
      }

      // Function to navigate calendar
      function navigateCalendar(direction) {
        if (direction === "prev") {
          currentCalendarMonth--
          if (currentCalendarMonth < 0) {
            currentCalendarMonth = 11
            currentCalendarYear--
          }
        } else {
          currentCalendarMonth++
          if (currentCalendarMonth > 11) {
            currentCalendarMonth = 0
            currentCalendarYear++
          }
        }
        
        renderCalendar()
      }

      // Function to show page
      function showPage(pageId) {
        // Hide all pages
        document.getElementById("homePage").style.display = "none"
        document.getElementById("profilePage").style.display = "none"
        document.getElementById("focusStatsPage").style.display = "none"
        document.getElementById("todoPage").style.display = "none"
        document.getElementById("youtubePage").style.display = "none"
        document.getElementById("inputForm").style.display = "none"
        
        // Show the requested page
        document.getElementById(pageId).style.display = "block"
        
        // Update page-specific content
        if (pageId === "homePage") {
          updateCurrentDate()
          updateFocusStatus()
        } else if (pageId === "profilePage") {
          updateProfileInfo()
        } else if (pageId === "focusStatsPage") {
          updateFocusStats()
        } else if (pageId === "todoPage") {
          renderTodoList()
        } else if (pageId === "youtubePage") {
          // Setup YouTube page
          restoreUrlInputs()
        }
      }

      // Function to render todo list
      function renderTodoList() {
        const todoListContainer = document.getElementById("todoListContainer")
        if (!todoListContainer) return
        
        todoListContainer.innerHTML = ""
        
        tasks.forEach((task, index) => {
          const todoItem = document.createElement("div")
          todoItem.className = "todo-item"
          
          // Neon Checkbox
          const checkbox = document.createElement("label")
          checkbox.className = "neon-checkbox"
          
          const checkboxInput = document.createElement("input")
          checkboxInput.type = "checkbox"
          checkboxInput.checked = task.completed
          checkboxInput.addEventListener("change", () => {
            tasks[index].completed = checkboxInput.checked
            todoText.classList.toggle("completed", checkboxInput.checked)
            saveTasks()
          })
          
          const checkboxFrame = document.createElement("div")
          checkboxFrame.className = "neon-checkbox__frame"
          checkboxFrame.innerHTML = `
            <div class="neon-checkbox__box">
              <div class="neon-checkbox__check-container">
                <svg viewBox="0 0 24 24" class="neon-checkbox__check">
                  <path d="M3,12.5l7,7L21,5"></path>
                </svg>
              </div>
              <div class="neon-checkbox__glow"></div>
              <div class="neon-checkbox__borders">
                <span></span><span></span><span></span><span></span>
              </div>
            </div>
            <div class="neon-checkbox__effects">
              <div class="neon-checkbox__particles">
                <span></span><span></span><span></span><span></span> <span></span
                ><span></span><span></span><span></span> <span></span><span></span
                ><span></span><span></span>
              </div>
              <div class="neon-checkbox__rings">
                <div class="ring"></div>
                <div class="ring"></div>
                <div class="ring"></div>
              </div>
              <div class="neon-checkbox__sparks">
                <span></span><span></span><span></span><span></span>
              </div>
            </div>
          `
          
          checkbox.appendChild(checkboxInput)
          checkbox.appendChild(checkboxFrame)
          
          // Todo text
          const todoText = document.createElement("div")
          todoText.className = "todo-text"
          if (task.completed) todoText.classList.add("completed")
          todoText.textContent = task.text
          
          // Todo actions
          const todoActions = document.createElement("div")
          todoActions.className = "todo-actions"
          
          // Deadline button
          const deadlineBtn = document.createElement("button")
          deadlineBtn.className = "todo-action-btn"
          deadlineBtn.innerHTML = ""
          deadlineBtn.addEventListener("click", () => showDeadlineDialog(todoItem))
          
          // Delete button
          const deleteBtn = document.createElement("button")
          deleteBtn.className = "todo-action-btn delete"
          deleteBtn.innerHTML = ""
          deleteBtn.addEventListener("click", () => {
            tasks.splice(index, 1)
            saveTasks()
            renderTodoList()
          })
          
          todoActions.appendChild(deadlineBtn)
          todoActions.appendChild(deleteBtn)
          
          todoItem.appendChild(checkbox)
          todoItem.appendChild(todoText)
          
          // Add deadline info if exists
          if (task.deadline) {
            const deadlineDate = new Date(task.deadline)
            const deadlineInfo = document.createElement("div")
            deadlineInfo.className = "deadline-info"
            deadlineInfo.textContent = `Due: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`
            todoItem.appendChild(deadlineInfo)
            
            const pointsInfo = document.createElement("div")
            pointsInfo.className = "points-info"
            pointsInfo.textContent = `+${task.points || 50}pts`
            todoItem.appendChild(pointsInfo)
          }
          
          todoItem.appendChild(todoActions)
          todoListContainer.appendChild(todoItem)
        })
      }

      // Function to add a new todo
      function addTodo() {
        const todoInput = document.getElementById("todoInput")
        if (!todoInput || !todoInput.value.trim()) return
        
        const newTask = {
          text: todoInput.value.trim(),
          completed: false,
          deadline: null,
          points: null,
          deadlineChecked: false
        }
        
        tasks.push(newTask)
        saveTasks()
        todoInput.value = ""
        renderTodoList()
        updateFocusStatus()
      }

      function initAudio() {
        lofiAudio = document.getElementById("lofiAudio")
        if (lofiAudio) {
          lofiAudio.loop = true
          lofiAudio.src = lofiSongs[currentLofiIndex]
        }
      }

      function getAchievementLevel(points) {
        let currentLevel = achievementLevels[0]
        for (const level of achievementLevels) {
          if (points >= level.points) currentLevel = level
          else break
        }
        return currentLevel
      }

      function updateAchievementLevel() {
        const achievementDiv = document.getElementById("achievementLevel")
        if (!achievementDiv) return

        const level = getAchievementLevel(points)
        let style = `color: ${level.color}; font-weight: bold;`
        if (level.glow) style += " text-shadow: 0 0 10px;"
        if (level.box) style += " border: 2px solid gold; padding: 5px;"
        if (level.boxGlow) style += " box-shadow: 0 0 10px gold;"
        if (level.color === "rainbow") achievementDiv.classList.add("rainbow")
        else achievementDiv.classList.remove("rainbow")
        achievementDiv.innerHTML = level.level
        achievementDiv.style = style
        updateSidebarDashboard()
      }

      function showAchievementOverlay(level) {
        const overlay = document.getElementById("achievementOverlay")
        if (!overlay) return

        overlay.textContent = `LEVEL UP! ${level.toUpperCase()} UNLOCKED!`
        overlay.style.display = "flex"
        setTimeout(() => overlay.style.display = "none", 5000)
      }

      function updateClock() {
        const clockDisplay = document.getElementById("clockDisplay")
        if (!clockDisplay) return

        const now = new Date()
        let hours = now.getHours()
        const minutes = now.getMinutes().toString().padStart(2, "0")
        const seconds = now.getSeconds().toString().padStart(2, "0")
        const period = hours >= 12 ? "PM" : "AM"
        hours = hours % 12 || 12
        hours = hours.toString().padStart(2, "0")
        clockDisplay.innerHTML = `<span class="time">${hours}:${minutes}:${seconds}</span> <span class="period">${period}</span>`
      }

      function playLofi() {
        if (!lofiAudio) return
        lofiAudio.play().catch((err) => console.error("Lofi play error:", err))
      }

      function pauseLofi() {
        if (!lofiAudio) return
        lofiAudio.pause()
      }

      function prevLofi() {
        if (!lofiAudio) return
        currentLofiIndex = (currentLofiIndex - 1 + lofiSongs.length) % lofiSongs.length
        lofiAudio.src = lofiSongs[currentLofiIndex]
        playLofi()
      }

      function nextLofi() {
        if (!lofiAudio) return
        currentLofiIndex = (currentLofiIndex + 1) % lofiSongs.length
        lofiAudio.src = lofiSongs[currentLofiIndex]
        playLofi()
      }

      function toggleSitesPopup() {
        const popup = document.getElementById("sitesPopup")
        if (!popup) return
        popup.style.display = popup.style.display === "block" ? "none" : "block"
      }

      function closeSitesPopup() {
        const popup = document.getElementById("sitesPopup")
        if (!popup) return
        popup.style.display = "none"
      }

      function updateStreak() {
        const streakDisplay = document.getElementById("streakDisplay")
        if (!streakDisplay) return

        const today = new Date().toDateString()
        const lastDate = localStorage.getItem("lastFocusDate")

        if (lastDate) {
          const last = new Date(lastDate)
          const diffTime = new Date(today) - last
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))

          if (diffDays === 1) {
            streakDays++
            checkMysteryBoxMilestone()
          } else if (diffDays > 1) {
            if (activePowerUps.streakShield.active && Date.now() < activePowerUps.streakShield.expiry) {
              streakDays++
              alert("Streak Shield protected your streak!")
            } else {
              streakDays = 0 // Reset streak if no focus session and no active shield
            }
          }
        } else {
          streakDays = 1 // First focus session
        }

        localStorage.setItem("lastFocusDate", today)
        streakDisplay.innerHTML = `<span style="color: #8e2de2;"></span> ${streakDays} day${streakDays === 1 ? "" : "s"} of focus`

        if (isSignedIn && currentUser) {
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          users[currentUser].streakDays = streakDays
          users[currentUser].mysteryBoxCount = mysteryBoxCount
          users[currentUser].activePowerUps = activePowerUps
          localStorage.setItem("users", JSON.stringify(users))
        }

        const sidebarStreak = document.getElementById("sidebarStreak")
        if (sidebarStreak) sidebarStreak.textContent = `${streakDays} day${streakDays === 1 ? "" : "s"}`
      }

      function checkMysteryBoxMilestone() {
        if (streakDays > 0 && streakDays % MYSTERY_BOX_STREAK_INTERVAL === 0) {
          mysteryBoxCount++
          showMysteryBoxPopup()
          saveState()
        }
      }

      function showMysteryBoxPopup() {
        const popup = document.getElementById("mysteryBoxPopup")
        const rewardText = document.getElementById("mysteryRewardText")
        if (!popup || !rewardText) return

        rewardText.textContent = `You earned a Focus Mystery Box! (${mysteryBoxCount} available)`
        popup.style.display = "block"
      }

      function openMysteryBox() {
        if (mysteryBoxCount <= 0) return

        const popup = document.getElementById("mysteryBoxPopup")
        const rewardText = document.getElementById("mysteryRewardText")
        if (!popup || !rewardText) return

        const reward = mysteryBoxRewards[Math.floor(Math.random() * mysteryBoxRewards.length)]
        let rewardValue = reward.value instanceof Function ? reward.value() : reward.value

        switch (reward.type) {
          case "points":
            points += rewardValue
            break
          case "doublePoints":
            activePowerUps.doublePoints.active = true
            activePowerUps.doublePoints.expiry = Date.now() + rewardValue
            setTimeout(() => {
              activePowerUps.doublePoints.active = false
              saveState()
              alert("Double Points power-up has expired!")
            }, rewardValue)
            break
          case "streakShield":
            activePowerUps.streakShield.active = true
            activePowerUps.streakShield.used = false
            activePowerUps.streakShield.expiry = Date.now() + STREAK_SHIELD_DURATION
            setTimeout(() => {
              activePowerUps.streakShield.active = false
              saveState()
              alert("Streak Shield has expired!")
            }, STREAK_SHIELD_DURATION)
            break
        }

        rewardText.textContent = `Reward: ${reward.message(rewardValue)}`
        mysteryBoxCount--
        document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
        saveState()

        setTimeout(() => {
          if (mysteryBoxCount > 0) showMysteryBoxPopup()
          else popup.style.display = "none"
        }, 2000)
      }

      function applyPowerUps(pointsEarned) {
        if (activePowerUps.doublePoints.active && Date.now() < activePowerUps.doublePoints.expiry) {
          return pointsEarned * 2
        }
        return pointsEarned
      }

      function showStreakShieldDialog() {
        const dialog = document.getElementById("streakShieldDialog")
        if (!dialog) return
        if (points < STREAK_SHIELD_COST) {
          alert("Not enough XP! You need 800 XP to buy a Streak Shield.")
          return
        }
        dialog.style.display = "block"
      }

      function handleStreakShieldConfirmation(choice) {
        const dialog = document.getElementById("streakShieldDialog")
        if (!dialog) return

        dialog.style.display = "none"
        if (choice === "yes") {
          points -= STREAK_SHIELD_COST
          activePowerUps.streakShield.active = true
          activePowerUps.streakShield.used = false
          activePowerUps.streakShield.expiry = Date.now() + STREAK_SHIELD_DURATION
          document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
          alert("Streak Shield activated for 1 week!")
          saveState()
          setTimeout(() => {
            activePowerUps.streakShield.active = false
            saveState()
            alert("Your Streak Shield has expired!")
          }, STREAK_SHIELD_DURATION)
        }
      }

      function showDoublePointsDialog() {
        const dialog = document.getElementById("doublePointsDialog")
        if (!dialog) return
        if (points < DOUBLE_POINTS_COST) {
          alert("Not enough XP! You need 800 XP to buy Double Points Power-Up.")
          return
        }
        dialog.style.display = "block"
      }

      function handleDoublePointsConfirmation(choice) {
        const dialog = document.getElementById("doublePointsDialog")
        if (!dialog) return

        dialog.style.display = "none"
        if (choice === "yes") {
          points -= DOUBLE_POINTS_COST
          activePowerUps.doublePoints.active = true
          activePowerUps.doublePoints.expiry = Date.now() + DOUBLE_POINTS_DURATION
          document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
          alert("Double Points Power-Up activated for 24 hours!")
          saveState()
          setTimeout(() => {
            activePowerUps.doublePoints.active = false
            saveState()
            alert("Your Double Points Power-Up has expired!")
          }, DOUBLE_POINTS_DURATION)
        }
      }

      // Pomodoro functions
      function showPomodoroOverlay() {
        const overlay = document.getElementById("pomodoroOverlay")
        if (!overlay) return
        
        // Reset pomodoro timer to 60 minutes
        pomodoroTimeRemaining = 60 * 60
        updatePomodoroDisplay()
        
        overlay.style.display = "flex"
        document.getElementById("pomodoroStatus").textContent = "Ready to begin"
      }

      function startPomodoro() {
        if (isPomodoroActive) return
        
        isPomodoroActive = true
        pomodoroStartTime = Date.now()
        document.getElementById("pomodoroStatus").textContent = "Focus in progress..."
        
        pomodoroInterval = setInterval(() => {
          pomodoroTimeRemaining--
          updatePomodoroDisplay()
          
          if (pomodoroTimeRemaining <= 0) {
            completePomodoroSession()
          }
        }, 1000)
      }

      function resetPomodoro() {
        clearInterval(pomodoroInterval)
        isPomodoroActive = false
        pomodoroTimeRemaining = 60 * 60
        pomodoroStartTime = null
        updatePomodoroDisplay()
        document.getElementById("pomodoroStatus").textContent = "Timer reset"
      }

      function closePomodoroOverlay() {
        const overlay = document.getElementById("pomodoroOverlay")
        if (!overlay) return
        
        if (isPomodoroActive) {
          if (confirm("Pomodoro session in progress. Are you sure you want to exit?")) {
            clearInterval(pomodoroInterval)
            isPomodoroActive = false
            overlay.style.display = "none"
            
            // Ensure all menu buttons are clickable after closing
            setTimeout(() => {
              reattachEventListeners()
            }, 100)
          }
        } else {
          overlay.style.display = "none"
          
          // Ensure all menu buttons are clickable after closing
          setTimeout(() => {
            reattachEventListeners()
          }, 100)
        }
      }

      // Function to reattach event listeners after pomodoro closes
      function reattachEventListeners() {
        document.getElementById("streakShieldBtn").onclick = showStreakShieldDialog
        document.getElementById("doublePointsBtn").onclick = showDoublePointsDialog
        document.getElementById("audioStoreBtn").onclick = showAudioTracksStore
        document.getElementById("quietPomodoroBtn").onclick = showPomodoroOverlay
        document.getElementById("logoutBtn").onclick = logout
      }

      function updatePomodoroDisplay() {
        const timerElement = document.getElementById("pomodoroTimer")
        if (!timerElement) return
        
        const minutes = Math.floor(pomodoroTimeRemaining / 60)
        const seconds = pomodoroTimeRemaining % 60
        
        timerElement.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`
      }

      function completePomodoroSession() {
        clearInterval(pomodoroInterval)
        isPomodoroActive = false
        
        // Play completion sound
        const audio = document.getElementById("pomodoroCompleteAudio")
        if (audio) audio.play().catch(err => console.error("Pomodoro audio error:", err))
        
        // Calculate points (1 point per minute)
        const minutesCompleted = 60 - Math.floor(pomodoroTimeRemaining / 60)
        const pointsEarned = applyPowerUps(minutesCompleted)
        points += pointsEarned
        
        document.getElementById("pomodoroStatus").textContent = `Completed! Earned ${pointsEarned} XP`
        document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
        
        saveState()
        checkLevelUp()
      }

      // Reminder feature functions
      function startReminderTimer() {
        const inputForm = document.getElementById("inputForm")
        if (inputForm.style.display !== "block") {
          stopReminderTimer()
          timeOnInputForm = 0
          return
        }

        reminderInterval = setInterval(() => {
          timeOnInputForm += reminderIntervalTime
          if (timeOnInputForm >= reminderThreshold) {
            if ("Notification" in window && Notification.permission === "granted") {
              new Notification("Check Your To-Do List!", {
                body: "Hey hero, don't forget to review your quests!",
                icon: "https://img.icons8.com/ios-filled/50/ffffff/checklist.png",
              })
            } else if ("Notification" in window && Notification.permission !== "denied") {
              Notification.requestPermission().then((permission) => {
                if (permission === "granted") {
                  new Notification("Check Your To-Do List!", {
                    body: "Hey hero, don't forget to review your quests!",
                    icon: "https://img.icons8.com/ios-filled/50/ffffff/checklist.png",
                  })
                } else {
                  alert("Reminder: Check your to-do list!")
                }
              })
            } else {
              alert("Reminder: Check your to-do list!")
            }
          }
        }, reminderIntervalTime)
      }

      function stopReminderTimer() {
        if (reminderInterval) {
          clearInterval(reminderInterval)
          reminderInterval = null
        }
      }

      // Task deadline functions
      function showDeadlineDialog(taskElement) {
        const dialog = document.getElementById("deadlineDialog")
        if (!dialog) return
        
        currentTaskForDeadline = taskElement
        
        // Set default date to tomorrow
        const tomorrow = new Date()
        tomorrow.setDate(tomorrow.getDate() + 1)
        const dateInput = document.getElementById("deadlineDate")
        dateInput.value = tomorrow.toISOString().split('T')[0]
        
        // Set default time to current time
        const timeInput = document.getElementById("deadlineTime")
        const now = new Date()
        timeInput.value = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`
        
        dialog.style.display = "block"
      }

      function handleDeadlineConfirmation(choice) {
        const dialog = document.getElementById("deadlineDialog")
        if (!dialog || !currentTaskForDeadline) return

        dialog.style.display = "none"
        
        if (choice === "yes") {
          const dateInput = document.getElementById("deadlineDate").value
          const timeInput = document.getElementById("deadlineTime").value
          const difficultySelect = document.getElementById("taskDifficulty")
          const points = difficultySelect.value
          
          const deadlineDate = new Date(`${dateInput}T${timeInput}`)
          
          // Add deadline info to the task
          const deadlineInfo = document.createElement("span")
          deadlineInfo.className = "deadline-info"
          deadlineInfo.textContent = `Due: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`
          
          const pointsInfo = document.createElement("span")
          pointsInfo.className = "points-info"
          pointsInfo.textContent = `+${points}pts`
          
          // Remove existing deadline info if any
          const existingDeadline = currentTaskForDeadline.querySelector(".deadline-info")
          if (existingDeadline) existingDeadline.remove()
          
          const existingPoints = currentTaskForDeadline.querySelector(".points-info")
          if (existingPoints) existingPoints.remove()
          
          currentTaskForDeadline.appendChild(deadlineInfo)
          currentTaskForDeadline.appendChild(pointsInfo)
          
          // Store deadline in task data
          const taskIndex = Array.from(document.querySelectorAll(".task-line")).indexOf(currentTaskForDeadline)
          if (taskIndex !== -1 && tasks[taskIndex]) {
            tasks[taskIndex].deadline = deadlineDate.getTime()
            tasks[taskIndex].points = parseInt(points)
            saveTasks()
          }
        }
        
        currentTaskForDeadline = null
      }

      function checkTaskDeadlines() {
        const now = Date.now()
        let tasksUpdated = false
        
        tasks.forEach((task, index) => {
          // Skip tasks without deadlines or already completed
          if (!task.deadline || task.deadlineChecked) return
          
          if (now > task.deadline) {
            // Deadline passed
            if (task.completed) {
              // Task was completed on time
              const earnedPoints = task.points || 50
              points += applyPowerUps(earnedPoints)
              alert(`Task "${task.text}" completed on time! +${earnedPoints} XP`)
            } else {
              // Task was not completed on time
              const lostPoints = Math.floor((task.points || 50) / 2)
              alert(`Task "${task.text}" deadline missed! -${lostPoints} XP`)
              points = Math.max(0, points - lostPoints)
            }
            
            // Mark as checked so we don't process it again
            tasks[index].deadlineChecked = true
            tasksUpdated = true
            
            document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
          }
        })
        
        if (tasksUpdated) {
          saveTasks()
          saveState()
        }
      }

      // Audio tracks store functions
      function showAudioTracksStore() {
        const store = document.getElementById("audioTracksStore")
        const tracksList = document.getElementById("audioTracksList")
        if (!store || !tracksList) return
        
        tracksList.innerHTML = ""
        
        premiumLofiTracks.forEach(track => {
          const trackItem = document.createElement("div")
          trackItem.className = `audio-track-item ${track.unlocked ? 'unlocked' : 'locked'}`
          
          const trackName = document.createElement("div")
          trackName.className = "track-name"
          trackName.textContent = track.name
          
          const unlockBtn = document.createElement("button")
          unlockBtn.className = "unlock-track-btn"
          
          if (track.unlocked) {
            unlockBtn.textContent = "UNLOCKED"
            unlockBtn.disabled = true
          } else {
            unlockBtn.textContent = `UNLOCK (${track.cost} XP)`
            unlockBtn.disabled = points < track.cost
            unlockBtn.onclick = () => unlockAudioTrack(track.id)
          }
          
          trackItem.appendChild(trackName)
          trackItem.appendChild(unlockBtn)
          tracksList.appendChild(trackItem)
        })
        
        store.style.display = "block"
      }

      function closeAudioTracksStore() {
        const store = document.getElementById("audioTracksStore")
        if (store) store.style.display = "none"
      }

      function unlockAudioTrack(trackId) {
        const track = premiumLofiTracks.find(t => t.id === trackId)
        if (!track || track.unlocked || points < track.cost) return
        
        // Deduct points and unlock the track
        points -= track.cost
        track.unlocked = true
        
        // Add to lofi songs if not already there
        if (!lofiSongs.includes(track.url)) {
          lofiSongs.push(track.url)
        }
        
        document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
        alert(`Successfully unlocked "${track.name}"!`)
        
        // Update the store display
        showAudioTracksStore()
        saveState()
      }

      // Session complete dialog
      function showSessionCompleteDialog() {
        const dialog = document.getElementById("sessionCompleteDialog")
        if (!dialog) return
        dialog.style.display = "block"
      }

      function handleSessionContinue(choice) {
        const dialog = document.getElementById("sessionCompleteDialog")
        if (!dialog) return
        
        dialog.style.display = "none"
        
        if (choice === "continue") {
          // Award bonus points
          points += applyPowerUps(100)
          document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
          
          // Start a new focus session
          startTimer(focusDuration, "Focus Time")
        } else {
          // End the session
          endFocusSession()
        }
        
        saveState()
      }

      function loadSavedState() {
        try {
          const savedState = localStorage.getItem("focusModeState")
          if (savedState) {
            const progressBar = document.getElementById("progressBar")
            if (progressBar) progressBar.style.display = "none"

            const state = JSON.parse(savedState)
            videoIds = state.videoIds || []
            currentVideoIndex = state.currentVideoIndex || 0
            distractionCount = state.distractionCount || 0
            points = state.points || 0
            timerMode = state.timerMode || "Focus Time"
            timerRemaining = state.timerRemaining || focusDuration / 1000
            isFocusModeActive = state.isFocusModeActive || false
            isSignedIn = state.isSignedIn || false
            currentUser = state.currentUser || null
            completedVideos = new Set(state.completedVideos || [])
            allVideosCompleted = state.allVideosCompleted || false
            totalFocusTime = state.totalFocusTime || 0
            totalDistractions = state.totalDistractions || 0
            totalVideosWatched = state.totalVideosWatched || 0
            streakDays = state.streakDays || 0
            lastFocusDate = state.lastFocusDate || null
            mysteryBoxCount = state.mysteryBoxCount || 0
            activePowerUps = state.activePowerUps || {
              doublePoints: { active: false, expiry: null },
              streakShield: { active: false, used: false, expiry: null },
            }
            
            // Load premium tracks state
            if (state.premiumLofiTracks) {
              state.premiumLofiTracks.forEach(savedTrack => {
                const track = premiumLofiTracks.find(t => t.id === savedTrack.id)
                if (track) {
                  track.unlocked = savedTrack.unlocked
                  if (track.unlocked && !lofiSongs.includes(track.url)) {
                    lofiSongs.push(track.url)
                  }
                }
              })
            }

            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            if (isSignedIn && currentUser) {
              document.getElementById("landingPage").style.display = "none"
              document.getElementById("signinForm").style.display = "none"
              document.getElementById("inputForm").style.display = "block"
              document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
              document.getElementById("clockDisplay").style.display = "block"
              document.getElementById("sitesBox").style.display = "none" // Keep Allied Realms hidden on input page
              document.getElementById("lofiPlayer").style.display = "block"
              restoreUrlInputs()
              populatePlaylistSelect()
              restoreTasks()
              startReminderTimer()
              if (mysteryBoxCount > 0) showMysteryBoxPopup()
            }
            if (videoIds.length > 0) {
              document.getElementById("inputForm").style.display = "none"
              document.getElementById("player").style.display = "block"
              document.getElementById("restartBtn").style.display = "block"
              document.getElementById("pdfToggle").style.display = "block"
              document.getElementById("clockDisplay").style.display = "none"
              document.getElementById("sitesBox").style.display = "none"
              document.getElementById("lofiPlayer").style.display = "none"
              stopReminderTimer()
              loadYouTubeAPI()
                .then(() => {
                  setupYouTubePlayer()
                  if (isFocusModeActive) startTimer(timerRemaining * 1000, timerMode)
                })
                .catch((err) => console.error("YouTube API load failed:", err))
            }
          } else {
            document.getElementById("landingPage").style.display = "block"
            document.getElementById("signinForm").style.display = "none"
            document.getElementById("inputForm").style.display = "none"
            document.getElementById("clockDisplay").style.display = "none"
            document.getElementById("sitesBox").style.display = "none"
            document.getElementById("lofiPlayer").style.display = "none"
            stopReminderTimer()
            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            restoreTasks()
          }
        } catch (err) {
          console.error("Load saved state error:", err)
        }
      }

      function redirectToPYQs() {
        window.open("https://room.examgoal.com/", "_blank")
      }

      function showSignIn() {
        document.getElementById("landingPage").style.display = "none"
        document.getElementById("signinForm").style.display = "block"
        document.getElementById("inputForm").style.display = "none"
        document.getElementById("clockDisplay").style.display = "none"
        document.getElementById("sitesBox").style.display = "none"
        document.getElementById("lofiPlayer").style.display = "none"
        stopReminderTimer()
      }

      function signIn() {
        try {
          const username = document.getElementById("username").value
          const password = document.getElementById("password").value
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          if (users[username] && users[username].password === password) {
            isSignedIn = true
            currentUser = username
            points = users[username].points || 0
            totalFocusTime = users[username].totalFocusTime || 0
            totalDistractions = users[username].totalDistractions || 0
            totalVideosWatched = users[username].totalVideosWatched || 0
            tasks = users[username].tasks || []
            streakDays = users[username].streakDays || 0
            mysteryBoxCount = users[username].mysteryBoxCount || 0
            activePowerUps = users[username].activePowerUps || {
              doublePoints: { active: false, expiry: null },
              streakShield: { active: false, used: false, expiry: null },
            }
            
            // Load premium tracks
            if (users[username].premiumLofiTracks) {
              users[username].premiumLofiTracks.forEach(savedTrack => {
                const track = premiumLofiTracks.find(t => t.id === savedTrack.id)
                if (track) {
                  track.unlocked = savedTrack.unlocked
                  if (track.unlocked && !lofiSongs.includes(track.url)) {
                    lofiSongs.push(track.url)
                  }
                }
              })
            }
            
            document.getElementById("landingPage").style.display = "none"
            document.getElementById("signinForm").style.display = "none"
            document.getElementById("inputForm").style.display = "block"
            document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
            document.getElementById("clockDisplay").style.display = "block"
            document.getElementById("sitesBox").style.display = "none" // Keep Allied Realms hidden on input page
            document.getElementById("lofiPlayer").style.display = "block"
            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            saveState()
            populatePlaylistSelect()
            restoreTasks()
            startReminderTimer()
            if (mysteryBoxCount > 0) showMysteryBoxPopup()
            updateSidebarDashboard()
          } else alert("Invalid username or password")
        } catch (err) {
          console.error("Sign-in error:", err)
          alert("Error during sign-in. Please try again.")
        }
      }

      function createAccount() {
        try {
          const username = document.getElementById("username").value
          const password = document.getElementById("password").value
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          if (users[username]) alert("Username already exists")
          else if (username && password) {
            users[username] = {
              password,
              points: 0,
              totalFocusTime: 0,
              totalDistractions: 0,
              totalVideosWatched: 0,
              tasks: [],
              streakDays: 0,
              mysteryBoxCount: 0,
              activePowerUps: {
                doublePoints: { active: false, expiry: null },
                streakShield: { active: false, used: false, expiry: null },
              },
              premiumLofiTracks: premiumLofiTracks.map(track => ({
                id: track.id,
                unlocked: false
              }))
            }
            localStorage.setItem("users", JSON.stringify(users))
            isSignedIn = true
            currentUser = username
            points = 0
            totalFocusTime = 0
            totalDistractions = 0
            totalVideosWatched = 0
            tasks = []
            streakDays = 0
            mysteryBoxCount = 0
            activePowerUps = {
              doublePoints: { active: false, expiry: null },
              streakShield: { active: false, used: false, expiry: null },
            }
            document.getElementById("landingPage").style.display = "none"
            document.getElementById("signinForm").style.display = "none"
            document.getElementById("inputForm").style.display = "block"
            document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${points}`
            document.getElementById("clockDisplay").style.display = "block"
            document.getElementById("sitesBox").style.display = "none" // Keep Allied Realms hidden on input page
            document.getElementById("lofiPlayer").style.display = "block"
            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            saveState()
            populatePlaylistSelect()
            restoreTasks()
            startReminderTimer()
            updateSidebarDashboard()
          } else alert("Please enter a username and password")
        } catch (err) {
          console.error("Account creation error:", err)
          alert("Error creating account. Please try again.")
        }
      }

      function addUrlInput() {
        const urlInputs = document.getElementById("urlInputs")
        if (!urlInputs) return

        const container = document.createElement("div")
        container.className = "url-container"
        const newInput = document.createElement("input")
        newInput.type = "text"
        newInput.className = "youtube-url"
        newInput.placeholder = "YouTube URL (Videos or Live Streams)"
        const removeBtn = document.createElement("button")
        removeBtn.textContent = "X"
        removeBtn.onclick = () => {
          if (urlInputs.children.length > 1) urlInputs.removeChild(container)
        }
        container.appendChild(newInput)
        container.appendChild(removeBtn)
        urlInputs.appendChild(container)
      }

      function restoreUrlInputs() {
        const urlInputs = document.getElementById("urlInputs")
        if (!urlInputs) return

        urlInputs.innerHTML = ""
        videoIds.forEach((id, index) => {
          const container = document.createElement("div")
          container.className = "url-container"
          const input = document.createElement("input")
          input.type = "text"
          input.className = "youtube-url"
          input.placeholder = "YouTube URL (Videos or Live Streams)"
          input.value = `https://www.youtube.com/watch?v=${id}`
          container.appendChild(input)
          if (index > 0) {
            const removeBtn = document.createElement("button")
            removeBtn.textContent = "X"
            removeBtn.onclick = () => {
              if (urlInputs.children.length > 1) urlInputs.removeChild(container)
            }
            container.appendChild(removeBtn)
          }
          urlInputs.appendChild(container)
        })
        if (videoIds.length === 0) {
          const container = document.createElement("div")
          container.className = "url-container"
          const input = document.createElement("input")
          input.type = "text"
          input.className = "youtube-url"
          input.placeholder = "YouTube URL (Videos or Live Streams)"
          input.required = true
          container.appendChild(input)
          urlInputs.appendChild(container)
        }
      }

      function addTaskLine() {
        const tasksDiv = document.getElementById("tasks")
        if (!tasksDiv) return null

        const container = document.createElement("div")
        container.className = "task-line"
        const checkbox = document.createElement("input")
        checkbox.type = "checkbox"
        checkbox.className = "task-check"
        checkbox.onchange = () => saveTasks()
        const input = document.createElement("input")
        input.type = "text"
        input.className = "task-text"
        input.placeholder = "Write a task..."
        input.onkeydown = (e) => {
          if (e.key === "Enter") {
            e.preventDefault()
            const newInput = addTaskLine()
            if (newInput) newInput.focus()
          }
        }
        input.onchange = () => saveTasks()
        
        const deadlineBtn = document.createElement("button")
        deadlineBtn.className = "set-deadline"
        deadlineBtn.textContent = ""
        deadlineBtn.onclick = () => showDeadlineDialog(container)
        
        const removeBtn = document.createElement("span")
        removeBtn.className = "remove-task"
        removeBtn.textContent = "x"
        removeBtn.onclick = () => removeTask(removeBtn)
        
        container.appendChild(checkbox)
        container.appendChild(input)
        container.appendChild(deadlineBtn)
        container.appendChild(removeBtn)
        tasksDiv.appendChild(container)
        return input
      }

      function removeTask(element) {
        const tasksDiv = document.getElementById("tasks")
        if (!tasksDiv || !element || !element.parentElement) return

        if (tasksDiv.children.length > 1) {
          tasksDiv.removeChild(element.parentElement)
          saveTasks()
        }
      }

      function restoreTasks() {
        const tasksDiv = document.getElementById("tasks")
        if (!tasksDiv) return

        tasksDiv.innerHTML = ""
        if (tasks.length === 0) addTaskLine()
        else {
          tasks.forEach((task) => {
            const container = document.createElement("div")
            container.className = "task-line"
            
            const checkbox = document.createElement("input")
            checkbox.type = "checkbox"
            checkbox.className = "task-check"
            checkbox.checked = task.completed
            checkbox.onchange = () => saveTasks()
            
            const input = document.createElement("input")
            input.type = "text"
            input.className = "task-text"
            input.value = task.text
            input.placeholder = "Write a task..."
            input.onchange = () => saveTasks()
            
            const deadlineBtn = document.createElement("button")
            deadlineBtn.className = "set-deadline"
            deadlineBtn.textContent = ""
            deadlineBtn.onclick = () => showDeadlineDialog(container)
            
            const removeBtn = document.createElement("span")
            removeBtn.className = "remove-task"
            removeBtn.textContent = "x"
            removeBtn.onclick = () => removeTask(removeBtn)
            
            container.appendChild(checkbox)
            container.appendChild(input)
            container.appendChild(deadlineBtn)
            container.appendChild(removeBtn)
            
            // Add deadline info if exists
            if (task.deadline) {
              const deadlineDate = new Date(task.deadline)
              const deadlineInfo = document.createElement("span")
              deadlineInfo.className = "deadline-info"
              deadlineInfo.textContent = `Due: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`
              container.appendChild(deadlineInfo)
              
              const pointsInfo = document.createElement("span")
              pointsInfo.className = "points-info"
              pointsInfo.textContent = `+${task.points || 50}pts`
              container.appendChild(pointsInfo)
            }
            
            tasksDiv.appendChild(container)
          })
        }
        
        // Check for any passed deadlines
        checkTaskDeadlines()
      }

      function saveTasks() {
        const taskLines = document.querySelectorAll(".task-line")
        if (!taskLines.length) return

        tasks = Array.from(taskLines)
          .map((line) => {
            const checkbox = line.querySelector(".task-check")
            const input = line.querySelector(".task-text")
            const deadlineInfo = line.querySelector(".deadline-info")
            const pointsInfo = line.querySelector(".points-info")
            
            // Get existing task to preserve deadline if it exists
            const taskIndex = Array.from(document.querySelectorAll(".task-line")).indexOf(line)
            const existingTask = tasks[taskIndex] || {}
            
            return {
              text: input ? input.value.trim() : "",
              completed: checkbox ? checkbox.checked : false,
              deadline: existingTask.deadline || null,
              points: existingTask.points || null,
              deadlineChecked: existingTask.deadlineChecked || false
            }
          })
          .filter((task) => task.text !== "")
        localStorage.setItem("tasks", JSON.stringify(tasks))
        if (isSignedIn && currentUser) {
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          users[currentUser].tasks = tasks
          localStorage.setItem("users", JSON.stringify(users))
        }
      }

      function toggleTodo() {
        const todoList = document.getElementById("todoList")
        if (!todoList) return
        todoList.style.display = todoList.style.display === "block" ? "none" : "block"
      }

      function extractVideoId(url) {
        try {
          let videoId = null
          const urlObj = new URL(url)
          const hostname = urlObj.hostname.toLowerCase()
          const pathname = urlObj.pathname
          const searchParams = urlObj.searchParams

          if (hostname.includes("youtube.com")) {
            if (pathname === "/watch") {
              videoId = searchParams.get("v")
            } else if (pathname.startsWith("/live/")) {
              videoId = pathname.split("/live/")[1].split("?")[0]
            } else if (pathname.startsWith("/shorts/")) {
              videoId = pathname.split("/shorts/")[1].split("?")[0]
            } else if (pathname.startsWith("/embed/")) {
              videoId = pathname.split("/embed/")[1].split("?")[0]
            }
          } else if (hostname.includes("youtu.be")) {
            videoId = pathname.substring(1).split("?")[0] // Remove leading '/'
          }

          // Basic validation for video ID format (typically 11 chars, can vary for live)
          if (videoId && /^[a-zA-Z0-9_-]+$/.test(videoId)) {
             // Further check length, maybe 11 chars for standard videos
             // Live stream IDs can vary, so a simple character check is often enough
             if (videoId.length >= 11) {
                 return videoId;
             }
          }
          return null; // Return null if no valid ID found or doesn't meet basic criteria

        } catch (error) {
          console.error("Error parsing URL:", error, url)
          return null // Return null if URL parsing fails
        }
      }

      function loadYouTubeAPI() {
        return new Promise((resolve, reject) => {
          if (isYouTubeAPILoaded) {
            resolve()
            return
          }
          const tag = document.createElement("script")
          tag.src = "https://www.youtube.com/iframe_api"
          tag.onload = () => {
            isYouTubeAPILoaded = true
            resolve()
          }
          tag.onerror = (err) => reject(err)
          document.body.appendChild(tag)
        })
      }

      function setupYouTubePlayer() {
        if (!isYouTubeAPILoaded || !videoIds.length) return
        const playerDiv = document.getElementById("player")
        if (!playerDiv) return

        if (player) player.destroy()

        player = new YT.Player("player", {
          height: "100%",
          width: "100%",
          videoId: videoIds[currentVideoIndex],
          playerVars: {
            autoplay: 1,
            controls: 0, // Disable YouTube's controls
            disablekb: 1, // Disable keyboard controls
            modestbranding: 1,
            rel: 0, // Don't show related videos
            iv_load_policy: 3, // Don't show annotations
          },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError,
          },
        })
        updateSidebarThumbnails()
      }

      function onYouTubeIframeAPIReady() {
        // This function is called automatically by the API
        // We handle the player setup manually after getting URLs
      }

      function onPlayerReady(event) {
        if (isFocusModeActive) {
            event.target.playVideo();
            // Start timer only if focus mode is active and timer isn't already running
            if (!countdownInterval) {
                startTimer(timerRemaining * 1000, timerMode);
            }
        } else {
             // If focus mode isn't active when player is ready, maybe pause?
             // Or rely on startFocusMode to begin playback and timer
        }
        updateSidebarThumbnails(); // Highlight current video
      }


      function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
          console.log("Video ended:", videoIds[currentVideoIndex])
          if (player && player.getVideoData) {
             const videoData = player.getVideoData();
             if (videoData && videoData.video_id) {
                 completedVideos.add(videoData.video_id);
             }
          }
          totalVideosWatched++;

          // Update stats immediately
          updateAnalytics();

          currentVideoIndex++;
          if (currentVideoIndex < videoIds.length) {
            player.loadVideoById(videoIds[currentVideoIndex])
            updateSidebarThumbnails()
          } else {
            allVideosCompleted = true
            alert("Congratulations! You've completed all videos in the playlist.")
            // Consider what happens next - loop, stop, show dialog?
             showSessionCompleteDialog(); // Or simply end session
          }
          saveState(); // Save progress after video ends
        } else if (event.data === YT.PlayerState.PLAYING) {
          console.log("Video playing");
           if (isFocusModeActive && !countdownInterval) {
               // If timer somehow stopped but video is playing in focus mode, restart timer
               startTimer(timerRemaining * 1000, timerMode);
           }
        } else if (event.data === YT.PlayerState.PAUSED && isFocusModeActive) {
            console.log("Video paused during focus mode");
            // Optionally handle pause during focus mode (e.g., pause timer)
            // pauseTimer(); // If you implement pauseTimer function
        }
      }

       function onPlayerError(event) {
          console.error("YouTube Player Error:", event.data);
          // Attempt to play the next video or show an error message
          alert(`Error playing video ${videoIds[currentVideoIndex]}. Skipping to next.`);
          currentVideoIndex++;
          if (currentVideoIndex < videoIds.length) {
              player.loadVideoById(videoIds[currentVideoIndex]);
          } else {
              alert("Error on last video. Playlist finished.");
              endFocusSession(); // Or handle differently
          }
       }

      function startFocusMode() {
        try {
          videoIds = Array.from(document.querySelectorAll(".youtube-url"))
            .map((input) => extractVideoId(input.value))
            .filter((id) => id !== null)

          if (videoIds.length === 0) {
            alert("Please enter at least one valid YouTube URL.")
            return
          }

          // Save the current URLs to local storage before starting
          saveUrlState();
          saveTasks(); // Also save tasks when starting

          // Check if YouTube API is loaded, load if necessary
          loadYouTubeAPI()
            .then(() => {
              document.getElementById("inputForm").style.display = "none"
              document.getElementById("player").style.display = "block"
              document.getElementById("restartBtn").style.display = "block"
              document.getElementById("pdfToggle").style.display = "block"
              document.getElementById("clockDisplay").style.display = "none" // Hide clock during focus
              document.getElementById("sitesBox").style.display = "none" // Hide Allied Realms during focus
              document.getElementById("lofiPlayer").style.display = "none" // Hide lofi during focus
              document.getElementById("fireBox").style.display = "none"; // Hide AI assistant during focus
              document.getElementById("aiPopup").style.display = "none";
              document.querySelector(".game-sidebar").style.left = "-250px"; // Ensure sidebar is hidden
              document.querySelector(".sidebar-trigger").style.display = "none"; // Hide sidebar trigger


              isFocusModeActive = true
              currentVideoIndex = 0
              distractionCount = 0
              allVideosCompleted = false
              completedVideos = new Set()

              // Initialize timer state
              timerMode = "Focus Time"
              timerRemaining = focusDuration / 1000

              setupYouTubePlayer() // This will create/recreate the player and start playback via onPlayerReady
              startTimer(focusDuration, "Focus Time")
              updateStreak() // Update streak on starting a session
              saveState()
              stopReminderTimer() // Stop reminder timer during focus
            })
            .catch((err) => {
              console.error("YouTube API Load failed:", err)
              alert("Could not load YouTube player API. Please check your connection.")
            })
        } catch (err) {
          console.error("Start focus mode error:", err)
          alert("An error occurred while starting focus mode.")
        }
      }

       function saveUrlState() {
         const urls = Array.from(document.querySelectorAll(".youtube-url"))
                           .map(input => input.value.trim())
                           .filter(url => url); // Filter out empty strings
         localStorage.setItem('lastUsedUrls', JSON.stringify(urls));
       }

       function loadUrlState() {
         const savedUrls = JSON.parse(localStorage.getItem('lastUsedUrls') || '[]');
         const urlInputsContainer = document.getElementById("urlInputs");
         if (!urlInputsContainer) return;

         urlInputsContainer.innerHTML = ''; // Clear existing inputs

         if (savedUrls.length > 0) {
             savedUrls.forEach((url, index) => {
                 const container = document.createElement("div");
                 container.className = "url-container";
                 const input = document.createElement("input");
                 input.type = "text";
                 input.className = "youtube-url";
                 input.placeholder = "YouTube URL (Videos or Live Streams)";
                 input.value = url;
                 container.appendChild(input);

                 if (savedUrls.length > 1) { // Add remove button only if there's more than one URL initially
                     const removeBtn = document.createElement("button");
                     removeBtn.textContent = "X";
                     removeBtn.onclick = () => {
                         if (urlInputsContainer.children.length > 1) {
                             urlInputsContainer.removeChild(container);
                         }
                     };
                     container.appendChild(removeBtn);
                 }
                 urlInputsContainer.appendChild(container);
             });
         } else {
             // Add one empty input if no URLs were saved
             addUrlInput();
         }
       }

      function startTimer(durationMs, mode) {
        clearInterval(countdownInterval)
        const timerDisplay = document.getElementById("timerDisplay")
        const timerText = document.getElementById("timerText")
        const progressBar = document.getElementById("progressBar")
        const progressFill = document.getElementById("progressFill")
        const focusAudio = document.getElementById("focusAudio")

        if (!timerDisplay || !timerText || !progressBar || !progressFill) return

        timerMode = mode
        timerRemaining = durationMs / 1000
        const totalDuration = durationMs / 1000

        progressBar.style.display = "block" // Show progress bar

        if (mode === "Focus Time" && focusAudio) {
            focusAudio.play().catch(err => console.log("Focus audio play blocked:", err)); // Play focus sound
        } else if (focusAudio) {
            focusAudio.pause(); // Pause focus sound during breaks
            focusAudio.currentTime = 0; // Reset audio
        }


        countdownInterval = setInterval(() => {
          if (!isFocusModeActive) {
              clearInterval(countdownInterval);
              countdownInterval = null;
              return;
          }

          timerRemaining--
          const minutes = Math.floor(timerRemaining / 60)
          const seconds = Math.floor(timerRemaining % 60)
          timerText.textContent = `${mode}: ${minutes}:${seconds.toString().padStart(2, "0")}`

          // Update progress bar
          const progress = ((totalDuration - timerRemaining) / totalDuration) * 100
          progressFill.style.width = `${Math.max(0, Math.min(100, progress))}%`

          // Update points and total focus time every second during focus time
          if (mode === "Focus Time") {
             const pointsEarnedThisSecond = applyPowerUps(1 / 60) // Award fraction of a point per second
             points += pointsEarnedThisSecond;
             totalFocusTime++; // Increment total focus time in seconds

             // Update points display less frequently to avoid flickering, e.g., every 5 seconds
             if (timerRemaining % 5 === 0) {
                document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: ${Math.floor(points)}`;
                checkLevelUp();
             }
          }

          if (timerRemaining <= 0) {
            clearInterval(countdownInterval)
            countdownInterval = null; // Clear interval ID

            if (mode === "Focus Time") {
                // Update daily points data for calendar
                const todayString = new Date().toISOString().split('T')[0];
                const currentDayPoints = dailyPointsData[todayString] || 0;
                const sessionPoints = Math.floor(points - previousPoints); // Points earned this session
                dailyPointsData[todayString] = currentDayPoints + sessionPoints;

                previousPoints = points; // Update baseline for next session
                showSessionCompleteDialog(); // Ask user if they want to continue or end

            } else if (mode === "Break Time 1") {
              startTimer(secondBreakDuration, "Break Time 2")
            } else { // Break Time 2 finished
              // Potentially loop back to focus time if desired, or just end
              // endFocusSession(); // For now, end after the second break
               showSessionCompleteDialog(); // Or ask again after break
            }
             saveState(); // Save state at the end of each timer segment
          }
        }, 1000)
        saveState(); // Save state when timer starts/changes mode
      }

       function checkLevelUp() {
         const currentLevelData = getAchievementLevel(points);
         const currentLevelIndex = achievementLevels.findIndex(l => l.level === currentLevelData.level);

         // Check if there's a next level and if points reached it
         if (currentLevelIndex < achievementLevels.length - 1) {
             const nextLevelData = achievementLevels[currentLevelIndex + 1];
             if (points >= nextLevelData.points) {
                 // Check if we haven't already shown overlay for this level recently
                 const lastLevelUpPoints = parseInt(localStorage.getItem('lastLevelUpPoints') || '0');
                 if(lastLevelUpPoints < nextLevelData.points) {
                     showAchievementOverlay(nextLevelData.level);
                     updateAchievementLevel(); // Update display immediately
                     localStorage.setItem('lastLevelUpPoints', nextLevelData.points.toString());
                     saveState(); // Save state after level up
                 }
             }
         }
         // Always update the level display in case points decreased or for initial load
         updateAchievementLevel();
       }


      function updateAnalytics() {
        const focusTimeSpan = document.getElementById("totalFocusTime")
        const distractionsSpan = document.getElementById("totalDistractions")
        const videosWatchedSpan = document.getElementById("totalVideosWatched")
        if (focusTimeSpan) focusTimeSpan.textContent = Math.floor(totalFocusTime / 60)
        if (distractionsSpan) distractionsSpan.textContent = totalDistractions
        if (videosWatchedSpan) videosWatchedSpan.textContent = totalVideosWatched
      }

      function showConfirmationDialog() {
          const dialog = document.getElementById("confirmationDialog");
          if(dialog) dialog.style.display = "block";
      }

      function handleConfirmation(choice) {
          const dialog = document.getElementById("confirmationDialog");
          if(dialog) dialog.style.display = "none";

          if (choice === 'yes') {
              endFocusSession();
          }
      }


      function endFocusSession() {
        isFocusModeActive = false
        clearInterval(countdownInterval)
        countdownInterval = null; // Clear interval ID

        // Stop video playback
        if (player && typeof player.stopVideo === 'function') {
            player.stopVideo();
        } else if (player && typeof player.pauseVideo === 'function') {
            // Fallback to pausing if stopVideo isn't available or fails
            player.pauseVideo();
        }

        // Stop focus sound
        const focusAudio = document.getElementById("focusAudio")
        if(focusAudio) {
            focusAudio.pause();
            focusAudio.currentTime = 0;
        }


        document.getElementById("player").style.display = "none"
        document.getElementById("inputForm").style.display = "block"
        document.getElementById("restartBtn").style.display = "none"
        document.getElementById("pdfToggle").style.display = "none"
        document.getElementById("pdfViewer").style.display = "none"; // Ensure PDF viewer is hidden
        document.getElementById("clockDisplay").style.display = "block" // Show clock again
        document.getElementById("sitesBox").style.display = "none"; // Keep Allied Realms hidden on input page
        document.getElementById("lofiPlayer").style.display = "block" // Show lofi player again
        document.getElementById("fireBox").style.display = "block"; // Show AI assistant again
        document.querySelector(".sidebar-trigger").style.display = "flex"; // Show sidebar trigger

        const timerDisplay = document.getElementById("timerDisplay");
        const progressBar = document.getElementById("progressBar");
        if(timerDisplay) timerDisplay.textContent = ""; // Clear timer text
        if(progressBar) progressBar.style.display = "none"; // Hide progress bar

        // Final update of stats and save
        updateAnalytics()
        updateAchievementLevel()
        checkLevelUp(); // Check for level up one last time
        saveState()
        restoreUrlInputs() // Put the URLs back in the input fields
        restoreTasks(); // Make sure tasks are up-to-date
        startReminderTimer(); // Restart reminder timer
        updateSidebarDashboard(); // Update sidebar stats
      }

      function toggleStats() {
        const analytics = document.getElementById("analytics")
        if (!analytics) return
        analytics.style.display = analytics.style.display === "block" ? "none" : "block"
        if (analytics.style.display === 'block') {
            updateAnalytics(); // Ensure stats are current when shown
        }
      }

      function savePlaylist() {
        const playlistName = document.getElementById("playlistName").value.trim()
        const urls = Array.from(document.querySelectorAll(".youtube-url"))
          .map((input) => input.value.trim())
          .filter((url) => url !== "")

        if (!playlistName) {
          alert("Please enter a name for the playlist.")
          return
        }
        if (urls.length === 0) {
          alert("Please add at least one URL to the playlist.")
          return
        }

        const existingIndex = playlists.findIndex((p) => p.name === playlistName)
        if (existingIndex !== -1) {
          // Update existing playlist
          playlists[existingIndex].urls = urls
          alert(`Playlist "${playlistName}" updated.`)
        } else {
          // Add new playlist
          playlists.push({ name: playlistName, urls: urls })
          alert(`Playlist "${playlistName}" saved.`)
        }

        localStorage.setItem("playlists", JSON.stringify(playlists))
        populatePlaylistSelect()
      }

      function populatePlaylistSelect() {
        const select = document.getElementById("playlistSelect")
        if (!select) return

        const currentSelection = select.value
        select.innerHTML = '<option value="">Select a Playlist</option>' // Reset options

        playlists.forEach((playlist) => {
          const option = document.createElement("option")
          option.value = playlist.name
          option.textContent = playlist.name
          select.appendChild(option)
        })
        select.value = currentSelection // Restore previous selection if possible
      }

      function loadPlaylist() {
        const select = document.getElementById("playlistSelect")
        const urlInputs = document.getElementById("urlInputs")
        if (!select || !urlInputs) return

        const playlistName = select.value
        if (!playlistName) {
           urlInputs.innerHTML = ''; // Clear inputs if "Select Playlist" is chosen
           addUrlInput(); // Add one empty input
           document.getElementById("playlistName").value = ""; // Clear playlist name input
           return;
        }


        const playlist = playlists.find((p) => p.name === playlistName)
        if (playlist) {
          urlInputs.innerHTML = "" // Clear existing inputs
          playlist.urls.forEach((url, index) => {
            const container = document.createElement("div")
            container.className = "url-container"
            const input = document.createElement("input")
            input.type = "text"
            input.className = "youtube-url"
            input.value = url
            const removeBtn = document.createElement("button")
            removeBtn.textContent = "X"
            removeBtn.onclick = () => {
              if (urlInputs.children.length > 1) urlInputs.removeChild(container)
            }
            container.appendChild(input)
            container.appendChild(removeBtn) // Add remove button to all loaded inputs
            urlInputs.appendChild(container)
          })
          document.getElementById("playlistName").value = playlistName; // Set playlist name input
        }
      }

      function removePlaylist() {
          const select = document.getElementById("playlistSelect");
          const urlInputs = document.getElementById("urlInputs");
          const playlistNameInput = document.getElementById("playlistName");
          if (!select || !urlInputs || !playlistNameInput) return;

          const playlistName = select.value;
          if (!playlistName) {
              alert("Please select a playlist to delete.");
              return;
          }

          if (confirm(`Are you sure you want to delete the playlist "${playlistName}"?`)) {
              playlists = playlists.filter(p => p.name !== playlistName);
              localStorage.setItem("playlists", JSON.stringify(playlists));
              alert(`Playlist "${playlistName}" deleted.`);
              populatePlaylistSelect(); // Refresh the dropdown
              urlInputs.innerHTML = ''; // Clear URL inputs
              addUrlInput(); // Add one empty input back
              playlistNameInput.value = ""; // Clear the name input
          }
      }


      function makeDraggable(element) {
          let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
          element.onmousedown = dragMouseDown;

          function dragMouseDown(e) {
              // Check if the clicked element is a button inside the draggable element
              if (e.target.tagName === 'BUTTON') {
                  return; // Don't start dragging if a button was clicked
              }
              e = e || window.event;
              e.preventDefault();
              // Get the mouse cursor position at startup:
              pos3 = e.clientX;
              pos4 = e.clientY;
              document.onmouseup = closeDragElement;
              // Call a function whenever the cursor moves:
              document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
              e = e || window.event;
              e.preventDefault();
              // Calculate the new cursor position:
              pos1 = pos3 - e.clientX;
              pos2 = pos4 - e.clientY;
              pos3 = e.clientX;
              pos4 = e.clientY;
              // Set the element's new position:
              element.style.top = (element.offsetTop - pos2) + "px";
              element.style.left = (element.offsetLeft - pos1) + "px";
          }

          function closeDragElement() {
              // Stop moving when mouse button is released:
              document.onmouseup = null;
              document.onmousemove = null;
          }
      }


      function saveState() {
          if (!isSignedIn || !currentUser) {
             // Save non-user specific state if needed, e.g., last used URLs
             saveUrlState();
             localStorage.setItem("tasks", JSON.stringify(tasks)); // Save tasks globally if not logged in? Or clear them?
             return; // Don't save user-specific data if not logged in
          }

          try {
              const state = {
                  videoIds,
                  currentVideoIndex,
                  distractionCount,
                  points,
                  timerMode,
                  timerRemaining,
                  isFocusModeActive,
                  isSignedIn,
                  currentUser,
                  completedVideos: Array.from(completedVideos),
                  allVideosCompleted,
                  totalFocusTime,
                  totalDistractions,
                  totalVideosWatched,
                  streakDays,
                  lastFocusDate,
                  mysteryBoxCount,
                  activePowerUps,
                  dailyPointsData, // Save daily points
                  premiumLofiTracks: premiumLofiTracks.map(track => ({ // Save unlocked state
                      id: track.id,
                      unlocked: track.unlocked
                  }))
              };
              localStorage.setItem("focusModeState", JSON.stringify(state));

              // Also update user data in the 'users' object
              const users = JSON.parse(localStorage.getItem("users") || "{}");
              if (users[currentUser]) {
                  users[currentUser].points = points;
                  users[currentUser].totalFocusTime = totalFocusTime;
                  users[currentUser].totalDistractions = totalDistractions;
                  users[currentUser].totalVideosWatched = totalVideosWatched;
                  users[currentUser].tasks = tasks;
                  users[currentUser].streakDays = streakDays;
                  users[currentUser].lastFocusDate = lastFocusDate;
                  users[currentUser].mysteryBoxCount = mysteryBoxCount;
                  users[currentUser].activePowerUps = activePowerUps;
                  users[currentUser].dailyPointsData = dailyPointsData;
                  users[currentUser].premiumLofiTracks = premiumLofiTracks.map(track => ({
                      id: track.id,
                      unlocked: track.unlocked
                  }));
                  localStorage.setItem("users", JSON.stringify(users));
              }
              saveUrlState(); // Save URLs separately as well
              localStorage.setItem("tasks", JSON.stringify(tasks)); // Save tasks
          } catch (error) {
              console.error("Error saving state:", error);
              // Potentially implement a more robust error handling or data cleanup
              if (error.name === 'QuotaExceededError') {
                  alert("Could not save progress: Local storage is full. Please clear some space or delete old playlists.");
                  // Maybe try deleting older/less important data here
              } else {
                   alert("An error occurred while saving your progress.");
              }
          }
      }

       function loadUserData() {
           const state = JSON.parse(localStorage.getItem("focusModeState") || '{}');
           isSignedIn = state.isSignedIn || false;
           currentUser = state.currentUser || null;

           if (isSignedIn && currentUser) {
               const users = JSON.parse(localStorage.getItem("users") || "{}");
               if (users[currentUser]) {
                   const userData = users[currentUser];
                   points = userData.points || 0;
                   totalFocusTime = userData.totalFocusTime || 0;
                   totalDistractions = userData.totalDistractions || 0;
                   totalVideosWatched = userData.totalVideosWatched || 0;
                   tasks = userData.tasks || [];
                   streakDays = userData.streakDays || 0;
                   lastFocusDate = userData.lastFocusDate || null;
                   mysteryBoxCount = userData.mysteryBoxCount || 0;
                   activePowerUps = userData.activePowerUps || {
                       doublePoints: { active: false, expiry: null },
                       streakShield: { active: false, used: false, expiry: null }
                   };
                   dailyPointsData = userData.dailyPointsData || {}; // Load daily points

                    // Load premium tracks unlocked status
                   if (userData.premiumLofiTracks) {
                       userData.premiumLofiTracks.forEach(savedTrack => {
                           const track = premiumLofiTracks.find(t => t.id === savedTrack.id);
                           if (track) {
                               track.unlocked = savedTrack.unlocked;
                               // Add to available songs if unlocked and not already present
                               if (track.unlocked && !lofiSongs.includes(track.url)) {
                                   lofiSongs.push(track.url);
                               }
                           }
                       });
                   }

               } else {
                   // Handle inconsistency: user is marked as signed in but data is missing
                   console.warn("User data not found for logged-in user:", currentUser);
                   logout(); // Force logout or reset data
                   return; // Stop further loading for this user
               }
           } else {
               // Load global tasks if not signed in
               tasks = JSON.parse(localStorage.getItem("tasks") || '[]');
           }
           // Always load playlists globally
           playlists = JSON.parse(localStorage.getItem("playlists") || "[]");
           // Load last used URLs globally
           loadUrlState();
       }


       function logout() {
           // Optionally ask for confirmation
           if (confirm("Are you sure you want to log out? Your progress will be saved.")) {
               saveState(); // Save final state before logging out
               isFocusModeActive = false; // Ensure focus mode is off
               clearInterval(countdownInterval); // Stop timers
               countdownInterval = null;

                // Clear user-specific data from active state
                isSignedIn = false;
                currentUser = null;
                points = 0;
                totalFocusTime = 0;
                totalDistractions = 0;
                totalVideosWatched = 0;
                tasks = []; // Clear tasks or load global tasks? Decide based on desired behavior
                streakDays = 0;
                lastFocusDate = null;
                mysteryBoxCount = 0;
                activePowerUps = {
                    doublePoints: { active: false, expiry: null },
                    streakShield: { active: false, used: false, expiry: null }
                };
                premiumLofiTracks.forEach(track => track.unlocked = false); // Reset premium tracks
                lofiSongs = lofiSongs.filter(url => !premiumLofiTracks.some(pt => pt.url === url && !pt.unlocked)); // Keep only default + unlocked


                // Clear focus state from local storage (or keep it but mark as logged out)
                localStorage.removeItem("focusModeState"); // Or update it with loggedOut = true

                 // Clear global tasks storage if they shouldn't persist after logout
                // localStorage.removeItem("tasks");

                // Reset UI
                document.getElementById("landingPage").style.display = "block";
                document.getElementById("signinForm").style.display = "none";
                document.getElementById("inputForm").style.display = "none";
                document.getElementById("player").style.display = "none";
                document.getElementById("restartBtn").style.display = "none";
                document.getElementById("pdfToggle").style.display = "none";
                document.getElementById("pdfViewer").style.display = "none";
                document.getElementById("clockDisplay").style.display = "none";
                document.getElementById("sitesBox").style.display = "none";
                document.getElementById("lofiPlayer").style.display = "none";
                document.getElementById("fireBox").style.display = "none";
                document.getElementById("aiPopup").style.display = "none";
                document.querySelector(".game-sidebar").style.left = "-250px";
                document.querySelector(".sidebar-trigger").style.display = "none";
                document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;"></span> XP: 0`;
                document.getElementById("achievementLevel").textContent = achievementLevels[0].level;
                document.getElementById("streakDisplay").textContent = " 0 days of focus";
                document.getElementById("username").value = ""; // Clear login form
                document.getElementById("password").value = "";

                if (player && typeof player.destroy === 'function') {
                    player.destroy(); // Destroy the YouTube player instance
                    player = null;
                }

                // Load global tasks and playlists again if needed
                loadUserData();
                populatePlaylistSelect();
                restoreTasks();
                updateSidebarDashboard(); // Update sidebar for logged-out state
           }
       }

      function updateSidebarThumbnails() {
        const sidebar = document.getElementById("videoSidebar")
        if (!sidebar || !player || typeof player.getVideoData !== 'function') return;

        sidebar.innerHTML = '<button id="minimizeBtn">X</button>'; // Add minimize button back
        const minimizeBtn = document.getElementById("minimizeBtn");
         if(minimizeBtn) minimizeBtn.onclick = () => { sidebar.style.right = "-320px"; };


        videoIds.forEach((videoId, index) => {
          try {
            const thumbnailUrl = `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`; // Medium quality thumbnail
            const img = document.createElement("img");
            img.src = thumbnailUrl;
            img.alt = `Video ${index + 1}`;
            img.className = "thumbnail";
            img.dataset.index = index; // Store index
             img.onerror = function() {
                 // Handle cases where thumbnail might not exist (e.g., private video)
                 this.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // Placeholder
                 console.warn(`Thumbnail not found for video ID: ${videoId}`);
             };

            // Highlight the current video
            if (index === currentVideoIndex) {
              img.style.borderColor = "var(--secondary)";
              img.style.borderWidth = "3px";
            }

            img.onclick = () => {
              if (player && typeof player.loadVideoById === 'function') {
                currentVideoIndex = index;
                player.loadVideoById(videoIds[currentVideoIndex]);
                updateSidebarThumbnails(); // Re-render to update highlight
                saveState(); // Save the new index
              }
            };
            sidebar.appendChild(img);
          } catch (e) {
            console.error("Error creating thumbnail for video:", videoId, e);
          }
        });
        sidebar.style.right = "0"; // Ensure sidebar is visible when updated
      }

        // PDF Viewer Functionality
        function togglePdfViewer() {
            const viewer = document.getElementById("pdfViewer");
            if (viewer) {
                viewer.style.display = (viewer.style.display === "block") ? "none" : "block";
            }
        }

        function loadPdf(event) {
            const file = event.target.files[0];
            const frame = document.getElementById("pdfFrame");
            if (file && frame && file.type === "application/pdf") {
                const fileURL = URL.createObjectURL(file);
                frame.src = fileURL;
                 // Consider revoking the URL later to free up memory:
                 // frame.onload = () => { URL.revokeObjectURL(fileURL); } // Be careful with timing
            } else if (file) {
                alert("Please select a valid PDF file.");
                frame.src = ""; // Clear frame if invalid file selected
                 event.target.value = null; // Reset file input
            } else {
                 frame.src = ""; // Clear frame if no file selected
            }
        }

        // AI Popup Functionality
        function toggleAiPopup() {
            const popup = document.getElementById("aiPopup");
            const firebox = document.getElementById("fireBox");
            if (popup && firebox) {
                if (popup.style.display === "block") {
                    popup.style.display = "none";
                    firebox.textContent = ""; // Reset icon
                } else {
                    popup.style.display = "block";
                    firebox.textContent = ""; // Change icon to close indicator
                }
            }
        }

       // Update Sidebar Dashboard
       function updateSidebarDashboard() {
         const levelEl = document.getElementById("sidebarLevel");
         const xpEl = document.getElementById("sidebarXP");
         const streakEl = document.getElementById("sidebarStreak");
         const focusTimeEl = document.getElementById("sidebarFocusTime");

         if (isSignedIn && currentUser) {
             const levelData = getAchievementLevel(points);
             if(levelEl) levelEl.textContent = levelData.level;
             if(xpEl) xpEl.textContent = points;
             if(streakEl) streakEl.textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`;
             if(focusTimeEl) focusTimeEl.textContent = `${Math.floor(totalFocusTime / 60)} mins`;
         } else {
             // Logged out state
             if(levelEl) levelEl.textContent = "Mortal";
             if(xpEl) xpEl.textContent = "0";
             if(streakEl) streakEl.textContent = "0 days";
             if(focusTimeEl) focusTimeEl.textContent = "0 mins";
         }
       }


      // Event Listeners Setup
      function setupEventListeners() {
          document.body.addEventListener('click', (event) => {
              const action = event.target.dataset.action;
              if (action) {
                  switch (action) {
                      case 'start-game': showSignIn(); break;
                      case 'github': window.open('https://github.com/THE-CHOSEN-ONE-o5/UltraFocusModeYT', '_blank'); break;
                      case 'sign-in': signIn(); break;
                      case 'create-account': createAccount(); break;
                      case 'add-url': addUrlInput(); break;
                      case 'start-playback': startFocusMode(); break;
                      case 'save-tasks': saveTasks(); alert("Quests Saved!"); break;
                      case 'save-playlist': savePlaylist(); break;
                      case 'remove-playlist': removePlaylist(); break;
                  }
              }
          });

          // Navbar buttons
           const profileBtn = document.getElementById('profileBtn');
           if (profileBtn) profileBtn.onclick = () => showPage('profilePage');

           const streakBtn = document.getElementById('streakBtn'); // Assuming this button exists for tooltip display
           // Tooltip handled by CSS hover

           const logoutBtnTop = document.getElementById('logoutBtnTop');
           if (logoutBtnTop) logoutBtnTop.onclick = logout;

           const homeLogoBtn = document.querySelector('.navbar-logo'); // Allow clicking logo to go home
           if (homeLogoBtn) homeLogoBtn.onclick = () => {
               if (isFocusModeActive) showConfirmationDialog(); // Ask before leaving focus mode
               else showPage('homePage');
           };


          // Home page buttons
           const watchLecturesBtn = document.getElementById('watchLecturesBtn');
           if (watchLecturesBtn) watchLecturesBtn.onclick = () => showPage('inputForm'); // Go to URL input form

           const todoPageBtn = document.getElementById('todoPageBtn');
           if (todoPageBtn) todoPageBtn.onclick = () => showPage('todoPage');

           const focusStatsBtn = document.getElementById('focusStatsBtn');
           if (focusStatsBtn) focusStatsBtn.onclick = () => showPage('focusStatsPage');

           const pyqsBtn = document.getElementById('pyqsBtn'); // Home page PYQs button
           if (pyqsBtn) pyqsBtn.onclick = redirectToPYQs;

           // Todo page add button
           const todoAddBtn = document.getElementById('todoAddBtn');
           if (todoAddBtn) todoAddBtn.onclick = addTodo;
           const todoInput = document.getElementById('todoInput');
            if(todoInput) todoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTodo();
            });


           // Focus stats page calendar navigation
           const prevMonthBtn = document.getElementById('prevMonthBtn');
           if (prevMonthBtn) prevMonthBtn.onclick = () => navigateCalendar('prev');

           const nextMonthBtn = document.getElementById('nextMonthBtn');
           if (nextMonthBtn) nextMonthBtn.onclick = () => navigateCalendar('next');


          // Input Form Buttons
          const todoBtn = document.getElementById("todoBtn")
          if (todoBtn) todoBtn.onclick = toggleTodo

          const statsBtn = document.getElementById("statsBtn")
          if (statsBtn) statsBtn.onclick = toggleStats

          const pyqBtnInput = document.getElementById("pyqBtn"); // PYQs button on input form
          if (pyqBtnInput) pyqBtnInput.onclick = redirectToPYQs;

          const playlistSelect = document.getElementById("playlistSelect")
          if (playlistSelect) playlistSelect.onchange = loadPlaylist

          const restartBtn = document.getElementById("restartBtn")
          if (restartBtn) restartBtn.onclick = showConfirmationDialog

          // Confirmation Dialog Buttons
          const confirmBtn = document.getElementById("confirmBtn")
          if (confirmBtn) confirmBtn.onclick = () => handleConfirmation('yes')
          const cancelBtn = document.getElementById("cancelBtn")
          if (cancelBtn) cancelBtn.onclick = () => handleConfirmation('no')

          // Sites Popup
          const sitesBox = document.getElementById("sitesBox")
          if (sitesBox) sitesBox.onclick = toggleSitesPopup
          const closeSitesPopupBtn = document.getElementById("closeSitesPopup")
          if (closeSitesPopupBtn) closeSitesPopupBtn.onclick = closeSitesPopup

          // Lo-fi Player Controls
          const lofiPause = document.getElementById("lofiPause")
          if (lofiPause) lofiPause.onclick = pauseLofi
          const lofiPlay = document.getElementById("lofiPlay")
          if (lofiPlay) lofiPlay.onclick = playLofi
          const lofiPrev = document.getElementById("lofiPrev")
          if (lofiPrev) lofiPrev.onclick = prevLofi
          const lofiNext = document.getElementById("lofiNext")
          if (lofiNext) lofiNext.onclick = nextLofi

          // Draggable Timer
          const timerDisplay = document.getElementById("timerDisplay");
          if (timerDisplay) makeDraggable(timerDisplay);

          // PDF Viewer
          const pdfToggle = document.getElementById("pdfToggle");
          if(pdfToggle) pdfToggle.onclick = togglePdfViewer;
          const pdfInput = document.getElementById("pdfInput");
          if(pdfInput) pdfInput.onchange = loadPdf;

          // AI Popup
          const fireBox = document.getElementById("fireBox");
          if (fireBox) fireBox.onclick = toggleAiPopup;

          // Sidebar buttons
           const streakShieldBtn = document.getElementById("streakShieldBtn");
           if(streakShieldBtn) streakShieldBtn.onclick = showStreakShieldDialog;
           const doublePointsBtn = document.getElementById("doublePointsBtn");
           if(doublePointsBtn) doublePointsBtn.onclick = showDoublePointsDialog;
           const audioStoreBtn = document.getElementById("audioStoreBtn");
           if (audioStoreBtn) audioStoreBtn.onclick = showAudioTracksStore;

           // Dialog confirm/cancel buttons
           const streakShieldConfirmBtn = document.getElementById("streakShieldConfirmBtn");
           if (streakShieldConfirmBtn) streakShieldConfirmBtn.onclick = () => handleStreakShieldConfirmation('yes');
           const streakShieldCancelBtn = document.getElementById("streakShieldCancelBtn");
           if (streakShieldCancelBtn) streakShieldCancelBtn.onclick = () => handleStreakShieldConfirmation('no');

           const doublePointsConfirmBtn = document.getElementById("doublePointsConfirmBtn");
           if(doublePointsConfirmBtn) doublePointsConfirmBtn.onclick = () => handleDoublePointsConfirmation('yes');
           const doublePointsCancelBtn = document.getElementById("doublePointsCancelBtn");
           if(doublePointsCancelBtn) doublePointsCancelBtn.onclick = () => handleDoublePointsConfirmation('no');

           // Deadline Dialog buttons
           const deadlineConfirmBtn = document.getElementById('deadlineConfirmBtn');
           if (deadlineConfirmBtn) deadlineConfirmBtn.onclick = () => handleDeadlineConfirmation('yes');
           const deadlineCancelBtn = document.getElementById('deadlineCancelBtn');
           if (deadlineCancelBtn) deadlineCancelBtn.onclick = () => handleDeadlineConfirmation('no');

           // Session Complete Dialog buttons
           const sessionContinueBtn = document.getElementById('sessionContinueBtn');
           if (sessionContinueBtn) sessionContinueBtn.onclick = () => handleSessionContinue('continue');
           const sessionEndBtn = document.getElementById('sessionEndBtn');
           if (sessionEndBtn) sessionEndBtn.onclick = () => handleSessionContinue('end');


            // Pomodoro Buttons
            const quietPomodoroBtn = document.getElementById("quietPomodoroBtn");
            if (quietPomodoroBtn) quietPomodoroBtn.onclick = showPomodoroOverlay;
            const pomodoroStartBtn = document.getElementById("pomodoroStartBtn");
            if (pomodoroStartBtn) pomodoroStartBtn.onclick = startPomodoro;
            const pomodoroResetBtn = document.getElementById("pomodoroResetBtn");
            if (pomodoroResetBtn) pomodoroResetBtn.onclick = resetPomodoro;
            const pomodoroCloseBtn = document.getElementById("pomodoroCloseBtn");
            if (pomodoroCloseBtn) pomodoroCloseBtn.onclick = closePomodoroOverlay;


            // Mystery Box Button
            const openMysteryBoxBtn = document.getElementById('openMysteryBox');
            if (openMysteryBoxBtn) openMysteryBoxBtn.onclick = openMysteryBox;

            // Audio Store Close Button
            const closeAudioStoreBtn = document.getElementById('closeAudioStore');
            if (closeAudioStoreBtn) closeAudioStoreBtn.onclick = closeAudioTracksStore;

            // Initial task line if tasks div exists and is empty
            const tasksDiv = document.getElementById("tasks");
            if (tasksDiv && tasksDiv.children.length === 0) {
              addTaskLine();
            }

           // Interval timers
           setInterval(updateClock, 1000); // Update digital clock every second
           setInterval(updateNavbarClock, 1000); // Update navbar clock every second
           setInterval(checkTaskDeadlines, 60 * 1000); // Check deadlines every minute
           setInterval(saveState, 5 * 60 * 1000); // Autosave every 5 minutes


           // Load initial data
           loadUserData(); // Load user data first
           loadSavedState(); // Load rest of the state, potentially overriding parts of user data if focus session was active
           populatePlaylistSelect(); // Populate after loading playlists
           restoreTasks(); // Restore tasks after loading tasks data
           initAudio(); // Init lofi audio player
           updateClock(); // Initial clock display
           updateNavbarClock(); // Initial navbar clock display
           updateAchievementLevel(); // Initial level display
           updateStreak(); // Initial streak display
           checkTaskDeadlines(); // Initial deadline check
           updateSidebarDashboard(); // Initial sidebar update
           updateCurrentDate(); // Initial date on home page
           updateFocusStatus(); // Initial focus status on home page
       }

      // --- Initialization ---
      // Use DOMContentLoaded to ensure the DOM is ready before setting up listeners and loading data
       document.addEventListener('DOMContentLoaded', () => {
          // Request notification permission early if desired
          if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
              // Optionally ask the user if they want notifications before requesting
              // Notification.requestPermission(); // Or request on first relevant action
          }
           setupEventListeners();
           showPage('homePage'); // Start on the home page initially
       });

    })()
  </script>
</body>
</html>
