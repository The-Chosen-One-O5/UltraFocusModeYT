<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Focus Mode YouTube Player</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4169e1;
      --primary-dark: #1e3a8a;
      --secondary: #8e2de2;
      --accent: #ff4500;
      --accent-alt: #ff8c00;
      --bg-dark: #0f0f1b;
      --bg-medium: #1a1a2e;
      --bg-light: #252538;
      --text: #e0e0ff;
      --text-dim: #9090b0;
      --calendar-blue-1: #0a1a3f;
      --calendar-blue-2: #1e3a8a;
      --calendar-blue-3: #3b5dc9;
      --calendar-blue-4: #4169e1;
      --calendar-blue-5: #6384e8;
    }

    body {
      background-color: var(--bg-dark);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: monospace;
      color: var(--text);
      overflow: hidden;
      font-size: 18px;
      line-height: 1.4;
    }

    .game-container {
      width: 100%;
      height: 100vh;
      position: relative;
      overflow: hidden;
      background-image: radial-gradient(circle at 10% 20%, rgba(142, 45, 226, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 20%),
        linear-gradient(to bottom, var(--bg-dark), var(--bg-medium));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1;
    }

    .game-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1h1z'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 2;
    }

    #landingPage,
    #signinForm,
    #inputForm {
      text-align: center;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
      z-index: 10;
      background-color: rgba(15, 15, 27, 0.8);
      border: 2px solid var(--secondary);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(142, 45, 226, 0.3);
      pointer-events: auto;
    }

    .title {
      font-family: monospace;
      font-size: 32px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 20px;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    .title span {
      color: var(--secondary);
      position: relative;
      display: inline-block;
    }

    .title span::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .subtitle {
      font-size: 20px;
      color: var(--text-dim);
      margin-bottom: 30px;
    }

    button {
      display: inline-block;
      padding: 12px 30px;
      font-size: 18px;
      font-family: monospace;
      font-weight: 600;
      background: var(--secondary);
      border: none;
      color: var(--text);
      border-radius: 0;
      cursor: pointer;
      margin: 0 10px 15px;
      transition: all 0.3s;
      position: relative;
      box-shadow: 4px 4px 0 var(--primary-dark);
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 1px;
      z-index: 11;
      pointer-events: auto;
    }

    button:hover {
      background: var(--primary);
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--primary-dark);
    }

    button:active {
      transform: translate(4px, 4px);
      box-shadow: none;
    }

    .github-btn {
      background: var(--bg-light);
      box-shadow: 4px 4px 0 var(--bg-medium);
    }

    .github-btn:hover {
      background: var(--bg-medium);
      box-shadow: 2px 2px 0 var(--bg-medium);
    }

    #features {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
      z-index: 10;
    }

    .feature {
      background: var(--bg-light);
      padding: 15px 20px;
      border-radius: 0;
      width: 200px;
      box-shadow: 4px 4px 0 var(--bg-medium);
      border: 2px solid var(--primary);
      position: relative;
      overflow: hidden;
      z-index: 10;
    }

    .feature::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .feature i {
      font-size: 24px;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .feature p {
      font-size: 16px;
      color: var(--text);
    }

    input,
    select {
      display: block;
      width: 100%;
      max-width: 320px;
      margin: 10px auto;
      padding: 12px;
      border-radius: 0;
      font-size: 16px;
      font-family: monospace;
      background: var(--bg-light);
      border: 2px solid var(--primary);
      color: var(--text);
      outline: none;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
      z-index: 11;
      pointer-events: auto;
    }

    input:focus,
    select:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(142, 45, 226, 0.3);
    }

    #inputForm {
      max-height: 80vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--secondary) var(--bg-medium);
    }

    #inputForm::-webkit-scrollbar {
      width: 8px;
    }

    #inputForm::-webkit-scrollbar-track {
      background: var(--bg-medium);
    }

    #inputForm::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 0;
      border: 2px solid var(--bg-medium);
    }

    #player {
      width: 100%;
      max-width: 1200px;
      aspect-ratio: 16 / 9;
      border-radius: 0;
      overflow: hidden;
      display: none;
      background: #000;
      border: 4px solid var(--primary);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      z-index: 5;
    }

    #timerDisplay {
      position: fixed;
      top: 10px;
      left: 10px;
      color: var(--text);
      font-size: 24px;
      z-index: 101;
      cursor: move;
      padding: 10px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      font-family: monospace;
      font-size: 16px;
      pointer-events: auto;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
    }

    #timerDisplay button {
      pointer-events: auto;
      padding: 5px 10px;
      margin: 0 5px;
      font-size: 12px;
      z-index: 102;
    }

    #pointsDisplay {
      position: fixed;
      top: 50px;
      left: 10px;
      font-size: 18px;
      color: var(--text);
      font-family: monospace;
      font-weight: 600;
      z-index: 101;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    #clockDisplay {
      position: fixed;
      top: 90px;
      left: 10px;
      font-size: 20px;
      font-family: monospace;
      font-weight: bold;
      z-index: 101;
      padding: 8px 12px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      display: none;
      pointer-events: none;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
    }

    #clockDisplay .time {
      color: var(--primary);
      font-weight: 600;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    #clockDisplay .period {
      color: var(--secondary);
      font-weight: 600;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    #progressBar {
      width: 200px;
      height: 10px;
      background: var(--bg-light);
      display: none;
      margin-top: 5px;
      border: 2px solid var(--primary);
      z-index: 101;
    }

    #progressFill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    #sitesBox {
      display: none;
      position: fixed;
      top: 130px;
      left: 10px;
      z-index: 101;
      padding: 8px 12px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      cursor: pointer;
      pointer-events: auto;
    }

    #sitesPopup {
      position: fixed;
      top: 170px;
      left: 10px;
      width: 250px;
      background: var(--bg-medium);
      padding: 15px;
      border: 2px solid var(--secondary);
      display: none;
      z-index: 102;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #sitesPopup a {
      display: block;
      color: var(--primary);
      text-decoration: none;
      margin: 10px 0;
      font-size: 14px;
      font-family: monospace;
      padding: 5px;
      border: 1px solid var(--primary);
      transition: all 0.3s;
      pointer-events: auto;
    }

    #sitesPopup a:hover {
      color: var(--text);
      background: var(--primary);
      transform: translate(2px, 2px);
    }

    #closeSitesPopup {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--accent);
      border: none;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      padding: 2px 6px;
      margin: 0;
      z-index: 103;
    }

    #restartBtn {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--accent);
      z-index: 103;
      pointer-events: auto;
    }

    #videoSidebar {
      position: fixed;
      right: -320px;
      top: 0;
      width: 300px;
      height: 100%;
      background: var(--bg-medium);
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
      z-index: 102;
      border-left: 4px solid var(--primary);
      pointer-events: auto;
    }

    .thumbnail {
      width: 100%;
      margin-bottom: 15px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 0;
      transition: all 0.3s;
      image-rendering: pixelated;
      pointer-events: auto;
    }

    .thumbnail:hover {
      border-color: var(--secondary);
      transform: scale(1.05);
    }

    #minimizeBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--accent);
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 6px;
      margin: 0;
      box-shadow: none;
      z-index: 102;
    }

    .url-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .url-container button {
      margin-left: 10px;
      padding: 5px 10px;
      background: var(--accent);
      font-size: 14px;
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
      z-index: 11;
    }

    #statsBtn,
    #todoBtn,
    #pyqBtn {
      padding: 8px 16px;
      font-size: 12px;
      margin: 0 5px 15px;
      z-index: 11;
    }

    #analytics,
    #todoList {
      position: absolute;
      left: 10px;
      background: var(--bg-medium);
      padding: 15px;
      border: 2px solid var(--secondary);
      display: none;
      z-index: 100;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #analytics {
      top: 90px;
    }

    #todoList {
      top: 50px;
      width: 300px;
      max-height: 400px;
    }

    #tasks {
      overflow-y: auto;
      max-height: 320px;
      margin-bottom: 10px;
      background: none;
    }

    #analytics h3,
    #todoList h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--secondary);
      font-family: monospace;
      font-size: 16px;
      text-align: center;
    }

    #analytics p {
      font-size: 16px;
      margin: 5px 0;
      border-bottom: 1px solid var(--bg-light);
      padding-bottom: 5px;
    }

    .task-line {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      background: var(--bg-light);
      padding: 5px;
      border: 1px solid var(--primary);
      pointer-events: auto;
    }

    .task-line input[type="checkbox"] {
      margin-right: 10px;
      width: 16px;
      height: 16px;
      appearance: none;
      border: 2px solid var(--primary);
      background: var(--bg-medium);
      position: relative;
      pointer-events: auto;
      z-index: 11;
    }

    .task-line input[type="checkbox"]:checked {
      background: var(--secondary);
    }

    .task-line input[type="checkbox"]:checked::after {
      content: "✓";
      position: absolute;
      color: var(--text);
      font-size: 12px;
      top: -2px;
      left: 2px;
    }

    .task-line input[type="text"] {
      flex-grow: 1;
      font-size: 16px;
      font-family: monospace;
      color: var(--text);
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--text-dim);
      padding: 2px 0;
      outline: none;
      box-shadow: none;
      margin: 0;
      pointer-events: auto;
      z-index: 11;
    }

    .task-line input[type="text"]:focus {
      border-bottom: 1px solid var(--secondary);
      box-shadow: none;
    }

    .task-line .remove-task {
      margin-left: 10px;
      color: var(--accent);
      font-size: 16px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
      pointer-events: auto;
      z-index: 11;
    }

    .task-line .set-deadline {
      margin-left: 5px;
      color: var(--primary);
      font-size: 14px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 2px 5px;
      border: 1px solid var(--primary);
      pointer-events: auto;
      z-index: 11;
    }

    .task-line .set-deadline:hover {
      background: var(--primary);
      color: var(--text);
    }

    .task-line .deadline-info {
      margin-left: 5px;
      font-size: 12px;
      color: var(--accent-alt);
    }

    .task-line .points-info {
      margin-left: 5px;
      font-size: 12px;
      color: var(--secondary);
    }

    #lofiPlayer {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 101;
      display: none;
      background: var(--bg-medium);
      padding: 10px;
      border: 2px solid var(--primary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #lofiPlayer button {
      background: var(--secondary);
      border: none;
      color: var(--text);
      padding: 5px 10px;
      margin: 0 2px;
      cursor: pointer;
      font-size: 12px;
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
      font-family: monospace;
      z-index: 102;
    }

    /* Audio visualizer styles */
    #audioVisualizer {
      width: 100%;
      height: 40px;
      margin-bottom: 10px;
      background: var(--bg-dark);
      border: 1px solid var(--primary);
      display: none;
    }

    #achievementOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      color: gold;
      font-size: 32px;
      font-weight: bold;
      z-index: 104;
      display: none;
      font-family: monospace;
      text-align: center;
      text-shadow: 3px 3px 0 var(--primary-dark);
      background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
    }

    #achievementLevel {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 20px;
      font-weight: bold;
      z-index: 101;
      font-family: monospace;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    #streakDisplay {
      position: fixed;
      top: 60px;
      right: 10px;
      font-size: 16px;
      color: var(--text);
      z-index: 101;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
      font-family: monospace;
    }

    .glow {
      text-shadow: 0 0 10px var(--text);
      animation: pulse 2s infinite;
    }

    .box-glow {
      border: 2px solid gold;
      padding: 5px;
      box-shadow: 0 0 10px gold;
      animation: pulse 2s infinite;
    }

    .rainbow {
      background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s infinite;
    }

    @keyframes rainbow {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    #confirmationDialog,
    #streakShieldDialog,
    #doublePointsDialog,
    #deadlineDialog,
    #sessionCompleteDialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-medium);
      padding: 20px;
      border: 4px solid var(--accent);
      box-shadow: 0 0 20px rgba(255, 69, 0, 0.5);
      z-index: 105;
      display: none;
      text-align: center;
      pointer-events: auto;
      font-family: monospace;
    }

    #confirmationDialog p,
    #streakShieldDialog p,
    #doublePointsDialog p,
    #deadlineDialog p,
    #sessionCompleteDialog p {
      font-size: 16px;
      margin-bottom: 20px;
    }

    #confirmationDialog button,
    #streakShieldDialog button,
    #doublePointsDialog button,
    #deadlineDialog button,
    #sessionCompleteDialog button {
      padding: 8px 20px;
      margin: 0 10px;
      font-size: 14px;
      pointer-events: auto;
      z-index: 106;
    }

    #confirmBtn,
    #streakShieldConfirmBtn,
    #doublePointsConfirmBtn,
    #deadlineConfirmBtn,
    #sessionContinueBtn {
      background: var(--accent);
    }

    #cancelBtn,
    #streakShieldCancelBtn,
    #doublePointsCancelBtn,
    #deadlineCancelBtn,
    #sessionEndBtn {
      background: var(--primary);
    }

    #deadlineDialog input,
    #deadlineDialog select {
      margin: 10px auto;
      width: 100%;
      max-width: 250px;
    }

    #pdfToggle {
      display: none;
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: var(--primary);
      z-index: 101;
      cursor: pointer;
      pointer-events: auto;
    }

    #pdfViewer {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 500px;
      background: var(--bg-medium);
      padding: 15px;
      border: 4px solid var(--primary);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      z-index: 101;
      pointer-events: auto;
    }

    #pdfInput {
      margin-bottom: 10px;
      width: 100%;
      pointer-events: auto;
      z-index: 102;
    }

    #pdfFrame {
      width: 100%;
      height: 90%;
      border: none;
      background: #fff;
    }

    #fireBox {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      border: 2px solid var(--secondary);
      pointer-events: auto;
    }

    #fireBox:hover {
      background: var(--secondary);
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
    }

    #aiPopup {
      position: fixed;
      bottom: 60px;
      left: 10px;
      width: 300px;
      height: 400px;
      background: var(--bg-medium);
      border-radius: 0;
      padding: 5px;
      display: none;
      z-index: 101;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      border: 4px solid var(--primary);
      pointer-events: auto;
    }

    #aiPopup iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .game-sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      width: 250px;
      height: 100vh;
      background: var(--bg-medium);
      border-right: 4px solid var(--primary);
      z-index: 200;
      transition: left 0.3s ease;
      padding: 20px 0;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
      pointer-events: auto;
    }

    .sidebar-trigger:hover + .game-sidebar,
    .game-sidebar:hover {
      left: 0;
    }

    .sidebar-trigger {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 80px;
      background: var(--primary);
      z-index: 199;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      font-weight: bold;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 12px;
      letter-spacing: 1px;
      pointer-events: auto;
    }

    .sidebar-section {
      padding: 15px;
      border-bottom: 2px solid var(--bg-dark);
    }

    .sidebar-section h3 {
      color: var(--secondary);
      font-size: 16px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-section a,
    .sidebar-section button {
      display: block;
      width: 100%;
      padding: 8px 10px;
      margin: 5px 0;
      background: var(--bg-light);
      color: var(--text);
      border: 1px solid var(--primary);
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      pointer-events: auto;
      z-index: 201;
    }

    .sidebar-section a:hover,
    .sidebar-section button:hover {
      background: var(--primary);
      transform: translateX(5px);
    }

    .dashboard-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dashboard-info p {
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }

    .dashboard-info p span:first-child {
      font-weight: bold;
      color: var(--primary);
    }

    #mysteryBoxPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-medium);
      padding: 20px;
      border: 4px solid gold;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      z-index: 105;
      display: none;
      text-align: center;
      pointer-events: auto;
      font-family: monospace;
      width: 300px;
    }

    #mysteryBoxPopup h3 {
      color: gold;
      font-size: 20px;
      margin-bottom: 15px;
    }

    #mysteryBoxPopup p {
      font-size: 16px;
      margin-bottom: 20px;
    }

    #mysteryBoxPopup button {
      padding: 8px 20px;
      background: var(--accent);
      font-size: 14px;
      pointer-events: auto;
    }

    /* Audio tracks store styles */
    #audioTracksStore {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      max-height: 500px;
      background: var(--bg-medium);
      padding: 20px;
      border: 4px solid var(--secondary);
      box-shadow: 0 0 20px rgba(142, 45, 226, 0.5);
      z-index: 105;
      display: none;
      text-align: center;
      pointer-events: auto;
      font-family: monospace;
      overflow-y: auto;
    }

    #audioTracksStore h3 {
      color: var(--secondary);
      font-size: 20px;
      margin-bottom: 15px;
    }

    .audio-track-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      margin-bottom: 10px;
      background: var(--bg-light);
      border: 1px solid var(--primary);
    }

    .audio-track-item.locked .track-name {
      color: var(--text-dim);
    }

    .audio-track-item.unlocked .track-name {
      color: var(--accent-alt);
    }

    .unlock-track-btn {
      padding: 5px 10px;
      background: var(--secondary);
      font-size: 12px;
      margin: 0;
    }

    .unlock-track-btn:disabled {
      background: var(--bg-light);
      color: var(--text-dim);
      cursor: not-allowed;
    }

    /* Quiet Pomodoro styles */
    #pomodoroOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 15, 27, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      pointer-events: auto;
    }

    #pomodoroContainer {
      width: 400px;
      background: var(--bg-medium);
      padding: 30px;
      border: 4px solid var(--secondary);
      box-shadow: 0 0 30px rgba(142, 45, 226, 0.5);
      text-align: center;
      pointer-events: auto;
    }

    #pomodoroTimer {
      font-size: 80px;
      font-weight: bold;
      color: var(--text);
      margin: 20px 0;
      font-family: monospace;
    }

    #pomodoroControls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }

    #pomodoroControls button {
      padding: 10px 25px;
      font-size: 16px;
    }

    #pomodoroStatus {
      font-size: 18px;
      color: var(--accent-alt);
      margin-top: 15px;
    }

    /* Detailed Stats Calendar styles */
    #detailedStatsOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 15, 27, 0.9);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      pointer-events: auto;
    }

    #detailedStatsContainer {
      width: 700px;
      max-width: 90vw;
      background: var(--bg-medium);
      padding: 30px;
      border: 4px solid var(--primary);
      box-shadow: 0 0 30px rgba(65, 105, 225, 0.5);
      text-align: center;
      pointer-events: auto;
    }

    #detailedStatsContainer h3 {
      color: var(--primary);
      font-size: 24px;
      margin-bottom: 20px;
      text-shadow: 2px 2px 0px var(--primary-dark);
    }

    #calendarContainer {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin: 20px 0;
    }

    .calendar-day-header {
      font-weight: bold;
      color: var(--secondary);
      padding: 5px;
      text-align: center;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 1px solid var(--primary);
      padding: 5px;
      font-size: 12px;
      position: relative;
      cursor: pointer;
    }

    .calendar-day .date {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .calendar-day .points {
      font-size: 10px;
    }

    .calendar-day.empty {
      background: var(--bg-light);
      opacity: 0.5;
    }

    .calendar-day.today {
      border: 2px solid var(--accent);
    }

    .calendar-day.level-0 {
      background: var(--calendar-blue-1);
    }

    .calendar-day.level-1 {
      background: var(--calendar-blue-2);
    }

    .calendar-day.level-2 {
      background: var(--calendar-blue-3);
    }

    .calendar-day.level-3 {
      background: var(--calendar-blue-4);
    }

    .calendar-day.level-4 {
      background: var(--calendar-blue-5);
    }

    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      font-size: 12px;
    }

    .legend-color {
      width: 15px;
      height: 15px;
      margin-right: 5px;
    }

    #calendarControls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    #calendarControls button {
      padding: 5px 10px;
      font-size: 14px;
    }

    #currentMonth {
      font-size: 18px;
      font-weight: bold;
      color: var(--text);
    }

    #closeDetailedStats {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--accent);
      padding: 5px 10px;
      font-size: 14px;
    }

    @media (max-width: 800px) {
      .title { font-size: 24px; }
      button { padding: 8px 16px; font-size: 12px; margin: 0 5px 10px; }
      #features { flex-direction: column; align-items: center; }
      .feature { width: 90%; max-width: 250px; }
      #timerDisplay, #pointsDisplay, #clockDisplay, #sitesBox { font-size: 14px; padding: 5px 8px; }
      #achievementLevel, #streakDisplay { font-size: 14px; padding: 5px 8px; }
      #videoSidebar { width: 250px; }
      #lofiPlayer button { padding: 3px 6px; font-size: 10px; }
      #confirmationDialog, #streakShieldDialog, #doublePointsDialog { width: 90%; max-width: 300px; }
      #confirmationDialog p, #streakShieldDialog p, #doublePointsDialog p { font-size: 14px; }
      #pdfViewer { width: 90%; height: 80%; max-height: 500px; }
      #aiPopup { width: 90%; max-width: 300px; height: 350px; }
      #mysteryBoxPopup { width: 90%; max-width: 280px; }
      #audioTracksStore { width: 90%; max-width: 350px; }
      #pomodoroContainer { width: 90%; max-width: 350px; padding: 20px; }
      #pomodoroTimer { font-size: 60px; }
      #detailedStatsContainer { width: 95%; padding: 15px; }
      .calendar-day { font-size: 10px; }
      .calendar-day .points { font-size: 8px; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="sidebar-trigger">MENU</div>
    <div class="game-sidebar">
      <div class="sidebar-section">
        <h3>Dashboard</h3>
        <div class="dashboard-info">
          <p><span>Hero:</span> <span id="sidebarUsername">Guest</span></p>
          <p><span>Level:</span> <span id="sidebarLevel">Mortal</span></p>
          <p><span>XP:</span> <span id="sidebarXP">0</span></p>
          <p><span>Streak:</span> <span id="sidebarStreak">0 days</span></p>
        </div>
        <button id="detailedStatsBtn">DETAILED STATS</button>
      </div>
      <div class="sidebar-section">
        <h3>Allied Realms</h3>
        <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer">FOREST QUEST - TASK MANAGEMENT</a>
        <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer">POMODORO REALM</a>
        <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer">DAILY QUEST PLANNER</a>
      </div>
      <div class="sidebar-section">
        <h3>Self Study</h3>
        <button id="quietPomodoroBtn">QUIET POMODORO</button>
      </div>
      <div class="sidebar-section">
        <h3>Shops</h3>
        <button id="streakShieldBtn">STREAK SHIELD</button>
        <button id="doublePointsBtn">DOUBLE POINTS POWER-UP</button>
        <button id="audioStoreBtn">AUDIO TRACKS STORE</button>
      </div>
      <div class="sidebar-section">
        <h3>Account</h3>
        <button id="logoutBtn">LOGOUT</button>
      </div>
    </div>
    <div id="landingPage">
      <div class="title">QUEST FOR <span>FOCUS</span></div>
      <div class="subtitle">Begin your learning adventure!</div>
      <button data-action="start-game">START GAME</button>
      <button class="github-btn" data-action="github">GITHUB REPO</button>
      <div id="features">
        <div class="feature">
          <i class="fas fa-ad"></i>
          <p>Ad Free<br>No distractions on your quest</p>
        </div>
        <div class="feature">
          <i class="fas fa-moon"></i>
          <p>Dark Mode<br>Save your vision for the final boss</p>
        </div>
      </div>
    </div>

    <div id="signinForm" style="display: none;">
      <div class="title">CREATE YOUR <span>ACCOUNT</span></div>
      <div class="subtitle">Sign in to track your progress</div>
      <input type="text" id="username" placeholder="Hero Name" required />
      <input type="password" id="password" placeholder="Secret Code" required />
      <button data-action="sign-in">ENTER REALM</button>
      <p>New adventurer? <button data-action="create-account">CREATE ACCOUNT</button></p>
    </div>

    <div id="inputForm" style="display: none;">
      <div id="achievementLevel"></div>
      <div id="streakDisplay"></div>
      <button id="todoBtn">TO-DO</button>
      <button id="statsBtn">HERO STATS</button>
      <button id="pyqBtn">TRAINING GROUNDS</button>

      <div id="todoList">
        <h3>TO-DO</h3>
        <div id="tasks">
          <div class="task-line">
            <input type="checkbox" class="task-check" />
            <input type="text" class="task-text" placeholder="Add a quest..." />
            <button class="set-deadline">⏰</button>
            <span class="remove-task">x</span>
          </div>
        </div>
        <button data-action="save-tasks">SAVE QUESTS</button>
      </div>

      <div id="analytics">
        <h3>HERO STATS</h3>
        <p>Focus Time: <span id="totalFocusTime">0</span> min</p>
        <p>Distractions Defeated: <span id="totalDistractions">0</span></p>
        <p>Videos Completed: <span id="totalVideosWatched">0</span></p>
      </div>

      <div class="title">ENTER YOUR <span>YOUTUBE URL</span></div>
      <div class="subtitle"></div>
      <select id="playlistSelect">
        <option value="">Select a Playlist</option>
      </select>
      <input type="text" id="playlistName" placeholder="Save Path As..." />
      <button data-action="save-playlist">SAVE PLAYLIST</button>
      <button data-action="remove-playlist">DELETE PLAYLIST</button>

      <div id="urlInputs">
        <div class="url-container">
          <input type="text" class="youtube-url" placeholder="YouTube URL (Videos or Live Streams)" required />
        </div>
      </div>

      <button data-action="add-url">ADD URL</button>
      <button data-action="start-playback">BEGIN FOCUS</button>
    </div>

    <div id="player" style="display: none;"></div>

    <div id="timerDisplay">
      <span id="timerText"></span>
      <div id="progressBar">
        <div id="progressFill"></div>
      </div>
    </div>

    <div id="pointsDisplay"><span style="color: #8e2de2;">⭐</span> XP: 0</div>
    <div id="clockDisplay"></div>

    <div id="sitesBox" style="display: none;">ALLIED REALMS 👇</div>
    <div id="sitesPopup">
      <button id="closeSitesPopup">X</button>
      <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer">FOREST QUEST - TASK MANAGEMENT</a>
      <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer">POMODORO REALM</a>
      <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer">DAILY QUEST PLANNER</a>
    </div>

    <button id="restartBtn" style="display: none;">EXIT</button>

    <div id="videoSidebar"></div>

    <div id="lofiPlayer">
      <canvas id="audioVisualizer"></canvas>
      <div style="text-align: center; margin-bottom: 5px;">LOFI MUSIC ♬</div>
      <button id="lofiPrev">◄</button>
      <button id="lofiPlay">▶</button>
      <button id="lofiPause">❚❚</button>
      <button id="lofiNext">►</button>
    </div>

    <div id="achievementOverlay"></div>

    <div id="confirmationDialog" style="display: none;">
      <p>Are you sure you want to abandon your quest?</p>
      <button id="confirmBtn">YES</button>
      <button id="cancelBtn">NO</button>
    </div>

    <div id="streakShieldDialog" style="display: none;">
      <p>Are you sure you want to buy Streak Shield for 800 XP? (Protects streak for 1 week)</p>
      <button id="streakShieldConfirmBtn">YES</button>
      <button id="streakShieldCancelBtn">NO</button>
    </div>

    <div id="doublePointsDialog" style="display: none;">
      <p>Are you sure you want to buy Double Points Power-Up for 800 XP? (Doubles points for 24 hours)</p>
      <button id="doublePointsConfirmBtn">YES</button>
      <button id="doublePointsCancelBtn">NO</button>
    </div>

    <div id="deadlineDialog" style="display: none;">
      <h3>Set Task Deadline</h3>
      <p>Set a deadline for your task to earn points!</p>
      <input type="date" id="deadlineDate" />
      <input type="time" id="deadlineTime" />
      <select id="taskDifficulty">
        <option value="50">Easy (50 points)</option>
        <option value="100">Medium (100 points)</option>
        <option value="200">Hard (200 points)</option>
      </select>
      <button id="deadlineConfirmBtn">SET DEADLINE</button>
      <button id="deadlineCancelBtn">CANCEL</button>
    </div>

    <div id="sessionCompleteDialog" style="display: none;">
      <h3>Session Complete!</h3>
      <p>Great work! You've completed a focus session.</p>
      <p>One more session for +100 bonus points?</p>
      <button id="sessionContinueBtn">CONTINUE (+100 XP)</button>
      <button id="sessionEndBtn">END SESSION</button>
    </div>

    <div id="detailedStatsOverlay" style="display: none;">
      <div id="detailedStatsContainer">
        <h3>DETAILED STATS</h3>
        <div id="calendarControls">
          <button id="prevMonthBtn">◄ PREV</button>
          <div id="currentMonth">January 2023</div>
          <button id="nextMonthBtn">NEXT ►</button>
        </div>
        <div id="calendarContainer"></div>
        <div class="calendar-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-1);"></div>
            <span>0-50 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-2);"></div>
            <span>51-100 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-3);"></div>
            <span>101-200 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-4);"></div>
            <span>201-300 XP</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--calendar-blue-5);"></div>
            <span>300+ XP</span>
          </div>
        </div>
        <button id="closeDetailedStats">CLOSE</button>
      </div>
    </div>

    <button id="pdfToggle">PDF UPLOAD</button>

    <div id="pdfViewer">
      <input type="file" id="pdfInput" accept=".pdf" />
      <iframe id="pdfFrame"></iframe>
      <button onclick="togglePDFViewer()" style="background: #ff4444; margin-top: 10px;">CLOSE</button>
    </div>

    <div id="fireBox">🧙</div>
    <div id="aiPopup">
      <iframe src="https://www.chatbase.co/chatbot-iframe/3dSdpryiYZlWipHUL8dNK" frameBorder="0"></iframe>
    </div>

    <div id="mysteryBoxPopup" style="display: none;">
      <h3>Focus Mystery Box</h3>
      <p id="mysteryRewardText">Click to reveal your reward!</p>
      <button id="openMysteryBox">OPEN</button>
    </div>

    <div id="audioTracksStore" style="display: none;">
      <h3>AUDIO TRACKS STORE</h3>
      <p>Unlock exclusive Lo-Fi tracks to enhance your focus sessions!</p>
      <div id="audioTracksList"></div>
      <button id="closeAudioStore" style="background: #ff4444; margin-top: 15px;">CLOSE</button>
    </div>

    <div id="pomodoroOverlay" style="display: none;">
      <div id="pomodoroContainer">
        <h3>QUIET POMODORO</h3>
        <p>Focus in silence, earn points with each minute</p>
        <div id="pomodoroTimer">60:00</div>
        <div id="pomodoroStatus">Ready to begin</div>
        <div id="pomodoroControls">
          <button id="pomodoroStartBtn">START</button>
          <button id="pomodoroResetBtn">RESET</button>
          <button id="pomodoroCloseBtn">CLOSE</button>
        </div>
      </div>
    </div>

    <audio id="focusAudio" preload="none" src="https://the-chosen-one-o5.github.io/UltraFocusModeYT/focus.mp3"></audio>
    <audio id="lofiAudio" preload="none" loop></audio>
    <audio id="pomodoroCompleteAudio" preload="none" src="https://www.dropbox.com/scl/fi/ihrcv1s3o4m4abhn6oa5z/level-up-4-243762.mp3?rlkey=qkaf4zrhipxtxpu51an0do45r&st=boipxpb5&dl=1"></audio>
  </div>

  <script>
    ;(() => {
      let currentVideoIndex = 0
      let player
      let videoIds = []
      let isFocusModeActive = false
      let countdownInterval
      let distractionCount = 0
      let points = 0
      let isSignedIn = false
      let currentUser = null
      const focusDuration = 50 * 60 * 1000
      const firstBreakDuration = 15 * 60 * 1000
      const secondBreakDuration = 10 * 60 * 1000
      let timerMode = "Focus Time"
      let timerRemaining = focusDuration / 1000
      let completedVideos = new Set()
      let allVideosCompleted = false
      let totalFocusTime = 0
      let totalDistractions = 0
      let totalVideosWatched = 0
      let playlists = JSON.parse(localStorage.getItem("playlists") || "[]")
      let tasks = JSON.parse(localStorage.getItem("tasks") || "[]")
      let previousPoints = 0
      let streakDays = 0
      let lastFocusDate = null
      let isYouTubeAPILoaded = false
      let lofiAudio
      const lofiSongs = [
        "https://www.dropbox.com/scl/fi/7qrgbk6vpej7x0ih7vev2/1-6_XRwBX7NX-1.mp3?rlkey=m3gntnys7az2hoq0iokkajucj&st=bmrhzjy8&dl=1",
        "https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1",
        "https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1",
        "https://www.dropbox.com/scl/fi/lb5f47widcz8mwhg79jiz/Kate-Grove-SKYRIM-THEME-skyrim-elderscrolls-ocarina.mp3?rlkey=f8kpm1ipyowc1wv998myu06us&st=bm9qmodf&dl=1",
        "https://www.dropbox.com/scl/fi/8wf64nv0rwub7hbs5x20/Kurate-Music-Best-of-Gibran-Alcocer-Beautiful-Piano-Mix.mp3?rlkey=i776feuxag0ebullqe0kjo0gp&st=bb3uyo3h&dl=1",
        "https://www.dropbox.com/scl/fi/7xoemzmrgq0wzbxc9i9tp/Jumping-_brick-Sidewalks-and-skeletons-goth-slowed-reverb-best-part-loop.mp3?rlkey=d4dt6rv6sdzteextqek29geug&st=4umnyp0c&dl=1",
        "https://www.dropbox.com/scl/fi/macw47c2kvur0yfi4r9up/St3phen-If-Youre-A-Gamer-This-Song-FOUND-You.mp3?rlkey=qudky54311tppavhvnpra89ff&st=7dgshk5k&dl=1",
        "https://www.dropbox.com/scl/fi/c1iy5yjmf3d57jrb1aokc/KestrelTapes-what-nostalgia-sounds-like...mp3?rlkey=qcdj1vpdnzwdb03fxp0vk0661&st=fyqrl6ge&dl=1",
        "https://www.dropbox.com/scl/fi/p303xk68pvu8sfrmtwzj2/rhawn-there-is-hopecore.mp3?rlkey=m6tva7g4dsva39ii1l0e8tnu0&st=6z218pii&dl=1",
        "https://www.dropbox.com/scl/fi/bw4n0ne8nli4dkp7p26po/Jaob-not-just-another-hopecore-playlist.mp3?rlkey=jy0umwkadkxj9cju1yf2wz7hw&st=yjxhzw0s&dl=1",
        "https://www.dropbox.com/scl/fi/evhrjdri6a9n9bk05qhcu/Kyle-Dixon-Michael-Stei-Kids.mp3?rlkey=lauo50rz3indg5n3to5gfks1y&st=gcqmonsf&dl=1",
      ]
      
      // Premium audio tracks that can be unlocked
      const premiumLofiTracks = [
        { id: "track1", name: "Celestial Dreams", url: "https://www.dropbox.com/scl/fi/3xkks3j4tcmnloz46o03m/Kyle-Dixon-Michael-Stei-Kids.mp3?rlkey=6w97eurecqph68b8f2r7zn5pf&st=epeucz72&dl=1", unlocked: false, cost: 100 },
        { id: "track2", name: "Midnight Study", url: "https://www.dropbox.com/scl/fi/7vikjhsay7xayyab0tlvt/enchanted-metamorphosis-chronicles-264087.mp3?rlkey=mrdncvjr3g5bo8dksxywh9zxh&st=ui3kdsq5&dl=1", unlocked: false, cost: 100 },
        { id: "track3", name: "Rainy Day Focus", url: "https://www.dropbox.com/scl/fi/iaouozc1osse7h5ea9lon/thunder-chosic.com.mp3?rlkey=o7u0rarnh4kk657qhmcgyiolz&st=2r9f625j&dl=1", unlocked: false, cost: 100 },
        { id: "track4", name: "Epic Concentration", url: "https://www.dropbox.com/scl/fi/7vikjhsay7xayyab0tlvt/enchanted-metamorphosis-chronicles-264087.mp3?rlkey=mrdncvjr3g5bo8dksxywh9zxh&st=cq8j3dij&dl=1", unlocked: false, cost: 100 },
        { id: "track5", name: "Zen Garden", url: "https://www.dropbox.com/scl/fi/8wf64nv0rwub7hbs5x20/Kurate-Music-Best-of-Gibran-Alcocer-Beautiful-Piano-Mix.mp3?rlkey=i776feuxag0ebullqe0kjo0gp&st=bb3uyo3h&dl=1", unlocked: false, cost: 100 },
      ]
      
      // Audio visualizer variables
      let audioContext
      let analyser
      let audioSource
      let visualizerCanvas
      let visualizerCtx
      let isVisualizerActive = false
      let visualizerAnimationFrame
      
      // Daily points tracking for calendar
      let dailyPointsData = {}
      let currentCalendarMonth = new Date().getMonth()
      let currentCalendarYear = new Date().getFullYear()
      
      let currentLofiIndex = 0
      let currentTaskForDeadline = null

      // Pomodoro variables
      let pomodoroInterval
      let pomodoroTimeRemaining = 60 * 60 // 60 minutes in seconds
      let isPomodoroActive = false
      let pomodoroStartTime = null
      let pomodoroPoints = 0

      // Reminder feature variables
      let reminderInterval
      let timeOnInputForm = 0
      const reminderIntervalTime = 20 * 60 * 1000 // 20 minutes in milliseconds
      const reminderThreshold = 20 * 60 * 1000 // 20 minutes threshold

      // Mystery Box and Power-Up feature variables
      let mysteryBoxCount = 0
      let activePowerUps = {
        doublePoints: { active: false, expiry: null },
        streakShield: { active: false, used: false, expiry: null },
      }
      const STREAK_SHIELD_COST = 800
      const STREAK_SHIELD_DURATION = 7 * 24 * 60 * 60 * 1000 // 1 week in milliseconds
      const DOUBLE_POINTS_COST = 800
      const DOUBLE_POINTS_DURATION = 24 * 60 * 60 * 1000 // 24 hours in milliseconds
      const MYSTERY_BOX_STREAK_INTERVAL = 14
      const mysteryBoxRewards = [
        { type: "points", value: () => Math.floor(Math.random() * 451) + 50, message: (val) => `+${val} XP` },
        { type: "doublePoints", value: DOUBLE_POINTS_DURATION, message: () => "Double Points for 24 Hours" },
        { type: "streakShield", value: 1, message: () => "1-Day Streak Shield" },
      ]

      const achievementLevels = [
        { points: 0, level: "Mortal", color: "white" },
        { points: 1000, level: "Soldier", color: "#4169E1" },
        { points: 2000, level: "Knight", color: "white", glow: true },
        { points: 3000, level: "KING", color: "#FF8C00", glow: true },
        { points: 4000, level: "GIGACHAD", color: "#FF4500", glow: true },
        { points: 5000, level: "Demigod", color: "gold", glow: true },
        { points: 6000, level: "Titan", color: "gold", glow: true, box: true },
        { points: 7000, level: "Immortal", color: "gold", glow: true, box: true, boxGlow: true },
        { points: 8000, level: "Celestial", color: "gold", glow: true, box: true, boxGlow: true },
        { points: 9000, level: "Divine", color: "rainbow" },
        { points: 10000, level: "Omnipotent", color: "rainbow", glow: true },
      ]

// Replace the initAudio function with this more robust version
function initAudio() {
  lofiAudio = document.getElementById("lofiAudio");
  if (lofiAudio) {
    // Set loop attribute directly
    lofiAudio.loop = true;
    
    // Preload metadata but don't autoplay
    lofiAudio.preload = "metadata";
    lofiAudio.src = lofiSongs[currentLofiIndex];
    
    console.log("Lofi audio initialized with source:", lofiSongs[currentLofiIndex]);
  }
  
  // Initialize audio visualizer canvas
  visualizerCanvas = document.getElementById("audioVisualizer");
  if (visualizerCanvas) {
    visualizerCtx = visualizerCanvas.getContext("2d");
    visualizerCanvas.width = visualizerCanvas.offsetWidth;
    visualizerCanvas.height = visualizerCanvas.offsetHeight;
    console.log("Visualizer canvas initialized:", visualizerCanvas.width, "x", visualizerCanvas.height);
  }
}

// Replace the initAudioContext function with this improved version
function initAudioContext() {
  console.log("Initializing audio context...");
  if (!audioContext) {
    try {
      // Create new audio context
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      console.log("Audio context created:", audioContext.state);
      
      // Create analyzer
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 256;
      console.log("Analyzer created with fftSize:", analyser.fftSize);
      
      // Don't connect audio source yet - we'll do that when play is clicked
    } catch (e) {
      console.error("Failed to create audio context:", e);
    }
  } else if (audioContext.state === "suspended") {
    audioContext.resume().then(() => {
      console.log("Audio context resumed:", audioContext.state);
    }).catch(err => {
      console.error("Failed to resume audio context:", err);
    });
  }
}

// Replace the playLofi function with this completely rewritten version
function playLofi() {
  console.log("Play lofi requested");
  
  if (!lofiAudio) {
    console.error("Lofi audio element not found");
    return;
  }
  
  // Initialize audio context on first play (must be in response to user gesture)
  if (!audioContext) {
    console.log("Creating audio context on user interaction");
    initAudioContext();
  }
  
  // Resume audio context if suspended
  if (audioContext && audioContext.state === "suspended") {
    console.log("Resuming suspended audio context");
    audioContext.resume().catch(err => console.error("Failed to resume audio context:", err));
  }
  
  // Create and connect audio source if it doesn't exist
  if (!audioSource && audioContext && lofiAudio) {
    try {
      console.log("Creating and connecting audio source");
      audioSource = audioContext.createMediaElementSource(lofiAudio);
      audioSource.connect(analyser);
      analyser.connect(audioContext.destination);
      console.log("Audio source connected to analyzer and destination");
    } catch (e) {
      console.error("Error connecting audio source:", e);
      
      // If we get an error about the source already being connected, try to recover
      if (e.message && e.message.includes("already connected")) {
        console.log("Attempting to recover from 'already connected' error");
        try {
          // Try disconnecting and reconnecting
          audioSource.disconnect();
          audioSource.connect(analyser);
          analyser.connect(audioContext.destination);
          console.log("Recovery successful");
        } catch (reconnectError) {
          console.error("Recovery failed:", reconnectError);
        }
      }
    }
  }
  
  // Ensure lofi audio is set to loop
  lofiAudio.loop = true;
  
  // Display visualizer before playing
  if (visualizerCanvas) {
    visualizerCanvas.style.display = "block";
    console.log("Visualizer canvas displayed");
  }
  
  // Play the audio with proper error handling
  console.log("Attempting to play lofi audio");
  lofiAudio.play()
    .then(() => {
      console.log("Lofi audio playing successfully");
      isVisualizerActive = true;
      startVisualizer();
    })
    .catch((err) => {
      console.error("Lofi play error:", err);
      
      // Try to recover by reloading the audio
      console.log("Attempting recovery...");
      lofiAudio.load();
      setTimeout(() => {
        lofiAudio.play()
          .then(() => {
            console.log("Recovery successful");
            isVisualizerActive = true;
            startVisualizer();
          })
          .catch(e => console.error("Recovery failed:", e));
      }, 500);
    });
}

// Replace the startVisualizer function with this improved version
function startVisualizer() {
  if (!visualizerCanvas || !analyser) {
    console.error("Cannot start visualizer: missing canvas or analyzer");
    return;
  }
  
  console.log("Starting visualizer");
  visualizerCanvas.style.display = "block";
  isVisualizerActive = true;
  
  // Make sure audio context is running
  if (audioContext && audioContext.state === "suspended") {
    audioContext.resume().catch(err => console.error("Failed to resume audio context:", err));
  }
  
  // Start the visualization loop
  drawVisualizer();
}

// Replace the drawVisualizer function with this improved version
function drawVisualizer() {
  if (!isVisualizerActive || !analyser || !visualizerCtx) {
    console.log("Visualizer inactive or missing components");
    return;
  }
  
  // Get frequency data
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  analyser.getByteFrequencyData(dataArray);
  
  // Clear canvas
  visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
  
  // Calculate bar width based on canvas size and buffer length
  const barWidth = (visualizerCanvas.width / bufferLength) * 2.5;
  let barHeight;
  let x = 0;
  
  // Draw bars
  for (let i = 0; i < bufferLength; i++) {
    barHeight = dataArray[i] / 2;
    
    // Create gradient for bars
    const gradient = visualizerCtx.createLinearGradient(0, 0, 0, visualizerCanvas.height);
    gradient.addColorStop(0, "#8e2de2"); // Purple
    gradient.addColorStop(1, "#4169e1"); // Blue
    
    visualizerCtx.fillStyle = gradient;
    visualizerCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
    
    x += barWidth + 1;
  }
  
  // Continue animation loop
  visualizerAnimationFrame = requestAnimationFrame(drawVisualizer);
}

// Replace the pauseLofi function with this improved version
function pauseLofi() {
  console.log("Pause lofi requested");
  
  if (!lofiAudio) {
    console.error("Lofi audio element not found");
    return;
  }
  
  // Pause the audio
  lofiAudio.pause();
  console.log("Lofi audio paused");
  
  // Stop visualizer
  stopVisualizer();
}

// Replace the stopVisualizer function with this improved version
function stopVisualizer() {
  console.log("Stopping visualizer");
  isVisualizerActive = false;
  
  if (visualizerAnimationFrame) {
    cancelAnimationFrame(visualizerAnimationFrame);
    console.log("Animation frame canceled");
  }
  
  if (visualizerCanvas) {
    visualizerCanvas.style.display = "none";
    console.log("Visualizer canvas hidden");
  }
}

// Replace the visibilitychange event handler with this improved version
document.addEventListener("visibilitychange", () => {
  if (document.hidden && isFocusModeActive) {
    console.log("Tab hidden while focus mode active");
    distractionCount++;
    totalDistractions++;
    
    // Reduce points when user is distracted (switching tabs)
    const pointsLost = 10; // Lose 10 points per distraction
    points = Math.max(0, points - pointsLost); // Ensure points don't go below 0
    document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
    
    // Pause lofi music
    pauseLofi();
    
    // Play focus audio when user is distracted
    const focusAudio = document.getElementById("focusAudio");
    if (focusAudio) {
      console.log("Playing focus audio");
      // Reset audio to beginning to ensure it plays
      focusAudio.currentTime = 0;
      focusAudio.play().catch(err => console.error("Focus audio play error:", err));
    }
    
    saveState();
    
    // Store the notification for when user returns
    window.distracted = true;
  } else if (!document.hidden && isFocusModeActive) {
    console.log("Tab visible again while focus mode active");
    
    // Show notification if user was distracted
    if (window.distracted) {
      setTimeout(() => {
        alert(`Distraction penalty: -10 XP. Stay focused!`);
        window.distracted = false;
      }, 300);
    }
    
    // Don't automatically resume lofi music - let user click play again
  }
});

      function saveState() {
        const state = {
          videoIds,
          currentVideoIndex,
          distractionCount,
          points,
          timerMode,
          timerRemaining,
          isFocusModeActive,
          isSignedIn,
          currentUser,
          completedVideos: Array.from(completedVideos),
          allVideosCompleted,
          totalFocusTime,
          totalDistractions,
          totalVideosWatched,
          streakDays,
          lastFocusDate: localStorage.getItem("lastFocusDate"),
          mysteryBoxCount,
          activePowerUps,
          premiumLofiTracks,
          dailyPointsData
        }
        localStorage.setItem("focusModeState", JSON.stringify(state))

        if (isSignedIn && currentUser) {
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          users[currentUser].points = points
          users[currentUser].totalFocusTime = totalFocusTime
          users[currentUser].totalDistractions = totalDistractions
          users[currentUser].totalVideosWatched = totalVideosWatched
          users[currentUser].tasks = tasks
          users[currentUser].streakDays = streakDays
          users[currentUser].mysteryBoxCount = mysteryBoxCount
          users[currentUser].activePowerUps = activePowerUps
          users[currentUser].premiumLofiTracks = premiumLofiTracks
          users[currentUser].dailyPointsData = dailyPointsData
          localStorage.setItem("users", JSON.stringify(users))
        }
      }

      function updateSidebarDashboard() {
        const sidebarUsername = document.getElementById("sidebarUsername")
        const sidebarLevel = document.getElementById("sidebarLevel")
        const sidebarXP = document.getElementById("sidebarXP")
        const sidebarStreak = document.getElementById("sidebarStreak")
        if (!sidebarUsername || !sidebarLevel || !sidebarXP || !sidebarStreak) return

        sidebarUsername.textContent = currentUser || "Guest"
        const level = getAchievementLevel(points)
        sidebarLevel.textContent = level.level
        sidebarXP.textContent = points
        sidebarStreak.textContent = `${streakDays} day${streakDays === 1 ? "" : "s"}`
      }

      function logout() {
        isSignedIn = false
        currentUser = null
        points = 0
        totalFocusTime = 0
        totalDistractions = 0
        totalVideosWatched = 0
        tasks = []
        streakDays = 0
        mysteryBoxCount = 0
        dailyPointsData = {}
        activePowerUps = {
          doublePoints: { active: false, expiry: null },
          streakShield: { active: false, used: false, expiry: null },
        }
        videoIds = []
        currentVideoIndex = 0
        completedVideos.clear()
        allVideosCompleted = false
        clearInterval(countdownInterval)
        isFocusModeActive = false
        if (player) player.destroy()
        document.getElementById("player").style.display = "none"
        document.getElementById("restartBtn").style.display = "none"
        document.getElementById("pdfToggle").style.display = "none"
        document.getElementById("videoSidebar").style.right = "-320px"
        document.getElementById("inputForm").style.display = "none"
        document.getElementById("landingPage").style.display = "block"
        document.getElementById("clockDisplay").style.display = "none"
        document.getElementById("sitesBox").style.display = "none"
        document.getElementById("lofiPlayer").style.display = "none"
        document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: 0`
        const progressBar = document.getElementById("progressBar")
        if (progressBar) progressBar.style.display = "none"
        saveState()
        stopReminderTimer()
        updateAnalytics()
        updateAchievementLevel()
        updateSidebarDashboard()
      }

      document.addEventListener("DOMContentLoaded", () => {
        initAudio()
        loadSavedState()
        setInterval(updateClock, 1000)

        document.querySelectorAll("button[data-action]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const action = btn.getAttribute("data-action")
            switch (action) {
              case "start-game":
                showSignIn()
                break
              case "github":
                window.open("https://github.com/The-Chosen-One-o5/UltraFocusModeYT", "_blank")
                break
              case "sign-in":
                signIn()
                break
              case "create-account":
                createAccount()
                break
              case "add-url":
                addUrlInput()
                break
              case "start-playback":
                startPlayback()
                break
              case "save-playlist":
                savePlaylist()
                break
              case "remove-playlist":
                removePlaylist()
                break
              case "save-tasks":
                saveTasks()
                break
            }
          })
        })

        document.getElementById("restartBtn").addEventListener("click", restartSession)
        document.getElementById("confirmBtn").addEventListener("click", () => handleRestartConfirmation("yes"))
        document.getElementById("cancelBtn").addEventListener("click", () => handleRestartConfirmation("no"))
        document.getElementById("sitesBox").addEventListener("click", toggleSitesPopup)
        document.getElementById("closeSitesPopup").addEventListener("click", closeSitesPopup)
// Add debug logging for audio visualizer
  const lofiPlayBtn = document.getElementById("lofiPlay");
  if (lofiPlayBtn) {
    lofiPlayBtn.addEventListener("click", () => {
      console.log("Play button clicked");
      // Force audio context creation on user interaction
      if (!audioContext) {
        initAudioContext();
      }
      playLofi();
    });
  }
        document.getElementById("lofiPlay").addEventListener("click", playLofi)
        document.getElementById("lofiPause").addEventListener("click", pauseLofi)
        document.getElementById("lofiPrev").addEventListener("click", prevLofi)
        document.getElementById("lofiNext").addEventListener("click", nextLofi)
        document.getElementById("statsBtn").addEventListener("click", toggleAnalytics)
        document.getElementById("todoBtn").addEventListener("click", toggleTodo)
        document.getElementById("pyqBtn").addEventListener("click", redirectToPYQs)
        document.getElementById("pdfToggle").addEventListener("click", togglePDFViewer)
        document.getElementById("pdfInput").addEventListener("change", handlePDFUpload)
        document.getElementById("fireBox").addEventListener("click", toggleAIPopup)
        document.getElementById("streakShieldBtn").addEventListener("click", showStreakShieldDialog)
        document
          .getElementById("streakShieldConfirmBtn")
          .addEventListener("click", () => handleStreakShieldConfirmation("yes"))
        document
          .getElementById("streakShieldCancelBtn")
          .addEventListener("click", () => handleStreakShieldConfirmation("no"))
        document.getElementById("doublePointsBtn").addEventListener("click", showDoublePointsDialog)
        document
          .getElementById("doublePointsConfirmBtn")
          .addEventListener("click", () => handleDoublePointsConfirmation("yes"))
        document
          .getElementById("doublePointsCancelBtn")
          .addEventListener("click", () => handleDoublePointsConfirmation("no"))
        document.getElementById("logoutBtn").addEventListener("click", logout)
        document.getElementById("openMysteryBox").addEventListener("click", openMysteryBox)
        document.getElementById("deadlineConfirmBtn").addEventListener("click", () => handleDeadlineConfirmation("yes"))
        document.getElementById("deadlineCancelBtn").addEventListener("click", () => handleDeadlineConfirmation("no"))
        document.getElementById("sessionContinueBtn").addEventListener("click", () => handleSessionContinue("continue"))
        document.getElementById("sessionEndBtn").addEventListener("click", () => handleSessionContinue("end"))
        document.getElementById("audioStoreBtn").addEventListener("click", showAudioTracksStore)
        document.getElementById("closeAudioStore").addEventListener("click", closeAudioTracksStore)
        document.getElementById("quietPomodoroBtn").addEventListener("click", showPomodoroOverlay)
        document.getElementById("pomodoroStartBtn").addEventListener("click", startPomodoro)
        document.getElementById("pomodoroResetBtn").addEventListener("click", resetPomodoro)
        document.getElementById("pomodoroCloseBtn").addEventListener("click", closePomodoroOverlay)
        document.getElementById("detailedStatsBtn").addEventListener("click", showDetailedStats)
        document.getElementById("closeDetailedStats").addEventListener("click", closeDetailedStats)
        document.getElementById("prevMonthBtn").addEventListener("click", () => navigateCalendar("prev"))
        document.getElementById("nextMonthBtn").addEventListener("click", () => navigateCalendar("next"))

        // Set up audio visualizer resize handler
        window.addEventListener("resize", () => {
          if (visualizerCanvas) {
            visualizerCanvas.width = visualizerCanvas.offsetWidth
            visualizerCanvas.height = visualizerCanvas.offsetHeight
          }
        })

        const timerDisplay = document.getElementById("timerDisplay")
        let isDragging = false
        let currentX
        let currentY
        let xOffset = 0
        let yOffset = 0

        timerDisplay.addEventListener("mousedown", (e) => {
          isDragging = true
          currentX = e.clientX - xOffset
          currentY = e.clientY - yOffset
        })

        document.addEventListener("mousemove", (e) => {
          if (isDragging) {
            e.preventDefault()
            xOffset = e.clientX - currentX
            yOffset = e.clientY - yOffset
            timerDisplay.style.left = `${xOffset}px`
            timerDisplay.style.top = `${yOffset}px`
          }
        })

        document.addEventListener("mouseup", () => {
          isDragging = false
        })

// Update the visibilitychange event handler to reduce points when switching tabs
document.addEventListener("visibilitychange", () => {
  if (document.hidden && isFocusModeActive) {
    console.log("Tab hidden while focus mode active");
    distractionCount++;
    totalDistractions++;
    
    // Reduce points when user is distracted (switching tabs)
    const pointsLost = 10; // Lose 10 points per distraction
    points = Math.max(0, points - pointsLost); // Ensure points don't go below 0
    document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
    
    // Pause lofi music
    pauseLofi();
    
    // Play focus audio when user is distracted
    const focusAudio = document.getElementById("focusAudio");
    if (focusAudio) {
      console.log("Playing focus audio");
      // Reset audio to beginning to ensure it plays
      focusAudio.currentTime = 0;
      focusAudio.play().catch(err => console.error("Focus audio play error:", err));
    }
    
    saveState();
    
    // Store the notification for when user returns
    window.distracted = true;
  } else if (!document.hidden && isFocusModeActive) {
    console.log("Tab visible again while focus mode active");
    
    // Show notification if user was distracted
    if (window.distracted) {
      setTimeout(() => {
        alert(`Distraction penalty: -10 XP. Stay focused!`);
        window.distracted = false;
      }, 300);
    }
    
    // Don't automatically resume lofi music - let user click play again
  }
});
        
        // Check task deadlines periodically
        setInterval(checkTaskDeadlines, 60000) // Check every minute
        
// Ensure lofi audio loops when it ends
document.addEventListener("DOMContentLoaded", () => {
  // Existing code...
  
  // Add event listener for lofi audio ended to automatically loop
  if (lofiAudio) {
    lofiAudio.loop = true; // Set loop attribute
    
    // Backup in case loop attribute doesn't work
    lofiAudio.addEventListener('ended', () => {
      console.log("Lofi track ended, looping or playing next");
      if (!lofiAudio.loop) {
        lofiAudio.currentTime = 0;
        lofiAudio.play().catch(err => console.error("Loop play error:", err));
      }
    });
  }
  
  // Add debug logging for audio visualizer
  const lofiPlayBtn = document.getElementById("lofiPlay");
  if (lofiPlayBtn) {
    lofiPlayBtn.addEventListener("click", () => {
      console.log("Play button clicked");
      // Force audio context creation on user interaction
      if (!audioContext) {
        initAudioContext();
      }
      playLofi();
    });
  }
  
  // Existing code...
});
        
        // Add event listener for lofi audio ended to automatically play next track
        if (lofiAudio) {
          lofiAudio.addEventListener('ended', () => {
            nextLofi()
          })
        }
      })

// Add these missing functions that are referenced but not defined in the code

// Add the prevLofi function
function prevLofi() {
  console.log("Previous lofi track requested");
  
  if (!lofiAudio) {
    console.error("Lofi audio element not found");
    return;
  }
  
  // Update the current index
  currentLofiIndex = (currentLofiIndex - 1 + lofiSongs.length) % lofiSongs.length;
  console.log("Switching to track index:", currentLofiIndex);
  
  // Update the source
  lofiAudio.src = lofiSongs[currentLofiIndex];
  
  // Play the new track
  playLofi();
}

// Add the nextLofi function
function nextLofi() {
  console.log("Next lofi track requested");
  
  if (!lofiAudio) {
    console.error("Lofi audio element not found");
    return;
  }
  
  // Update the current index
  currentLofiIndex = (currentLofiIndex + 1) % lofiSongs.length;
  console.log("Switching to track index:", currentLofiIndex);
  
  // Update the source
  lofiAudio.src = lofiSongs[currentLofiIndex];
  
  // Play the new track
  playLofi();
}

// Add the toggleSitesPopup function
function toggleSitesPopup() {
  const popup = document.getElementById("sitesPopup");
  if (!popup) return;
  popup.style.display = popup.style.display === "block" ? "none" : "block";
}

// Add the closeSitesPopup function
function closeSitesPopup() {
  const popup = document.getElementById("sitesPopup");
  if (!popup) return;
  popup.style.display = "none";
}

// Add the updateClock function
function updateClock() {
  const clockDisplay = document.getElementById("clockDisplay");
  if (!clockDisplay) return;

  const now = new Date();
  let hours = now.getHours();
  const minutes = now.getMinutes().toString().padStart(2, "0");
  const seconds = now.getSeconds().toString().padStart(2, "0");
  const period = hours >= 12 ? "PM" : "AM";
  hours = hours % 12 || 12;
  hours = hours.toString().padStart(2, "0");
  clockDisplay.innerHTML = `<span class="time">${hours}:${minutes}:${seconds}</span> <span class="period">${period}</span>`;
}

// Add the loadSavedState function
function loadSavedState() {
  try {
    const savedState = localStorage.getItem("focusModeState");
    if (savedState) {
      const progressBar = document.getElementById("progressBar");
      if (progressBar) progressBar.style.display = "none";

      const state = JSON.parse(savedState);
      videoIds = state.videoIds || [];
      currentVideoIndex = state.currentVideoIndex || 0;
      distractionCount = state.distractionCount || 0;
      points = state.points || 0;
      timerMode = state.timerMode || "Focus Time";
      timerRemaining = state.timerRemaining || focusDuration / 1000;
      isFocusModeActive = state.isFocusModeActive || false;
      isSignedIn = state.isSignedIn || false;
      currentUser = state.currentUser || null;
      completedVideos = new Set(state.completedVideos || []);
      allVideosCompleted = state.allVideosCompleted || false;
      totalFocusTime = state.totalFocusTime || 0;
      totalDistractions = state.totalDistractions || 0;
      totalVideosWatched = state.totalVideosWatched || 0;
      streakDays = state.streakDays || 0;
      lastFocusDate = state.lastFocusDate || null;
      mysteryBoxCount = state.mysteryBoxCount || 0;
      activePowerUps = state.activePowerUps || {
        doublePoints: { active: false, expiry: null },
        streakShield: { active: false, used: false, expiry: null },
      };
        expiry: null },
        streakShield: { active: false, used: false, expiry: null },
      };
      
      // Load daily points data
      if (state.dailyPointsData) {
        dailyPointsData = state.dailyPointsData;
      } else {
        loadDailyPointsData();
      }
      
      // Load premium tracks state
      if (state.premiumLofiTracks) {
        state.premiumLofiTracks.forEach(savedTrack => {
          const track = premiumLofiTracks.find(t => t.id === savedTrack.id);
          if (track) {
            track.unlocked = savedTrack.unlocked;
            if (track.unlocked && !lofiSongs.includes(track.url)) {
              lofiSongs.push(track.url);
            }
          }
        });
      }

      updateAnalytics();
      updateAchievementLevel();
      updateStreak();
      if (isSignedIn && currentUser) {
        document.getElementById("landingPage").style.display = "none";
        document.getElementById("signinForm").style.display = "none";
        document.getElementById("inputForm").style.display = "block";
        document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
        document.getElementById("clockDisplay").style.display = "block";
        document.getElementById("sitesBox").style.display = "none"; // Keep Allied Realms hidden on input page
        document.getElementById("lofiPlayer").style.display = "block";
        pauseLofi(); // Ensure lofi doesn't autoplay
        restoreUrlInputs();
        populatePlaylistSelect();
        restoreTasks();
        startReminderTimer();
        if (mysteryBoxCount > 0) showMysteryBoxPopup();
        updateSidebarDashboard();
      }
      if (videoIds.length > 0) {
        document.getElementById("inputForm").style.display = "none";
        document.getElementById("player").style.display = "block";
        document.getElementById("restartBtn").style.display = "block";
        document.getElementById("pdfToggle").style.display = "block";
        document.getElementById("clockDisplay").style.display = "none";
        document.getElementById("sitesBox").style.display = "none";
        document.getElementById("lofiPlayer").style.display = "none";
        stopReminderTimer();
        loadYouTubeAPI()
          .then(() => {
            setupYouTubePlayer();
            if (isFocusModeActive) startTimer(timerRemaining * 1000, timerMode);
          })
          .catch((err) => console.error("YouTube API load failed:", err));
      }
    } else {
      document.getElementById("landingPage").style.display = "block";
      document.getElementById("signinForm").style.display = "none";
      document.getElementById("inputForm").style.display = "none";
      document.getElementById("clockDisplay").style.display = "none";
      document.getElementById("sitesBox").style.display = "none";
      document.getElementById("lofiPlayer").style.display = "none";
      stopReminderTimer();
      updateAnalytics();
      updateAchievementLevel();
      updateStreak();
      restoreTasks();
    }
  } catch (err) {
    console.error("Load saved state error:", err);
  }
}

// Add the updateAnalytics function
function updateAnalytics() {
  const totalFocusTimeElement = document.getElementById("totalFocusTime");
  const totalDistractionsElement = document.getElementById("totalDistractions");
  const totalVideosWatchedElement = document.getElementById("totalVideosWatched");
  
  if (totalFocusTimeElement) totalFocusTimeElement.textContent = Math.floor(totalFocusTime / 60);
  if (totalDistractionsElement) totalDistractionsElement.textContent = totalDistractions;
  if (totalVideosWatchedElement) totalVideosWatchedElement.textContent = totalVideosWatched;
}

// Add the updateAchievementLevel function
function updateAchievementLevel() {
  const achievementDiv = document.getElementById("achievementLevel");
  if (!achievementDiv) return;

  const level = getAchievementLevel(points);
  let style = `color: ${level.color}; font-weight: bold;`;
  if (level.glow) style += " text-shadow: 0 0 10px;";
  if (level.box) style += " border: 2px solid gold; padding: 5px;";
  if (level.boxGlow) style += " box-shadow: 0 0 10px gold;";
  if (level.color === "rainbow") achievementDiv.classList.add("rainbow");
  else achievementDiv.classList.remove("rainbow");
  achievementDiv.innerHTML = level.level;
  achievementDiv.style = style;
  updateSidebarDashboard();
}

// Add the getAchievementLevel function
function getAchievementLevel(points) {
  let currentLevel = achievementLevels[0];
  for (const level of achievementLevels) {
    if (points >= level.points) currentLevel = level;
    else break;
  }
  return currentLevel;
}

// Add the updateStreak function
function updateStreak() {
  const streakDisplay = document.getElementById("streakDisplay");
  if (!streakDisplay) return;

  const today = new Date().toDateString();
  const lastDate = localStorage.getItem("lastFocusDate");

  if (lastDate) {
    const last = new Date(lastDate);
    const diffTime = new Date(today) - last;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 1) {
      streakDays++;
      checkMysteryBoxMilestone();
    } else if (diffDays > 1) {
      if (activePowerUps.streakShield.active && Date.now() < activePowerUps.streakShield.expiry) {
        streakDays++;
        alert("Streak Shield protected your streak!");
      } else {
        streakDays = 0; // Reset streak if no focus session and no active shield
      }
    }
  } else {
    streakDays = 1; // First focus session
  }

  localStorage.setItem("lastFocusDate", today);
  streakDisplay.innerHTML = `<span style="color: #8e2de2;">🔥</span> ${streakDays} day${streakDays === 1 ? "" : "s"} of focus`;

  if (isSignedIn && currentUser) {
    const users = JSON.parse(localStorage.getItem("users") || "{}");
    users[currentUser].streakDays = streakDays;
    users[currentUser].mysteryBoxCount = mysteryBoxCount;
    users[currentUser].activePowerUps = activePowerUps;
    localStorage.setItem("users", JSON.stringify(users));
  }

  const sidebarStreak = document.getElementById("sidebarStreak");
  if (sidebarStreak) sidebarStreak.textContent = `${streakDays} day${streakDays === 1 ? "" : "s"}`;
}

// Add the checkMysteryBoxMilestone function
function checkMysteryBoxMilestone() {
  if (streakDays > 0 && streakDays % MYSTERY_BOX_STREAK_INTERVAL === 0) {
    mysteryBoxCount++;
    showMysteryBoxPopup();
    saveState();
  }
}

// Add the showMysteryBoxPopup function
function showMysteryBoxPopup() {
  const popup = document.getElementById("mysteryBoxPopup");
  const rewardText = document.getElementById("mysteryRewardText");
  if (!popup || !rewardText) return;

  rewardText.textContent = `You earned a Focus Mystery Box! (${mysteryBoxCount} available)`;
  popup.style.display = "block";
}

// Add the openMysteryBox function
function openMysteryBox() {
  if (mysteryBoxCount <= 0) return;

  const popup = document.getElementById("mysteryBoxPopup");
  const rewardText = document.getElementById("mysteryRewardText");
  if (!popup || !rewardText) return;

  const reward = mysteryBoxRewards[Math.floor(Math.random() * mysteryBoxRewards.length)];
  let rewardValue = reward.value instanceof Function ? reward.value() : reward.value;

  switch (reward.type) {
    case "points":
      points += rewardValue;
      updateDailyPoints(rewardValue);
      break;
    case "doublePoints":
      activePowerUps.doublePoints.active = true;
      activePowerUps.doublePoints.expiry = Date.now() + rewardValue;
      setTimeout(() => {
        activePowerUps.doublePoints.active = false;
        saveState();
        alert("Double Points power-up has expired!");
      }, rewardValue);
      break;
    case "streakShield":
      activePowerUps.streakShield.active = true;
      activePowerUps.streakShield.used = false;
      activePowerUps.streakShield.expiry = Date.now() + STREAK_SHIELD_DURATION;
      setTimeout(() => {
        activePowerUps.streakShield.active = false;
        saveState();
        alert("Streak Shield has expired!");
      }, STREAK_SHIELD_DURATION);
      break;
  }

  rewardText.textContent = `Reward: ${reward.message(rewardValue)}`;
  mysteryBoxCount--;
  document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
  saveState();

  setTimeout(() => {
    if (mysteryBoxCount > 0) showMysteryBoxPopup();
    else popup.style.display = "none";
  }, 2000);
}

// Add the loadDailyPointsData function
function loadDailyPointsData() {
  if (isSignedIn && currentUser) {
    const users = JSON.parse(localStorage.getItem("users") || "{}");
    if (users[currentUser] && users[currentUser].dailyPointsData) {
      dailyPointsData = users[currentUser].dailyPointsData;
    }
  } else {
    dailyPointsData = JSON.parse(localStorage.getItem("dailyPointsData") || "{}");
  }
}

// Add the updateDailyPoints function
function updateDailyPoints(pointsEarned) {
  const today = new Date().toISOString().split('T')[0];
  
  if (!dailyPointsData[today]) {
    dailyPointsData[today] = 0;
  }
  
  dailyPointsData[today] += pointsEarned;
  saveDailyPointsData();
}

// Add the saveDailyPointsData function
function saveDailyPointsData() {
  if (isSignedIn && currentUser) {
    const users = JSON.parse(localStorage.getItem("users") || "{}");
    if (users[currentUser]) {
      users[currentUser].dailyPointsData = dailyPointsData;
      localStorage.setItem("users", JSON.stringify(users));
    }
  } else {
    localStorage.setItem("dailyPointsData", JSON.stringify(dailyPointsData));
  }
}

// Add the restoreUrlInputs function
function restoreUrlInputs() {
  const urlInputs = document.getElementById("urlInputs");
  if (!urlInputs) return;

  urlInputs.innerHTML = "";
  videoIds.forEach((id, index) => {
    const container = document.createElement("div");
    container.className = "url-container";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "youtube-url";
    input.placeholder = "YouTube URL (Videos or Live Streams)";
    input.value = `https://www.youtube.com/watch?v=${id}`;
    container.appendChild(input);
    if (index > 0) {
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "X";
      removeBtn.onclick = () => {
        if (urlInputs.children.length > 1) urlInputs.removeChild(container);
      };
      container.appendChild(removeBtn);
    }
    urlInputs.appendChild(container);
  });
  if (videoIds.length === 0) {
    const container = document.createElement("div");
    container.className = "url-container";
    const input = document.createElement("input");
    input.type = "text";
    input.className = "youtube-url";
    input.placeholder = "YouTube URL (Videos or Live Streams)";
    input.required = true;
    container.appendChild(input);
    urlInputs.appendChild(container);
  }
}

// Add the populatePlaylistSelect function
function populatePlaylistSelect() {
  const playlistSelect = document.getElementById("playlistSelect");
  if (!playlistSelect) return;

  playlistSelect.innerHTML = '<option value="">Select a Playlist</option>';
  playlists.forEach((playlist) => {
    const option = document.createElement("option");
    option.value = playlist.name;
    option.textContent = playlist.name;
    playlistSelect.appendChild(option);
  });

  playlistSelect.onchange = () => {
    const selectedName = playlistSelect.value;
    if (selectedName) {
      const selectedPlaylist = playlists.find((p) => p.name === selectedName);
      if (selectedPlaylist) {
        videoIds = selectedPlaylist.videoIds;
        restoreUrlInputs();
      }
    }
  };
}

// Add the restoreTasks function
function restoreTasks() {
  const tasksDiv = document.getElementById("tasks");
  if (!tasksDiv) return;

  tasksDiv.innerHTML = "";
  if (tasks.length === 0) addTaskLine();
  else {
    tasks.forEach((task) => {
      const container = document.createElement("div");
      container.className = "task-line";
      
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.className = "task-check";
      checkbox.checked = task.completed;
      checkbox.onchange = () => saveTasks();
      
      const input = document.createElement("input");
      input.type = "text";
      input.className = "task-text";
      input.value = task.text;
      input.placeholder = "Write a task...";
      input.onchange = () => saveTasks();
      
      const deadlineBtn = document.createElement("button");
      deadlineBtn.className = "set-deadline";
      deadlineBtn.textContent = "⏰";
      deadlineBtn.onclick = () => showDeadlineDialog(container);
      
      const removeBtn = document.createElement("span");
      removeBtn.className = "remove-task";
      removeBtn.textContent = "x";
      removeBtn.onclick = () => removeTask(removeBtn);
      
      container.appendChild(checkbox);
      container.appendChild(input);
      container.appendChild(deadlineBtn);
      container.appendChild(removeBtn);
      
      // Add deadline info if exists
      if (task.deadline) {
        const deadlineDate = new Date(task.deadline);
        const deadlineInfo = document.createElement("span");
        deadlineInfo.className = "deadline-info";
        deadlineInfo.textContent = `Due: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        container.appendChild(deadlineInfo);
        
        const pointsInfo = document.createElement("span");
        pointsInfo.className = "points-info";
        pointsInfo.textContent = `+${task.points || 50}pts`;
        container.appendChild(pointsInfo);
      }
      
      tasksDiv.appendChild(container);
    });
  }
  
  // Check for any passed deadlines
  checkTaskDeadlines();
}

// Add the addTaskLine function
function addTaskLine() {
  const tasksDiv = document.getElementById("tasks");
  if (!tasksDiv) return null;

  const container = document.createElement("div");
  container.className = "task-line";
  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.className = "task-check";
  checkbox.onchange = () => saveTasks();
  const input = document.createElement("input");
  input.type = "text";
  input.className = "task-text";
  input.placeholder = "Write a task...";
  input.onkeydown = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const newInput = addTaskLine();
      if (newInput) newInput.focus();
    }
  };
  input.onchange = () => saveTasks();
  
  const deadlineBtn = document.createElement("button");
  deadlineBtn.className = "set-deadline";
  deadlineBtn.textContent = "⏰";
  deadlineBtn.onclick = () => showDeadlineDialog(container);
  
  const removeBtn = document.createElement("span");
  removeBtn.className = "remove-task";
  removeBtn.textContent = "x";
  removeBtn.onclick = () => removeTask(removeBtn);
  
  container.appendChild(checkbox);
  container.appendChild(input);
  container.appendChild(deadlineBtn);
  container.appendChild(removeBtn);
  tasksDiv.appendChild(container);
  return input;
}

// Add the removeTask function
function removeTask(element) {
  const tasksDiv = document.getElementById("tasks");
  if (!tasksDiv || !element || !element.parentElement) return;

  if (tasksDiv.children.length > 1) {
    tasksDiv.removeChild(element.parentElement);
    saveTasks();
  }
}

// Add the saveTasks function
function saveTasks() {
  const taskLines = document.querySelectorAll(".task-line");
  if (!taskLines.length) return;

  tasks = Array.from(taskLines)
    .map((line) => {
      const checkbox = line.querySelector(".task-check");
      const input = line.querySelector(".task-text");
      const deadlineInfo = line.querySelector(".deadline-info");
      const pointsInfo = line.querySelector(".points-info");
      
      // Get existing task to preserve deadline if it exists
      const taskIndex = Array.from(document.querySelectorAll(".task-line")).indexOf(line);
      const existingTask = tasks[taskIndex] || {};
      
      return {
        text: input ? input.value.trim() : "",
        completed: checkbox ? checkbox.checked : false,
        deadline: existingTask.deadline || null,
        points: existingTask.points || null,
        deadlineChecked: existingTask.deadlineChecked || false
      };
    })
    .filter((task) => task.text !== "");
  localStorage.setItem("tasks", JSON.stringify(tasks));
  if (isSignedIn && currentUser) {
    const users = JSON.parse(localStorage.getItem("users") || "{}");
    users[currentUser].tasks = tasks;
    localStorage.setItem("users", JSON.stringify(users));
  }
}

// Add the checkTaskDeadlines function
function checkTaskDeadlines() {
  const now = Date.now();
  let tasksUpdated = false;
  
  tasks.forEach((task, index) => {
    // Skip tasks without deadlines or already completed
    if (!task.deadline || task.deadlineChecked) return;
    
    if (now > task.deadline) {
      // Deadline passed
      if (task.completed) {
        // Task was completed on time
        const earnedPoints = task.points || 50;
        const pointsToAdd = applyPowerUps(earnedPoints);
        points += pointsToAdd;
        updateDailyPoints(pointsToAdd);
        alert(`Task "${task.text}" completed on time! +${earnedPoints} XP`);
      } else {
        // Task was not completed on time
        const lostPoints = Math.floor((task.points || 50) / 2);
        alert(`Task "${task.text}" deadline missed! -${lostPoints} XP`);
        points = Math.max(0, points - lostPoints);
      }
      
      // Mark as checked so we don't process it again
      tasks[index].deadlineChecked = true;
      tasksUpdated = true;
      
      document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
    }
  });
  
  if (tasksUpdated) {
    saveTasks();
    saveState();
  }
}

// Add the applyPowerUps function
function applyPowerUps(pointsEarned) {
  if (activePowerUps.doublePoints.active && Date.now() < activePowerUps.doublePoints.expiry) {
    return pointsEarned * 2;
  }
  return pointsEarned;
}

// Add the showDeadlineDialog function
function showDeadlineDialog(taskElement) {
  const dialog = document.getElementById("deadlineDialog");
  if (!dialog) return;
  
  currentTaskForDeadline = taskElement;
  
  // Set default date to tomorrow
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  const dateInput = document.getElementById("deadlineDate");
  dateInput.value = tomorrow.toISOString().split('T')[0];
  
  // Set default time to current time
  const timeInput = document.getElementById("deadlineTime");
  const now = new Date();
  timeInput.value = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
  
  dialog.style.display = "block";
}

// Add the handleDeadlineConfirmation function
function handleDeadlineConfirmation(choice) {
  const dialog = document.getElementById("deadlineDialog");
  if (!dialog || !currentTaskForDeadline) return;

  dialog.style.display = "none";
  
  if (choice === "yes") {
    const dateInput = document.getElementById("deadlineDate").value;
    const timeInput = document.getElementById("deadlineTime").value;
    const difficultySelect = document.getElementById("taskDifficulty");
    const points = difficultySelect.value;
    
    const deadlineDate = new Date(`${dateInput}T${timeInput}`);
    
    // Add deadline info to the task
    const deadlineInfo = document.createElement("span");
    deadlineInfo.className = "deadline-info";
    deadlineInfo.textContent = `Due: ${deadlineDate.toLocaleDateString()} ${deadlineDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    
    const pointsInfo = document.createElement("span");
    pointsInfo.className = "points-info";
    pointsInfo.textContent = `+${points}pts`;
    
    // Remove existing deadline info if any
    const existingDeadline = currentTaskForDeadline.querySelector(".deadline-info");
    if (existingDeadline) existingDeadline.remove();
    
    const existingPoints = currentTaskForDeadline.querySelector(".points-info");
    if (existingPoints) existingPoints.remove();
    
    currentTaskForDeadline.appendChild(deadlineInfo);
    currentTaskForDeadline.appendChild(pointsInfo);
    
    // Store deadline in task data
    const taskIndex = Array.from(document.querySelectorAll(".task-line")).indexOf(currentTaskForDeadline);
    if (taskIndex !== -1 && tasks[taskIndex]) {
      tasks[taskIndex].deadline = deadlineDate.getTime();
      tasks[taskIndex].points = parseInt(points);
      saveTasks();
    }
  }
  
  currentTaskForDeadline = null;
}

// Add the startReminderTimer function
function startReminderTimer() {
  const inputForm = document.getElementById("inputForm");
  if (inputForm.style.display !== "block") {
    stopReminderTimer();
    timeOnInputForm = 0;
    return;
  }

  reminderInterval = setInterval(() => {
    timeOnInputForm += reminderIntervalTime;
    if (timeOnInputForm >= reminderThreshold) {
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification("Check Your To-Do List!", {
          body: "Hey hero, don't forget to review your quests!",
          icon: "https://img.icons8.com/ios-filled/50/ffffff/checklist.png",
        });
      } else if ("Notification" in window && Notification.permission !== "denied") {
        Notification.requestPermission().then((permission) => {
          if (permission === "granted") {
            new Notification("Check Your To-Do List!", {
              body: "Hey hero, don't forget to review your quests!",
              icon: "https://img.icons8.com/ios-filled/50/ffffff/checklist.png",
            });
          } else {
            alert("Reminder: Check your to-do list!");
          }
        });
      } else {
        alert("Reminder: Check your to-do list!");
      }
    }
  }, reminderIntervalTime);
}

// Add the stopReminderTimer function
function stopReminderTimer() {
  if (reminderInterval) {
    clearInterval(reminderInterval);
    reminderInterval = null;
  }
}

// Add the toggleTodo function
function toggleTodo() {
  const todoList = document.getElementById("todoList");
  if (!todoList) return;
  todoList.style.display = todoList.style.display === "block" ? "none" : "block";
}

// Add the toggleAnalytics function
function toggleAnalytics() {
  const analytics = document.getElementById("analytics");
  if (!analytics) return;
  analytics.style.display = analytics.style.display === "block" ? "none" : "block";
}

// Add the redirectToPYQs function
function redirectToPYQs() {
  window.open("https://room.examgoal.com/", "_blank");
}

// Add the togglePDFViewer function
function togglePDFViewer() {
  const pdfViewer = document.getElementById("pdfViewer");
  if (!pdfViewer) return;
  pdfViewer.style.display = pdfViewer.style.display === "block" ? "none" : "block";
}

// Add the handlePDFUpload function
function handlePDFUpload(event) {
  const file = event.target.files[0];
  if (!file || file.type !== "application/pdf") {
    alert("Please upload a valid PDF file.");
    return;
  }

  const pdfFrame = document.getElementById("pdfFrame");
  if (!pdfFrame) return;

  const url = URL.createObjectURL(file);
  pdfFrame.src = url;
  document.getElementById("pdfViewer").style.display = "block";
}

// Add the toggleAIPopup function
function toggleAIPopup() {
  const aiPopup = document.getElementById("aiPopup");
  if (!aiPopup) return;
  aiPopup.style.display = aiPopup.style.display === "block" ? "none" : "block";
}

// Add the showStreakShieldDialog function
function showStreakShieldDialog() {
  const dialog = document.getElementById("streakShieldDialog");
  if (!dialog) return;
  if (points < STREAK_SHIELD_COST) {
    alert("Not enough XP! You need 800 XP to buy a Streak Shield.");
    return;
  }
  dialog.style.display = "block";
}

// Add the handleStreakShieldConfirmation function
function handleStreakShieldConfirmation(choice) {
  const dialog = document.getElementById("streakShieldDialog");
  if (!dialog) return;

  dialog.style.display = "none";
  if (choice === "yes") {
    points -= STREAK_SHIELD_COST;
    activePowerUps.streakShield.active = true;
    activePowerUps.streakShield.used = false;
    activePowerUps.streakShield.expiry = Date.now() + STREAK_SHIELD_DURATION;
    document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
    alert("Streak Shield activated for 1 week!");
    saveState();
    setTimeout(() => {
      activePowerUps.streakShield.active = false;
      saveState();
      alert("Your Streak Shield has expired!");
    }, STREAK_SHIELD_DURATION);
  }
}

// Add the showDoublePointsDialog function
function showDoublePointsDialog() {
  const dialog = document.getElementById("doublePointsDialog");
  if (!dialog) return;
  if (points < DOUBLE_POINTS_COST) {
    alert("Not enough XP! You need 800 XP to buy Double Points Power-Up.");
    return;
  }
  dialog.style.display = "block";
}

// Add the handleDoublePointsConfirmation function
function handleDoublePointsConfirmation(choice) {
  const dialog = document.getElementById("doublePointsDialog");
  if (!dialog) return;

  dialog.style.display = "none";
  if (choice === "yes") {
    points -= DOUBLE_POINTS_COST;
    activePowerUps.doublePoints.active = true;
    activePowerUps.doublePoints.expiry = Date.now() + DOUBLE_POINTS_DURATION;
    document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
    alert("Double Points Power-Up activated for 24 hours!");
    saveState();
    setTimeout(() => {
      activePowerUps.doublePoints.active = false;
      saveState();
      alert("Your Double Points Power-Up has expired!");
    }, DOUBLE_POINTS_DURATION);
  }
}

// Add the showAudioTracksStore function
function showAudioTracksStore() {
  const store = document.getElementById("audioTracksStore");
  const tracksList = document.getElementById("audioTracksList");
  if (!store || !tracksList) return;
  
  tracksList.innerHTML = "";
  
  premiumLofiTracks.forEach(track => {
    const trackItem = document.createElement("div");
    trackItem.className = `audio-track-item ${track.unlocked ? 'unlocked' : 'locked'}`;
    
    const trackName = document.createElement("div");
    trackName.className = "track-name";
    trackName.textContent = track.name;
    
    const unlockBtn = document.createElement("button");
    unlockBtn.className = "unlock-track-btn";
    
    if (track.unlocked) {
      unlockBtn.textContent = "UNLOCKED";
      unlockBtn.disabled = true;
    } else {
      unlockBtn.textContent = `UNLOCK (${track.cost} XP)`;
      unlockBtn.disabled = points < track.cost;
      unlockBtn.onclick = () => unlockAudioTrack(track.id);
    }
    
    trackItem.appendChild(trackName);
    trackItem.appendChild(unlockBtn);
    tracksList.appendChild(trackItem);
  });
  
  store.style.display = "block";
}

// Add the closeAudioTracksStore function
function closeAudioTracksStore() {
  const store = document.getElementById("audioTracksStore");
  if (store) store.style.display = "none";
}

// Add the unlockAudioTrack function
function unlockAudioTrack(trackId) {
  const track = premiumLofiTracks.find(t => t.id === trackId);
  if (!track || track.unlocked || points < track.cost) return;
  
  // Deduct points and unlock the track
  points -= track.cost;
  track.unlocked = true;
  
  // Add to lofi songs if not already there
  if (!lofiSongs.includes(track.url)) {
    lofiSongs.push(track.url);
  }
  
  document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
  alert(`Successfully unlocked "${track.name}"!`);
  
  // Update the store display
  showAudioTracksStore();
  saveState();
}

// Add the showPomodoroOverlay function
function showPomodoroOverlay() {
  const overlay = document.getElementById("pomodoroOverlay");
  if (!overlay) return;
  
  // Reset pomodoro timer to 60 minutes
  pomodoroTimeRemaining = 60 * 60;
  updatePomodoroDisplay();
  
  overlay.style.display = "flex";
  document.getElementById("pomodoroStatus").textContent = "Ready to begin";
}

// Add the startPomodoro function
function startPomodoro() {
  if (isPomodoroActive) return;
  
  isPomodoroActive = true;
  pomodoroStartTime = Date.now();
  document.getElementById("pomodoroStatus").textContent = "Focus in progress...";
  
  pomodoroInterval = setInterval(() => {
    pomodoroTimeRemaining--;
    updatePomodoroDisplay();
    
    if (pomodoroTimeRemaining <= 0) {
      completePomodoroSession();
    }
  }, 1000);
}

// Add the resetPomodoro function
function resetPomodoro() {
  clearInterval(pomodoroInterval);
  isPomodoroActive = false;
  pomodoroTimeRemaining = 60 * 60;
  pomodoroStartTime = null;
  updatePomodoroDisplay();
  document.getElementById("pomodoroStatus").textContent = "Timer reset";
}

// Add the closePomodoroOverlay function
function closePomodoroOverlay() {
  const overlay = document.getElementById("pomodoroOverlay");
  if (!overlay) return;
  
  if (isPomodoroActive) {
    if (confirm("Pomodoro session in progress. Are you sure you want to exit?")) {
      clearInterval(pomodoroInterval);
      isPomodoroActive = false;
      overlay.style.display = "none";
      
      // Ensure all menu buttons are clickable after closing
      setTimeout(() => {
        reattachEventListeners();
      }, 100);
    }
  } else {
    overlay.style.display = "none";
    
    // Ensure all menu buttons are clickable after closing
    setTimeout(() => {
      reattachEventListeners();
    }, 100);
  }
}

// Add the reattachEventListeners function
function reattachEventListeners() {
  document.getElementById("streakShieldBtn").onclick = showStreakShieldDialog;
  document.getElementById("doublePointsBtn").onclick = showDoublePointsDialog;
  document.getElementById("audioStoreBtn").onclick = showAudioTracksStore;
  document.getElementById("quietPomodoroBtn").onclick = showPomodoroOverlay;
  document.getElementById("logoutBtn").onclick = logout;
  document.getElementById("detailedStatsBtn").onclick = showDetailedStats;
}

// Add the updatePomodoroDisplay function
function updatePomodoroDisplay() {
  const timerElement = document.getElementById("pomodoroTimer");
  if (!timerElement) return;
  
  const minutes = Math.floor(pomodoroTimeRemaining / 60);
  const seconds = pomodoroTimeRemaining % 60;
  
  timerElement.textContent = `${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
}

// Add the completePomodoroSession function
function completePomodoroSession() {
  clearInterval(pomodoroInterval);
  isPomodoroActive = false;
  
  // Play completion sound
  const audio = document.getElementById("pomodoroCompleteAudio");
  if (audio) audio.play().catch(err => console.error("Pomodoro audio error:", err));
  
  // Calculate points (1 point per minute)
  const minutesCompleted = 60 - Math.floor(pomodoroTimeRemaining / 60);
  const pointsEarned = applyPowerUps(minutesCompleted);
  points += pointsEarned;
  updateDailyPoints(pointsEarned);
  
  document.getElementById("pomodoroStatus").textContent = `Completed! Earned ${pointsEarned} XP`;
  document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
  
  saveState();
  checkLevelUp();
}

// Add the checkLevelUp function
function checkLevelUp() {
  const currentLevel = getAchievementLevel(previousPoints);
  const newLevel = getAchievementLevel(points);
  if (newLevel.points > currentLevel.points) showAchievementOverlay(newLevel.level);
  previousPoints = points;
  updateAchievementLevel();
}

// Add the showAchievementOverlay function
function showAchievementOverlay(level) {
  const overlay = document.getElementById("achievementOverlay");
  if (!overlay) return;

  overlay.textContent = `LEVEL UP! ${level.toUpperCase()} UNLOCKED!`;
  overlay.style.display = "flex";
  setTimeout(() => overlay.style.display = "none", 5000);
}

// Add the showDetailedStats function
function showDetailedStats() {
  loadDailyPointsData();
  renderCalendar();
  document.getElementById("detailedStatsOverlay").style.display = "flex";
}

// Add the closeDetailedStats function
function closeDetailedStats() {
  document.getElementById("detailedStatsOverlay").style.display = "none";
}

// Add the renderCalendar function
function renderCalendar() {
  const calendarContainer = document.getElementById("calendarContainer");
  const currentMonthElement = document.getElementById("currentMonth");
  
  if (!calendarContainer || !currentMonthElement) return;
  
  // Clear previous calendar
  calendarContainer.innerHTML = "";
  
  // Set current month display
  const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
  currentMonthElement.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
  
  // Add day headers
  const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
  dayNames.forEach(day => {
    const dayHeader = document.createElement("div");
    dayHeader.className = "calendar-day-header";
    dayHeader.textContent = day;
    calendarContainer.appendChild(dayHeader);
  });
  
  // Get first day of month and total days
  const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
  const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
  const totalDays = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();
  
  // Add empty cells for days before first day of month
  for (let i = 0; i < startingDayOfWeek; i++) {
    const emptyDay = document.createElement("div");
    emptyDay.className = "calendar-day empty";
    calendarContainer.appendChild(emptyDay);
  }
  
  // Add days of the month
  const today = new Date();
  const isCurrentMonth = today.getMonth() === currentCalendarMonth && today.getFullYear() === currentCalendarYear;
  
  for (let day = 1; day <= totalDays; day++) {
    const dayElement = document.createElement("div");
    dayElement.className = "calendar-day";
    
    // Check if this is today
    if (isCurrentMonth && today.getDate() === day) {
      dayElement.classList.add("today");
    }
    
    // Add date number
    const dateSpan = document.createElement("div");
    dateSpan.className = "date";
    dateSpan.textContent = day;
    dayElement.appendChild(dateSpan);
    
    // Check if we have points data for this day
    const dateString = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayPoints = dailyPointsData[dateString] || 0;
    
    // Add points info
    const pointsSpan = document.createElement("div");
    pointsSpan.className = "points";
    pointsSpan.textContent = `${dayPoints} XP`;
    dayElement.appendChild(pointsSpan);
    
    // Color based on points level
    const level = getPointsLevel(dayPoints);
    dayElement.classList.add(`level-${level}`);
    
    calendarContainer.appendChild(dayElement);
  }
}

// Add the getPointsLevel function
function getPointsLevel(points) {
  if (points === 0) return 0;
  if (points <= 50) return 0;
  if (points <= 100) return 1;
  if (points <= 200) return 2;
  if (points <= 300) return 3;
  return 4;
}

// Add the navigateCalendar function
function navigateCalendar(direction) {
  if (direction === "prev") {
    currentCalendarMonth--;
    if (currentCalendarMonth < 0) {
      currentCalendarMonth = 11;
      currentCalendarYear--;
    }
  } else {
    currentCalendarMonth++;
    if (currentCalendarMonth > 11) {
      currentCalendarMonth = 0;
      currentCalendarYear++;
    }
  }
  
  renderCalendar();
}

// Add the showSessionCompleteDialog function
function showSessionCompleteDialog() {
  const dialog = document.getElementById("sessionCompleteDialog");
  if (!dialog) return;
  dialog.style.display = "block";
}

// Add the handleSessionContinue function
function handleSessionContinue(choice) {
  const dialog = document.getElementById("sessionCompleteDialog");
  if (!dialog) return;
  
  dialog.style.display = "none";
  
  if (choice === "continue") {
    // Award bonus points
    const bonusPoints = applyPowerUps(100);
    points += bonusPoints;
    updateDailyPoints(bonusPoints);
    document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
    
    // Start a new focus session
    startTimer(focusDuration, "Focus Time");
  } else {
    // End the session
    endFocusSession();
  }
  
  saveState();
}

// Add the startTimer function
function startTimer(duration, mode) {
  const timerDisplay = document.getElementById("timerDisplay");
  const progressFill = document.getElementById("progressFill");
  const progressBar = document.getElementById("progressBar");
  if (!timerDisplay || !progressFill || !progressBar) return;

  isFocusModeActive = true;
  timerMode = mode;
  let timeRemaining = duration / 1000;
  timerRemaining = timeRemaining;
  progressBar.style.display = "block";
  const totalDuration = duration / 1000;

  updateStreak();

  clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = Math.floor(timeRemaining % 60);
    timerDisplay.querySelector("#timerText").textContent = `${timerMode}: ${minutes
      .toString()
      .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
    const progress = ((totalDuration - timeRemaining) / totalDuration) * 100;
    progressFill.style.width = `${progress}%`;

    if (mode === "Focus Time") totalFocusTime += 1;
    timeRemaining--;
    timerRemaining = timeRemaining;

    if (timeRemaining < 0) {
      clearInterval(countdownInterval);
      progressBar.style.display = "none";
      if (mode === "Focus Time") {
        const sessionPoints = applyPowerUps(100); // Base 100 points per focus session, doubled if power-up active
        points += sessionPoints;
        updateDailyPoints(sessionPoints);
        document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`;
        checkLevelUp();
        
        // Show session complete dialog instead of automatically starting break
        showSessionCompleteDialog();
        playFocusAudio();
      } else if (mode === "Break Time") {
        startTimer(secondBreakDuration, "Short Break");
      } else {
        startTimer(focusDuration, "Focus Time");
      }
      saveState();
    }
  }, 1000);
}

// Add the endFocusSession function
function endFocusSession() {
  clearInterval(countdownInterval);
  isFocusModeActive = false;
  const timerDisplay = document.getElementById("timerDisplay");
  const progressBar = document.getElementById("progressBar");
  if (timerDisplay && progressBar) {
    timerDisplay.querySelector("#timerText").textContent = "Focus Complete!";
    progressBar.style.display = "none";
  }
  // Exit fullscreen when session ends
  exitFullscreen();
  saveState();
}

// Add the exitFullscreen function
function exitFullscreen() {
  if (document.exitFullscreen) {
    document.exitFullscreen();
  } else if (document.mozCancelFullScreen) { // Firefox
    document.mozCancelFullScreen();
  } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
    document.webkitExitFullscreen();
  } else if (document.msExitFullscreen) { // IE/Edge
    document.msExitFullscreen();
  }
}

// Add the playFocusAudio function
function playFocusAudio() {
  const audio = document.getElementById("focusAudio");
  if (audio) {
    // Reset to beginning to ensure it plays
    audio.currentTime = 0;
    audio.play().catch((err) => console.error("Audio play error:", err));
  }
}

// Add the restartSession function
function restartSession() {
  const dialog = document.getElementById("confirmationDialog");
  if (!dialog) return;
  dialog.style.display = "block";
}

// Add the handleRestartConfirmation function
function handleRestartConfirmation(choice) {
  const dialog = document.getElementById("confirmationDialog");
  if (!dialog) return;

  dialog.style.display = "none";
  if (choice === "yes") {
    clearInterval(countdownInterval);
    isFocusModeActive = false;
    videoIds = [];
    currentVideoIndex = 0;
    completedVideos.clear();
    allVideosCompleted = false;
    if (player) player.destroy();
    document.getElementById("player").style.display = "none";
    document.getElementById("restartBtn").style.display = "none";
    document.getElementById("pdfToggle").style.display = "none";
    document.getElementById("videoSidebar").style.right = "-320px";
    document.getElementById("inputForm").style.display = "block";
    document.getElementById("clockDisplay").style.display = "block";
    document.getElementById("sitesBox").style.display = "none";
    document.getElementById("lofiPlayer").style.display = "block";
    const progressBar = document.getElementById("progressBar");
    if (progressBar) progressBar.style.display = "none";
    // Exit fullscreen when restarting
    exitFullscreen();
    restoreUrlInputs();
    saveState();
    startReminderTimer();
  }
}
    })()
</script>
</body>
</html>
