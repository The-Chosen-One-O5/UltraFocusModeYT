<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Focus Mode YouTube Player</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet"> <!-- Font for Pomodoro -->
  <style>
    /* --- Existing Styles (Keep as is, unless noted) --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4169e1;
      --primary-dark: #1e3a8a;
      --secondary: #8e2de2;
      --accent: #ff4500;
      --accent-alt: #ff8c00;
      --bg-dark: #0f0f1b;
      --bg-medium: #1a1a2e;
      --bg-light: #252538;
      --text: #e0e0ff;
      --text-dim: #9090b0;
    }

    body {
      background-color: var(--bg-dark);
      min-height: 100vh;
      /* display: flex; */ /* Remove flex from body if top bar is fixed */
      /* justify-content: center; */
      /* align-items: center; */
      font-family: monospace;
      color: var(--text);
      overflow-x: hidden; /* Prevent horizontal scroll */
      font-size: 18px;
      line-height: 1.4;
      padding-top: 60px; /* Add padding for fixed top bar */
    }

    /* --- Top Navigation Bar Styles --- */
    #topNavBar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background-color: var(--bg-medium);
      border-bottom: 2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000; /* Ensure it's above most content */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    #navLogo {
      font-family: monospace;
      font-size: 24px;
      font-weight: 600;
      color: var(--text);
      text-shadow: 2px 2px 0px var(--primary-dark);
      letter-spacing: 1px;
    }
     #navLogo span {
       color: var(--secondary);
     }

    #navClockContainer {
       font-size: 20px;
       font-family: monospace;
       font-weight: bold;
    }
     #navClockContainer .time { color: var(--primary); }
     #navClockContainer .period { color: var(--secondary); }


    #navButtons {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Streak Button Styles (Adapted from provided CSS) */
    .StreakBtn {
      display: flex;
      align-items: center;
      justify-content: center; /* Center the icon */
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      overflow: hidden; /* Keep hidden for tooltip */
      transition-duration: .3s;
      box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.199);
      background-color: var(--accent-alt); /* Orange for streak */
      padding: 0; /* Reset padding */
      color: var(--text); /* Ensure icon color */
      font-size: 20px; /* Adjust icon size */
    }

    .StreakBtn .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: var(--bg-light);
      color: var(--text);
      text-align: center;
      border-radius: 6px;
      padding: 5px 0;
      position: absolute;
      z-index: 1;
      bottom: 125%; /* Position above the button */
      left: 50%;
      margin-left: -60px; /* Center the tooltip */
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
      font-family: monospace;
    }

    .StreakBtn:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Basic styles for other nav buttons */
    .NavBtn {
      background: var(--primary);
      color: var(--text);
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      font-size: 14px;
      transition: background 0.3s;
    }
    .NavBtn:hover {
      background: var(--primary-dark);
    }

    /* --- Container for Pages --- */
    .page-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 60px); /* Adjust height considering top bar */
        width: 100%;
        padding: 20px; /* Add some padding */
        position: relative;
        overflow: hidden; /* Keep gradient contained */
        background-image: radial-gradient(circle at 10% 20%, rgba(142, 45, 226, 0.1) 0%, transparent 20%),
          radial-gradient(circle at 90% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 20%),
          linear-gradient(to bottom, var(--bg-dark), var(--bg-medium));
        z-index: 1;
    }

    .page-container::before { /* Keep the dot pattern */
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1h1z'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 2;
    }

    /* --- Page Styles (Common Base) --- */
    #landingPage,
    #signinForm,
    #homePage,
    #watchLecturesPage,
    #profilePage, /* Add styles for profile/stats pages */
    #focusStatsPage {
      text-align: center;
      width: 100%;
      max-width: 900px; /* Adjust as needed */
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
      z-index: 10;
      background-color: rgba(15, 15, 27, 0.85); /* Slightly less transparent */
      border: 2px solid var(--secondary);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(142, 45, 226, 0.3);
      pointer-events: auto; /* Ensure interaction */
      display: none; /* Hide all pages by default */
    }
    #landingPage { display: block; } /* Show landing page initially */

    #watchLecturesPage {
        max-width: 1300px; /* Allow wider for player */
    }

    .title {
      font-family: monospace;
      font-size: 32px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 20px;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    .title span {
      color: var(--secondary);
      position: relative;
      display: inline-block;
    }

    .title span::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .subtitle {
      font-size: 20px;
      color: var(--text-dim);
      margin-bottom: 30px;
    }

    /* --- Home Page Specific Styles --- */
    #homePage .welcome-msg {
      font-size: 24px;
      margin-bottom: 15px;
      color: var(--primary);
    }
    #homePage .time-date {
      font-size: 18px;
      margin-bottom: 15px;
      color: var(--text-dim);
    }
    #homePage .focus-status {
      font-size: 18px;
      margin-bottom: 30px;
      color: var(--secondary);
      font-weight: bold;
    }
    #homePage .motivation {
        font-style: italic;
        color: var(--accent-alt);
        margin-top: 40px;
        font-size: 16px;
    }

    /* --- Watch Lectures Page Styles --- */
    #lectureInputSection {
       /* Styles for the input part of the watch page */
       margin-bottom: 30px;
    }

    #player { /* Keep player styles, but ensure it's initially hidden */
      width: 100%;
      max-width: 1200px;
      aspect-ratio: 16 / 9;
      border-radius: 0;
      overflow: hidden;
      display: none; /* Initially hidden */
      background: #000;
      border: 4px solid var(--primary);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      z-index: 5;
      margin: 20px auto 0; /* Add margin when visible */
    }

    /* --- Profile & Stats Page Styles --- */
     #profilePage, #focusStatsPage {
         position: fixed; /* Make them overlays/modals */
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         width: 90%;
         max-width: 500px;
         max-height: 80vh;
         overflow-y: auto;
         z-index: 105; /* Above other content but below dialogs */
         border-color: var(--accent); /* Different border */
         box-shadow: 0 0 20px rgba(255, 69, 0, 0.4);
         scrollbar-width: thin;
         scrollbar-color: var(--accent) var(--bg-medium);
     }
      #profilePage::-webkit-scrollbar, #focusStatsPage::-webkit-scrollbar { width: 8px; }
      #profilePage::-webkit-scrollbar-track, #focusStatsPage::-webkit-scrollbar-track { background: var(--bg-medium); }
      #profilePage::-webkit-scrollbar-thumb, #focusStatsPage::-webkit-scrollbar-thumb { background: var(--accent); }


     #profilePage h3, #focusStatsPage h3 {
         color: var(--accent);
         margin-bottom: 25px;
         font-size: 24px;
     }
     .profile-info p, #focusStatsPage p {
         font-size: 18px;
         margin: 10px 0;
         padding-bottom: 8px;
         border-bottom: 1px solid var(--bg-light);
         display: flex;
         justify-content: space-between;
     }
     .profile-info span:first-child, #focusStatsPage span:first-child {
         font-weight: bold;
         color: var(--primary);
         margin-right: 10px;
     }
     .profile-pic { /* Placeholder style */
         width: 80px;
         height: 80px;
         background: var(--bg-light);
         border-radius: 50%;
         margin: 0 auto 20px;
         display: flex;
         align-items: center;
         justify-content: center;
         font-size: 40px;
         border: 2px solid var(--primary);
     }
     .close-modal-btn {
         position: absolute;
         top: 10px;
         right: 15px;
         background: var(--accent);
         color: var(--text);
         border: none;
         border-radius: 50%;
         width: 30px;
         height: 30px;
         font-size: 18px;
         font-weight: bold;
         cursor: pointer;
         line-height: 28px;
         text-align: center;
     }

    /* Stats Calendar Styles */
    #statsCalendar {
        margin-top: 30px;
        border-collapse: collapse;
        width: 100%;
    }
    #statsCalendar th, #statsCalendar td {
        border: 1px solid var(--bg-light);
        padding: 5px;
        text-align: center;
        font-size: 12px;
        width: 14.28%; /* 7 days */
        height: 40px;
    }
    #statsCalendar th {
        color: var(--secondary);
    }
    #statsCalendar td {
        cursor: default;
        background-color: var(--bg-light); /* Default empty day */
        position: relative; /* For tooltip */
        color: var(--text-dim);
    }
    #statsCalendar td.has-data {
        color: var(--text);
        font-weight: bold;
    }
    /* Add classes for different heatmap levels (adjust colors) */
    #statsCalendar td.level-1 { background-color: rgba(65, 105, 225, 0.2); }
    #statsCalendar td.level-2 { background-color: rgba(65, 105, 225, 0.4); }
    #statsCalendar td.level-3 { background-color: rgba(65, 105, 225, 0.6); }
    #statsCalendar td.level-4 { background-color: rgba(65, 105, 225, 0.8); }
    #statsCalendar td.level-5 { background-color: var(--primary); }


    /* --- Sidebar Styles (Updated) --- */
    .game-sidebar {
        position: fixed;
        left: -250px; /* Keep initial state */
        top: 0;
        width: 250px;
        height: 100vh;
        background: var(--bg-medium);
        border-right: 4px solid var(--primary);
        z-index: 200;
        transition: left 0.3s ease;
        padding: 80px 0 20px; /* Add padding top for nav bar */
        box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
        overflow-y: auto;
        pointer-events: auto;
    }
     .sidebar-trigger { /* Keep trigger */
       position: fixed;
       left: 0;
       top: 50%;
       transform: translateY(-50%);
       width: 20px;
       height: 80px;
       background: var(--primary);
       z-index: 199;
       border-radius: 0 5px 5px 0;
       cursor: pointer;
       display: flex;
       align-items: center;
       justify-content: center;
       color: var(--text);
       font-weight: bold;
       writing-mode: vertical-rl;
       text-orientation: mixed;
       font-size: 12px;
       letter-spacing: 1px;
       pointer-events: auto;
       margin-top: 30px; /* Adjust trigger position due to top bar */
     }
     .sidebar-section button, .sidebar-section a { /* Style links/buttons */
         /* Existing styles */
         display: block;
         width: calc(100% - 30px); /* Adjust width for padding */
         padding: 10px 15px;
         margin: 8px 15px;
         background: var(--bg-light);
         color: var(--text);
         border: 1px solid var(--primary);
         text-align: left;
         font-size: 14px;
         cursor: pointer;
         transition: all 0.2s;
         pointer-events: auto;
         z-index: 201;
         font-family: monospace;
         text-decoration: none; /* For 'a' tags */
         box-shadow: 2px 2px 0 var(--primary-dark); /* Subtle shadow */
         text-transform: uppercase;
     }
      .sidebar-section button:hover, .sidebar-section a:hover {
          background: var(--primary);
          transform: translateX(5px);
          box-shadow: none;
      }

    /* --- Pomodoro Styles (Updated) --- */
    #pomodoroContainer {
      width: 400px;
      background: var(--bg-medium);
      padding: 30px;
      /* border: 4px solid var(--secondary); */ /* Removed border */
      border-radius: 10px; /* Added subtle rounding */
      box-shadow: 0 0 30px rgba(142, 45, 226, 0.5);
      text-align: center;
      pointer-events: auto;
    }
    #pomodoroTimer {
      font-size: 90px; /* Larger */
      font-weight: bold;
      color: var(--text);
      margin: 20px 0;
      font-family: 'Orbitron', monospace; /* Digital-style font */
      text-shadow: 0 0 10px var(--secondary); /* Add glow */
    }

    /* --- Global Elements Positioning --- */
     #timerDisplay { /* Only shown on lecture page now */
         display: none; /* Hidden by default */
         position: fixed;
         top: 70px; /* Below top bar */
         left: 10px;
         /* Keep other styles */
         z-index: 101;
     }
     #pointsDisplay {
         position: fixed;
         top: 70px; /* Below top bar */
         right: 10px; /* Move to right */
         /* Keep other styles */
         z-index: 101;
     }
     #lofiPlayer {
         position: fixed;
         bottom: 10px;
         right: 10px;
         z-index: 101;
         display: block; /* Should always be visible after login */
         /* Keep other styles */
     }
     #fireBox {
         position: fixed;
         bottom: 10px;
         left: 10px;
         z-index: 100;
         /* Keep other styles */
     }
      #aiPopup {
          position: fixed;
          bottom: 60px; /* Above firebox */
          left: 10px;
          z-index: 101;
          /* Keep other styles */
      }

     /* Hide elements not needed initially or on specific pages */
     #restartBtn, #pdfToggle {
         display: none;
     }

     /* Adjust todoList position if needed */
     #todoList {
       position: fixed; /* Make it fixed for overlay */
       top: 70px; /* Position below top bar */
       left: 10px;
       /* Keep other styles */
       display: none;
       z-index: 102; /* Above most things but below modals */
     }

     /* Remove old elements that are now part of pages/topbar */
     #clockDisplay, #achievementLevel, #streakDisplay, #sitesBox, #sitesPopup {
         /* These might be removed or repurposed */
         /* Let's hide them for now */
         display: none !important;
     }

    /* --- Responsive Adjustments (Review and Add as Needed) --- */
    @media (max-width: 800px) {
       body { padding-top: 50px; } /* Adjust for smaller top bar */
       #topNavBar { height: 50px; padding: 0 10px; }
       #navLogo { font-size: 18px; }
       #navClockContainer { font-size: 16px; }
       #navButtons { gap: 8px; }
       .NavBtn { padding: 6px 10px; font-size: 12px; }
       .StreakBtn { width: 35px; height: 35px; font-size: 16px; }
       .page-container { padding: 10px; min-height: calc(100vh - 50px); }
       #landingPage, #signinForm, #homePage, #watchLecturesPage, #profilePage, #focusStatsPage { padding: 20px 15px; }
       .title { font-size: 24px; }
       .subtitle { font-size: 16px; }
       #homePage .welcome-msg { font-size: 20px; }
       #homePage .time-date, #homePage .focus-status { font-size: 14px; }
       #homePage .motivation { font-size: 14px; }
       #pomodoroTimer { font-size: 60px; }
       #timerDisplay { top: 60px; }
       #pointsDisplay { top: 60px; }
       #todoList { top: 60px; width: calc(100% - 20px); max-width: 300px; }
       .sidebar-trigger { margin-top: 25px; }
       .game-sidebar { padding-top: 60px; }
    }
  </style>
</head>
<body>

  <!-- Top Navigation Bar -->
  <div id="topNavBar" style="display: none;"> <!-- Initially hidden until logged in -->
    <div id="navLogo">FOCUS<span>QUEST</span></div>
    <div id="navClockContainer">
      <!-- Clock content will be injected by JS -->
    </div>
    <div id="navButtons">
      <button class="NavBtn" id="profileBtn">Profile</button>
      <button class="StreakBtn" id="streakBtn">
        üî• <!-- Fire icon -->
        <span class="tooltiptext" id="streakTooltip">0-day focus streak</span>
      </button>
      <!-- <button class="NavBtn" id="settingsBtn">Settings</button> --> <!-- Add if needed -->
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="game-container"> <!-- This container now holds the pages -->

    <!-- Sidebar Trigger -->
    <div class="sidebar-trigger">MENU</div>

    <!-- Sidebar -->
    <div class="game-sidebar">
       <!-- REMOVED Dashboard Section -->
      <div class="sidebar-section">
        <h3>Navigation</h3>
        <button data-page="homePage">HOME</button>
        <button data-page="watchLecturesPage">WATCH LECTURES</button>
        <button id="sidebarTodoBtn">TO-DO LIST</button>
        <button id="sidebarStatsBtn">FOCUS STATS</button>
        <a href="https://room.examgoal.com/" target="_blank" rel="noreferrer">PYQs PRACTICE</a>
      </div>
      <div class="sidebar-section">
        <h3>Allied Realms</h3>
        <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer">FOREST QUEST</a>
        <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer">POMODORO REALM</a>
        <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer">DAILY QUEST PLANNER</a>
      </div>
      <div class="sidebar-section">
        <h3>Self Study</h3>
        <button id="quietPomodoroBtn">QUIET POMODORO</button>
      </div>
      <div class="sidebar-section">
        <h3>Shops</h3>
        <button id="streakShieldBtn">STREAK SHIELD (800 XP)</button>
        <button id="doublePointsBtn">DOUBLE XP (800 XP)</button>
        <button id="audioStoreBtn">AUDIO STORE</button>
      </div>
      <div class="sidebar-section">
        <h3>Account</h3>
        <button id="logoutBtn">LOGOUT</button>
      </div>
    </div>

    <!-- Page Wrappers -->
    <div class="page-container"> <div id="landingPage">
        <div class="title">QUEST FOR <span>FOCUS</span></div>
        <div class="subtitle">Begin your learning adventure!</div>
        <button data-action="show-signin">START GAME</button>
        <button class="github-btn" data-action="github">GITHUB REPO</button>
        <div id="features">
          <div class="feature">
            <i class="fas fa-ad"></i>
            <p>Ad Free<br>No distractions on your quest</p>
          </div>
          <div class="feature">
            <i class="fas fa-moon"></i>
            <p>Dark Mode<br>Save your vision for the final boss</p>
          </div>
        </div>
      </div>

      <div id="signinForm" style="display: none;">
        <div class="title">CREATE YOUR <span>ACCOUNT</span></div>
        <div class="subtitle">Sign in to track your progress</div>
        <input type="text" id="username" placeholder="Hero Name" required />
        <input type="password" id="password" placeholder="Secret Code" required />
        <button data-action="sign-in">ENTER REALM</button>
        <p>New adventurer? <button data-action="create-account">CREATE ACCOUNT</button></p>
        <p style="margin-top: 15px;"><button data-action="show-landing">BACK</button></p>
      </div>

      <!-- NEW Home Page (Shown After Login) -->
      <div id="homePage" style="display: none;">
          <div class="title">WELCOME <span>HERO</span></div>
          <div class="subtitle" id="homeUsername">Ready to conquer your goals?</div>
          <div class="welcome-msg" id="welcomeMessage">Welcome back! Ready to get in the zone?</div>
          <div class="time-date" id="homeTimeDate"></div>
          <div class="focus-status" id="homeFocusStatus">Loading status...</div>
          <!-- Add quick access buttons or stats here if desired -->
          <div class="motivation">"The secret of getting ahead is getting started." - Mark Twain</div>
      </div>

      <!-- NEW Watch Lectures Page -->
      <div id="watchLecturesPage" style="display: none;">
          <!-- Input Section -->
          <div id="lectureInputSection">
              <div class="title">SELECT YOUR <span>LECTURE</span></div>
              <select id="playlistSelect">
                <option value="">Select a Saved Path</option>
              </select>
              <input type="text" id="playlistName" placeholder="Save Current Path As..." />
              <button data-action="save-playlist">SAVE PATH</button>
              <button data-action="remove-playlist">DELETE PATH</button>

              <div id="urlInputs">
                <div class="url-container">
                  <input type="text" class="youtube-url" placeholder="YouTube URL (Video or Live Stream)" required />
                </div>
              </div>

              <button data-action="add-url">ADD URL</button>
              <button data-action="start-playback">BEGIN FOCUS</button>
          </div>

          <!-- Player (Moved Here) -->
          <div id="player"></div>

          <!-- Sidebar (Remains associated with player) -->
          <div id="videoSidebar"></div>

          <!-- Buttons specific to playback -->
           <button id="restartBtn">EXIT FOCUS</button>
           <button id="pdfToggle">PDF VIEWER</button>
      </div>

    </div> <!-- End page-container -->

    <!-- Profile Page Modal -->
    <div id="profilePage" style="display: none;">
        <button class="close-modal-btn" onclick="toggleProfilePage(false)">X</button>
        <h3>Profile Settings</h3>
        <div class="profile-pic" id="profilePic">üë§</div>
        <div class="profile-info">
            <p><span>Hero Name:</span> <span id="profileUsername"></span></p>
            <p><span>Level:</span> <span id="profileLevel"></span></p>
            <p><span>XP:</span> <span id="profileXP"></span></p>
            <p><span>Focus Streak:</span> <span id="profileStreak"></span></p>
            <!-- Add more stats or settings options here -->
        </div>
    </div>

    <!-- Focus Stats Page Modal -->
    <div id="focusStatsPage" style="display: none;">
        <button class="close-modal-btn" onclick="toggleStatsPage(false)">X</button>
        <h3>Focus Stats</h3>
        <p><span>Total Focus Time:</span> <span id="statsTotalFocusTime">0</span> min</p>
        <p><span>Distractions Defeated:</span> <span id="statsTotalDistractions">0</span></p>
        <p><span>Videos Completed:</span> <span id="statsTotalVideosWatched">0</span></p>

        <h4>Daily Focus Heatmap</h4>
        <table id="statsCalendar">
            <thead>
                <tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>
            </thead>
            <tbody id="statsCalendarBody">
                <!-- Calendar grid generated by JS -->
            </tbody>
        </table>
         <p style="font-size: 12px; margin-top: 10px; border: none;">*More blue means more XP earned that day.</p>
    </div>

    <!-- ToDo List (Now a fixed overlay) -->
    <div id="todoList">
        <button class="close-modal-btn" onclick="toggleTodo(false)" style="z-index: 103;">X</button> <!-- Ensure close button is usable -->
        <h3>TO-DO QUESTS</h3>
        <div id="tasks">
          <!-- Task lines added by JS -->
        </div>
        <button data-action="add-task">ADD QUEST</button> <!-- Optional: Button to add new task -->
        <button data-action="save-tasks">SAVE QUESTS</button>
    </div>

    <!-- Timer Display (Only shown during focus session) -->
    <div id="timerDisplay">
        <span id="timerText"></span>
        <div id="progressBar"><div id="progressFill"></div></div>
    </div>

    <!-- Points Display (Global) -->
    <div id="pointsDisplay"><span style="color: #8e2de2;">‚≠ê</span> XP: 0</div>

    <!-- PDF Viewer (Remains global, toggled) -->
    <div id="pdfViewer">
        <input type="file" id="pdfInput" accept=".pdf" />
        <iframe id="pdfFrame"></iframe>
        <button onclick="togglePDFViewer(false)" style="background: var(--accent); margin-top: 10px;">CLOSE</button>
    </div>

    <!-- Chatbot (Global) -->
    <div id="fireBox">üßô</div>
    <div id="aiPopup">
      <iframe src="https://www.chatbase.co/chatbot-iframe/3dSdpryiYZlWipHUL8dNK" frameBorder="0"></iframe>
    </div>

    <!-- Lofi Player (Global) -->
    <div id="lofiPlayer">
      <div style="text-align: center; margin-bottom: 5px;">LOFI MUSIC ‚ô¨</div>
      <button id="lofiPrev">‚óÑ</button>
      <button id="lofiPlay">‚ñ∂</button>
      <button id="lofiPause">‚ùö‚ùö</button>
      <button id="lofiNext">‚ñ∫</button>
    </div>

    <!-- Pomodoro Overlay -->
    <div id="pomodoroOverlay">
      <div id="pomodoroContainer">
        <h3>QUIET POMODORO</h3>
        <p>Focus in silence, earn XP with each minute</p>
        <div id="pomodoroTimer">60:00</div>
        <div id="pomodoroStatus">Ready to begin</div>
        <div id="pomodoroControls">
          <button id="pomodoroStartBtn">START</button>
          <button id="pomodoroResetBtn">RESET</button>
          <button id="pomodoroCloseBtn">CLOSE</button>
        </div>
      </div>
    </div>

    <!-- Dialogs & Overlays (Keep as is) -->
    <div id="achievementOverlay"></div>
    <div id="confirmationDialog">...</div>
    <div id="streakShieldDialog">...</div>
    <div id="doublePointsDialog">...</div>
    <div id="deadlineDialog">...</div>
    <div id="sessionCompleteDialog">...</div>
    <div id="mysteryBoxPopup">...</div>
    <div id="audioTracksStore">...</div>

    <!-- Audio Elements (Keep as is) -->
    <audio id="focusAudio" preload="none" src="..."></audio>
    <audio id="lofiAudio" preload="none" loop></audio>
    <audio id="pomodoroCompleteAudio" preload="none" src="..."></audio>

  </div> <!-- End game-container -->

  <script>
    ;(() => {
      // --- Existing Variables (Keep as is unless noted) ---
      let currentPage = 'landingPage'; // Track current visible page
      let dailyFocusData = JSON.parse(localStorage.getItem("dailyFocusData") || "{}"); // For calendar heatmap


      // --- NEW Helper Function for Page Navigation ---
      function showPage(pageId) {
          console.log("Showing page:", pageId);
          // Hide all main page containers
          document.getElementById('landingPage').style.display = 'none';
          document.getElementById('signinForm').style.display = 'none';
          document.getElementById('homePage').style.display = 'none';
          document.getElementById('watchLecturesPage').style.display = 'none';
          // Modals/Overlays are handled separately (Profile, Stats, Todo)

          // Show the target page
          const page = document.getElementById(pageId);
          if (page) {
              page.style.display = 'block';
              currentPage = pageId;

              // Show/hide top bar based on login state
              const topBar = document.getElementById('topNavBar');
              if (isSignedIn && pageId !== 'landingPage' && pageId !== 'signinForm') {
                  topBar.style.display = 'flex';
              } else {
                  topBar.style.display = 'none';
              }

              // Show/hide global elements based on page
              const showGlobalElements = isSignedIn && (pageId === 'homePage' || pageId === 'watchLecturesPage');
               document.getElementById('lofiPlayer').style.display = showGlobalElements ? 'block' : 'none';
               document.getElementById('fireBox').style.display = showGlobalElements ? 'flex' : 'none'; // firebox uses flex

               // Specific elements for watchLecturesPage during playback are handled in startPlayback/restartSession

          } else {
              console.error("Page not found:", pageId);
              // Fallback to home if logged in, landing otherwise
              showPage(isSignedIn ? 'homePage' : 'landingPage');
          }

          // Close sidebar after navigation (optional)
          document.querySelector('.game-sidebar').style.left = '-250px';

          // Update Home Page content if showing home
          if(pageId === 'homePage') {
              updateHomePageContent();
          }
      }

      // --- Update Clock Function (Targets new element) ---
      function updateClock() {
        const clockContainer = document.getElementById("navClockContainer"); // Target top nav bar clock
        const homeTimeDate = document.getElementById("homeTimeDate"); // Target home page date display

        if (!clockContainer) return;

        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, "0");
        const seconds = now.getSeconds().toString().padStart(2, "0");
        const period = hours >= 12 ? "PM" : "AM";
        hours = hours % 12 || 12;
        hours = hours.toString().padStart(2, "0");

        // Update top bar clock
        clockContainer.innerHTML = `<span class="time">${hours}:${minutes}:${seconds}</span> <span class="period">${period}</span>`;

        // Update home page date/time
        if (homeTimeDate && currentPage === 'homePage') {
             const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
             homeTimeDate.textContent = now.toLocaleDateString(undefined, dateOptions) + ` - ${hours}:${minutes} ${period}`;
        }
      }

      // --- Update Streak Display (Targets new element) ---
      function updateStreak() {
        // Removed old streakDisplay logic
        const streakTooltip = document.getElementById("streakTooltip");
        const streakButton = document.getElementById("streakBtn"); // For potential styling changes based on streak

        if (!streakTooltip) return;

        const today = new Date().toDateString();
        const lastDate = localStorage.getItem("lastFocusDate");
        let updatedStreak = false;

        if (lastDate) {
          const last = new Date(lastDate);
          const diffTime = new Date(today).getTime() - last.getTime(); // Use getTime() for accurate difference
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

          if (diffDays === 1) {
            streakDays++;
            updatedStreak = true;
            checkMysteryBoxMilestone();
          } else if (diffDays > 1) {
            console.log(`Streak check: ${diffDays} days since last focus.`);
            if (activePowerUps.streakShield.active && !activePowerUps.streakShield.used && Date.now() < activePowerUps.streakShield.expiry) {
               // Don't increment, just protect
               activePowerUps.streakShield.used = true; // Mark as used for this break
               alert(`Streak Shield protected your ${streakDays}-day streak! Focus today to continue.`);
               saveState(); // Save shield usage
            } else {
                 if (streakDays > 0) { // Only reset if there was a streak
                     console.log("Streak reset.");
                     streakDays = 0;
                     updatedStreak = true;
                 }
            }
          }
          // If diffDays is 0, do nothing (already focused today)

        } else if (isFocusModeActive || isPomodoroActive) { // Start streak on first focus of the day
            streakDays = 1;
            updatedStreak = true;
            checkMysteryBoxMilestone();
        }

        if (updatedStreak && (isFocusModeActive || isPomodoroActive)) { // Only save date if focus actually happened
            localStorage.setItem("lastFocusDate", today);
            // Reset shield 'used' status for the next potential break
             if(activePowerUps.streakShield.active) {
                 activePowerUps.streakShield.used = false;
             }
            if (isSignedIn && currentUser) {
              const users = JSON.parse(localStorage.getItem("users") || "{}");
              if (users[currentUser]) {
                  users[currentUser].streakDays = streakDays;
                  users[currentUser].lastFocusDate = today;
                  users[currentUser].mysteryBoxCount = mysteryBoxCount;
                  users[currentUser].activePowerUps = activePowerUps;
                  localStorage.setItem("users", JSON.stringify(users));
              }
            }
             console.log("Streak updated to:", streakDays, "Last focus date:", today);
        }

        // Update UI
        streakTooltip.textContent = `${streakDays}-day focus streak`;
        // Optional: Add visual indicator for active streak
        if (streakDays > 0) {
            streakButton.style.boxShadow = '0 0 10px gold';
        } else {
            streakButton.style.boxShadow = '2px 2px 10px rgba(0, 0, 0, 0.199)';
        }


        // Update sidebar (if still needed there, but removed from default)
        updateSidebarDashboard(); // Ensure sidebar function still updates streak if needed elsewhere
      }

      // --- Update Home Page Content ---
      function updateHomePageContent() {
          if (currentPage !== 'homePage') return;

          const welcomeMsg = document.getElementById('welcomeMessage');
          const focusStatus = document.getElementById('homeFocusStatus');
          const homeUsername = document.getElementById('homeUsername');

          if(currentUser && welcomeMsg) {
              homeUsername.textContent = `Hero: ${currentUser}`;
              // Simple welcome messages
              const messages = [
                  `Ready to conquer your quests, ${currentUser}?`,
                  `Let's get focused, ${currentUser}!`,
                  `Time to learn and grow, ${currentUser}!`,
                  `What challenge will you overcome today, ${currentUser}?`
              ];
              welcomeMsg.textContent = messages[Math.floor(Math.random() * messages.length)];
          }

          if(focusStatus) {
              // Example status - enhance this
              const incompleteTasks = tasks.filter(task => !task.completed).length;
              if (incompleteTasks > 0) {
                  focusStatus.textContent = `Today's objective: ${incompleteTasks} quest${incompleteTasks === 1 ? '' : 's'} remaining!`;
              } else {
                  focusStatus.textContent = `All quests complete! Ready for a new challenge?`;
              }
          }

          // Time/Date is updated by updateClock()
      }


      // --- Toggle Profile Page ---
      function toggleProfilePage(show) {
          const profilePage = document.getElementById('profilePage');
          if (!profilePage) return;

          if (show) {
              document.getElementById('profileUsername').textContent = currentUser || 'N/A';
              const levelData = getAchievementLevel(points);
              document.getElementById('profileLevel').textContent = levelData.level;
              document.getElementById('profileXP').textContent = points;
              document.getElementById('profileStreak').textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`;
              // Add profile picture logic if implemented
              profilePage.style.display = 'block';
          } else {
              profilePage.style.display = 'none';
          }
      }

      // --- Toggle Stats Page ---
      function toggleStatsPage(show) {
          const statsPage = document.getElementById('focusStatsPage');
          if (!statsPage) return;

          if (show) {
              // Update basic stats
              document.getElementById('statsTotalFocusTime').textContent = Math.floor(totalFocusTime / 60);
              document.getElementById('statsTotalDistractions').textContent = totalDistractions;
              document.getElementById('statsTotalVideosWatched').textContent = totalVideosWatched;

              // Generate Calendar Heatmap
              generateCalendarHeatmap();

              statsPage.style.display = 'block';
          } else {
              statsPage.style.display = 'none';
          }
      }

       // --- Generate Calendar Heatmap ---
       function generateCalendarHeatmap() {
           const calendarBody = document.getElementById('statsCalendarBody');
           if (!calendarBody) return;

           calendarBody.innerHTML = ''; // Clear previous calendar

           const today = new Date();
           const currentMonth = today.getMonth();
           const currentYear = today.getFullYear();

           // Go back ~3 months (adjust as needed)
           let startDate = new Date(currentYear, currentMonth - 3, 1);
           let endDate = new Date(currentYear, currentMonth + 1, 0); // End of current month

           let date = new Date(startDate);
           let week = [];
           let firstDayOffset = date.getDay(); // 0=Sun, 1=Mon, ...

           // Add empty cells for the first week offset
           for (let i = 0; i < firstDayOffset; i++) {
               week.push(document.createElement('td'));
           }

           while (date <= endDate) {
               let cell = document.createElement('td');
               let dayOfMonth = date.getDate();
               cell.textContent = dayOfMonth;

               let dateString = date.toISOString().split('T')[0]; // YYYY-MM-DD format

               if (dailyFocusData[dateString]) {
                   let pointsToday = dailyFocusData[dateString];
                   cell.classList.add('has-data');
                   // Determine heatmap level (example thresholds)
                   let level = 0;
                   if (pointsToday >= 500) level = 5;
                   else if (pointsToday >= 300) level = 4;
                   else if (pointsToday >= 150) level = 3;
                   else if (pointsToday >= 50) level = 2;
                   else if (pointsToday > 0) level = 1;

                   if (level > 0) {
                       cell.classList.add(`level-${level}`);
                   }
                   cell.title = `${dateString}: ${pointsToday} XP`; // Tooltip
               } else {
                    cell.title = `${dateString}: 0 XP`;
               }

               // Highlight today
               if (date.toDateString() === today.toDateString()) {
                   cell.style.borderColor = var(--accent);
                   cell.style.fontWeight = 'bold';
               }

               week.push(cell);

               if (date.getDay() === 6) { // Saturday, end of week
                   let row = document.createElement('tr');
                   week.forEach(dayCell => row.appendChild(dayCell));
                   calendarBody.appendChild(row);
                   week = []; // Start new week
               }

               date.setDate(date.getDate() + 1); // Move to next day
           }

           // Add remaining cells for the last week
           if (week.length > 0) {
               while (week.length < 7) {
                   week.push(document.createElement('td'));
               }
               let row = document.createElement('tr');
               week.forEach(dayCell => row.appendChild(dayCell));
               calendarBody.appendChild(row);
           }
       }

        // --- Update Daily Focus Data ---
        function updateDailyData(pointsEarned) {
            if (pointsEarned <= 0) return;

            const todayStr = new Date().toISOString().split('T')[0];
            dailyFocusData[todayStr] = (dailyFocusData[todayStr] || 0) + pointsEarned;
            localStorage.setItem("dailyFocusData", JSON.stringify(dailyFocusData));
             console.log("Updated daily data:", todayStr, dailyFocusData[todayStr]);

             // Also save to user data if logged in
             if (isSignedIn && currentUser) {
                 const users = JSON.parse(localStorage.getItem("users") || "{}");
                 if (users[currentUser]) {
                     if (!users[currentUser].dailyFocusData) {
                         users[currentUser].dailyFocusData = {};
                     }
                     users[currentUser].dailyFocusData[todayStr] = dailyFocusData[todayStr];
                     localStorage.setItem("users", JSON.stringify(users));
                 }
             }
        }


      // --- MODIFIED loadSavedState ---
      function loadSavedState() {
        try {
          // Load general state
          const savedState = localStorage.getItem("focusModeState");
          let state = {};
          if (savedState) {
              state = JSON.parse(savedState);
              // Load basic state variables
              videoIds = state.videoIds || [];
              currentVideoIndex = state.currentVideoIndex || 0;
              distractionCount = state.distractionCount || 0; // Local session distraction
              points = state.points || 0;
              timerMode = state.timerMode || "Focus Time";
              timerRemaining = state.timerRemaining || focusDuration / 1000;
              isFocusModeActive = state.isFocusModeActive || false; // If YT focus was active
              isSignedIn = state.isSignedIn || false;
              currentUser = state.currentUser || null;
              completedVideos = new Set(state.completedVideos || []);
              allVideosCompleted = state.allVideosCompleted || false;
              totalFocusTime = state.totalFocusTime || 0; // Overall stats
              totalDistractions = state.totalDistractions || 0; // Overall stats
              totalVideosWatched = state.totalVideosWatched || 0; // Overall stats
              streakDays = state.streakDays || 0;
              lastFocusDate = state.lastFocusDate || null; // Get last focus date from state
              mysteryBoxCount = state.mysteryBoxCount || 0;
              activePowerUps = state.activePowerUps || {
                  doublePoints: { active: false, expiry: null },
                  streakShield: { active: false, used: false, expiry: null },
              };
              premiumLofiTracks.forEach(track => { // Load premium track state
                  const saved = state.premiumLofiTracks?.find(t => t.id === track.id);
                  if(saved) track.unlocked = saved.unlocked;
                  if (track.unlocked && !lofiSongs.includes(track.url)) {
                    lofiSongs.push(track.url);
                  }
              });
              dailyFocusData = state.dailyFocusData || {}; // Load daily data from state
              currentPage = state.currentPage || (isSignedIn ? 'homePage' : 'landingPage'); // Restore last page
          }

          // Load user-specific data if signed in
          if (isSignedIn && currentUser) {
              const users = JSON.parse(localStorage.getItem("users") || "{}");
              const userData = users[currentUser];
              if (userData) {
                  // Override general state with potentially more up-to-date user data
                  points = userData.points || points;
                  totalFocusTime = userData.totalFocusTime || totalFocusTime;
                  totalDistractions = userData.totalDistractions || totalDistractions;
                  totalVideosWatched = userData.totalVideosWatched || totalVideosWatched;
                  tasks = userData.tasks || [];
                  streakDays = userData.streakDays || streakDays;
                  lastFocusDate = userData.lastFocusDate || lastFocusDate; // Get user's last focus date
                  mysteryBoxCount = userData.mysteryBoxCount || mysteryBoxCount;
                  activePowerUps = userData.activePowerUps || activePowerUps;
                  dailyFocusData = userData.dailyFocusData || dailyFocusData; // Load user's daily data

                  premiumLofiTracks.forEach(track => {
                     const savedUserTrack = userData.premiumLofiTracks?.find(t => t.id === track.id);
                     if(savedUserTrack) track.unlocked = savedUserTrack.unlocked;
                      if (track.unlocked && !lofiSongs.includes(track.url)) {
                         lofiSongs.push(track.url);
                      }
                  });
              } else {
                  // User data not found, might indicate an issue, log out?
                  console.warn("User data not found for logged-in user:", currentUser);
                  logout(); // Force logout if user data is missing
                  return; // Stop further processing
              }
          } else {
              // Not signed in, ensure defaults
              isSignedIn = false;
              currentUser = null;
              // Keep points etc. from general state if needed for guest session, or reset them:
              // points = 0; totalFocusTime = 0; ... tasks = []; streakDays = 0;
              currentPage = 'landingPage';
          }

          console.log("Loaded State - Signed In:", isSignedIn, "User:", currentUser, "Page:", currentPage, "Streak:", streakDays, "Last Focus:", lastFocusDate);

          // Update UI based on loaded state
          document.getElementById('pointsDisplay').innerHTML = `<span style="color: #8e2de2;">‚≠ê</span> XP: ${points}`;
          updateAchievementLevel(); // Update level display (if visible)
          updateStreak(); // Update streak display (top bar tooltip)
          updateSidebarDashboard(); // Update sidebar info
          restoreTasks(); // Load tasks into UI

           // Determine initial page view
           if (isFocusModeActive && videoIds.length > 0) {
               // Resume YouTube focus session
               showPage('watchLecturesPage'); // Show the container
               document.getElementById('lectureInputSection').style.display = 'none'; // Hide input
               document.getElementById('player').style.display = 'block'; // Show player
               document.getElementById('restartBtn').style.display = 'block';
               document.getElementById('pdfToggle').style.display = 'block';
               document.getElementById('timerDisplay').style.display = 'block'; // Show timer

               loadYouTubeAPI()
                   .then(() => {
                       setupYouTubePlayer(); // Re-setup player instance
                       startTimer(timerRemaining * 1000, timerMode); // Resume timer
                       // player might need to seek to the right position if YT remembers it
                   })
                   .catch((err) => console.error("YouTube API load failed on resume:", err));
           } else {
               // Not in active YT focus mode, show the determined page
                showPage(currentPage); // Show the correct page (home, landing, etc.)
                // If watch page, ensure inputs are visible and player is hidden
                if (currentPage === 'watchLecturesPage') {
                    document.getElementById('lectureInputSection').style.display = 'block';
                    document.getElementById('player').style.display = 'none';
                    restoreUrlInputs(); // Restore URLs in the input fields
                }
                 populatePlaylistSelect(); // Populate playlist dropdown
           }


          if (isSignedIn) {
              startReminderTimer(); // Start reminder if logged in and on home/watch page
              if (mysteryBoxCount > 0) showMysteryBoxPopup();
          }

        } catch (err) {
          console.error("Load saved state error:", err);
          // Attempt to gracefully recover or reset
          localStorage.removeItem("focusModeState");
          logout(); // Force logout/reset on error
        }
      }

      // --- MODIFIED saveState ---
      function saveState() {
        const state = {
          // --- Keep existing properties ---
          videoIds,
          currentVideoIndex,
          // distractionCount, // Maybe don't save local session distraction?
          points,
          timerMode,
          timerRemaining,
          isFocusModeActive,
          isSignedIn,
          currentUser,
          completedVideos: Array.from(completedVideos),
          allVideosCompleted,
          totalFocusTime,
          totalDistractions, // Save overall distractions
          totalVideosWatched,
          streakDays,
          lastFocusDate: localStorage.getItem("lastFocusDate"), // Get current saved date
          mysteryBoxCount,
          activePowerUps,
          premiumLofiTracks: premiumLofiTracks.map(t => ({ id: t.id, unlocked: t.unlocked })), // Save only necessary track info
          // --- Add new properties ---
          currentPage: (isFocusModeActive ? 'watchLecturesPage' : currentPage), // Save current page, override if YT focus active
          dailyFocusData // Save daily focus data
        };
        localStorage.setItem("focusModeState", JSON.stringify(state));
        // console.log("Saved State:", state);


        // Save critical parts to user data immediately
        if (isSignedIn && currentUser) {
          const users = JSON.parse(localStorage.getItem("users") || "{}");
          if (users[currentUser]) {
             users[currentUser].points = points;
             users[currentUser].totalFocusTime = totalFocusTime;
             users[currentUser].totalDistractions = totalDistractions;
             users[currentUser].totalVideosWatched = totalVideosWatched;
             users[currentUser].tasks = tasks;
             users[currentUser].streakDays = streakDays;
             users[currentUser].lastFocusDate = localStorage.getItem("lastFocusDate");
             users[currentUser].mysteryBoxCount = mysteryBoxCount;
             users[currentUser].activePowerUps = activePowerUps;
             users[currentUser].premiumLofiTracks = premiumLofiTracks.map(t => ({ id: t.id, unlocked: t.unlocked }));
             users[currentUser].dailyFocusData = dailyFocusData;
             localStorage.setItem("users", JSON.stringify(users));
          }
        }
      }

      // --- MODIFIED signIn / createAccount ---
      function signIn() {
          try {
              // ... (get username/password)
              const users = JSON.parse(localStorage.getItem("users") || "{}");
              if (users[username] && users[username].password === password) {
                  isSignedIn = true;
                  currentUser = username;
                  // Load user data into current variables
                  points = users[username].points || 0;
                  totalFocusTime = users[username].totalFocusTime || 0;
                  totalDistractions = users[username].totalDistractions || 0;
                  totalVideosWatched = users[username].totalVideosWatched || 0;
                  tasks = users[username].tasks || [];
                  streakDays = users[username].streakDays || 0;
                  lastFocusDate = users[username].lastFocusDate || null;
                  mysteryBoxCount = users[username].mysteryBoxCount || 0;
                  activePowerUps = users[username].activePowerUps || { /* default */ };
                  dailyFocusData = users[username].dailyFocusData || {};
                  // Load premium tracks...
                  premiumLofiTracks.forEach(track => {
                     const savedUserTrack = users[username].premiumLofiTracks?.find(t => t.id === track.id);
                     if(savedUserTrack) track.unlocked = savedUserTrack.unlocked;
                      if (track.unlocked && !lofiSongs.includes(track.url)) {
                         lofiSongs.push(track.url);
                      }
                  });

                  console.log("Sign In successful. User:", currentUser, "Streak:", streakDays, "Last Focus:", lastFocusDate);

                  document.getElementById('pointsDisplay').innerHTML = `<span style="color: #8e2de2;">‚≠ê</span> XP: ${points}`;
                  updateAchievementLevel();
                  updateStreak(); // Important: call updateStreak AFTER loading data
                  updateSidebarDashboard();
                  restoreTasks();
                  populatePlaylistSelect(); // Populate playlist for watch page
                  saveState(); // Save the logged-in state
                  showPage('homePage'); // Show home page after login
                  startReminderTimer();
                  if (mysteryBoxCount > 0) showMysteryBoxPopup();

              } else {
                  alert("Invalid username or password");
              }
          } catch (err) {
              console.error("Sign-in error:", err);
              alert("Error during sign-in.");
          }
      }

      function createAccount() {
           try {
              // ... (get username/password)
               const users = JSON.parse(localStorage.getItem("users") || "{}");
               if (users[username]) { /*...*/ }
               else if (username && password) {
                    // Set initial user data
                    users[username] = {
                       password,
                       points: 0,
                       totalFocusTime: 0,
                       totalDistractions: 0,
                       totalVideosWatched: 0,
                       tasks: [],
                       streakDays: 0,
                       lastFocusDate: null, // Initialize last focus date
                       mysteryBoxCount: 0,
                       activePowerUps: { /* default */ },
                       premiumLofiTracks: premiumLofiTracks.map(track => ({ id: track.id, unlocked: false })),
                       dailyFocusData: {} // Initialize daily data
                    };
                    localStorage.setItem("users", JSON.stringify(users));

                    // Set current state variables
                    isSignedIn = true;
                    currentUser = username;
                    points = 0;
                    totalFocusTime = 0;
                    totalDistractions = 0;
                    totalVideosWatched = 0;
                    tasks = [];
                    streakDays = 0;
                    lastFocusDate = null;
                    mysteryBoxCount = 0;
                    activePowerUps = { /* default */ };
                    dailyFocusData = {};
                     premiumLofiTracks.forEach(track => track.unlocked = false); // Ensure tracks are locked

                    console.log("Account Created. User:", currentUser);

                    document.getElementById('pointsDisplay').innerHTML = `<span style="color: #8e2de2;">‚≠ê</span> XP: ${points}`;
                    updateAchievementLevel();
                    updateStreak();
                    updateSidebarDashboard();
                    restoreTasks();
                    populatePlaylistSelect();
                    saveState();
                    showPage('homePage'); // Show home page after creation
                    startReminderTimer();

               } else { /* alert */ }
           } catch (err) {
                console.error("Account creation error:", err);
                alert("Error creating account.");
           }
      }

      // --- MODIFIED startPlayback ---
      function startPlayback() {
        try {
          // Get URLs from inputs inside #watchLecturesPage
          const urlInputs = document.querySelectorAll("#watchLecturesPage .youtube-url");
          // ... (rest of URL extraction logic) ...

          if (videoIds.length === 0) {
            alert("No valid YouTube URLs provided in the Watch Lectures section.");
            return;
          }

          // Hide input section, show player section
          document.getElementById('lectureInputSection').style.display = 'none';
          document.getElementById('player').style.display = 'block';
          document.getElementById('restartBtn').style.display = 'block';
          document.getElementById('pdfToggle').style.display = 'block';
          document.getElementById('timerDisplay').style.display = 'block'; // Show timer only now
          // Keep lofi/chatbot visible? Yes.

          stopReminderTimer(); // Stop reminders during YT focus

          loadYouTubeAPI()
            .then(() => {
              setupYouTubePlayer(); // This uses global 'player' variable
              startTimer(focusDuration, "Focus Time"); // Start the focus timer
              saveState(); // Save that we are starting playback
              requestFullscreen(document.documentElement);
            })
            .catch((err) => {
              console.error("YouTube API load failed:", err);
              alert("Failed to load YouTube player.");
              // Revert UI changes if API fails
              document.getElementById('lectureInputSection').style.display = 'block';
              document.getElementById('player').style.display = 'none';
              document.getElementById('restartBtn').style.display = 'none';
              document.getElementById('pdfToggle').style.display = 'none';
              document.getElementById('timerDisplay').style.display = 'none';
            });
        } catch (err) {
          console.error("Start playback error:", err);
          alert("An error occurred starting playback.");
        }
      }

      // --- MODIFIED restartSession ---
      function restartSession() { // Renamed from showConfirmationDialog
        const dialog = document.getElementById("confirmationDialog");
        if (!dialog) return;
        dialog.style.display = "block";
      }

      function handleRestartConfirmation(choice) { // Renamed from handleConfirmation
        const dialog = document.getElementById("confirmationDialog");
        if (!dialog) return;
        dialog.style.display = "none";

        if (choice === "yes") {
          clearInterval(countdownInterval);
          isFocusModeActive = false;
          // videoIds = []; // Don't clear videoIds, user might want to restart same list later
          // currentVideoIndex = 0;
          // completedVideos.clear();
          // allVideosCompleted = false;
          if (player) {
              // player.stopVideo(); // Stop video before destroying
              player.destroy();
              player = null; // Ensure player object is cleared
          }

          // Reset UI elements specific to watchLecturesPage playback
          document.getElementById('player').style.display = 'none';
          document.getElementById('restartBtn').style.display = 'none';
          document.getElementById('pdfToggle').style.display = 'none';
          document.getElementById('timerDisplay').style.display = 'none';
          const progressBar = document.getElementById("progressBar");
          if (progressBar) progressBar.style.display = "none";
          document.getElementById('videoSidebar').style.right = "-320px";

          // Show the input section again on the watch page
          document.getElementById('lectureInputSection').style.display = 'block';

          exitFullscreen();
          // restoreUrlInputs(); // Restore URLs in inputs if they were cleared

          // Navigate back to home page
          showPage('homePage');

          saveState(); // Save the state after ending the session
          startReminderTimer(); // Restart reminders now that YT focus ended
        }
      }

       // --- MODIFIED startTimer ---
       function startTimer(duration, mode) {
           // ... (existing timer setup) ...
           timerRemaining = duration / 1000; // Ensure timerRemaining is set correctly
           progressBar.style.display = "block";

           updateStreak(); // Check/update streak when a timer starts

           clearInterval(countdownInterval);
           countdownInterval = setInterval(() => {
               // ... (existing time display and progress bar logic) ...

               // Update total focus time and potentially points per second/minute
               if (mode === "Focus Time") {
                   totalFocusTime += 1;
                   // Optional: Award tiny points per second/minute
                   // if (timerRemaining % 60 === 0) { // Award per minute
                   //    let minutePoints = applyPowerUps(1);
                   //    points += minutePoints;
                   //    updateDailyData(minutePoints); // Update daily data
                   //    document.getElementById('pointsDisplay').innerHTML = ...;
                   // }
               }
               timeRemaining--;
               timerRemaining = timeRemaining; // Update global timerRemaining for saving state

               if (timeRemaining < 0) {
                   clearInterval(countdownInterval);
                   progressBar.style.display = "none";

                   let pointsEarned = 0; // Track points for this interval completion

                   if (mode === "Focus Time") {
                       pointsEarned = applyPowerUps(100); // Points for completing focus block
                       playFocusAudio();
                       showSessionCompleteDialog(); // Show continue/end dialog
                   } else if (mode === "Break Time") {
                       pointsEarned = applyPowerUps(20); // Small points for completing break
                       startTimer(secondBreakDuration, "Short Break");
                   } else { // Short Break finished
                       pointsEarned = applyPowerUps(10); // Small points for completing short break
                       startTimer(focusDuration, "Focus Time"); // Loop back to focus
                   }

                   if (pointsEarned > 0) {
                       points += pointsEarned;
                       updateDailyData(pointsEarned); // Update daily data when points are awarded
                       document.getElementById('pointsDisplay').innerHTML = `<span style="color: #8e2de2;">‚≠ê</span> XP: ${points}`;
                       checkLevelUp();
                   }

                   saveState(); // Save state after timer transition
               }
           }, 1000);
       }

        // --- MODIFIED completePomodoroSession ---
        function completePomodoroSession() {
            clearInterval(pomodoroInterval);
            isPomodoroActive = false;

            const audio = document.getElementById("pomodoroCompleteAudio");
            if (audio) audio.play().catch(err => console.error("Pomodoro audio error:", err));

            const minutesCompleted = 60; // Assume full 60 mins for simplicity now
            const pointsEarned = applyPowerUps(minutesCompleted); // 1 point per minute base
            points += pointsEarned;
            updateDailyData(pointsEarned); // Update daily data

            document.getElementById("pomodoroStatus").textContent = `Completed! Earned ${pointsEarned} XP`;
            document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">‚≠ê</span> XP: ${points}`;

            saveState();
            checkLevelUp();
            updateStreak(); // Check streak after Pomodoro completion
        }


        // --- MODIFIED logout ---
        function logout() {
           // Reset state variables
           isSignedIn = false;
           currentUser = null;
           points = 0;
           totalFocusTime = 0;
           totalDistractions = 0;
           totalVideosWatched = 0;
           tasks = [];
           streakDays = 0;
           lastFocusDate = null;
           mysteryBoxCount = 0;
           activePowerUps = { /* default */ };
           videoIds = [];
           currentVideoIndex = 0;
           completedVideos.clear();
           allVideosCompleted = false;
           dailyFocusData = {};
            premiumLofiTracks.forEach(track => track.unlocked = false); // Reset unlocked tracks

           clearInterval(countdownInterval); // Clear YT timer
           isFocusModeActive = false;
           clearInterval(pomodoroInterval); // Clear Pomodoro timer
           isPomodoroActive = false;

           if (player) {
               try { player.destroy(); } catch (e) {}
               player = null;
           }

           // Reset UI elements
           document.getElementById('pointsDisplay').innerHTML = `<span style="color: #8e2de2;">‚≠ê</span> XP: 0`;
           const progressBar = document.getElementById("progressBar");
           if (progressBar) progressBar.style.display = "none";
           document.getElementById('timerDisplay').style.display = 'none';
           document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('pdfToggle').style.display = 'none';
           document.getElementById('videoSidebar').style.right = "-320px";
           document.getElementById('topNavBar').style.display = 'none'; // Hide top bar

           // Clear potential sensitive info from inputs
           document.getElementById('username').value = '';
           document.getElementById('password').value = '';
           // restoreUrlInputs(); // Clear URL inputs

           saveState(); // Save the logged-out state (clears most things)
           stopReminderTimer();
           // updateAnalytics(); // Analytics are likely part of modals now
           updateAchievementLevel(); // Reset level display (if visible)
           updateSidebarDashboard(); // Reset sidebar info

           // Navigate to landing page
           showPage('landingPage');
           exitFullscreen(); // Ensure fullscreen is exited
        }

       // --- Event Listeners Setup ---
       function setupEventListeners() {
            document.querySelectorAll("button[data-action]").forEach((btn) => {
              btn.addEventListener("click", () => {
                const action = btn.getAttribute("data-action");
                switch (action) {
                  case "show-signin": showPage('signinForm'); break;
                  case "show-landing": showPage('landingPage'); break;
                  case "github": window.open("https://github.com/The-Chosen-One-o5/UltraFocusModeYT", "_blank"); break;
                  case "sign-in": signIn(); break;
                  case "create-account": createAccount(); break;
                  case "add-url": addUrlInput(); break; // Ensure this targets #watchLecturesPage
                  case "start-playback": startPlayback(); break;
                  case "save-playlist": savePlaylist(); break; // Ensure this targets #watchLecturesPage inputs
                  case "remove-playlist": removePlaylist(); break; // Ensure this targets #watchLecturesPage inputs
                  case "add-task": addTaskLine(); break; // For ToDo list
                  case "save-tasks": saveTasks(); break; // For ToDo list
                }
              });
            });

             // Sidebar Navigation Buttons
             document.querySelectorAll('.game-sidebar button[data-page]').forEach(button => {
                 button.addEventListener('click', () => showPage(button.dataset.page));
             });

             // Top Bar Buttons
             document.getElementById("profileBtn").addEventListener("click", () => toggleProfilePage(true));
             // document.getElementById("settingsBtn").addEventListener("click", () => {/* Show settings */});
             // Streak button might not need a click action, just tooltip

             // Sidebar Action Buttons
             document.getElementById("sidebarTodoBtn").addEventListener("click", () => toggleTodo(true));
             document.getElementById("sidebarStatsBtn").addEventListener("click", () => toggleStatsPage(true));
             document.getElementById("quietPomodoroBtn").addEventListener("click", showPomodoroOverlay);
             document.getElementById("streakShieldBtn").addEventListener("click", showStreakShieldDialog);
             document.getElementById("doublePointsBtn").addEventListener("click", showDoublePointsDialog);
             document.getElementById("audioStoreBtn").addEventListener("click", showAudioTracksStore);
             document.getElementById("logoutBtn").addEventListener("click", logout);

             // Playback Control Buttons (specific page)
             document.getElementById("restartBtn").addEventListener("click", restartSession); // Show confirmation
             document.getElementById("pdfToggle").addEventListener("click", () => togglePDFViewer(true));


             // Dialog Confirmation Buttons
             document.getElementById("confirmBtn").addEventListener("click", () => handleRestartConfirmation("yes"));
             document.getElementById("cancelBtn").addEventListener("click", () => handleRestartConfirmation("no"));
             document.getElementById("streakShieldConfirmBtn").addEventListener("click", () => handleStreakShieldConfirmation("yes"));
             document.getElementById("streakShieldCancelBtn").addEventListener("click", () => handleStreakShieldConfirmation("no"));
             document.getElementById("doublePointsConfirmBtn").addEventListener("click", () => handleDoublePointsConfirmation("yes"));
             document.getElementById("doublePointsCancelBtn").addEventListener("click", () => handleDoublePointsConfirmation("no"));
             document.getElementById("deadlineConfirmBtn").addEventListener("click", () => handleDeadlineConfirmation("yes"));
             document.getElementById("deadlineCancelBtn").addEventListener("click", () => handleDeadlineConfirmation("no"));
             document.getElementById("sessionContinueBtn").addEventListener("click", () => handleSessionContinue("continue"));
             document.getElementById("sessionEndBtn").addEventListener("click", () => handleSessionContinue("end"));


             // Other Global Buttons/Toggles
             document.getElementById("closeAudioStore").addEventListener("click", closeAudioTracksStore);
             document.getElementById("pdfInput").addEventListener("change", handlePDFUpload);
             document.getElementById("fireBox").addEventListener("click", toggleAIPopup);
             document.getElementById("openMysteryBox").addEventListener("click", openMysteryBox);

             // Pomodoro Controls
             document.getElementById("pomodoroStartBtn").addEventListener("click", startPomodoro);
             document.getElementById("pomodoroResetBtn").addEventListener("click", resetPomodoro);
             document.getElementById("pomodoroCloseBtn").addEventListener("click", closePomodoroOverlay);

             // Lofi Controls
             document.getElementById("lofiPlay").addEventListener("click", playLofi);
             document.getElementById("lofiPause").addEventListener("click", pauseLofi);
             document.getElementById("lofiPrev").addEventListener("click", prevLofi);
             document.getElementById("lofiNext").addEventListener("click", nextLofi);

             // Timer Dragging (Keep as is)
              const timerDisplay = document.getElementById("timerDisplay");
              let isDragging = false; let currentX; let currentY; let xOffset = 0; let yOffset = 0;
              timerDisplay.addEventListener("mousedown", (e) => { isDragging = true; currentX = e.clientX - xOffset; currentY = e.clientY - yOffset; });
              document.addEventListener("mousemove", (e) => { if (isDragging) { e.preventDefault(); xOffset = e.clientX - currentX; yOffset = e.clientY - currentY; timerDisplay.style.left = `${xOffset}px`; timerDisplay.style.top = `${yOffset}px`; }});
              document.addEventListener("mouseup", () => { isDragging = false; });

             // Visibility Change Listener (Keep as is, maybe add pomodoro pause?)
              document.addEventListener("visibilitychange", () => {
                 if (document.hidden && (isFocusModeActive /* || isPomodoroActive */) ) { // Pause Pomodoro too? Decide behavior.
                    distractionCount++; // Local session count
                    totalDistractions++; // Global count
                    updateDailyData(-5); // Penalize distractions slightly
                    pauseLofi();
                     // Maybe pause timers?
                     // if (isFocusModeActive) clearInterval(countdownInterval);
                     // if (isPomodoroActive) clearInterval(pomodoroInterval);
                    saveState();
                 } else if (!document.hidden && (isFocusModeActive /* || isPomodoroActive */) ) {
                    playLofi();
                    // Maybe resume timers? Requires storing time elapsed during pause.
                 }
              });

               // Initial Task Line for ToDo
               if (document.getElementById('tasks') && document.getElementById('tasks').children.length === 0) {
                   addTaskLine();
               }
        }


      // --- Initialization ---
      document.addEventListener("DOMContentLoaded", () => {
        initAudio();
        loadSavedState(); // Load state first to determine starting page
        setInterval(updateClock, 1000); // Start clock updates
        setupEventListeners(); // Attach all listeners
        setInterval(checkTaskDeadlines, 60000); // Check deadlines periodically
      });

      // --- Make utility functions globally accessible if needed by inline HTML onclick ---
      window.toggleProfilePage = toggleProfilePage;
      window.toggleStatsPage = toggleStatsPage;
      window.toggleTodo = toggleTodo; // Ensure this works globally
      window.togglePDFViewer = togglePDFViewer; // Ensure this works globally

    })();
  </script>
</body>
</html>
