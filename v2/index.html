<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Focus Mode YouTube Player</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #4169e1;
      --primary-dark: #1e3a8a;
      --secondary: #8e2de2;
      --accent: #ff4500;
      --accent-alt: #ff8c00;
      --bg-dark: #0f0f1b;
      --bg-medium: #1a1a2e;
      --bg-light: #252538;
      --text: #e0e0ff;
      --text-dim: #9090b0;
    }

    body {
      background-color: var(--bg-dark);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: monospace;
      color: var(--text);
      overflow: hidden;
      font-size: 18px;
      line-height: 1.4;
    }

    .game-container {
      width: 100%;
      height: 100vh;
      position: relative;
      overflow: hidden;
      background-image: radial-gradient(circle at 10% 20%, rgba(142, 45, 226, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 20%),
        linear-gradient(to bottom, var(--bg-dark), var(--bg-medium));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1; /* Ensure base layer has lowest z-index */
    }

    .game-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1h1z'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 2;
    }

    #landingPage,
    #signinForm,
    #inputForm {
      text-align: center;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
      z-index: 10;
      background-color: rgba(15, 15, 27, 0.8);
      border: 2px solid var(--secondary);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(142, 45, 226, 0.3);
      pointer-events: auto; /* Ensure clickable */
    }

    .title {
      font-family: monospace;
      font-size: 32px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 20px;
      text-shadow: 3px 3px 0px var(--primary-dark);
      letter-spacing: 2px;
    }

    .title span {
      color: var(--secondary);
      position: relative;
      display: inline-block;
    }

    .title span::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .subtitle {
      font-size: 20px;
      color: var(--text-dim);
      margin-bottom: 30px;
    }

    button {
      display: inline-block;
      padding: 12px 30px;
      font-size: 18px;
      font-family: monospace;
      font-weight: 600;
      background: var(--secondary);
      border: none;
      color: var(--text);
      border-radius: 0;
      cursor: pointer;
      margin: 0 10px 15px;
      transition: all 0.3s;
      position: relative;
      box-shadow: 4px 4px 0 var(--primary-dark);
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 1px;
      z-index: 11; /* Higher than container */
      pointer-events: auto; /* Ensure clickable */
    }

    button:hover {
      background: var(--primary);
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 var(--primary-dark);
    }

    button:active {
      transform: translate(4px, 4px);
      box-shadow: none;
    }

    .github-btn {
      background: var(--bg-light);
      box-shadow: 4px 4px 0 var(--bg-medium);
    }

    .github-btn:hover {
      background: var(--bg-medium);
      box-shadow: 2px 2px 0 var(--bg-medium);
    }

    #features {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
      flex-wrap: wrap;
      z-index: 10;
    }

    .feature {
      background: var(--bg-light);
      padding: 15px 20px;
      border-radius: 0;
      width: 200px;
      box-shadow: 4px 4px 0 var(--bg-medium);
      border: 2px solid var(--primary);
      position: relative;
      overflow: hidden;
      z-index: 10;
    }

    .feature::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .feature i {
      font-size: 24px;
      color: var(--secondary);
      margin-bottom: 10px;
    }

    .feature p {
      font-size: 16px;
      color: var(--text);
    }

    input,
    select {
      display: block;
      width: 100%;
      max-width: 320px;
      margin: 10px auto;
      padding: 12px;
      border-radius: 0;
      font-size: 16px;
      font-family: monospace;
      background: var(--bg-light);
      border: 2px solid var(--primary);
      color: var(--text);
      outline: none;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
      z-index: 11;
      pointer-events: auto;
    }

    input:focus,
    select:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 2px rgba(142, 45, 226, 0.3);
    }

    #inputForm {
      max-height: 80vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--secondary) var(--bg-medium);
    }

    #inputForm::-webkit-scrollbar {
      width: 8px;
    }

    #inputForm::-webkit-scrollbar-track {
      background: var(--bg-medium);
    }

    #inputForm::-webkit-scrollbar-thumb {
      background: var(--secondary);
      border-radius: 0;
      border: 2px solid var(--bg-medium);
    }

    #player {
      width: 100%;
      max-width: 1200px;
      aspect-ratio: 16 / 9;
      border-radius: 0;
      overflow: hidden;
      display: none;
      background: #000;
      border: 4px solid var(--primary);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      z-index: 5;
    }

    #timerDisplay {
      position: fixed;
      top: 10px;
      left: 10px;
      color: var(--text);
      font-size: 24px;
      z-index: 101;
      cursor: move;
      padding: 10px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      font-family: monospace;
      font-size: 16px;
      pointer-events: auto;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
    }

    #timerDisplay button {
      pointer-events: auto;
      padding: 5px 10px;
      margin: 0 5px;
      font-size: 12px;
      z-index: 102;
    }

    #pointsDisplay {
      position: fixed;
      top: 50px;
      left: 10px;
      font-size: 18px;
      color: var(--text);
      font-family: monospace;
      font-weight: 600;
      z-index: 101;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    #clockDisplay {
      position: fixed;
      top: 90px;
      left: 10px;
      font-size: 20px;
      font-family: monospace;
      font-weight: bold;
      z-index: 101;
      padding: 8px 12px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      display: none;
      pointer-events: none;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
    }

    #clockDisplay .time {
      color: var(--primary);
    }

    #clockDisplay .period {
      color: var(--secondary);
    }

    #progressBar {
      width: 200px;
      height: 10px;
      background: var(--bg-light);
      display: none;
      margin-top: 5px;
      border: 2px solid var(--primary);
      z-index: 101;
    }

    #progressFill {
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    #sitesBox {
      display: none;
      position: fixed;
      top: 130px;
      left: 10px;
      z-index: 101;
      padding: 8px 12px;
      background: var(--bg-medium);
      border: 2px solid var(--primary);
      cursor: pointer;
      pointer-events: auto;
    }

    #sitesPopup {
      position: fixed;
      top: 170px;
      left: 10px;
      width: 250px;
      background: var(--bg-medium);
      padding: 15px;
      border: 2px solid var(--secondary);
      display: none;
      z-index: 102;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #sitesPopup a {
      display: block;
      color: var(--primary);
      text-decoration: none;
      margin: 10px 0;
      font-size: 14px;
      font-family: monospace;
      padding: 5px;
      border: 1px solid var(--primary);
      transition: all 0.3s;
      pointer-events: auto;
    }

    #sitesPopup a:hover {
      color: var(--text);
      background: var(--primary);
      transform: translate(2px, 2px);
    }

    #closeSitesPopup {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--accent);
      border: none;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      padding: 2px 6px;
      margin: 0;
      z-index: 103;
    }

    #restartBtn {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      background: var(--accent);
      z-index: 103;
      pointer-events: auto;
    }

    #videoSidebar {
      position: fixed;
      right: -320px;
      top: 0;
      width: 300px;
      height: 100%;
      background: var(--bg-medium);
      transition: right 0.3s ease;
      padding: 20px;
      overflow-y: auto;
      z-index: 102;
      border-left: 4px solid var(--primary);
      pointer-events: auto;
    }

    .thumbnail {
      width: 100%;
      margin-bottom: 15px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 0;
      transition: all 0.3s;
      image-rendering: pixelated;
      pointer-events: auto;
    }

    .thumbnail:hover {
      border-color: var(--secondary);
      transform: scale(1.05);
    }

    #minimizeBtn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: var(--accent);
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 6px;
      margin: 0;
      box-shadow: none;
      z-index: 102;
    }

    .url-container {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .url-container button {
      margin-left: 10px;
      padding: 5px 10px;
      background: var(--accent);
      font-size: 14px;
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
      z-index: 11;
    }

    #statsBtn,
    #todoBtn,
    #pyqBtn {
      padding: 8px 16px;
      font-size: 12px;
      margin: 0 5px 15px;
      z-index: 11;
    }

    #analytics,
    #todoList {
      position: absolute;
      left: 10px;
      background: var(--bg-medium);
      padding: 15px;
      border: 2px solid var(--secondary);
      display: none;
      z-index: 100;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #analytics {
      top: 90px;
    }

    #todoList {
      top: 50px;
      width: 300px;
      max-height: 400px;
    }

    #tasks {
      overflow-y: auto;
      max-height: 320px;
      margin-bottom: 10px;
      background: none;
    }

    #analytics h3,
    #todoList h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: var(--secondary);
      font-family: monospace;
      font-size: 16px;
      text-align: center;
    }

    #analytics p {
      font-size: 16px;
      margin: 5px 0;
      border-bottom: 1px solid var(--bg-light);
      padding-bottom: 5px;
    }

    .task-line {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      background: var(--bg-light);
      padding: 5px;
      border: 1px solid var(--primary);
      pointer-events: auto;
    }

    .task-line input[type="checkbox"] {
      margin-right: 10px;
      width: 16px;
      height: 16px;
      appearance: none;
      border: 2px solid var(--primary);
      background: var(--bg-medium);
      position: relative;
      pointer-events: auto;
      z-index: 11;
    }

    .task-line input[type="checkbox"]:checked {
      background: var(--secondary);
    }

    .task-line input[type="checkbox"]:checked::after {
      content: "✓";
      position: absolute;
      color: var(--text);
      font-size: 12px;
      top: -2px;
      left: 2px;
    }

    .task-line input[type="text"] {
      flex-grow: 1;
      font-size: 16px;
      font-family: monospace;
      color: var(--text);
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--text-dim);
      padding: 2px 0;
      outline: none;
      box-shadow: none;
      margin: 0;
      pointer-events: auto;
      z-index: 11;
    }

    .task-line input[type="text"]:focus {
      border-bottom: 1px solid var(--secondary);
      box-shadow: none;
    }

    .task-line .remove-task {
      margin-left: 10px;
      color: var(--accent);
      font-size: 16px;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
      pointer-events: auto;
      z-index: 11;
    }

    #lofiPlayer {
      position: fixed;
      bottom: 10px;
      right: 10px;
      z-index: 101;
      display: none;
      background: var(--bg-medium);
      padding: 10px;
      border: 2px solid var(--primary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: auto;
    }

    #lofiPlayer button {
      background: var(--secondary);
      border: none;
      color: var(--text);
      padding: 5px 10px;
      margin: 0 2px;
      cursor: pointer;
      font-size: 12px;
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
      font-family: monospace;
      z-index: 102;
    }

    #achievementOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      color: gold;
      font-size: 32px;
      font-weight: bold;
      z-index: 104;
      display: none;
      font-family: monospace;
      text-align: center;
      text-shadow: 3px 3px 0 var(--primary-dark);
      background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
    }

    #achievementLevel {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 20px;
      font-weight: bold;
      z-index: 101;
      font-family: monospace;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    #streakDisplay {
      position: fixed;
      top: 60px;
      right: 10px;
      font-size: 16px;
      color: var(--text);
      z-index: 101;
      background: var(--bg-medium);
      padding: 8px 12px;
      border: 2px solid var(--secondary);
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      pointer-events: none;
      font-family: monospace;
    }

    .glow {
      text-shadow: 0 0 10px var(--text);
      animation: pulse 2s infinite;
    }

    .box-glow {
      border: 2px solid gold;
      padding: 5px;
      box-shadow: 0 0 10px gold;
      animation: pulse 2s infinite;
    }

    .rainbow {
      background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s infinite;
    }

    @keyframes rainbow {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    #confirmationDialog {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--bg-medium);
      padding: 20px;
      border: 4px solid var(--accent);
      box-shadow: 0 0 20px rgba(255, 69, 0, 0.5);
      z-index: 105;
      display: none;
      text-align: center;
      pointer-events: auto;
      font-family: monospace;
    }

    #confirmationDialog p {
      font-size: 16px;
      margin-bottom: 20px;
    }

    #confirmationDialog button {
      padding: 8px 20px;
      margin: 0 10px;
      font-size: 14px;
      pointer-events: auto;
      z-index: 106;
    }

    #confirmBtn {
      background: var(--accent);
    }

    #cancelBtn {
      background: var(--primary);
    }

    #pdfToggle {
      display: none;
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: var(--primary);
      z-index: 101;
      cursor: pointer;
      pointer-events: auto;
    }

    #pdfViewer {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      height: 500px;
      background: var(--bg-medium);
      padding: 15px;
      border: 4px solid var(--primary);
      box-shadow: 0 0 20px rgba(65, 105, 225, 0.5);
      z-index: 101;
      pointer-events: auto;
    }

    #pdfInput {
      margin-bottom: 10px;
      width: 100%;
      pointer-events: auto;
      z-index: 102;
    }

    #pdfFrame {
      width: 100%;
      height: 90%;
      border: none;
      background: #fff;
    }

    #fireBox {
      position: fixed;
      bottom: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      border: 2px solid var(--secondary);
      pointer-events: auto;
    }

    #fireBox:hover {
      background: var(--secondary);
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3);
    }

    #aiPopup {
      position: fixed;
      bottom: 60px;
      left: 10px;
      width: 300px;
      height: 400px;
      background: var(--bg-medium);
      border-radius: 0;
      padding: 5px;
      display: none;
      z-index: 101;
      box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.3);
      border: 4px solid var(--primary);
      pointer-events: auto;
    }

    #aiPopup iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .game-sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      width: 250px;
      height: 100vh;
      background: var(--bg-medium);
      border-right: 4px solid var(--primary);
      z-index: 200;
      transition: left 0.3s ease;
      padding: 20px 0;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
      pointer-events: auto;
    }

    .sidebar-trigger:hover + .game-sidebar,
    .game-sidebar:hover {
      left: 0;
    }

    .sidebar-trigger {
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 80px;
      background: var(--primary);
      z-index: 199;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      font-weight: bold;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 12px;
      letter-spacing: 1px;
      pointer-events: auto;
    }

    .sidebar-section {
      padding: 15px;
      border-bottom: 2px solid var(--bg-dark);
    }

    .sidebar-section h3 {
      color: var(--secondary);
      font-size: 16px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-section a,
    .sidebar-section button {
      display: block;
      width: 100%;
      padding: 8px 10px;
      margin: 5px 0;
      background: var(--bg-light);
      color: var(--text);
      border: 1px solid var(--primary);
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      pointer-events: auto;
      z-index: 201;
    }

    .sidebar-section a:hover,
    .sidebar-section button:hover {
      background: var(--primary);
      transform: translateX(5px);
    }

    .dashboard-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dashboard-info p {
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }

    .dashboard-info p span:first-child {
      font-weight: bold;
      color: var(--primary);
    }

    @media (max-width: 800px) {
      .title { font-size: 24px; }
      button { padding: 8px 16px; font-size: 12px; margin: 0 5px 10px; }
      #features { flex-direction: column; align-items: center; }
      .feature { width: 90%; max-width: 250px; }
      #timerDisplay, #pointsDisplay, #clockDisplay, #sitesBox { font-size: 14px; padding: 5px 8px; }
      #achievementLevel, #streakDisplay { font-size: 14px; padding: 5px 8px; }
      #videoSidebar { width: 250px; }
      #lofiPlayer button { padding: 3px 6px; font-size: 10px; }
      #confirmationDialog { width: 90%; max-width: 300px; }
      #confirmationDialog p { font-size: 14px; }
      #pdfViewer { width: 90%; height: 80%; max-height: 500px; }
      #aiPopup { width: 90%; max-width: 300px; height: 350px; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="sidebar-trigger">MENU</div>
    <div class="game-sidebar">
      <div class="sidebar-section">
        <h3>Dashboard</h3>
        <div class="dashboard-info">
          <p><span>Hero:</span> <span id="sidebarUsername">Guest</span></p>
          <p><span>Level:</span> <span id="sidebarLevel">Mortal</span></p>
          <p><span>XP:</span> <span id="sidebarXP">0</span></p>
          <p><span>Streak:</span> <span id="sidebarStreak">0 days</span></p>
        </div>
      </div>
      <div class="sidebar-section">
        <h3>Allied Realms</h3>
        <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer">FOREST QUEST - TASK MANAGEMENT</a>
        <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer">POMODORO REALM</a>
        <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer">DAILY QUEST PLANNER</a>
      </div>
      <div class="sidebar-section">
        <h3>Account</h3>
        <button id="logoutBtn">LOGOUT</button>
      </div>
    </div>
    <div id="landingPage">
      <div class="title">QUEST FOR <span>FOCUS</span></div>
      <div class="subtitle">Begin your learning adventure!</div>
      <button data-action="start-game">START GAME</button>
      <button class="github-btn" data-action="github">GITHUB REPO</button>
      <div id="features">
        <div class="feature">
          <i class="fas fa-ad"></i>
          <p>Ad Free<br>No distractions on your quest</p>
        </div>
        <div class="feature">
          <i class="fas fa-moon"></i>
          <p>Dark Mode<br>Save your vision for the final boss</p>
        </div>
      </div>
    </div>

    <div id="signinForm" style="display: none;">
      <div class="title">CREATE YOUR <span>ACCOUNT</span></div>
      <div class="subtitle">Sign in to track your progress</div>
      <input type="text" id="username" placeholder="Hero Name" required />
      <input type="password" id="password" placeholder="Secret Code" required />
      <button data-action="sign-in">ENTER REALM</button>
      <p>New adventurer? <button data-action="create-account">CREATE ACCOUNT</button></p>
    </div>

    <div id="inputForm" style="display: none;">
      <div id="achievementLevel"></div>
      <div id="streakDisplay"></div>
      <button id="todoBtn">TO-DO</button>
      <button id="statsBtn">HERO STATS</button>
      <button id="pyqBtn">TRAINING GROUNDS</button>

      <div id="todoList">
        <h3>TO-DO</h3>
        <div id="tasks">
          <div class="task-line">
            <input type="checkbox" class="task-check" />
            <input type="text" class="task-text" placeholder="Add a quest..." />
            <span class="remove-task">x</span>
          </div>
        </div>
        <button data-action="save-tasks">SAVE QUESTS</button>
      </div>

      <div id="analytics">
        <h3>HERO STATS</h3>
        <p>Focus Time: <span id="totalFocusTime">0</span> min</p>
        <p>Distractions Defeated: <span id="totalDistractions">0</span></p>
        <p>Videos Completed: <span id="totalVideosWatched">0</span></p>
      </div>

      <div class="title">ENTER YOUR <span>YOUTUBE URL</span></div>
      <div class="subtitle"></div>
      <select id="playlistSelect">
        <option value="">Select a Playlist</option>
      </select>
      <input type="text" id="playlistName" placeholder="Save Path As..." />
      <button data-action="save-playlist">SAVE PLAYLIST</button>
      <button data-action="remove-playlist">DELETE PLAYLIST</button>

      <div id="urlInputs">
        <div class="url-container">
          <input type="text" class="youtube-url" placeholder="YouTube URL (Videos or Live Streams)" required />
        </div>
      </div>

      <button data-action="add-url">ADD URL</button>
      <button data-action="start-playback">BEGIN FOCUS</button>
    </div>

    <div id="player" style="display: none;"></div>

    <div id="timerDisplay">
      <button id="minimizeBtn">-</button>
      <span id="timerText"></span>
      <div id="progressBar">
        <div id="progressFill"></div>
      </div>
    </div>

    <div id="pointsDisplay"><span style="color: #8e2de2;">⭐</span> XP: 0</div>
    <div id="clockDisplay"></div>

    <div id="sitesBox">ALLIED REALMS 👇</div>
    <div id="sitesPopup">
      <button id="closeSitesPopup">X</button>
      <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer">FOREST QUEST - TASK MANAGEMENT</a>
      <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer">POMODORO REALM</a>
      <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer">DAILY QUEST PLANNER</a>
    </div>

    <button id="restartBtn" style="display: none;">EXIT</button>

    <div id="videoSidebar"></div>

    <div id="lofiPlayer">
      <div style="text-align: center; margin-bottom: 5px;">LOFI MUSIC ♬</div>
      <button id="lofiPrev">◄</button>
      <button id="lofiPlay">▶</button>
      <button id="lofiPause">❚❚</button>
      <button id="lofiNext">►</button>
    </div>

    <div id="achievementOverlay"></div>

    <div id="confirmationDialog" style="display: none;">
      <p>Are you sure you want to abandon your quest?</p>
      <button id="confirmBtn">YES</button>
      <button id="cancelBtn">NO</button>
    </div>

    <button id="pdfToggle">PDF UPLOAD</button>

    <div id="pdfViewer">
      <input type="file" id="pdfInput" accept=".pdf" />
      <iframe id="pdfFrame"></iframe>
      <button onclick="togglePDFViewer()" style="background: #ff4444; margin-top: 10px;">CLOSE</button>
    </div>

    <div id="fireBox">🧙</div>
    <div id="aiPopup">
      <iframe src="https://www.chatbase.co/chatbot-iframe/3dSdpryiYZlWipHUL8dNK" frameBorder="0"></iframe>
    </div>

    <audio id="focusAudio" preload="none" src="https://the-chosen-one-o5.github.io/UltraFocusModeYT/focus.mp3"></audio>
    <audio id="lofiAudio" preload="none" loop></audio>
  </div>

  <script>
    ;(() => {
      let currentVideoIndex = 0
      let player
      let videoIds = []
      let isFocusModeActive = false
      let countdownInterval
      let distractionCount = 0
      let points = 0
      let isSignedIn = false
      let currentUser = null
      const focusDuration = 50 * 60 * 1000
      const firstBreakDuration = 15 * 60 * 1000
      const secondBreakDuration = 10 * 60 * 1000
      let timerMode = "Focus Time"
      let timerRemaining = focusDuration / 1000
      let completedVideos = new Set()
      let allVideosCompleted = false
      let totalFocusTime = 0
      let totalDistractions = 0
      let totalVideosWatched = 0
      let playlists = JSON.parse(localStorage.getItem("playlists") || "[]")
      let tasks = JSON.parse(localStorage.getItem("tasks") || "[]")
      let previousPoints = 0
      let streakDays = 0
      let lastFocusDate = null

      let isYouTubeAPILoaded = false
      let lofiAudio
      const lofiSongs = [
        "https://www.dropbox.com/scl/fi/7qrgbk6vpej7x0ih7vev2/1-6_XRwBX7NX-1.mp3?rlkey=m3gntnys7az2hoq0iokkajucj&st=bmrhzjy8&dl=1",
        "https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1",
        "https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1",
        "https://www.dropbox.com/scl/fi/lb5f47widcz8mwhg79jiz/Kate-Grove-SKYRIM-THEME-skyrim-elderscrolls-ocarina.mp3?rlkey=f8kpm1ipyowc1wv998myu06us&st=bm9qmodf&dl=1",
        "https://www.dropbox.com/scl/fi/8wf64nv0rwubt7hbs5x20/Kurate-Music-Best-of-Gibran-Alcocer-Beautiful-Piano-Mix.mp3?rlkey=i776feuxag0ebullqe0kjo0gp&st=bb3uyo3h&dl=1",
        "https://www.dropbox.com/scl/fi/7xoemzmrgq0wzbxc9i9tp/Jumping-_brick-Sidewalks-and-skeletons-goth-slowed-reverb-best-part-loop.mp3?rlkey=d4dt6rv6sdzteextqek29geug&st=4umnyp0c&dl=1",
        "https://www.dropbox.com/scl/fi/macw47c2kvur0yfi4r9up/St3phen-If-Youre-A-Gamer-This-Song-FOUND-You.mp3?rlkey=qudky54311tppavhvnpra89ff&st=7dgshk5k&dl=1",
        "https://www.dropbox.com/scl/fi/c1iy5yjmf3d57jrb1aokc/KestrelTapes-what-nostalgia-sounds-like...mp3?rlkey=qcdj1vpdnzwdb03fxp0vk0661&st=fyqrl6ge&dl=1",
        "https://www.dropbox.com/scl/fi/p303xk68pvu8sfrmtwzj2/rhawn-there-is-hopecore.mp3?rlkey=m6tva7g4dsva39ii1l0e8tnu0&st=6z218pii&dl=1",
        "https://www.dropbox.com/scl/fi/bw4n0ne8nli4dkp7p26po/Jaob-not-just-another-hopecore-playlist.mp3?rlkey=jy0umwkadkxj9cju1yf2wz7hw&st=yjxhzw0s&dl=1",
        "https://www.dropbox.com/scl/fi/evhrjdri6a9n9bk05qhcu/Kyle-Dixon-Michael-Stei-Kids.mp3?rlkey=lauo50rz3indg5n3to5gfks1y&st=gcqmonsf&dl=1",
      ]
      let currentLofiIndex = 0

      const achievementLevels = [
        { points: 0, level: "Mortal", color: "white" },
        { points: 1000, level: "Soldier", color: "#4169E1" },
        { points: 2000, level: "Knight", color: "white", glow: true },
        { points: 3000, level: "KING", color: "#FF8C00", glow: true },
        { points: 4000, level: "GIGACHAD", color: "#FF4500", glow: true },
        { points: 5000, level: "Demigod", color: "gold", glow: true },
        { points: 6000, level: "Titan", color: "gold", glow: true, box: true },
        { points: 7000, level: "Immortal", color: "gold", glow: true, box: true, boxGlow: true },
        { points: 8000, level: "Celestial", color: "gold", glow: true, box: true, boxGlow: true },
        { points: 9000, level: "Divine", color: "rainbow" },
        { points: 10000, level: "Omnipotent", color: "rainbow", glow: true },
      ]

      function initAudio() {
        lofiAudio = document.getElementById("lofiAudio")
        if (lofiAudio) lofiAudio.src = lofiSongs[currentLofiIndex]
      }

      function getAchievementLevel(points) {
        let currentLevel = achievementLevels[0]
        for (const level of achievementLevels) {
          if (points >= level.points) currentLevel = level
          else break
        }
        return currentLevel
      }

      function updateAchievementLevel() {
        const achievementDiv = document.getElementById("achievementLevel")
        if (!achievementDiv) return

        const level = getAchievementLevel(points)
        let style = `color: ${level.color}; font-weight: bold;`
        if (level.glow) style += " text-shadow: 0 0 10px;"
        if (level.box) style += " border: 2px solid gold; padding: 5px;"
        if (level.boxGlow) style += " box-shadow: 0 0 10px gold;"
        if (level.color === "rainbow") achievementDiv.classList.add("rainbow")
        else achievementDiv.classList.remove("rainbow")
        achievementDiv.innerHTML = level.level
        achievementDiv.style = style
        updateSidebarDashboard()
      }

      function showAchievementOverlay(level) {
        const overlay = document.getElementById("achievementOverlay")
        if (!overlay) return

        overlay.textContent = `LEVEL UP! ${level.toUpperCase()} UNLOCKED!`
        overlay.style.display = "flex"
        setTimeout(() => overlay.style.display = "none", 5000)
      }

      function updateClock() {
        const clockDisplay = document.getElementById("clockDisplay")
        if (!clockDisplay) return

        const now = new Date()
        let hours = now.getHours()
        const minutes = now.getMinutes().toString().padStart(2, "0")
        const seconds = now.getSeconds().toString().padStart(2, "0")
        const period = hours >= 12 ? "PM" : "AM"
        hours = hours % 12 || 12
        hours = hours.toString().padStart(2, "0")
        clockDisplay.innerHTML = `<span class="time">${hours}:${minutes}:${seconds}</span> <span class="period">${period}</span>`
      }

      function playLofi() {
        if (!lofiAudio) return
        lofiAudio.play().catch((err) => console.error("Lofi play error:", err))
      }

      function pauseLofi() {
        if (!lofiAudio) return
        lofiAudio.pause()
      }

      function prevLofi() {
        if (!lofiAudio) return
        currentLofiIndex = (currentLofiIndex - 1 + lofiSongs.length) % lofiSongs.length
        lofiAudio.src = lofiSongs[currentLofiIndex]
        playLofi()
      }

      function nextLofi() {
        if (!lofiAudio) return
        currentLofiIndex = (currentLofiIndex + 1) % lofiSongs.length
        lofiAudio.src = lofiSongs[currentLofiIndex]
        playLofi()
      }

      function toggleSitesPopup() {
        const popup = document.getElementById("sitesPopup")
        if (!popup) return
        popup.style.display = popup.style.display === "block" ? "none" : "block"
      }

      function closeSitesPopup() {
        const popup = document.getElementById("sitesPopup")
        if (!popup) return
        popup.style.display = "none"
      }

      function updateStreak() {
        const streakDisplay = document.getElementById("streakDisplay")
        if (!streakDisplay) return

        const today = new Date().toDateString()
        const lastDate = localStorage.getItem("lastFocusDate")

        if (lastDate) {
          const last = new Date(lastDate)
          const diffTime = new Date(today) - last
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))

          if (diffDays === 1) streakDays++
          else if (diffDays > 1) streakDays = 1
        } else streakDays = 1

        localStorage.setItem("lastFocusDate", today)
        streakDisplay.innerHTML = `<span style="color: #8e2de2;">🔥</span> ${streakDays} day${streakDays === 1 ? "" : "s"} of focus`

        if (isSignedIn && currentUser) {
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          users[currentUser].streakDays = streakDays
          localStorage.setItem("users", JSON.stringify(users))
        }

        const sidebarStreak = document.getElementById("sidebarStreak")
        if (sidebarStreak) sidebarStreak.textContent = `${streakDays} day${streakDays === 1 ? "" : "s"}`
      }

      function loadSavedState() {
        try {
          const savedState = localStorage.getItem("focusModeState")
          if (savedState) {
            const progressBar = document.getElementById("progressBar")
            if (progressBar) progressBar.style.display = "none"

            const state = JSON.parse(savedState)
            videoIds = state.videoIds || []
            currentVideoIndex = state.currentVideoIndex || 0
            distractionCount = state.distractionCount || 0
            points = state.points || 0
            timerMode = state.timerMode || "Focus Time"
            timerRemaining = state.timerRemaining || focusDuration / 1000
            isFocusModeActive = state.isFocusModeActive || false
            isSignedIn = state.isSignedIn || false
            currentUser = state.currentUser || null
            completedVideos = new Set(state.completedVideos || [])
            allVideosCompleted = state.allVideosCompleted || false
            totalFocusTime = state.totalFocusTime || 0
            totalDistractions = state.totalDistractions || 0
            totalVideosWatched = state.totalVideosWatched || 0
            streakDays = state.streakDays || 0
            lastFocusDate = state.lastFocusDate || null

            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            if (isSignedIn && currentUser) {
              document.getElementById("landingPage").style.display = "none"
              document.getElementById("signinForm").style.display = "none"
              document.getElementById("inputForm").style.display = "block"
              document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`
              document.getElementById("clockDisplay").style.display = "block"
              document.getElementById("sitesBox").style.display = "block"
              document.getElementById("lofiPlayer").style.display = "block"
              restoreUrlInputs()
              populatePlaylistSelect()
              restoreTasks()
            }
            if (videoIds.length > 0) {
              document.getElementById("inputForm").style.display = "none"
              document.getElementById("player").style.display = "block"
              document.getElementById("restartBtn").style.display = "block"
              document.getElementById("pdfToggle").style.display = "block"
              document.getElementById("clockDisplay").style.display = "none"
              document.getElementById("sitesBox").style.display = "none"
              document.getElementById("lofiPlayer").style.display = "none"
              loadYouTubeAPI()
                .then(() => {
                  setupYouTubePlayer()
                  if (isFocusModeActive) startTimer(timerRemaining * 1000, timerMode)
                })
                .catch((err) => console.error("YouTube API load failed:", err))
            }
          } else {
            document.getElementById("landingPage").style.display = "block"
            document.getElementById("signinForm").style.display = "none"
            document.getElementById("inputForm").style.display = "none"
            document.getElementById("clockDisplay").style.display = "none"
            document.getElementById("sitesBox").style.display = "none"
            document.getElementById("lofiPlayer").style.display = "none"
            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            restoreTasks()
          }
        } catch (err) {
          console.error("Load saved state error:", err)
        }
      }

      function redirectToPYQs() {
        window.open("https://room.examgoal.com/", "_blank")
      }

      function showSignIn() {
        document.getElementById("landingPage").style.display = "none"
        document.getElementById("signinForm").style.display = "block"
        document.getElementById("inputForm").style.display = "none"
        document.getElementById("clockDisplay").style.display = "none"
        document.getElementById("sitesBox").style.display = "none"
        document.getElementById("lofiPlayer").style.display = "none"
      }

      function signIn() {
        try {
          const username = document.getElementById("username").value
          const password = document.getElementById("password").value
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          if (users[username] && users[username].password === password) {
            isSignedIn = true
            currentUser = username
            points = users[username].points || 0
            totalFocusTime = users[username].totalFocusTime || 0
            totalDistractions = users[username].totalDistractions || 0
            totalVideosWatched = users[username].totalVideosWatched || 0
            tasks = users[username].tasks || []
            streakDays = users[username].streakDays || 0
            document.getElementById("landingPage").style.display = "none"
            document.getElementById("signinForm").style.display = "none"
            document.getElementById("inputForm").style.display = "block"
            document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`
            document.getElementById("clockDisplay").style.display = "block"
            document.getElementById("sitesBox").style.display = "block"
            document.getElementById("lofiPlayer").style.display = "block"
            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            saveState()
            populatePlaylistSelect()
            restoreTasks()
            updateSidebarDashboard()
          } else alert("Invalid username or password")
        } catch (err) {
          console.error("Sign-in error:", err)
          alert("Error during sign-in. Please try again.")
        }
      }

      function createAccount() {
        try {
          const username = document.getElementById("username").value
          const password = document.getElementById("password").value
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          if (users[username]) alert("Username already exists")
          else if (username && password) {
            users[username] = {
              password,
              points: 0,
              totalFocusTime: 0,
              totalDistractions: 0,
              totalVideosWatched: 0,
              tasks: [],
              streakDays: 0,
            }
            localStorage.setItem("users", JSON.stringify(users))
            isSignedIn = true
            currentUser = username
            points = 0
            totalFocusTime = 0
            totalDistractions = 0
            totalVideosWatched = 0
            tasks = []
            streakDays = 0
            document.getElementById("landingPage").style.display = "none"
            document.getElementById("signinForm").style.display = "none"
            document.getElementById("inputForm").style.display = "block"
            document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`
            document.getElementById("clockDisplay").style.display = "block"
            document.getElementById("sitesBox").style.display = "block"
            document.getElementById("lofiPlayer").style.display = "block"
            updateAnalytics()
            updateAchievementLevel()
            updateStreak()
            saveState()
            populatePlaylistSelect()
            restoreTasks()
            updateSidebarDashboard()
          } else alert("Please enter a username and password")
        } catch (err) {
          console.error("Account creation error:", err)
          alert("Error creating account. Please try again.")
        }
      }

      function addUrlInput() {
        const urlInputs = document.getElementById("urlInputs")
        if (!urlInputs) return

        const container = document.createElement("div")
        container.className = "url-container"
        const newInput = document.createElement("input")
        newInput.type = "text"
        newInput.className = "youtube-url"
        newInput.placeholder = "YouTube URL (Videos or Live Streams)"
        const removeBtn = document.createElement("button")
        removeBtn.textContent = "X"
        removeBtn.onclick = () => {
          if (urlInputs.children.length > 1) urlInputs.removeChild(container)
        }
        container.appendChild(newInput)
        container.appendChild(removeBtn)
        urlInputs.appendChild(container)
      }

      function restoreUrlInputs() {
        const urlInputs = document.getElementById("urlInputs")
        if (!urlInputs) return

        urlInputs.innerHTML = ""
        videoIds.forEach((id, index) => {
          const container = document.createElement("div")
          container.className = "url-container"
          const input = document.createElement("input")
          input.type = "text"
          input.className = "youtube-url"
          input.placeholder = "YouTube URL (Videos or Live Streams)"
          input.value = `https://www.youtube.com/watch?v=${id}`
          container.appendChild(input)
          if (index > 0) {
            const removeBtn = document.createElement("button")
            removeBtn.textContent = "X"
            removeBtn.onclick = () => {
              if (urlInputs.children.length > 1) urlInputs.removeChild(container)
            }
            container.appendChild(removeBtn)
          }
          urlInputs.appendChild(container)
        })
        if (videoIds.length === 0) {
          const container = document.createElement("div")
          container.className = "url-container"
          const input = document.createElement("input")
          input.type = "text"
          input.className = "youtube-url"
          input.placeholder = "YouTube URL (Videos or Live Streams)"
          input.required = true
          container.appendChild(input)
          urlInputs.appendChild(container)
        }
      }

      function addTaskLine() {
        const tasksDiv = document.getElementById("tasks")
        if (!tasksDiv) return null

        const container = document.createElement("div")
        container.className = "task-line"
        const checkbox = document.createElement("input")
        checkbox.type = "checkbox"
        checkbox.className = "task-check"
        checkbox.onchange = () => saveTasks()
        const input = document.createElement("input")
        input.type = "text"
        input.className = "task-text"
        input.placeholder = "Write a task..."
        input.onkeydown = (e) => {
          if (e.key === "Enter") {
            e.preventDefault()
            const newInput = addTaskLine()
            if (newInput) newInput.focus()
          }
        }
        input.onchange = () => saveTasks()
        const removeBtn = document.createElement("span")
        removeBtn.className = "remove-task"
        removeBtn.textContent = "x"
        removeBtn.onclick = () => removeTask(removeBtn)
        container.appendChild(checkbox)
        container.appendChild(input)
        container.appendChild(removeBtn)
        tasksDiv.appendChild(container)
        return input
      }

      function removeTask(element) {
        const tasksDiv = document.getElementById("tasks")
        if (!tasksDiv || !element || !element.parentElement) return

        if (tasksDiv.children.length > 1) {
          tasksDiv.removeChild(element.parentElement)
          saveTasks()
        }
      }

      function restoreTasks() {
        const tasksDiv = document.getElementById("tasks")
        if (!tasksDiv) return

        tasksDiv.innerHTML = ""
        if (tasks.length === 0) addTaskLine()
        else {
          tasks.forEach((task) => {
            const input = addTaskLine()
            if (input) {
              input.value = task.text
              input.previousElementSibling.checked = task.completed
            }
          })
        }
      }

      function saveTasks() {
        const taskLines = document.querySelectorAll(".task-line")
        if (!taskLines.length) return

        tasks = Array.from(taskLines)
          .map((line) => {
            const checkbox = line.querySelector(".task-check")
            const input = line.querySelector(".task-text")
            return {
              text: input ? input.value.trim() : "",
              completed: checkbox ? checkbox.checked : false,
            }
          })
          .filter((task) => task.text !== "")
        localStorage.setItem("tasks", JSON.stringify(tasks))
        if (isSignedIn && currentUser) {
          const users = JSON.parse(localStorage.getItem("users") || "{}")
          users[currentUser].tasks = tasks
          localStorage.setItem("users", JSON.stringify(users))
        }
      }

      function toggleTodo() {
        const todoList = document.getElementById("todoList")
        if (!todoList) return
        todoList.style.display = todoList.style.display === "block" ? "none" : "block"
      }

      function extractVideoId(url) {
        try {
          let videoId = null
          const urlObj = new URL(url)
          const hostname = urlObj.hostname.toLowerCase()
          const pathname = urlObj.pathname

          if (hostname.includes("youtube.com")) {
            if (pathname.startsWith("/watch")) videoId = urlObj.searchParams.get("v")
            else if (pathname.startsWith("/live")) videoId = pathname.split("/live/")[1]?.split("/")[0] || pathname.split("/live/")[1]
          } else if (hostname.includes("youtu.be")) videoId = pathname.substring(1)

          if (videoId && videoId.length === 11) return videoId
          throw new Error("Invalid YouTube URL")
        } catch (e) {
          console.error("Invalid URL:", url, e)
          return null
        }
      }

      function startPlayback() {
        try {
          const urlInputs = document.querySelectorAll(".youtube-url")
          if (!urlInputs.length) return

          const urls = Array.from(urlInputs).map((input) => input.value.trim()).filter((url) => url !== "")
          videoIds = urls.map(extractVideoId).filter((id) => id !== null)

          if (videoIds.length === 0) {
            alert("Please enter at least one valid YouTube URL (videos or live streams)")
            return
          }

          document.getElementById("inputForm").style.display = "none"
          document.getElementById("player").style.display = "block"
          document.getElementById("restartBtn").style.display = "block"
          document.getElementById("pdfToggle").style.display = "block"
          document.getElementById("clockDisplay").style.display = "none"
          document.getElementById("sitesBox").style.display = "none"
          document.getElementById("lofiPlayer").style.display = "none"
          pauseLofi()
          populateVideoSidebar()
          loadYouTubeAPI()
            .then(() => {
              setupYouTubePlayer()
              enterFullscreen()
              startFocusBreakLoop()
              saveState()
            })
            .catch((err) => {
              console.error("Playback start error:", err)
              alert("Failed to start video playback. Please check your connection and try again.")
              resetFocusMode()
            })

          alert('Note: Use "T" to toggle video sidebar. Live streams won\'t auto-advance.')
        } catch (err) {
          console.error("Start playback error:", err)
          alert("An error occurred starting Focus Mode. Please try again.")
        }
      }

      let YT

      function loadYouTubeAPI() {
        return new Promise((resolve, reject) => {
          if (window.YT && window.YT.Player) {
            YT = window.YT
            isYouTubeAPILoaded = true
            resolve()
            return
          }
          const tag = document.createElement("script")
          tag.src = "https://www.youtube.com/iframe_api"
          tag.async = true
          tag.onload = () => {
            isYouTubeAPILoaded = true
            window.onYouTubeIframeAPIReady = () => {
              YT = window.YT
              resolve()
            }
          }
          tag.onerror = () => reject(new Error("Failed to load YouTube API"))
          document.body.appendChild(tag)
        })
      }

      function setupYouTubePlayer() {
        try {
          if (player) player.destroy()
          player = new YT.Player("player", {
            height: "100%",
            width: "100%",
            videoId: videoIds[currentVideoIndex],
            playerVars: { autoplay: 1, controls: 1, modestbranding: 1, rel: 0, fs: 1 },
            events: {
              onReady: onPlayerReady,
              onStateChange: (event) => {
                try {
                  if (event.data === YT.PlayerState.ENDED) {
                    completedVideos.add(videoIds[currentVideoIndex])
                    totalVideosWatched++
                    if (completedVideos.size === videoIds.length && !allVideosCompleted && isSignedIn) {
                      points += 150
                      document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`
                      alert("Incredible! +150 points for completing the entire playlist!")
                      allVideosCompleted = true
                    }
                    updateAnalytics()
                    saveState()
                    currentVideoIndex = (currentVideoIndex + 1) % videoIds.length
                    player.loadVideoById(videoIds[currentVideoIndex])
                  } else if (event.data === YT.PlayerState.PLAYING) {
                    document.getElementById("progressBar").style.display = "block"
                  } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.BUFFERING) {
                    document.getElementById("progressBar").style.display = "none"
                  }
                } catch (err) {
                  console.error("Player state change error:", err)
                }
              },
              onError: (event) => {
                console.error("YouTube Player Error:", event.data)
                alert("Error loading video. Trying next video...")
                currentVideoIndex = (currentVideoIndex + 1) % videoIds.length
                player.loadVideoById(videoIds[currentVideoIndex])
              },
            },
          })
        } catch (err) {
          console.error("Player setup error:", err)
          alert("Failed to set up video player. Please try again.")
        }
      }

      function savePlaylist() {
        try {
          const playlistNameInput = document.getElementById("playlistName")
          if (!playlistNameInput) return

          const playlistName = playlistNameInput.value.trim()
          if (!playlistName) {
            alert("Please enter a playlist name")
            return
          }
          const urlInputs = document.querySelectorAll(".youtube-url")
          const urls = Array.from(urlInputs).map((input) => input.value.trim()).filter((url) => url !== "")
          const videoIdsForPlaylist = urls.map(extractVideoId).filter((id) => id !== null)
          if (videoIdsForPlaylist.length === 0) {
            alert("Please enter at least one valid YouTube URL to save a playlist")
            return
          }
          playlists = playlists.filter((p) => p.name !== playlistName)
          playlists.push({ name: playlistName, videoIds: videoIdsForPlaylist })
          localStorage.setItem("playlists", JSON.stringify(playlists))
          populatePlaylistSelect()
          alert(`Playlist "${playlistName}" saved!`)
          playlistNameInput.value = ""
        } catch (err) {
          console.error("Save playlist error:", err)
          alert("Error saving playlist. Please try again.")
        }
      }

      function removePlaylist() {
        try {
          const playlistSelect = document.getElementById("playlistSelect")
          if (!playlistSelect) return

          const playlistName = playlistSelect.value
          if (!playlistName) {
            alert("Please select a playlist to remove")
            return
          }
          if (confirm(`Are you sure you want to remove "${playlistName}" playlist?`)) {
            playlists = playlists.filter((p) => p.name !== playlistName)
            localStorage.setItem("playlists", JSON.stringify(playlists))
            populatePlaylistSelect()
            playlistSelect.value = ""
            alert(`Playlist "${playlistName}" removed!`)
          }
        } catch (err) {
          console.error("Remove playlist error:", err)
          alert("Error removing playlist. Please try again.")
        }
      }

      function populatePlaylistSelect() {
        const select = document.getElementById("playlistSelect")
        if (!select) return

        select.innerHTML = '<option value="">Select a Playlist</option>'
        playlists.forEach((playlist) => {
          const option = document.createElement("option")
          option.value = playlist.name
          option.textContent = playlist.name
          select.appendChild(option)
        })
      }

      function loadPlaylist() {
        try {
          const playlistSelect = document.getElementById("playlistSelect")
          if (!playlistSelect) return

          const playlistName = playlistSelect.value
          if (!playlistName) return
          const playlist = playlists.find((p) => p.name === playlistName)
          if (playlist) {
            videoIds = playlist.videoIds
            restoreUrlInputs()
          }
        } catch (err) {
          console.error("Load playlist error:", err)
          alert("Error loading playlist. Please try again.")
        }
      }

      function updateAnalytics() {
        const totalFocusTimeEl = document.getElementById("totalFocusTime")
        const totalDistractionsEl = document.getElementById("totalDistractions")
        const totalVideosWatchedEl = document.getElementById("totalVideosWatched")

        if (totalFocusTimeEl) totalFocusTimeEl.textContent = totalFocusTime
        if (totalDistractionsEl) totalDistractionsEl.textContent = totalDistractions
        if (totalVideosWatchedEl) totalVideosWatchedEl.textContent = totalVideosWatched

        const currentLevel = Math.floor(points / 1000)
        const previousLevel = Math.floor(previousPoints / 1000)
        if (currentLevel > previousLevel) showAchievementOverlay(getAchievementLevel(points).level)
        previousPoints = points
        updateAchievementLevel()
      }

      function toggleStats() {
        const analytics = document.getElementById("analytics")
        if (!analytics) return
        if (analytics.style.display === "block") analytics.style.display = "none"
        else {
          updateAnalytics()
          analytics.style.display = "block"
        }
      }

      function saveState() {
        try {
          const timerText = document.getElementById("timerText")
          if (!timerText) return

          const timerTextContent = timerText.textContent || ""
          const timerMatch = timerTextContent.match(/^(.*?): (\d+) min (\d+) sec$/)
          let remaining = timerRemaining
          let mode = timerMode
          if (timerMatch) {
            mode = timerMatch[1]
            remaining = Number.parseInt(timerMatch[2]) * 60 + Number.parseInt(timerMatch[3])
          }
          const state = {
            videoIds,
            currentVideoIndex,
            distractionCount,
            points,
            timerMode: mode,
            timerRemaining: remaining,
            isFocusModeActive,
            isSignedIn,
            currentUser,
            completedVideos: Array.from(completedVideos),
            allVideosCompleted,
            totalFocusTime,
            totalDistractions,
            totalVideosWatched,
            streakDays,
            lastFocusDate: localStorage.getItem("lastFocusDate"),
            isMinimized: timerText.style.display === "none",
          }
          localStorage.setItem("focusModeState", JSON.stringify(state))
          if (isSignedIn && currentUser) {
            const users = JSON.parse(localStorage.getItem("users") || "{}")
            users[currentUser].points = points
            users[currentUser].totalFocusTime = totalFocusTime
            users[currentUser].totalDistractions = totalDistractions
            users[currentUser].totalVideosWatched = totalVideosWatched
            users[currentUser].tasks = tasks
            users[currentUser].streakDays = streakDays
            localStorage.setItem("users", JSON.stringify(users))
          }
        } catch (err) {
          console.error("Save state error:", err)
        }
      }

      function populateVideoSidebar() {
        const videoSidebar = document.getElementById("videoSidebar")
        if (!videoSidebar) return

        videoSidebar.innerHTML = videoIds
          .map(
            (id, index) =>
              `<img class="thumbnail" src="https://img.youtube.com/vi/${id}/0.jpg" onclick="changeVideo('${id}', ${index})" alt="Video ${index + 1}" loading="lazy">`,
          )
          .join("")
      }

      function changeVideo(videoId, index) {
        currentVideoIndex = index
        if (player) player.loadVideoById(videoId)
        const videoSidebar = document.getElementById("videoSidebar")
        if (videoSidebar) videoSidebar.style.right = "-320px"
        saveState()
      }

      function startFocusBreakLoop() {
        isFocusModeActive = true
        timerMode = "Focus Time"
        timerRemaining = focusDuration / 1000
        distractionCount = 0
        startTimer(focusDuration, timerMode)

        setTimeout(() => {
          isFocusModeActive = false
          totalFocusTime += 50
          if (isSignedIn && distractionCount === 0) {
            points += 80
            document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`
            alert("Great job! +80 points for a distraction-free session!")
          }
          updateAnalytics()
          updateStreak()
          saveState()
          timerMode = "Break Time"
          timerRemaining = firstBreakDuration / 1000
          startTimer(firstBreakDuration, timerMode)
          alert("Break time! Enjoy 15 minutes.")

          setTimeout(() => {
            isFocusModeActive = true
            timerMode = "Focus Time"
            timerRemaining = focusDuration / 1000
            distractionCount = 0
            startTimer(focusDuration, timerMode)

            setTimeout(() => {
              isFocusModeActive = false
              totalFocusTime += 50
              if (isSignedIn && distractionCount === 0) {
                points += 80
                document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: ${points}`
    alert("Great job! +80 points for a distraction-free session!")
  }
  updateAnalytics()
  updateStreak()
  saveState()
  timerMode = "Short Break"
  timerRemaining = secondBreakDuration / 1000
  startTimer(secondBreakDuration, timerMode)
  alert("Short break! Take 10 minutes.")

  setTimeout(() => {
    startFocusBreakLoop() // Restart the cycle
  }, secondBreakDuration)
}, focusDuration)
}, firstBreakDuration)
}, focusDuration)
}

function startTimer(duration, mode) {
try {
  clearInterval(countdownInterval)
  const timerDisplay = document.getElementById("timerText")
  const progressFill = document.getElementById("progressFill")
  if (!timerDisplay || !progressFill) return

  let timeLeft = duration / 1000
  timerRemaining = timeLeft
  const totalTime = duration / 1000

  timerDisplay.textContent = `${mode}: ${Math.floor(timeLeft / 60)} min ${Math.floor(timeLeft % 60)} sec`
  
  countdownInterval = setInterval(() => {
    timeLeft--
    timerRemaining = timeLeft
    timerDisplay.textContent = `${mode}: ${Math.floor(timeLeft / 60)} min ${Math.floor(timeLeft % 60)} sec`
    
    const progress = ((totalTime - timeLeft) / totalTime) * 100
    progressFill.style.width = `${progress}%`

    if (timeLeft <= 0) {
      clearInterval(countdownInterval)
      progressFill.style.width = "0%"
    }
    saveState()
  }, 1000)

  const focusAudio = document.getElementById("focusAudio")
  if (focusAudio && mode === "Focus Time") focusAudio.play().catch((err) => console.error("Audio play error:", err))
} catch (err) {
  console.error("Timer start error:", err)
}
}

function onPlayerReady(event) {
try {
  event.target.playVideo()
} catch (err) {
  console.error("Player ready error:", err)
}
}

function enterFullscreen() {
try {
  const playerContainer = document.getElementById("player")
  if (!playerContainer) return

  if (playerContainer.requestFullscreen) playerContainer.requestFullscreen()
  else if (playerContainer.mozRequestFullScreen) playerContainer.mozRequestFullScreen()
  else if (playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen()
  else if (playerContainer.msRequestFullscreen) playerContainer.msRequestFullscreen()
} catch (err) {
  console.error("Fullscreen error:", err)
}
}

function toggleVideoSidebar() {
const videoSidebar = document.getElementById("videoSidebar")
if (!videoSidebar) return
videoSidebar.style.right = videoSidebar.style.right === "0px" ? "-320px" : "0px"
}

function togglePDFViewer() {
const pdfViewer = document.getElementById("pdfViewer")
const pdfToggle = document.getElementById("pdfToggle")
if (!pdfViewer || !pdfToggle) return

if (pdfViewer.style.display === "block") {
  pdfViewer.style.display = "none"
  pdfToggle.style.display = "block"
} else {
  pdfViewer.style.display = "block"
  pdfToggle.style.display = "none"
}
}

function toggleAIPopup() {
const aiPopup = document.getElementById("aiPopup")
if (!aiPopup) return
aiPopup.style.display = aiPopup.style.display === "block" ? "none" : "block"
}

function resetFocusMode() {
try {
  clearInterval(countdownInterval)
  if (player) player.stopVideo()
  document.getElementById("player").style.display = "none"
  document.getElementById("restartBtn").style.display = "none"
  document.getElementById("pdfToggle").style.display = "none"
  document.getElementById("inputForm").style.display = "block"
  document.getElementById("clockDisplay").style.display = "block"
  document.getElementById("sitesBox").style.display = "block"
  document.getElementById("lofiPlayer").style.display = "block"
  isFocusModeActive = false
  timerRemaining = focusDuration / 1000
  timerMode = "Focus Time"
  const timerText = document.getElementById("timerText")
  if (timerText) timerText.style.display = "inline"
  const progressBar = document.getElementById("progressBar")
  if (progressBar) progressBar.style.display = "none"
  document.getElementById("videoSidebar").style.right = "-320px"
  saveState()
  totalDistractions += distractionCount
  updateAnalytics()
} catch (err) {
  console.error("Reset focus mode error:", err)
}
}

function confirmRestart() {
const dialog = document.getElementById("confirmationDialog")
if (!dialog) return
dialog.style.display = "block"
}

function handleConfirm() {
const dialog = document.getElementById("confirmationDialog")
if (!dialog) return
dialog.style.display = "none"
resetFocusMode()
}

function handleCancel() {
const dialog = document.getElementById("confirmationDialog")
if (!dialog) return
dialog.style.display = "none"
}

function logout() {
try {
  isSignedIn = false
  currentUser = null
  points = 0
  totalFocusTime = 0
  totalDistractions = 0
  totalVideosWatched = 0
  tasks = []
  streakDays = 0
  videoIds = []
  currentVideoIndex = 0
  distractionCount = 0
  isFocusModeActive = false
  timerMode = "Focus Time"
  timerRemaining = focusDuration / 1000
  completedVideos.clear()
  allVideosCompleted = false
  clearInterval(countdownInterval)
  if (player) player.destroy()
  document.getElementById("landingPage").style.display = "block"
  document.getElementById("signinForm").style.display = "none"
  document.getElementById("inputForm").style.display = "none"
  document.getElementById("player").style.display = "none"
  document.getElementById("restartBtn").style.display = "none"
  document.getElementById("pdfToggle").style.display = "none"
  document.getElementById("clockDisplay").style.display = "none"
  document.getElementById("sitesBox").style.display = "none"
  document.getElementById("lofiPlayer").style.display = "none"
  document.getElementById("pointsDisplay").innerHTML = `<span style="color: #8e2de2;">⭐</span> XP: 0`
  document.getElementById("videoSidebar").style.right = "-320px"
  localStorage.removeItem("focusModeState")
  updateAnalytics()
  updateAchievementLevel()
  updateStreak()
  restoreUrlInputs()
  restoreTasks()
  updateSidebarDashboard()
} catch (err) {
  console.error("Logout error:", err)
}
}

function updateSidebarDashboard() {
const sidebarUsername = document.getElementById("sidebarUsername")
const sidebarLevel = document.getElementById("sidebarLevel")
const sidebarXP = document.getElementById("sidebarXP")
const sidebarStreak = document.getElementById("sidebarStreak")

if (sidebarUsername) sidebarUsername.textContent = currentUser || "Guest"
if (sidebarLevel) sidebarLevel.textContent = getAchievementLevel(points).level
if (sidebarXP) sidebarXP.textContent = points
if (sidebarStreak) sidebarStreak.textContent = `${streakDays} day${streakDays === 1 ? "" : "s"}`
}

// Event Listeners with Delegation
document.addEventListener("click", (e) => {
const action = e.target.getAttribute("data-action")
if (!action) return

switch (action) {
  case "start-game":
    showSignIn()
    break
  case "github":
    window.open("https://github.com/The-Chosen-One-o5/UltraFocusModeYT", "_blank")
    break
  case "sign-in":
    signIn()
    break
  case "create-account":
    createAccount()
    break
  case "add-url":
    addUrlInput()
    break
  case "start-playback":
    startPlayback()
    break
  case "save-playlist":
    savePlaylist()
    break
  case "remove-playlist":
    removePlaylist()
    break
  case "save-tasks":
    saveTasks()
    break
}
})

document.getElementById("restartBtn")?.addEventListener("click", confirmRestart)
document.getElementById("confirmBtn")?.addEventListener("click", handleConfirm)
document.getElementById("cancelBtn")?.addEventListener("click", handleCancel)
document.getElementById("sitesBox")?.addEventListener("click", toggleSitesPopup)
document.getElementById("closeSitesPopup")?.addEventListener("click", closeSitesPopup)
document.getElementById("lofiPlay")?.addEventListener("click", playLofi)
document.getElementById("lofiPause")?.addEventListener("click", pauseLofi)
document.getElementById("lofiPrev")?.addEventListener("click", prevLofi)
document.getElementById("lofiNext")?.addEventListener("click", nextLofi)
document.getElementById("statsBtn")?.addEventListener("click", toggleStats)
document.getElementById("todoBtn")?.addEventListener("click", toggleTodo)
document.getElementById("pyqBtn")?.addEventListener("click", redirectToPYQs)
document.getElementById("logoutBtn")?.addEventListener("click", logout)
document.getElementById("fireBox")?.addEventListener("click", toggleAIPopup)
document.getElementById("pdfToggle")?.addEventListener("click", togglePDFViewer)

document.getElementById("minimizeBtn")?.addEventListener("click", () => {
const timerText = document.getElementById("timerText")
const progressBar = document.getElementById("progressBar")
if (!timerText || !progressBar) return

if (timerText.style.display === "none") {
  timerText.style.display = "inline"
  progressBar.style.display = "block"
} else {
  timerText.style.display = "none"
  progressBar.style.display = "none"
}
saveState()
})

document.getElementById("pdfInput")?.addEventListener("change", (e) => {
const file = e.target.files[0]
if (!file) return

const pdfFrame = document.getElementById("pdfFrame")
if (!pdfFrame) return

const url = URL.createObjectURL(file)
pdfFrame.src = url
})

document.getElementById("playlistSelect")?.addEventListener("change", loadPlaylist)

// Draggable Timer
let isDragging = false
let currentX
let currentY
let initialX
let initialY

const timerDisplay = document.getElementById("timerDisplay")
if (timerDisplay) {
timerDisplay.addEventListener("mousedown", (e) => {
  isDragging = true
  initialX = e.clientX - currentX
  initialY = e.clientY - currentY
})

document.addEventListener("mousemove", (e) => {
  if (isDragging) {
    e.preventDefault()
    currentX = e.clientX - initialX
    currentY = e.clientY - initialY
    timerDisplay.style.left = `${currentX}px`
    timerDisplay.style.top = `${currentY}px`
  }
})

document.addEventListener("mouseup", () => {
  isDragging = false
})

currentX = parseInt(window.getComputedStyle(timerDisplay).left) || 10
currentY = parseInt(window.getComputedStyle(timerDisplay).top) || 10
timerDisplay.style.left = `${currentX}px`
timerDisplay.style.top = `${currentY}px`
}

// Keyboard Shortcuts
document.addEventListener("keydown", (e) => {
if (e.key === "t" || e.key === "T") toggleVideoSidebar()
if (e.key === "Escape" && document.fullscreenElement) document.exitFullscreen()
})

// Distraction Detection
document.addEventListener("visibilitychange", () => {
if (document.hidden && isFocusModeActive) {
  distractionCount++
  totalDistractions++
  alert("Distraction detected! Stay focused!")
  saveState()
}
})

setInterval(updateClock, 1000)

// Initialization
initAudio()
loadSavedState()
setInterval(saveState, 30000) // Auto-save every 30 seconds

updateClock()
updateAchievementLevel()
updateStreak()
})();
</script>
</body>
</html>
