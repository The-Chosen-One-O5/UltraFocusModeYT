<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
    <title>Ultra Focus Mode</title>

    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <!-- End Favicon Links -->

    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4169e1; /* Royal Blue */
            --primary-dark: #1e3a8a; /* Darker Blue */
            --secondary: #8e2de2; /* Purple */
            --accent: #ff4500; /* OrangeRed */
            --accent-alt: #ff8c00; /* DarkOrange */
            --bg-dark: #0f0f1b; /* Very Dark Blue/Purple */
            --bg-medium: #1a1a2e; /* Dark Blue/Purple */
            --bg-light: #252538; /* Medium Dark Blue/Purple */
            --text: #e0e0ff; /* Light Lavender */
            --text-dim: #9090b0; /* Grayish Lavender */
            --gold: #ffd700;
            --success: #28a745; /* Green */
            --danger: #dc3545; /* Red */
            --info: #17a2b8; /* Teal */
            --warning: #ffc107; /* Yellow */
            --calendar-focus-low: rgba(65, 105, 225, 0.2);
            --calendar-focus-medium: rgba(65, 105, 225, 0.5);
            --calendar-focus-high: rgba(65, 105, 225, 0.8);
            --calendar-today-border: var(--accent);
            --timer-warning-color: var(--danger); /* Added for timer warning */
            --notification-badge-bg: var(--danger); /* Added for notification badge */
            --notification-badge-text: white; /* Added for notification badge text */
        }

        html {
            scrollbar-width: thin;
            scrollbar-color: var(--secondary) var(--bg-medium);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-medium);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 0;
            border: 2px solid var(--bg-medium);
        }

        body {
            background-color: var(--bg-dark);
            min-height: 100vh;
            font-family: 'Roboto Mono', monospace;
            color: var(--text);
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Game Container and Background */
        .game-container {
            width: 100%;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
            background-image: radial-gradient(circle at 10% 20%, rgba(142, 45, 226, 0.1) 0%, transparent 25%),
                            radial-gradient(circle at 90% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 25%),
                            linear-gradient(to bottom, var(--bg-dark) 0%, var(--bg-medium) 100%);
            display: flex;
            flex-direction: column; /* Stack nav and content */
            z-index: 1;
        }

        .game-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='8' height='8' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.04' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1h1z'/%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 2;
            opacity: 0.5;
        }

        /* Page/View Containers */
        .page-view {
            width: 100%;
            flex-grow: 1; /* Allow view to take remaining space */
            display: none; /* Hidden by default */
            flex-direction: column;
            padding: 20px;
            position: relative;
            z-index: 10;
            overflow-y: auto;
            pointer-events: auto;
        }

        /* Landing Page & Signin Form Styles */
        #landingPageContainer, #signinFormContainer {
            text-align: center;
            width: 100%;
            max-width: 700px;
            margin: auto;
            padding: 40px 30px;
            background-color: rgba(15, 15, 27, 0.85);
            border: 2px solid var(--secondary);
            border-radius: 12px;
            box-shadow: 0 0 25px rgba(142, 45, 226, 0.4);
            backdrop-filter: blur(4px);
            pointer-events: auto;
        }

         #landingPage, #signinForm {
             justify-content: center;
             align-items: center;
         }


        /* Titles and Subtitles */
        .title {
            font-family: 'Press Start 2P', cursive;
            font-size: 28px;
            font-weight: 400;
            color: var(--text);
            margin-bottom: 25px;
            text-shadow: 2px 2px 0px var(--primary-dark), 4px 4px 0px rgba(0,0,0,0.3);
            letter-spacing: 1px;
            line-height: 1.3;
        }

        .title span {
            color: var(--secondary);
            position: relative;
            display: inline-block;
        }

        .title span::after {
            content: "";
            position: absolute;
            bottom: -6px;
            left: 5%;
            width: 90%;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            opacity: 0.8;
        }

        .subtitle {
            font-size: 18px;
            color: var(--text-dim);
            margin-bottom: 35px;
            font-family: 'Roboto Mono', monospace;
        }

        /* Buttons */
        button {
            display: inline-block;
            padding: 10px 25px;
            font-size: 14px;
            font-family: 'Roboto Mono', monospace;
            font-weight: 600;
            background: var(--secondary);
            border: none;
            color: var(--text);
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 8px 15px;
            transition: all 0.2s ease-in-out;
            position: relative;
            box-shadow: 3px 3px 0 var(--primary-dark);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 11;
            pointer-events: auto;
            outline: none;
        }

        button:hover:not(:disabled) {
            background: var(--primary);
            transform: translate(1px, 1px);
            box-shadow: 2px 2px 0 var(--primary-dark);
        }

        button:active:not(:disabled) {
            transform: translate(3px, 3px);
            box-shadow: none;
        }

        button:disabled {
            background: var(--bg-light);
            color: var(--text-dim);
            cursor: not-allowed;
            box-shadow: 2px 2px 0 var(--bg-medium);
            transform: none;
            opacity: 0.7;
        }

        .github-btn {
            background: var(--bg-light);
            box-shadow: 3px 3px 0 var(--bg-medium);
        }

        .github-btn:hover:not(:disabled) {
            background: var(--bg-medium);
            box-shadow: 2px 2px 0 var(--bg-medium);
        }

        .accent-btn {
            background: var(--accent);
            box-shadow: 3px 3px 0 #b33000;
        }

        .accent-btn:hover:not(:disabled) {
            background: var(--accent-alt);
             box-shadow: 2px 2px 0 #b33000;
        }

        .primary-btn {
            background: var(--primary);
            box-shadow: 3px 3px 0 var(--primary-dark);
        }
        .primary-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            box-shadow: 2px 2px 0 var(--primary-dark);
        }


        /* Landing Page Features */
        #features {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 40px;
            flex-wrap: wrap;
            z-index: 10;
        }

        .feature {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 8px;
            width: 220px;
            box-shadow: 4px 4px 0 var(--bg-medium);
            border: 1px solid var(--primary);
            position: relative;
            overflow: hidden;
            z-index: 10;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
             text-align: center;
        }
         .feature:hover {
            transform: translateY(-3px);
            box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.3);
        }


        .feature::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .feature i {
            font-size: 28px;
            color: var(--secondary);
            margin-bottom: 12px;
            display: block;
        }

        .feature p {
            font-size: 15px;
            color: var(--text);
            text-align: center;
        }

        /* Input Fields */
        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="time"],
        input[type="number"], /* Added number type */
        select {
            display: block;
            width: 100%;
            /* Removed max-width: 350px here to allow parent control */
            margin: 15px auto; /* Default margin */
            padding: 12px 15px;
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Roboto Mono', monospace;
            background: var(--bg-light);
            border: 2px solid var(--primary);
            color: var(--text);
            outline: none;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2);
            transition: border-color 0.3s, box-shadow 0.3s;
            z-index: 11;
            pointer-events: auto;
        }
        /* Style specifically for number input spinners (optional) */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }


        input:focus,
        select:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(142, 45, 226, 0.3), inset 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Top Navigation Bar */
        #topNavBar {
            width: 100%;
            height: 60px;
            background-color: rgba(15, 15, 27, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
            border-bottom: 1px solid rgba(65, 105, 225, 0.3);
            z-index: 200;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            pointer-events: auto;
            display: none;
            flex-shrink: 0;
            order: -1;
        }

        #navLogo {
            text-decoration: none;
            white-space: nowrap;
            display: flex; /* Allow vertical centering of image */
            align-items: center;
            height: 100%; /* Take full nav height */
        }
        #navLogo img { /* Style for the logo image */
             height: 50px; /* << INCREASED LOGO SIZE */
             width: auto; /* Maintain aspect ratio */
             object-fit: contain; /* Ensure image fits well */
             filter: brightness(0.9) saturate(1.2); /* Optional: Adjust image appearance */
         }

        #navClockContainer {
            font-family: 'Roboto Mono', monospace;
            font-size: 16px;
            color: var(--text-dim);
            text-align: center;
            flex-grow: 1;
            flex-shrink: 0;
            margin: 0 20px;
            white-space: nowrap;
        }
        #navClockTime {
            color: var(--primary);
            font-weight: 600;
            letter-spacing: 1px;
        }
         #navClockPeriod {
            color: var(--secondary);
            font-weight: 600;
            margin-left: 5px;
        }

        #navButtons {
            display: flex;
            align-items: center;
            gap: 20px;
            white-space: nowrap;
        }

        /* Simple text display for streak */
        #navStreakDisplay {
            font-family: 'Roboto Mono', monospace;
            font-size: 15px;
            color: var(--accent);
            font-weight: 600;
            padding: 5px 10px;
            background-color: rgba(255, 69, 0, 0.1);
            border-radius: 4px;
            cursor: default;
        }
         #navStreakDisplay i {
            margin-right: 5px;
            font-style: normal;
            display: inline-block;
         }


        /* Simple buttons for Profile in nav */
         #navProfileBtn {
             background: none;
             border: none;
             color: var(--text-dim);
             font-size: 24px;
             cursor: pointer;
             padding: 5px;
             margin: 0;
             box-shadow: none;
             transition: color 0.2s ease, transform 0.2s ease;
         }
          #navProfileBtn:hover {
             color: var(--primary);
             transform: scale(1.1);
             box-shadow: none;
         }


        /* Home Page Styles (Simplified) */
        #homePage {
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #homePageContent {
            max-width: 600px;
            width: 90%;
        }

        #welcomeMessage {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--text);
            font-weight: 600;
        }
        #welcomeMessage span {
            font-weight: bold;
            color: var(--secondary);
        }

        #dateTimeDisplay {
            font-size: 18px;
            color: var(--text-dim);
            margin-bottom: 20px; /* Reduced margin */
        }

        /* Upcoming Task Display on Home */
        #upcomingTaskDisplay {
            font-size: 16px;
            color: var(--warning); /* Yellow for upcoming */
            margin-bottom: 25px; /* Spacing */
            padding: 10px 15px;
            background-color: rgba(37, 37, 56, 0.7); /* Slightly different bg */
            border-radius: 6px;
            border-left: 4px solid var(--warning);
            min-height: 40px;
            display: inline-block; /* Allows centering via text-align on parent */
            max-width: 90%;
            text-align: left; /* Align text inside */
        }
        #upcomingTaskDisplay i { margin-right: 8px; }
        #upcomingTaskDisplay.overdue {
            color: var(--danger);
            border-left-color: var(--danger);
        }
        #upcomingTaskDisplay.none {
            color: var(--text-dim);
            border-left-color: var(--text-dim);
            font-style: italic;
        }
        /* End Upcoming Task Display */

        #focusStatus {
            font-size: 20px;
            color: var(--accent-alt);
            margin-bottom: 30px; /* Adjusted margin */
            font-weight: 600;
            min-height: 25px;
            padding: 10px;
            background-color: rgba(26, 26, 46, 0.5);
            border-radius: 6px;
            display: inline-block;
        }

        #motivationQuote {
            margin-top: 30px; /* Adjusted margin */
            font-size: 18px;
            color: var(--text-dim);
            font-style: italic;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }


        /* YouTube Lecture Page Styles */
        #youtubeLecturePage {
             justify-content: flex-start;
             align-items: center;
             padding: 20px;
             gap: 20px;
        }

        #youtubeInputContainer {
            background-color: rgba(26, 26, 46, 0.7);
            padding: 20px 30px;
            border-radius: 10px;
            border: 1px solid var(--primary-dark);
            max-width: 800px;
            width: 95%;
            margin: 0 auto 20px auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
            pointer-events: auto;
            display: block; /* Show input section initially */
        }
         #youtubeInputContainer .subtitle {
            font-size: 18px; color: var(--text-dim); margin-bottom: 20px;
            font-family: 'Roboto Mono', monospace;
        }

        /* --- Positioning Fix for URL Input Area --- */
        #urlInputs {
            margin: 0 auto 15px auto; /* Center the block */
            max-width: 450px; /* Control max width */
            width: 100%; /* Take available space up to max-width */
            pointer-events: auto;
        }
        .url-container {
            display: flex; align-items: center; margin-bottom: 10px; gap: 10px;
        }
        /* --- Override general input margin within URL container --- */
        .url-container input {
            margin: 0; /* Remove default auto margin */
            flex-grow: 1; pointer-events: auto;
            max-width: none; /* Remove max-width from input itself */
        }
        .url-container button {
            padding: 8px 12px; margin: 0; background: var(--danger); font-size: 12px;
            box-shadow: 2px 2px 0 rgba(167, 29, 42, 0.8); min-width: 35px; pointer-events: auto;
            flex-shrink: 0; /* Prevent button from shrinking */
        }
        /* --- End Positioning Fix --- */

        #youtubeInputContainer button[data-action="add-url"] {
            font-size: 12px;
            padding: 8px 15px;
            margin-bottom: 15px; /* Keep vertical spacing */
            pointer-events: auto;
        }

        #playlistManagement {
            display: flex; gap: 10px; justify-content: center; align-items: center;
            margin-top: 15px; flex-wrap: wrap; pointer-events: auto;
        }
         #playlistManagement select, #playlistManagement input { margin: 0; max-width: 180px; pointer-events: auto; }
         #playlistManagement button { margin: 0; padding: 10px 15px; font-size: 12px; pointer-events: auto; }
         #youtubeInputContainer button[data-action="start-playback"] { margin-top: 25px; padding: 12px 30px; display: block; margin-left: auto; margin-right: auto; pointer-events: auto; }


        #playerContainer {
            width: 100%; max-width: 1200px; aspect-ratio: 16 / 9; position: relative;
            margin: 0 auto; pointer-events: auto;
             display: none; /* Hidden initially */
        }

        #player {
            width: 100%; height: 100%; border-radius: 0; overflow: hidden; background: #000;
            border: 4px solid var(--primary); box-shadow: 0 0 25px rgba(65, 105, 225, 0.6);
            z-index: 5; position: absolute; top: 0; left: 0;
        }

        #timerDisplay {
            position: fixed; top: 70px; left: 10px; color: var(--text); z-index: 101; cursor: move;
            padding: 10px 15px; background: rgba(26, 26, 46, 0.85); border: 1px solid var(--primary);
            border-radius: 4px; font-family: 'Roboto Mono', monospace; font-size: 16px;
            pointer-events: auto; box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px);
            display: none;
        }
         #timerText { display: block; margin-bottom: 5px; }

        #progressBar {
            width: 180px; height: 8px; background: var(--bg-light); border: 1px solid var(--primary);
            border-radius: 2px; overflow: hidden; margin-top: 5px; z-index: 101; display: block;
        }

        #progressFill { height: 100%; width: 0; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.5s linear; border-radius: 1px; }

         #youtubeLecturePageControls {
            position: fixed; top: 70px; right: 10px; display: flex; flex-direction: column;
            gap: 10px; z-index: 103; display: none; pointer-events: auto;
         }

        #restartBtn {
            background: var(--danger); box-shadow: 3px 3px 0 #a71d2a; padding: 8px 15px;
            font-size: 12px; margin: 0; pointer-events: auto;
        }
         #restartBtn:hover:not(:disabled) { background: #c82333; box-shadow: 2px 2px 0 #a71d2a; }

        #videoSidebar {
            position: fixed; right: -320px; top: 60px; width: 300px; height: calc(100vh - 60px);
            background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(8px); transition: right 0.3s ease;
            padding: 20px; overflow-y: auto; z-index: 102; border-left: 3px solid var(--primary);
            pointer-events: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.3); display: none;
        }
        #videoSidebar.open { right: 0; }

         #videoSidebarToggleBtn {
            position: fixed; top: 130px; right: 10px; z-index: 103; background: var(--secondary);
            padding: 8px 10px; font-size: 18px; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            margin: 0; display: none; pointer-events: auto;
         }
          #videoSidebarToggleBtn:hover:not(:disabled) { background: var(--primary); }

        .thumbnail {
            width: 100%; margin-bottom: 15px; cursor: pointer; border: 2px solid transparent;
            border-radius: 4px; transition: all 0.2s ease; image-rendering: auto;
            pointer-events: auto; display: block;
        }
        .thumbnail:hover { border-color: var(--secondary); transform: scale(1.03); box-shadow: 0 0 10px rgba(142, 45, 226, 0.5); }
         .thumbnail.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(255, 69, 0, 0.6); }
         #videoSidebar h3 { color: var(--secondary); margin-bottom: 15px; text-align: center; font-size: 16px; }

        /* Profile Page Styles */
        #profile { /* Changed ID */
            justify-content: center; align-items: center;
        }
        #profileContainer {
            background-color: rgba(26, 26, 46, 0.8); padding: 40px; border-radius: 12px;
            border: 1px solid var(--primary); max-width: 500px; width: 90%; text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); pointer-events: auto;
        }
        #profileIcon {
            font-size: 60px; color: var(--secondary); margin-bottom: 15px; display: inline-block;
            background: var(--bg-light); width: 100px; height: 100px; line-height: 100px;
            border-radius: 50%; border: 3px solid var(--primary);
        }
         #profileUsername { font-size: 24px; font-weight: bold; color: var(--text); margin-bottom: 10px; }
         .profile-stat { font-size: 18px; color: var(--text-dim); margin-bottom: 12px; border-bottom: 1px dashed var(--bg-light); padding-bottom: 8px; }
         .profile-stat span { font-weight: bold; color: var(--primary); margin-left: 8px; }
          .profile-stat .level { color: var(--gold); }
          .profile-stat .streak { color: var(--accent); }
          .profile-stat .xp { color: var(--secondary); }
          /* Settings section in Profile */
         #profileSettings {
             margin-top: 30px;
             padding-top: 20px;
             border-top: 1px solid var(--primary-dark);
             text-align: left;
         }
         #profileSettings h4 {
             color: var(--secondary);
             font-size: 16px;
             margin-bottom: 15px;
             text-align: center;
             font-family: 'Roboto Mono', monospace;
         }
         .setting-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 10px;
             padding: 8px 0;
         }
         .setting-item label {
             font-size: 15px;
             color: var(--text-dim);
             flex-grow: 1;
             margin-right: 15px;
         }
         .setting-item input[type="checkbox"] {
             appearance: none;
             width: 40px;
             height: 20px;
             background: var(--bg-light);
             border-radius: 10px;
             position: relative;
             cursor: pointer;
             outline: none;
             transition: background-color 0.3s;
             border: 1px solid var(--primary);
             flex-shrink: 0;
         }
         .setting-item input[type="checkbox"]::before {
             content: "";
             position: absolute;
             width: 16px;
             height: 16px;
             border-radius: 50%;
             background: var(--text-dim);
             top: 1px;
             left: 2px;
             transition: transform 0.3s, background-color 0.3s;
         }
         .setting-item input[type="checkbox"]:checked {
             background-color: var(--primary);
         }
         .setting-item input[type="checkbox"]:checked::before {
             background: white;
             transform: translateX(20px);
         }
          /* End Settings */
           #profile button[data-action="show-view"] { /* Target button inside profile view */
                margin-top: 20px; background: var(--bg-light); font-size: 12px;
            }

        /* Focus Stats Page Styles */
        #focusStats { /* Changed ID */
            justify-content: flex-start; /* Align content to top */
            align-items: center;
        }
         #focusStatsContainer {
             background-color: rgba(26, 26, 46, 0.8); padding: 30px; border-radius: 12px;
             border: 1px solid var(--primary); max-width: 800px; width: 90%; /* Increased max-width */
             box-shadow: 0 5px 20px rgba(0,0,0,0.3); pointer-events: auto;
         }
         #focusStatsContainer h3 { text-align: center; font-family: 'Press Start 2P', cursive; font-size: 20px; color: var(--secondary); margin-bottom: 30px; }
         #statsDisplay { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 25px; margin-bottom: 30px; }
         .stat-item { background: var(--bg-light); padding: 20px; border-radius: 6px; border: 1px solid var(--primary-dark); text-align: center; }
         .stat-item .label { font-size: 14px; color: var(--text-dim); margin-bottom: 10px; display: block; }
          .stat-item .value { font-size: 24px; font-weight: bold; color: var(--primary); }
          .stat-item .value.streak { color: var(--accent); }
          .stat-item .value.videos { color: var(--secondary); }
          .stat-item .value.distractions { color: var(--warning); }

         /* --- Calendar Styles --- */
         #focusCalendar { margin-top: 30px; background: var(--bg-light); padding: 20px; border-radius: 8px; border: 1px solid var(--primary-dark); }
         #calendarHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
         #calendarHeader h4 { margin: 0; color: var(--text-dim); flex-grow: 1; text-align: center; font-size: 16px; }
         #calendarHeader button { background: var(--primary); box-shadow: 2px 2px 0 var(--primary-dark); padding: 5px 10px; font-size: 12px; margin: 0; min-width: 40px; }
         #calendarHeader button:hover:not(:disabled) { background: var(--secondary); box-shadow: 1px 1px 0 var(--primary-dark); }
         #calendarGrid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
         .calendar-day { aspect-ratio: 1 / 1; background-color: var(--bg-medium); border-radius: 3px; display: flex; justify-content: center; align-items: center; font-size: 12px; color: var(--text-dim); position: relative; border: 1px solid transparent; cursor: default; transition: background-color 0.2s; }
         .calendar-day.other-month { opacity: 0.4; pointer-events: none; }
         .calendar-day.has-focus { background-color: var(--calendar-focus-low); color: var(--text); }
         .calendar-day.focus-medium { background-color: var(--calendar-focus-medium); }
         .calendar-day.focus-high { background-color: var(--calendar-focus-high); }
         .calendar-day.today { border: 1px solid var(--calendar-today-border); }
         .calendar-day .tooltip { visibility: hidden; width: 120px; background-color: var(--bg-dark); color: var(--text); text-align: center; border-radius: 4px; padding: 5px 0; position: absolute; z-index: 1; bottom: 115%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 11px; pointer-events: none; }
         .calendar-day:hover .tooltip { visibility: visible; opacity: 0.95; }
         /* --- End Calendar Styles --- */

           #focusStats button[data-action="show-view"] { /* Target button inside focusStats view */
                margin-top: 30px; background: var(--bg-light); font-size: 12px; display: block; margin-left: auto; margin-right: auto;
            }

        /* Sidebar Styles */
        .sidebar-trigger { position: fixed; left: 0; top: 50%; transform: translateY(-50%); width: 25px; height: 100px; background: var(--primary); z-index: 199; border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text); font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; font-size: 14px; letter-spacing: 2px; pointer-events: auto; transition: background-color 0.2s ease, left 0.3s ease; box-shadow: 3px 0 8px rgba(0,0,0,0.3); }
         .sidebar-trigger:hover { background: var(--secondary); }
        .game-sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100vh; background: rgba(26, 26, 46, 0.98); backdrop-filter: blur(5px); border-right: 3px solid var(--primary); z-index: 200; transition: left 0.3s ease; padding: 70px 0 20px 0; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.4); overflow-y: auto; pointer-events: auto; }
        .game-sidebar.open { left: 0; }
         .game-sidebar.open + .sidebar-trigger { left: 280px; }
        /* Hide sidebar trigger and sidebar on public pages (landing/signin) or when not signed in */
        .hide-menu .sidebar-trigger,
        .hide-menu .game-sidebar {
            display: none !important;
        }
        .sidebar-section { padding: 15px 20px; border-bottom: 1px solid var(--bg-light); }
        .sidebar-section:last-child { border-bottom: none; }
        .sidebar-section h3 { color: var(--secondary); font-size: 16px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1.5px; padding-bottom: 5px; border-bottom: 1px dashed var(--primary-dark); }
        .sidebar-section a, .sidebar-section button { position: relative; /* Needed for badge positioning */ display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; margin: 8px 0; background: var(--bg-light); color: var(--text); border: 1px solid var(--primary); border-radius: 4px; text-align: left; font-size: 14px; font-family: 'Roboto Mono', monospace; cursor: pointer; transition: all 0.2s ease; pointer-events: auto; z-index: 201; text-transform: none; box-shadow: none; letter-spacing: 0.5px; }
         .sidebar-section button i, .sidebar-section a i { width: 18px; text-align: center; color: var(--primary); }
        .sidebar-section a:hover, .sidebar-section button:hover:not(:disabled) { background: var(--primary); color: white; transform: translateX(5px); border-color: var(--secondary); box-shadow: none; }
         .sidebar-section a:hover i, .sidebar-section button:hover:not(:disabled) i { color: white; }
        .sidebar-section a { text-decoration: none; }
         /* To-Do Badge Style */
         .todo-badge {
             position: absolute;
             top: 5px;
             right: 5px;
             background-color: var(--notification-badge-bg);
             color: var(--notification-badge-text);
             border-radius: 50%;
             width: 20px;
             height: 20px;
             font-size: 11px;
             display: flex;
             align-items: center;
             justify-content: center;
             font-weight: bold;
             line-height: 1;
             box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
             display: none; /* Hidden by default */
         }
         .todo-badge.visible { display: flex; }
         /* End To-Do Badge Style */
         #logoutBtn { background: var(--danger); border-color: #a71d2a; color: white; }
          #logoutBtn i { color: white; }
          #logoutBtn:hover:not(:disabled) { background: #c82333; border-color: #a71d2a; }

        /* Shared Components (Points, Lofi, AI, Dialogs, Overlays) */
        #pointsDisplay { position: fixed; top: 70px; left: 10px; font-size: 16px; color: var(--text); font-family: 'Roboto Mono', monospace; font-weight: 600; z-index: 101; background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(5px); padding: 8px 12px; border: 1px solid var(--secondary); border-radius: 4px; box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); pointer-events: none; display: none; }
        #achievementLevel { position: fixed; top: 120px; left: 10px; font-size: 14px; font-weight: bold; z-index: 101; font-family: 'Press Start 2P', cursive; background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(5px); padding: 6px 10px; border: 2px solid var(--secondary); box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); border-radius: 4px; pointer-events: none; text-transform: uppercase; letter-spacing: 1px; display: none; }
        .rainbow { background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 3s infinite linear; border-color: transparent !important; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .level-glow { text-shadow: 0 0 10px var(--text); }
        .level-box-glow { box-shadow: 0 0 10px var(--gold); }
        #lofiPlayer { position: fixed; bottom: 10px; right: 10px; z-index: 101; background: rgba(26, 26, 46, 0.9); backdrop-filter: blur(5px); padding: 12px; border: 1px solid var(--primary); border-radius: 6px; box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.3); pointer-events: auto; display: none; }
        #lofiPlayer .lofi-title { text-align: center; margin-bottom: 8px; font-size: 12px; color: var(--text-dim); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        #lofiPlayer button { background: var(--secondary); border: none; color: var(--text); padding: 6px 12px; margin: 0 3px; cursor: pointer; font-size: 14px; border-radius: 4px; box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3); font-family: 'Roboto Mono', monospace; z-index: 102; min-width: 35px; pointer-events: auto; }
        #lofiPlayer button:hover:not(:disabled) { background: var(--primary); }
        #lofiPlayer #lofiPause { display: none; }
        #fireBox { position: fixed; bottom: 10px; left: 10px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 26px; cursor: pointer; z-index: 100; box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.4); border: 2px solid var(--secondary); pointer-events: auto; transition: all 0.2s ease; display: none; }
        #fireBox:hover { background: var(--secondary); transform: translateY(-3px) scale(1.05); box-shadow: 4px 4px 15px rgba(0, 0, 0, 0.5); }
        #aiPopup { position: fixed; bottom: 70px; left: 10px; width: 320px; height: 450px; background: var(--bg-medium); border-radius: 8px; padding: 5px; display: none; z-index: 101; box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.4); border: 3px solid var(--primary); pointer-events: auto; overflow: hidden; }
        #aiPopup iframe { width: 100%; height: 100%; border: none; border-radius: 5px; }
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(6px); display: flex; justify-content: center; align-items: center; z-index: 105; display: none; pointer-events: auto; padding: 15px; }
        .dialog-box { background: var(--bg-medium); padding: 25px 30px; border: 3px solid var(--accent); box-shadow: 0 0 30px rgba(255, 69, 0, 0.5); border-radius: 10px; text-align: center; pointer-events: auto; font-family: 'Roboto Mono', monospace; max-width: 450px; width: 90%; }
        .dialog-box.warning { border-color: var(--danger); box-shadow: 0 0 30px rgba(220, 53, 69, 0.6); }
        .dialog-box.warning h3 { color: var(--danger); }
        .dialog-box h3 { color: var(--accent); font-size: 20px; margin-bottom: 15px; font-family: 'Press Start 2P', cursive; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .dialog-box h3 i { font-size: 18px; }
        .dialog-box p { font-size: 16px; margin-bottom: 25px; color: var(--text); line-height: 1.5; }
        .dialog-box .dialog-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .dialog-box button { padding: 10px 25px; margin: 0; font-size: 14px; pointer-events: auto; z-index: 106; }
        #confirmBtn, #streakShieldConfirmBtn, #doublePointsConfirmBtn, #deadlineConfirmBtn, #sessionContinueBtn, #openMysteryBox { background: var(--accent); box-shadow: 3px 3px 0 #b33000; }
        #confirmBtn:hover:not(:disabled), #streakShieldConfirmBtn:hover:not(:disabled), #doublePointsConfirmBtn:hover:not(:disabled), #deadlineConfirmBtn:hover:not(:disabled), #sessionContinueBtn:hover:not(:disabled), #openMysteryBox:hover:not(:disabled) { background: var(--accent-alt); box-shadow: 2px 2px 0 #b33000; }
        #cancelBtn, #streakShieldCancelBtn, #doublePointsCancelBtn, #deadlineCancelBtn, #sessionEndBtn, #closeAudioStore, #closeMysteryBoxBtn { background: var(--bg-light); box-shadow: 3px 3px 0 var(--bg-medium); }
        #cancelBtn:hover:not(:disabled), #streakShieldCancelBtn:hover:not(:disabled), #doublePointsCancelBtn:hover:not(:disabled), #deadlineCancelBtn:hover:not(:disabled), #sessionEndBtn:hover:not(:disabled), #closeAudioStore:hover:not(:disabled), #closeMysteryBoxBtn:hover:not(:disabled) { background: var(--bg-medium); box-shadow: 2px 2px 0 var(--bg-medium); }
        #deadlineDialog input, #deadlineDialog select { margin: 15px auto; max-width: 300px; /* Ensure these dont stretch too much */ }
        #mysteryBoxPopup .dialog-box { border-color: var(--gold); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
        #mysteryBoxPopup h3 { color: var(--gold); }
        #mysteryRewardText { font-weight: bold; color: var(--accent-alt); min-height: 40px;}
        #audioTracksStore .dialog-box { border-color: var(--secondary); box-shadow: 0 0 30px rgba(142, 45, 226, 0.5); max-width: 500px; max-height: 80vh; overflow-y: auto; }
        #audioTracksStore h3 { color: var(--secondary); }
        #audioTracksList { margin-top: 20px; }
        .audio-track-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; margin-bottom: 10px; background: var(--bg-light); border: 1px solid var(--primary); border-radius: 4px; transition: background-color 0.2s; pointer-events: auto; }
        .audio-track-item:hover { background-color: var(--bg-medium); }
        .audio-track-item .track-info { text-align: left; }
        .audio-track-item .track-name { font-weight: bold; }
        .audio-track-item.locked .track-name { color: var(--text-dim); }
        .audio-track-item.unlocked .track-name { color: var(--accent-alt); }
        .audio-track-item .track-cost { font-size: 12px; color: var(--text-dim); }
        .unlock-track-btn { padding: 6px 12px; background: var(--secondary); font-size: 12px; margin: 0; flex-shrink: 0; pointer-events: auto; }
        .unlock-track-btn:disabled { background: var(--bg-light); color: var(--text-dim); cursor: not-allowed; opacity: 0.7; }
        .unlock-track-btn.unlocked { background: var(--success); color: white; cursor: default; }
        .unlock-track-btn.unlocked:hover:not(:disabled) { background: var(--success); }
        #achievementOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(15, 15, 27, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; color: gold; font-size: 36px; font-weight: bold; z-index: 104; display: none; font-family: 'Press Start 2P', cursive; text-align: center; text-shadow: 3px 3px 0 var(--primary-dark), 5px 5px 10px rgba(0,0,0,0.5); background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23FFD700' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E"); pointer-events: none; padding: 20px; line-height: 1.4; }
        #todoList { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 450px; max-height: 75vh; background: var(--bg-medium); padding: 20px; border: 2px solid var(--secondary); border-radius: 8px; display: none; z-index: 100; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4); pointer-events: auto; display: flex; flex-direction: column; }
        #todoList h3 { font-size: 18px; margin-bottom: 15px; color: var(--secondary); font-family: 'Roboto Mono', monospace; text-align: center; flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #tasks { overflow-y: auto; margin-bottom: 15px; background: none; padding-right: 5px; flex-grow: 1; pointer-events: auto; }
        .task-line { display: flex; align-items: center; margin-bottom: 10px; background: var(--bg-light); padding: 8px 10px; border: 1px solid var(--primary-dark); border-radius: 4px; pointer-events: auto; transition: background-color 0.2s, opacity 0.2s; }
        .task-line:hover { background-color: rgba(37, 37, 56, 0.8); }
        .task-line input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; appearance: none; border: 2px solid var(--primary); background: var(--bg-medium); position: relative; cursor: pointer; pointer-events: auto; z-index: 11; border-radius: 3px; transition: background-color 0.2s, border-color 0.2s; flex-shrink: 0; }
        .task-line input[type="checkbox"]:checked { background: var(--secondary); border-color: var(--secondary); }
        .task-line input[type="checkbox"]:checked::after { content: "âœ”"; position: absolute; color: var(--text); font-size: 14px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .task-line input[type="checkbox"]:hover { border-color: var(--secondary); }
        .task-line input[type="text"] { flex-grow: 1; font-size: 15px; font-family: 'Roboto Mono', monospace; color: var(--text); background: transparent; border: none; border-bottom: 1px solid transparent; padding: 5px 0; outline: none; box-shadow: none; margin: 0; pointer-events: auto; z-index: 11; transition: border-color 0.2s; max-width: none; /* Override general input max-width */ }
        .task-line input[type="text"]:focus { border-bottom: 1px solid var(--secondary); box-shadow: none; }
        .task-line input[type="text"][readonly] { text-decoration: line-through; color: var(--text-dim); }
        .task-line .task-buttons { display: flex; align-items: center; margin-left: 10px; flex-shrink: 0; pointer-events: auto; }
        .task-line .set-deadline, .task-line .remove-task { color: var(--text-dim); font-size: 16px; cursor: pointer; background: none; border: none; padding: 5px; line-height: 1; pointer-events: auto; z-index: 11; transition: color 0.2s; margin: 0 2px; }
        .task-line .set-deadline:hover:not(:disabled) { color: var(--primary); }
        .task-line .set-deadline:disabled { opacity: 0.5; cursor: not-allowed;}
        .task-line .remove-task:hover { color: var(--danger); }
        .task-line .deadline-info, .task-line .points-info { margin-left: 8px; font-size: 11px; padding: 2px 5px; border-radius: 3px; white-space: nowrap; pointer-events: none; }
        .task-line .deadline-info { color: var(--accent-alt); background-color: rgba(255, 140, 0, 0.1); }
        .task-line .points-info { color: var(--secondary); background-color: rgba(142, 45, 226, 0.1); }
        #todoList .dialog-buttons { margin-top: 15px; flex-shrink: 0; pointer-events: auto; }
        #todoList .dialog-buttons button { pointer-events: auto; }

        /* Pomodoro Styles */
        #pomodoroOverlay { background: rgba(15, 15, 27, 0.95); backdrop-filter: blur(12px); z-index: 1000; }
        #pomodoroContainer { width: 90%; max-width: 420px; background: transparent; padding: 30px; border: none; box-shadow: none; text-align: center; pointer-events: auto; }
        #pomodoroContainer h3 { font-family: 'Press Start 2P', cursive; font-size: 22px; color: var(--secondary); margin-bottom: 15px; text-shadow: 2px 2px 0px var(--primary-dark); display: flex; align-items: center; justify-content: center; gap: 10px; }
        #pomodoroContainer p { font-size: 16px; color: var(--text-dim); margin-bottom: 15px; } /* Adjusted margin */
        #pomodoroTimer { font-size: 90px; font-weight: bold; color: var(--text); margin: 20px 0; /* Adjusted margin */ font-family: 'Press Start 2P', cursive; text-shadow: 0 0 15px rgba(65, 105, 225, 0.5), 0 0 25px rgba(142, 45, 226, 0.4); transition: color 0.3s ease; }
        #pomodoroTimer.timer-warning { color: var(--timer-warning-color); text-shadow: 0 0 15px rgba(220, 53, 69, 0.6); }
        #pomodoroTimer.timer-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #pomodoroDurationSetting { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 25px; pointer-events: auto; }
        #pomodoroDurationSetting label { color: var(--text-dim); font-size: 14px; }
        #pomodoroDurationInput { width: 70px; padding: 8px 10px; font-size: 14px; text-align: center; margin: 0; pointer-events: auto; }
        #pomodoroDurationInput:disabled { background-color: var(--bg-medium); cursor: not-allowed; opacity: 0.6; }
        #pomodoroStatus { font-size: 18px; color: var(--accent-alt); margin-top: 15px; min-height: 25px; font-weight: 600; }
        #pomodoroControls { display: flex; justify-content: center; gap: 25px; margin-top: 35px; pointer-events: auto; }
        #pomodoroControls button { padding: 12px 30px; font-size: 16px; pointer-events: auto; }
        #pomodoroStartBtn { background: var(--success); border: none; box-shadow: 3px 3px 0 #1c7430;}
        #pomodoroStartBtn:hover:not(:disabled) { background: #218838; box-shadow: 2px 2px 0 #1c7430;}
        #pomodoroResetBtn { background: var(--accent); box-shadow: 3px 3px 0 #b33000;}
        #pomodoroResetBtn:hover:not(:disabled) { background: var(--accent-alt); box-shadow: 2px 2px 0 #b33000;}
        #pomodoroCloseBtn { background: var(--bg-light); box-shadow: 3px 3px 0 var(--bg-medium);}
        #pomodoroCloseBtn:hover:not(:disabled) { background: var(--bg-medium); box-shadow: 2px 2px 0 var(--bg-medium);}

        /* Responsive Adjustments */
        @media (max-width: 800px) {
            body { font-size: 14px; } .title { font-size: 22px; margin-bottom: 20px;} .subtitle { font-size: 16px; margin-bottom: 25px; } button { padding: 8px 18px; font-size: 12px; margin: 5px 5px 12px; } #landingPageContainer, #signinFormContainer { padding: 30px 20px; } #features { gap: 15px; } .feature { width: 180px; padding: 15px; } .feature i { font-size: 24px; } .feature p { font-size: 14px; }
            input[type="text"], input[type="password"], input[type="date"], input[type="time"], input[type="number"], select { padding: 10px 12px; font-size: 14px; }
            #topNavBar { height: 50px; padding: 0 15px; }
            #navLogo img { height: 40px; /* Adjusted logo size for medium screens */ }
            #navClockContainer { font-size: 14px; margin: 0 10px; } #navButtons { gap: 15px; } #navStreakDisplay { font-size: 13px; padding: 4px 8px; } #navProfileBtn { font-size: 22px; } .page-view { padding: 15px; } #welcomeMessage { font-size: 20px; } #dateTimeDisplay { font-size: 16px; } #upcomingTaskDisplay { font-size: 14px; padding: 8px 12px;} #focusStatus { font-size: 18px; margin-bottom: 30px; } #motivationQuote { font-size: 16px; }
            #urlInputs { max-width: 90%; /* Adjust centering */ }
            #youtubeInputContainer { padding: 15px 20px; } #youtubeInputContainer .subtitle { font-size: 16px; } #timerDisplay { top: 60px; font-size: 14px; padding: 8px 12px; } #progressBar { width: 150px; height: 6px; } #pointsDisplay { top: 60px; font-size: 14px; padding: 6px 10px; } #achievementLevel { top: 105px; font-size: 12px; padding: 5px 8px; } #youtubeLecturePageControls { top: 60px; } #restartBtn, #videoSidebarToggleBtn { padding: 6px 10px; font-size: 10px; } #videoSidebarToggleBtn { top: 110px; font-size: 16px; } #videoSidebar { width: 250px; right: -270px; top: 50px; height: calc(100vh - 50px); } #lofiPlayer { padding: 10px; } #lofiPlayer button { padding: 5px 10px; font-size: 12px; min-width: 30px;} #fireBox { width: 45px; height: 45px; font-size: 22px; } #aiPopup { width: 90%; max-width: 300px; height: 400px; bottom: 65px; } .dialog-box { padding: 20px; } .dialog-box h3 { font-size: 18px; } .dialog-box p { font-size: 14px; margin-bottom: 20px; } .dialog-box button { padding: 8px 20px; font-size: 12px; }
            #pomodoroContainer { padding: 20px; } #pomodoroTimer { font-size: 60px; margin: 15px 0;} #pomodoroDurationSetting { margin-bottom: 20px; } #pomodoroControls { gap: 15px; margin-top: 25px;} #pomodoroControls button { padding: 10px 20px; font-size: 14px; } #profileContainer { padding: 30px; } #profileIcon { font-size: 50px; width: 80px; height: 80px; line-height: 80px;} #profileUsername { font-size: 20px; } .profile-stat { font-size: 16px; } .setting-item label {font-size: 14px;} #focusStatsContainer { padding: 20px; max-width: 95%; } #focusStatsContainer h3 { font-size: 18px; margin-bottom: 25px; } .stat-item .value { font-size: 20px; } #todoList { max-width: 90%; } .task-line input[type="text"] { font-size: 14px; } .task-line .task-buttons { margin-left: 5px;} .task-line .set-deadline, .task-line .remove-task { font-size: 14px; padding: 3px;} .task-line .deadline-info, .task-line .points-info { font-size: 10px; margin-left: 4px;} .sidebar-trigger { left: 0px; /* Adjusted for consistency */ } .game-sidebar.open + .sidebar-trigger { left: 240px; }
            #calendarHeader h4 { font-size: 14px; } #calendarHeader button { padding: 4px 8px; font-size: 10px; } .calendar-day { font-size: 10px; }
         }
         @media (max-width: 480px) {
            .title { font-size: 18px; } .subtitle { font-size: 14px; }
            #navLogo { display: none; }
            #navClockContainer { flex-grow: 1; text-align: left; margin-left: 0px;}
            #topNavBar { padding: 0 10px; } #navButtons { gap: 10px; } #navStreakDisplay { font-size: 12px; padding: 3px 6px; } #navProfileBtn { font-size: 20px; } #welcomeMessage { font-size: 18px; } #dateTimeDisplay { font-size: 14px; } #upcomingTaskDisplay { font-size: 13px; padding: 6px 10px;} #focusStatus { font-size: 16px; margin-bottom: 25px; padding: 8px;} #motivationQuote { font-size: 14px; } #youtubeInputContainer { padding: 10px 15px; } #youtubeInputContainer .subtitle { font-size: 14px; }
            #urlInputs { max-width: 95%; } /* Adjust centering */
            .url-container { flex-direction: column; align-items: stretch; gap: 5px; } .url-container button { width: 100%; margin-top: 5px; } #playlistManagement { flex-direction: column; gap: 8px; align-items: stretch;} #playlistManagement select, #playlistManagement input { max-width: 100%; } #timerDisplay { font-size: 12px; padding: 6px 8px; } #progressBar { width: 120px; } #pointsDisplay { font-size: 12px; padding: 5px 8px; } #achievementLevel { font-size: 10px; padding: 4px 6px; top: 100px;} #videoSidebar { width: 200px; right: -220px; padding: 15px; } #videoSidebar.open { right: 0; } /* Ensure open works */
            .game-sidebar.open + .sidebar-trigger { left: 200px; }
            #pomodoroTimer { font-size: 48px; } #pomodoroControls { gap: 10px; } #pomodoroControls button { padding: 8px 15px; font-size: 12px; } .dialog-box button { padding: 8px 15px; } .sidebar-trigger { width: 20px; height: 80px; font-size: 12px; left: 0px; /* Ensure correct initial pos */ } .game-sidebar { width: 200px; left: -220px; padding-top: 60px;} .sidebar-section { padding: 10px 15px; } .sidebar-section h3 { font-size: 14px; margin-bottom: 10px;} .sidebar-section a, .sidebar-section button { padding: 8px 10px; font-size: 13px; gap: 8px;} .sidebar-section button i, .sidebar-section a i { width: 16px; } .todo-badge { width: 18px; height: 18px; font-size: 10px;} #todoList { max-width: 95%; padding: 15px;} #todoList h3 { font-size: 16px;} .task-line { padding: 6px 8px;} .task-line input[type="checkbox"] { width: 16px; height: 16px; margin-right: 8px;} .task-line input[type="text"] { font-size: 13px;}
            #calendarGrid { gap: 3px; } .calendar-day { font-size: 9px; }
         }

    /* PYQ iframe styles */
    #pyqEmbedContainer {
        position: relative;
        width: 100%;
        flex: 1 1 auto;
        min-height: calc(100vh - 140px); /* account for header/margins */
        border: 2px solid var(--primary);
        border-radius: 8px;
        box-shadow: 0 0 20px rgba(65,105,225,0.25);
        overflow: hidden;
        background: var(--bg-light);
    }
    #pyqEmbedPage { padding: 20px; }
    #pyqToolbar button { margin: 0; }
    #pyqFallback { z-index: 5; }
    </style>
    <!-- Include Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Press+Start+2P&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Canvas Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Supabase + Firebase ESM modules -->
<script type="module">
  // ===== BEGIN supabase/client.js (inlined) =====
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const SUPABASE_URL = 'https://zflpmhajkjwqzbkcrqhz.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmbHBtaGFqa2p3cXpia2NycWh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDg2OTcsImV4cCI6MjA3MjIyNDY5N30.LvkCfq4XdRoVc5wZcJ0mOAuV_AMxfehZ4MAqKqWn3AM';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true
    }
  });

  // Feature flag: keep Supabase auth button hidden until dashboard OAuth is ready
  const ENABLE_SUPABASE_GOOGLE = true;

  // Map Firebase uid -> Supabase user id (when both present, prefer Firebase uid to keep current app logic stable)
  function getActiveUserId() {
    const g = window;
    if (g.currentFirebaseUser?.uid) return g.currentFirebaseUser.uid; // use Firebase uid during dual-write
    if (g.__sbUser?.id) return g.__sbUser.id;
    return null;
  }

  // Safe helpers (no-throw): log but do not break app
  async function sbUpsertAppState(state) {
    try {
      const userId = getActiveUserId();
      if (!userId) return;
      // Minimal columns required; extra json stored in columns below
      const payload = {
        user_id: userId,
        points: state.points ?? 0,
        previous_points: state.previousPoints ?? 0,
        total_focus_time: state.totalFocusTime ?? 0,
        total_distractions: state.totalDistractions ?? 0,
        total_videos_watched: state.totalVideosWatched ?? 0,
        streak_days: state.streakDays ?? 0,
        last_focus_date: state.lastFocusDate ?? null,
        mystery_box_count: state.mysteryBoxCount ?? 0,
        active_power_ups: state.activePowerUps ?? null,
        premium_lofi_tracks: state.premiumLofiTracks ?? [],
        daily_focus_data: state.dailyFocusData ?? {},
        browser_notifications_enabled: !!state.browserNotificationsEnabled,
        current_pomodoro_duration_setting: state.currentPomodoroDurationSetting ?? 60,
        current_view: state.currentView ?? 'homePage',
        updated_at: new Date().toISOString()
      };
      await supabase.from('app_state').upsert(payload, { onConflict: 'user_id' });
    } catch (e) {
      console.warn('[Supabase] app_state upsert failed:', e?.message || e);
    }
  }

  async function sbUpsertTasks(tasks) {
    try {
      const userId = getActiveUserId();
      if (!userId || !Array.isArray(tasks)) return;
      if (tasks.length === 0) return;

      // Expect tasks as [{id?, title, completed, deadline?, difficulty?, points?}]
      const rows = tasks.map(t => ({
        user_id: userId,
        title: t.title ?? '',
        completed: !!t.completed,
        deadline: t.deadline ?? null,
        difficulty: t.difficulty ?? null,
        points_awarded: t.points_awarded ?? null,
        // If you maintain client ids, include id to enable upsert by id
      }));

      // Insert in batches to avoid payload limits
      const chunkSize = 50;
      for (let i = 0; i < rows.length; i += chunkSize) {
        const chunk = rows.slice(i, i + chunkSize);
        const { error } = await supabase.from('tasks').insert(chunk);
        if (error && error.code !== '23505') {
          // ignore duplicates; else log warning
          console.warn('[Supabase] tasks insert warning:', error.message);
        }
      }
    } catch (e) {
      console.warn('[Supabase] tasks upsert failed:', e?.message || e);
    }
  }

  async function sbReplaceTasks(tasks) {
    // Optionally replace all tasks for user to keep in sync with Firebase-local
    try {
      const userId = getActiveUserId();
      if (!userId) return;
      await supabase.from('tasks').delete().eq('user_id', userId);
      await sbUpsertTasks(tasks);
    } catch (e) {
      console.warn('[Supabase] tasks replace failed:', e?.message || e);
    }
  }

  async function sbUpsertPlaylists(playlists) {
    try {
      const userId = getActiveUserId();
      if (!userId || !Array.isArray(playlists)) return;
      // Strategy: delete-all-then-insert for idempotency by name
      await supabase.from('playlists').delete().eq('user_id', userId);
      if (playlists.length === 0) return;

      const rows = playlists.map(p => ({
        user_id: userId,
        name: p.name ?? '',
        urls: Array.isArray(p.urls) ? p.urls : []
      }));

      const chunkSize = 50;
      for (let i = 0; i < rows.length; i += chunkSize) {
        const chunk = rows.slice(i, i + chunkSize);
        const { error } = await supabase.from('playlists').insert(chunk);
        if (error) console.warn('[Supabase] playlists insert warning:', error.message);
      }
    } catch (e) {
      console.warn('[Supabase] playlists upsert failed:', e?.message || e);
    }
  }

  // Optional: read helpers (not used as primary yet)
  async function sbLoadAppState() {
    try {
      const userId = getActiveUserId();
      if (!userId) return null;
      const { data, error } = await supabase
        .from('app_state')
        .select('*')
        .eq('user_id', userId)
        .single();
      if (error) return null;
      return data || null;
    } catch {
      return null;
    }
  }

  // Supabase auth placeholder wiring
  async function sbSignInWithGoogle() {
    try {
      const redirectTo = `${window.location.origin}/v2`;
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo }
      });
      if (error) throw error;
    } catch (e) {
      console.warn('[Supabase] Google sign-in failed:', e?.message || e);
    }
  }

  // Auth state listener: store Supabase user for dual-write id source if Firebase not present
  supabase.auth.onAuthStateChange((_event, session) => {
    window.__sbUser = session?.user || null;
  });

  // Expose safe Supabase API for dual-write
  window.__sb = {
    client: supabase,
    upsertAppState: sbUpsertAppState,
    upsertTasks: sbUpsertTasks,
    replaceTasks: sbReplaceTasks,
    upsertPlaylists: sbUpsertPlaylists,
    loadAppState: sbLoadAppState,
    signInWithGoogle: sbSignInWithGoogle,
    ENABLE_SUPABASE_GOOGLE
  };
  // Hydrate session immediately on load
  try { supabase.auth.getSession().then(({ data }) => { window.__sbUser = data?.session?.user || null; }); } catch {}
  // ===== END supabase/client.js (inlined) =====

  // ===== Firebase removed =====

  // ===== Storage: cloud save/load via Supabase =====
  async function saveStateToCloud(uid) {
    if (!uid) throw new Error('saveStateToCloud: uid required');
    const g = window;
    const state = {
      points: g.points || 0,
      previousPoints: g.previousPoints || 0,
      totalFocusTime: g.totalFocusTime || 0,
      totalDistractions: g.totalDistractions || 0,
      totalVideosWatched: g.totalVideosWatched || 0,
      tasks: Array.isArray(g.tasks) ? g.tasks : [],
      playlists: Array.isArray(g.playlists) ? g.playlists : [],
      streakDays: g.streakDays || 0,
      lastFocusDate: g.lastFocusDate || null,
      mysteryBoxCount: g.mysteryBoxCount || 0,
      activePowerUps: g.activePowerUps || { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null } },
      premiumLofiTracks: Array.isArray(g.premiumLofiTracks) ? g.premiumLofiTracks.map(t => ({ id: t.id, unlocked: !!t.unlocked })) : [],
      dailyFocusData: g.dailyFocusData || {},
      browserNotificationsEnabled: !!g.browserNotificationsEnabled,
      currentPomodoroDurationSetting: g.currentPomodoroDurationSetting || 60,
      currentView: g.currentView || 'homePage'
    };
    await window.__sb?.upsertAppState(state);
  }
  async function loadStateFromCloud(uid) {
    if (!uid) throw new Error('loadStateFromCloud: uid required');
    const data = await window.__sb?.loadAppState();
    return data;
  }
  // Expose for other inline module
  const __dbExports = { saveStateToCloud, loadStateFromCloud }; // kept for compatibility
  // ===== End storage helpers =====

  // ===== Auth wiring (Supabase only) =====
  function collectAppStateFromWindow() {
    const g = window;
    return {
      points: g.points || 0,
      previousPoints: g.previousPoints || 0,
      totalFocusTime: g.totalFocusTime || 0,
      totalDistractions: g.totalDistractions || 0,
      totalVideosWatched: g.totalVideosWatched || 0,
      tasks: Array.isArray(g.tasks) ? g.tasks : [],
      playlists: Array.isArray(g.playlists) ? g.playlists : [],
      streakDays: g.streakDays || 0,
      lastFocusDate: g.lastFocusDate || null,
      mysteryBoxCount: g.mysteryBoxCount || 0,
      activePowerUps: g.activePowerUps || { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null } },
      premiumLofiTracks: Array.isArray(g.premiumLofiTracks) ? g.premiumLofiTracks.map(t => ({ id: t.id, unlocked: !!t.unlocked })) : [],
      dailyFocusData: g.dailyFocusData || {},
      browserNotificationsEnabled: !!g.browserNotificationsEnabled,
      currentPomodoroDurationSetting: g.currentPomodoroDurationSetting || 60,
      currentView: g.currentView || 'landingPage'
    };
  }
  function applyAppStateToWindow(data) {
    const g = window;
    if (!data) return;
    g.points = data.points ?? g.points ?? 0;
    g.previousPoints = data.previousPoints ?? g.previousPoints ?? g.points ?? 0;
    g.totalFocusTime = data.totalFocusTime ?? g.totalFocusTime ?? 0;
    g.totalDistractions = data.totalDistractions ?? g.totalDistractions ?? 0;
    g.totalVideosWatched = data.totalVideosWatched ?? g.totalVideosWatched ?? 0;
    g.tasks = Array.isArray(data.tasks) ? data.tasks : (g.tasks || []);
    g.playlists = Array.isArray(data.playlists) ? data.playlists : (g.playlists || []);
    g.streakDays = data.streakDays ?? g.streakDays ?? 0;
    g.lastFocusDate = data.lastFocusDate ?? g.lastFocusDate ?? null;
    g.mysteryBoxCount = data.mysteryBoxCount ?? g.mysteryBoxCount ?? 0;
    g.activePowerUps = data.activePowerUps ?? g.activePowerUps ?? { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null } };
    if (Array.isArray(data.premiumLofiTracks) && Array.isArray(g.premiumLofiTracks)) {
      const unlockedMap = new Map(data.premiumLofiTracks.map(t => [t.id, !!t.unlocked]));
      g.premiumLofiTracks.forEach(t => { if (unlockedMap.has(t.id)) t.unlocked = unlockedMap.get(t.id); });
    }
    g.dailyFocusData = data.dailyFocusData ?? g.dailyFocusData ?? {};
    g.browserNotificationsEnabled = !!(data.browserNotificationsEnabled ?? g.browserNotificationsEnabled);
    g.currentPomodoroDurationSetting = data.currentPomodoroDurationSetting ?? g.currentPomodoroDurationSetting ?? 60;

    try {
      if (typeof g.updateAchievementLevel === 'function') g.updateAchievementLevel();
      if (typeof g.updateStreakDisplay === 'function') g.updateStreakDisplay();
      if (typeof g.restoreTasks === 'function') g.restoreTasks();
      if (typeof g.populatePlaylistSelect === 'function') g.populatePlaylistSelect();
    } catch (e) {
      console.warn('Post-hydration UI update warning:', e.message);
    }
  }

  async function googleSignIn() {
    if (window.__sb?.signInWithGoogle) {
      await window.__sb.signInWithGoogle();
      return null;
    }
    throw new Error('Supabase client not initialized');
  }
  async function supabaseSignOut() {
    try { await window.__sb?.client?.auth?.signOut(); } catch {}
  }

  export function wireAuthButtons() {
    window.wireAuthButtons = wireAuthButtons;
    const googleBtn = document.querySelector('#googleSignInBtn') || document.querySelector('#signinFormContainer button[data-action="google-sign-in"]');
    if (googleBtn && !googleBtn.dataset.fbwired) {
      googleBtn.dataset.fbwired = '1';
      googleBtn.addEventListener('click', async (ev) => {
        ev.preventDefault();
        console.log('[Auth] Google button clicked (redirect flow)');
        googleBtn.disabled = true;
        const orig = googleBtn.textContent;
        googleBtn.textContent = 'Redirecting to Google...';
        try {
          try {
            await googleSignIn(); // Firebase path (redirect)
          } catch (fbErr) {
            console.warn('[Auth] Firebase redirect failed, trying Supabase OAuth...', fbErr?.code || fbErr);
            if (window.__sb?.ENABLE_SUPABASE_GOOGLE) {
              await window.__sb.signInWithGoogle();
            } else {
              throw fbErr;
            }
          }
        } catch (e) {
          console.error('[Auth] Google sign-in failed:', e);
          alert('Google sign-in failed. Check console.');
          googleBtn.textContent = orig;
          googleBtn.disabled = false;
        }
      });
      // Also expose a global handler as a fallback if wiring happens late
      window.__googleSignin = async () => {
        try {
          await googleSignIn();
        } catch (e) {
          console.error('[Auth] Global google signin failed:', e);
        }
      };
    }

    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn && !logoutBtn.dataset.fbwired) {
      logoutBtn.dataset.fbwired = '1';
      logoutBtn.addEventListener('click', async () => {
        try { sessionStorage.removeItem('ufm_v2_logged_in'); } catch {}
        try {
          await supabaseSignOut();
        } catch (err) {
          console.error('Sign out error:', err);
        }
      });
    }
  }

  // Expose handlers globally for robustness
  window.wireAuthButtons = wireAuthButtons;
  window.__googleSignin = async () => { try { await googleSignIn(); } catch (e) { console.error('[Auth] Global google signin failed:', e); } };

  // Supabase auth state: simple session listener
  window.__sb?.client?.auth?.onAuthStateChange?.((_event, session) => {
    window.__sbUser = session?.user || null;
    if (window.__sbUser) {
      window.isSignedIn = true;
      window.currentUser = window.__sbUser.id;
      try { if (typeof window.showView === 'function') window.showView('homePage'); } catch {}
    }
  });

  // Guard: ensure __fbExports exists before wiring auth state listener
  if (false) {
    __fbExports.onAuthStateChanged(__fbExports.auth, async (fbUser) => {
      const g = window;
      if (fbUser) {
        g.isSignedIn = true;
        g.currentUser = fbUser.uid;
        // Persist a short-lived session marker
        try { sessionStorage.setItem('ufm_v2_logged_in', '1'); } catch {}

        // Populate nav UI basics if present (defensive: don't block on failures)
        try {
          const remoteState = await __fbExports.loadAppState(fbUser.uid);
          applyAppStateToWindow(remoteState);
        } catch (e) {
          console.warn('[Auth] Remote state load failed:', e?.code || e);
        }

        // Migrate any local state once, ignore permission denials
        try {
          const localMigratable = collectAppStateFromWindow();
          await __fbExports.saveAppState(fbUser.uid, localMigratable);
        } catch (e) {
          console.warn('[Auth] Initial save/migration failed:', e?.code || e);
        }

        // Supabase: one-time migration of local data after Firebase sign-in (best-effort)
        try {
          const uid = fbUser.uid;
          const flagKey = `sb_migrated_${uid}`;
          if (!localStorage.getItem(flagKey)) {
            const g = window;
            // Build state for Supabase app_state
            const stateForSb = {
              points: g.points || 0,
              previousPoints: g.previousPoints || 0,
              totalFocusTime: g.totalFocusTime || 0,
              totalDistractions: g.totalDistractions || 0,
              totalVideosWatched: g.totalVideosWatched || 0,
              streakDays: g.streakDays || 0,
              lastFocusDate: g.lastFocusDate || null,
              mysteryBoxCount: g.mysteryBoxCount || 0,
              activePowerUps: g.activePowerUps || { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null } },
              premiumLofiTracks: Array.isArray(g.premiumLofiTracks) ? g.premiumLofiTracks.map(t => ({ id: t.id, unlocked: !!t.unlocked })) : [],
              dailyFocusData: g.dailyFocusData || {},
              browserNotificationsEnabled: !!g.browserNotificationsEnabled,
              currentPomodoroDurationSetting: g.currentPomodoroDurationSetting || 60,
              currentView: g.currentView || 'homePage'
            };
            // Normalize lists
            const flatTasks = Array.isArray(g.tasks) ? g.tasks.map(t => ({
              title: t.text ?? t.title ?? '',
              completed: !!t.completed,
              deadline: t.deadline ?? null,
              difficulty: t.points ?? t.difficulty ?? null,
              points_awarded: t.points_awarded ?? null
            })) : [];
            const flatPlaylists = Array.isArray(g.playlists) ? g.playlists.map(p => ({
              name: p.name ?? '',
              urls: Array.isArray(p.urls) ? p.urls : []
            })) : [];

            await window.__sb?.upsertAppState(stateForSb);
            await window.__sb?.replaceTasks(flatTasks);
            await window.__sb?.upsertPlaylists(flatPlaylists);
            localStorage.setItem(flagKey, '1');
            console.log('[Supabase] One-time migration completed for uid:', uid);
          }
        } catch (e) {
          console.warn('[Supabase] One-time migration skipped/failed:', e?.message || e);
        }

        // Unconditional navigation to home after successful login (avoids race on view detection)
        try {
          if (typeof g.showView === 'function') {
            g.showView('homePage');
          } else {
            // Defer to next tick if showView not yet defined
            setTimeout(() => {
              if (typeof g.showView === 'function') g.showView('homePage');
            }, 0);
          }
        } catch (e) {
          console.warn('Navigation warning:', e?.message || e);
        }
      } else {
        g.isSignedIn = false;
        g.currentUser = null;
        try { sessionStorage.removeItem('ufm_v2_logged_in'); } catch {}
        // Avoid hard navigation loops: only show landing if not already on a private view
        try {
          if (typeof g.showView === 'function') {
            g.showView('landingPage');
          }
        } catch {}
      }
    });
  } else {
    // Defer listener registration until DOM ready, then try again once __fbExports is available
    document.addEventListener('DOMContentLoaded', () => {
      const bootAuthListener = () => { return; /* Firebase removed */
        if (typeof __fbExports === 'object' && __fbExports && __fbExports.onAuthStateChanged && __fbExports.auth) {
          // Re-run the same listener attach logic
          __fbExports.onAuthStateChanged(__fbExports.auth, async (fbUser) => {
            const g = window;
            if (fbUser) {
              g.isSignedIn = true;
              g.currentUser = fbUser.uid;
              try { const remoteState = await __fbExports.loadAppState(fbUser.uid); applyAppStateToWindow(remoteState); } catch (e) { console.warn('[Auth] Remote state load failed:', e?.code || e); }
              try { const localMigratable = collectAppStateFromWindow(); await __fbExports.saveAppState(fbUser.uid, localMigratable); } catch (e) { console.warn('[Auth] Initial save/migration failed:', e?.code || e); }

              // Supabase: one-time migration in fallback bootAuthListener path
              try {
                const uid = fbUser.uid;
                const flagKey = `sb_migrated_${uid}`;
                if (!localStorage.getItem(flagKey)) {
                  const g = window;
                  const stateForSb = {
                    points: g.points || 0,
                    previousPoints: g.previousPoints || 0,
                    totalFocusTime: g.totalFocusTime || 0,
                    totalDistractions: g.totalDistractions || 0,
                    totalVideosWatched: g.totalVideosWatched || 0,
                    streakDays: g.streakDays || 0,
                    lastFocusDate: g.lastFocusDate || null,
                    mysteryBoxCount: g.mysteryBoxCount || 0,
                    activePowerUps: g.activePowerUps || { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null } },
                    premiumLofiTracks: Array.isArray(g.premiumLofiTracks) ? g.premiumLofiTracks.map(t => ({ id: t.id, unlocked: !!t.unlocked })) : [],
                    dailyFocusData: g.dailyFocusData || {},
                    browserNotificationsEnabled: !!g.browserNotificationsEnabled,
                    currentPomodoroDurationSetting: g.currentPomodoroDurationSetting || 60,
                    currentView: g.currentView || 'homePage'
                  };
                  const flatTasks = Array.isArray(g.tasks) ? g.tasks.map(t => ({
                    title: t.text ?? t.title ?? '',
                    completed: !!t.completed,
                    deadline: t.deadline ?? null,
                    difficulty: t.points ?? t.difficulty ?? null,
                    points_awarded: t.points_awarded ?? null
                  })) : [];
                  const flatPlaylists = Array.isArray(g.playlists) ? g.playlists.map(p => ({
                    name: p.name ?? '',
                    urls: Array.isArray(p.urls) ? p.urls : []
                  })) : [];

                  await window.__sb?.upsertAppState(stateForSb);
                  await window.__sb?.replaceTasks(flatTasks);
                  await window.__sb?.upsertPlaylists(flatPlaylists);
                  localStorage.setItem(flagKey, '1');
                  console.log('[Supabase] One-time migration completed (fallback) for uid:', uid);
                }
              } catch (e) {
                console.warn('[Supabase] One-time migration (fallback) skipped/failed:', e?.message || e);
              }
              // Unconditional navigation to home after successful login (fallback listener)
              try {
                if (typeof g.showView === 'function') {
                  g.showView('homePage');
                } else {
                  setTimeout(() => {
                    if (typeof g.showView === 'function') g.showView('homePage');
                  }, 0);
                }
              } catch (e) { console.warn('Navigation warning:', e?.message || e); }
            } else {
              g.isSignedIn = false;
              g.currentUser = null;
              try { if (typeof g.showView === 'function') g.showView('landingPage'); } catch {}
            }
          });
        } else {
          // If still not ready, retry shortly a few times
          let retries = 0;
          const maxRetries = 20;
          const t = setInterval(() => {
            retries++;
            if (typeof __fbExports === 'object' && __fbExports && __fbExports.onAuthStateChanged && __fbExports.auth) {
              clearInterval(t);
              bootAuthListener();
            } else if (retries >= maxRetries) {
              clearInterval(t);
              console.error('[Auth] __fbExports not available; auth state listener not attached.');
            }
          }, 100);
        }
      };
      bootAuthListener();
    });
  }
  // ===== End auth wiring =====

  // Wire buttons after module load
  document.addEventListener('DOMContentLoaded', () => {
    try {
      wireAuthButtons();
      // If Supabase session exists, mark signed in
      const updateFromSession = async () => {
        try {
          const { data } = await (window.__sb?.client?.auth?.getSession?.() || Promise.resolve({ data: { session: null } }));
          const sbUser = data?.session?.user || window.__sbUser;
          if (sbUser) {
            window.__sbUser = sbUser;
            window.isSignedIn = true;
            window.currentUser = sbUser.id;
            if (typeof window.showView === 'function') window.showView('homePage');
          }
        } catch {}
      };
      updateFromSession();
      console.log('[Auth] wireAuthButtons initialized');
    } catch (e) {
      console.error('[Auth] Failed to initialize auth wiring:', e);
    }
  });
</script>

</head>
<body>

    <!-- Main Game Container -->
    <div class="game-container">

        <!-- Top Navigation Bar -->
        <nav id="topNavBar">
             <!-- Logo Image -->
            <a href="#" id="navLogo" title="Quest for Focus" data-action="show-view" data-view="homePage">
                <img src="logo.png" alt="Quest for Focus Logo"> <!-- Ensure logo.png exists -->
            </a>
            <div id="navClockContainer"> <span id="navClockTime">00:00:00</span> <span id="navClockPeriod">AM</span> </div>
            <div id="navButtons">
                <span id="navStreakDisplay"><i class="fas fa-fire"></i> 0 days focus</span>
                <span id="navUserArea" style="display:none;align-items:center;gap:8px;">
                    <img id="navUserPhoto" alt="avatar" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid var(--primary);display:none;">
                    <span id="navUserName" style="font-size:14px;color:var(--text-dim);"></span>
                </span>
                <button id="navProfileBtn" title="Profile" data-action="show-view" data-view="profile"> <i class="fas fa-user-circle"></i> </button>
            </div>
        </nav>

        <!-- == Page Views == -->
        <div id="landingPage" class="page-view" style="display: flex;"> <div id="landingPageContainer"> <div class="title">QUEST FOR <span>FOCUS</span></div> <div class="subtitle">Embark on your learning adventure! Conquer distractions, master knowledge.</div> <button data-action="show-view" data-view="signinForm" class="primary-btn">START QUEST</button> <button class="github-btn" data-action="github"><i class="fab fa-github"></i> GITHUB</button> <div id="features"> <div class="feature"> <i class="fas fa-ban"></i> <p>Ad-Free Zone<br>Focus!</p> </div> <div class="feature"> <i class="fas fa-moon"></i> <p>Dark Mode<br>Easy on eyes</p> </div> <div class="feature"> <i class="fas fa-gamepad"></i> <p>Gamified<br>Level up!</p> </div> </div> </div> </div>
        <div id="signinForm" class="page-view"> <div id="signinFormContainer">
    <div class="title">ENTER <span>REALM</span></div>
    <div class="subtitle">Sign in with Google to begin your quest!</div>

    <button id="googleSignInBtn" data-action="google-sign-in" class="primary-btn" style="margin-bottom: 30px; padding: 15px 30px; font-size: 16px;">
        <i class="fab fa-google"></i> SIGN IN WITH GOOGLE
    </button>
    
    <button data-action="show-view" data-view="landingPage" style="margin-top: 20px; background: var(--bg-light); font-size: 12px;">
        <i class="fas fa-arrow-left"></i> Back
    </button>
</div>
        <div id="homePage" class="page-view">
            <div id="homePageContent">
                <div id="welcomeMessage">Welcome, <span id="homeUsername">Hero</span>!</div>
                <div id="dateTimeDisplay">Loading...</div>
                <!-- Added Upcoming Task Display -->
                <div id="upcomingTaskDisplay" class="none"><i class="fas fa-star"></i> No urgent quests!</div>
                <!-- End Upcoming Task Display -->
                <div id="focusStatus">Ready to focus?</div>
                <div id="motivationQuote">"Loading motivation..."</div>
            </div>
        </div>
        <div id="youtubeLecturePage" class="page-view"> <div id="youtubeInputContainer"> <div class="subtitle">Prepare Focus Session</div> <select id="playlistSelect"> <option value="">Load Playlist</option> </select> <div id="urlInputs"> <div class="url-container"> <input type="text" class="youtube-url" placeholder="YouTube URL (Video or Playlist)" required /> </div> </div> <button data-action="add-url"><i class="fas fa-plus"></i> Add URL</button> <div id="playlistManagement"> <input type="text" id="playlistName" placeholder="Save As..." /> <button data-action="save-playlist" class="primary-btn"><i class="fas fa-save"></i> Save</button> <button data-action="remove-playlist" class="accent-btn" style="background: var(--danger); box-shadow: 3px 3px 0 #a71d2a;"><i class="fas fa-trash"></i> Delete</button> </div> <button data-action="start-playback" class="primary-btn"><i class="fas fa-play-circle"></i> BEGIN FOCUS</button> </div> <div id="playerContainer"> <div id="player"></div> </div> <button id="videoSidebarToggleBtn" title="Toggle List (T)"> <i class="fas fa-list"></i> </button> <div id="youtubeLecturePageControls"> <button id="restartBtn" title="Exit Session"><i class="fas fa-times-circle"></i> Exit</button> </div> <div id="videoSidebar"> <h3><i class="fas fa-video"></i> Playlist</h3> <div id="videoThumbnailList"></div> </div> </div>
        <div id="profile" class="page-view">
            <div id="profileContainer">
                <div id="profileIcon"><i class="fas fa-user-shield"></i></div>
                <div id="profileUsername">Hero Name</div>
                <div class="profile-stat">Level: <span id="profileLevel" class="level">Mortal</span></div>
                <div class="profile-stat">XP: <span id="profileXP" class="xp">0</span></div>
                <div class="profile-stat">Streak: <span id="profileStreak" class="streak">0 days</span></div>

                <!-- Added Settings Section -->
                <div id="profileSettings">
                    <h4><i class="fas fa-cog"></i> Settings</h4>
                    <div class="setting-item">
                        <label for="browserNotificationSetting">Enable Browser Notifications for Deadlines</label>
                        <input type="checkbox" id="browserNotificationSetting">
                    </div>
                    <small style="color: var(--text-dim); font-size: 12px; display: block; text-align: center; margin-top: -5px;">Requires browser permission.</small>
                </div>
                <!-- End Settings Section -->

                <button data-action="show-view" data-view="homePage" style="margin-top: 20px; background: var(--bg-light); font-size: 12px;"> <i class="fas fa-arrow-left"></i> Home</button>
            </div>
        </div>
        <div id="focusStats" class="page-view"> <div id="focusStatsContainer"> <h3><i class="fas fa-chart-line"></i> Hero <span>Stats</span></h3> <div id="statsDisplay"> <div class="stat-item"> <span class="label"><i class="fas fa-stopwatch"></i> Focus Time</span> <span id="statsTotalFocusTime" class="value">0m</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-eye-slash"></i> Distractions</span> <span id="statsTotalDistractions" class="value distractions">0</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-film"></i> Videos Done</span> <span id="statsTotalVideosWatched" class="value videos">0</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-fire"></i> Current Streak</span> <span id="statsCurrentStreak" class="value streak">0 days</span> </div> </div> <div id="focusCalendar"> <div id="calendarHeader"> <button id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button> <h4 id="calendarMonthYear"><i class="fas fa-calendar-alt"></i> Calendar</h4> <button id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button> </div> <div id="calendarGrid"> <!-- Calendar grid will be generated here --> </div> </div> <button data-action="show-view" data-view="homePage" style="margin-top: 30px; background: var(--bg-light); font-size: 12px; display: block; margin-left: auto; margin-right: auto;"> <i class="fas fa-arrow-left"></i> Home</button> </div> </div>
        <!-- PYQ Embedded View -->
        <div id="pyqEmbedPage" class="page-view" style="display:none;">
            <div id="pyqToolbar" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <button id="pyqBackBtn" class="accent-btn" style="background: var(--bg-light);"><i class="fas fa-arrow-left"></i> Back</button>
                <span style="color: var(--text-dim); font-size: 14px;"><i class="fas fa-dumbbell"></i> PYQs</span>
                <span></span>
            </div>
            <div id="pyqEmbedContainer">
                <iframe id="pyqIframe" title="ExamGoal PYQs" src="about:blank" loading="lazy" referrerpolicy="no-referrer" allow="clipboard-read; clipboard-write; fullscreen" style="width:100%;height:100%;border:0;background:#111;"></iframe>
                <div id="pyqFallback" style="display:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:20px;text-align:center;background:rgba(26,26,46,0.9);border:2px dashed var(--danger);border-radius:8px;">
                    <div>
                        <h3 style="color: var(--danger); margin-bottom:10px;"><i class="fas fa-ban"></i> Embedding blocked</h3>
                        <p style="color: var(--text);">room.examgoal.com disallows embedding in an iframe. You can open it in a new tab:</p>
                        <p style="margin-top:10px;"><a href="https://room.examgoal.com/" target="_blank" rel="noreferrer" style="color: var(--accent); text-decoration: underline;">Open PYQs</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- == Shared Components == -->
        <div class="sidebar-trigger" title="Open Menu">MENU</div>
        <div class="game-sidebar"> <div class="sidebar-section"> <h3>Navigation</h3> <button data-action="show-view" data-view="homePage"><i class="fas fa-home"></i> Home</button> <button data-action="show-view" data-view="youtubeLecturePage"><i class="fab fa-youtube"></i> Lectures</button> <button data-action="toggle-todo"><i class="fas fa-list-check"></i> To-Do<span id="todoBadge" class="todo-badge">0</span></button> <!-- Badge added here --> </div> <div class="sidebar-section"> <h3>Progress</h3> <button data-action="show-view" data-view="focusStats"><i class="fas fa-chart-line"></i> Stats</button> <button id="pyqOpenBtn"><i class="fas fa-dumbbell"></i> PYQs</button> </div> <div class="sidebar-section"> <h3>Self Study</h3> <button id="quietPomodoroBtn"><i class="fas fa-brain"></i> Pomodoro</button> </div> <div class="sidebar-section"> <h3>Shops & Realms</h3> <button id="streakShieldBtn"><i class="fas fa-shield-alt"></i> Shield</button> <button id="doublePointsBtn"><i class="fas fa-bolt"></i> Double XP</button> <button id="audioStoreBtn"><i class="fas fa-music"></i> Audio</button> <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer"><i class="fas fa-tree"></i> Forest</a> <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer"><i class="fas fa-clock"></i> Pomodoro Realm</a> <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer"><i class="fas fa-calendar-alt"></i> Planner</a> </div> <div class="sidebar-section"> <h3>Account</h3> <button data-action="show-view" data-view="profile"><i class="fas fa-user"></i> Profile</button> <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button> </div> </div>
        <div id="timerDisplay"> <span id="timerText">Focus: 00:00</span> <div id="progressBar"> <div id="progressFill"></div> </div> </div>
        <div id="pointsDisplay"><span style="color: var(--secondary);">â­</span> XP: 0</div>
        <div id="achievementLevel">Mortal</div>
        <div id="todoList"> <h3><i class="fas fa-tasks"></i> Quests</h3> <div id="tasks"></div> <div class="dialog-buttons"> <button data-action="save-tasks" class="primary-btn"><i class="fas fa-save"></i> Save</button> <button data-action="add-task-line" style="background: var(--bg-light);"><i class="fas fa-plus"></i> Add</button> <button data-action="close-todo" class="accent-btn" style="background: var(--danger); box-shadow: 3px 3px 0 #a71d2a;"><i class="fas fa-times"></i> Close</button> </div> </div>
        <div id="lofiPlayer"> <div class="lofi-title">LOFI â™¬</div> <button id="lofiPrev" title="Prev"><i class="fas fa-backward-step"></i></button> <button id="lofiPlay" title="Play"><i class="fas fa-play"></i></button> <button id="lofiPause" title="Pause"><i class="fas fa-pause"></i></button> <button id="lofiNext" title="Next"><i class="fas fa-forward-step"></i></button> </div>
        <div id="fireBox" title="AI Assistant"><i class="fas fa-robot"></i></div>
        <div id="aiPopup"> <iframe src="https://www.chatbase.co/chatbot-iframe/3dSdpryiYZlWipHUL8dNK" frameBorder="0"></iframe> </div>
        <div id="achievementOverlay">LEVEL UP!</div>
        <div id="confirmationDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-question-circle"></i> Confirm</h3> <p id="confirmationDialogText">Are you sure?</p> <div class="dialog-buttons"> <button id="confirmBtn">YES</button> <button id="cancelBtn">NO</button> </div> </div> </div>
        <div id="streakShieldDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-shield-alt"></i> Shield</h3> <p>Protect streak (1 week)? Costs 800 XP.</p> <div class="dialog-buttons"> <button id="streakShieldConfirmBtn">Buy</button> <button id="streakShieldCancelBtn">Cancel</button> </div> </div> </div>
        <div id="doublePointsDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-bolt"></i> Double XP</h3> <p>Activate Double XP (24h)? Costs 800 XP.</p> <div class="dialog-buttons"> <button id="doublePointsConfirmBtn">Activate</button> <button id="doublePointsCancelBtn">Cancel</button> </div> </div> </div>
        <div id="deadlineDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-calendar-check"></i> Deadline</h3> <p>Set deadline & difficulty for bonus XP!</p> <input type="date" id="deadlineDate" /> <input type="time" id="deadlineTime" /> <select id="taskDifficulty"> <option value="50">Easy (+50)</option> <option value="100">Medium (+100)</option> <option value="200">Hard (+200)</option> <option value="300">Very Hard (+300)</option> </select> <div class="dialog-buttons"> <button id="deadlineConfirmBtn">Set</button> <button id="deadlineCancelBtn">Cancel</button> </div> </div> </div>
        <div id="sessionCompleteDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-check-circle"></i> Session Done!</h3> <p>Great focus!</p> <p>Continue for +100 XP bonus?</p> <div class="dialog-buttons"> <button id="sessionContinueBtn">Continue</button> <button id="sessionEndBtn">End</button> </div> </div> </div>
        <div id="mysteryBoxPopup" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-gift"></i> Mystery Box</h3> <p id="mysteryRewardText">Mystery box earned!</p> <div class="dialog-buttons"> <button id="openMysteryBox">Open</button> <button id="closeMysteryBoxBtn">Later</button> </div> </div> </div>
        <div id="audioTracksStore" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-store"></i> Audio Store</h3> <p>Unlock Lo-Fi tracks!</p> <div id="audioTracksList"></div> <div class="dialog-buttons" style="margin-top: 20px;"> <button id="closeAudioStore">Close</button> </div> </div> </div>
        <div id="pomodoroOverlay" class="dialog-overlay">
            <div id="pomodoroContainer">
                <h3><i class="fas fa-brain"></i> POMODORO</h3>
                <p>Focus deeply. Earn 1 XP per minute.</p>
                <!-- Custom Duration Input -->
                <div id="pomodoroDurationSetting">
                    <label for="pomodoroDurationInput">Duration (min):</label>
                    <input type="number" id="pomodoroDurationInput" value="60" min="1" max="180">
                </div>
                <!-- End Custom Duration Input -->
                <div id="pomodoroTimer">60:00</div>
                <div id="pomodoroStatus">Ready</div>
                <div id="pomodoroControls">
                    <button id="pomodoroStartBtn"><i class="fas fa-play"></i> START</button>
                    <button id="pomodoroResetBtn"><i class="fas fa-redo"></i> RESET</button>
                    <button id="pomodoroCloseBtn"><i class="fas fa-times"></i> CLOSE</button>
                </div>
            </div>
        </div>

        <!-- Audio Elements -->
        <audio id="focusAudio" preload="metadata" src="https://the-chosen-one-o5.github.io/UltraFocusModeYT/focus.mp3" loop></audio> <!-- Added loop attribute -->
        <audio id="lofiAudio" preload="metadata" loop></audio>
        <audio id="pomodoroCompleteAudio" preload="none" src="https://www.dropbox.com/scl/fi/ihrcv1s3o4m4abhn6oa5z/level-up-4-243762.mp3?rlkey=qkaf4zrhipxtxpu51an0do45r&st=boipxpb5&dl=1"></audio>
        <audio id="levelUpAudio" preload="none" src="https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1"></audio>
        <audio id="achievementAudio" preload="none" src="https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1"></audio>

    </div> <!-- End Game Container -->

    <!-- Firebase wiring (inline) -->
    <script type="module">
      // Reuse inline exports bound above, guarded to avoid ReferenceError if not ready yet
      const fbInlineSrc = (window.__fbInline ||= (window.__fbExports
        ? { auth: window.__fbExports.auth, onAuthStateChanged: window.__fbExports.onAuthStateChanged }
        : { auth: null, onAuthStateChanged: () => {} }));
      const { auth: navAuth, onAuthStateChanged } = fbInlineSrc;

      // Wait for the app's main script to define globals, then wire buttons
      const ready = () => {
        try { window.wireAuthButtons && window.wireAuthButtons(); } catch(e) { console.warn('wireAuthButtons error', e); }

        // Update nav user area when auth state changes (basic UI only)
        onAuthStateChanged(navAuth, (user) => {
          const area = document.getElementById('navUserArea');
          const photo = document.getElementById('navUserPhoto');
          const name = document.getElementById('navUserName');
          if (!area || !photo || !name) return;
          if (user) {
            area.style.display = 'flex';
            name.textContent = user.displayName || (user.email || '').split('@')[0] || 'You';
            if (user.photoURL) { photo.src = user.photoURL; photo.style.display = 'inline-block'; } else { photo.style.display = 'none'; }
          } else {
            area.style.display = 'none';
            name.textContent = '';
            photo.removeAttribute('src'); photo.style.display = 'none';
          }
        });
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ready, { once: true });
      } else {
        ready();
      }
    </script>


<script>
    // Wrap entire script in IIFE
    ;(() => {

        // !!! WARNING: Storing API keys directly in client-side JS is insecure for public apps.
        // This is acceptable ONLY for personal use or very low-traffic prototypes
        // with strict HTTP referrer restrictions set in Google Cloud Console.
        // Consider a backend proxy for better security if this becomes a serious project.
        const YOUTUBE_API_KEY = 'AIzaSyA16li1kPmHxCkcIw87ThOHmpBB1fuBPFY'; // <-- PASTE YOUR KEY HERE

        // --- State Variables ---
        let currentView = 'landingPage';
        let player; let videoIds = []; let currentVideoIndex = 0;
        let isFocusModeActive = false; let countdownInterval;
        let points = 0; let isSignedIn = false; let currentUser = null;
        const focusDuration = 50 * 60 * 1000; const firstBreakDuration = 15 * 60 * 1000; const secondBreakDuration = 10 * 60 * 1000;
        let timerMode = "Focus Time"; let timerRemaining = focusDuration / 1000;
        let completedVideos = new Set(); let allVideosCompleted = false;
        let totalFocusTime = 0; let totalDistractions = 0; let totalVideosWatched = 0;
        let playlists = []; let tasks = [];
        let previousPoints = 0; let streakDays = 0; let lastFocusDate = null;
        let isYouTubeAPILoaded = false;
        let lofiAudio, focusAudioElement;
        let currentLofiIndex = 0; let currentTaskForDeadline = null;
        let isSidebarOpen = false; let isVideoSidebarOpen = false;

        // Pomodoro State
        let pomodoroInterval;
        let pomodoroTimeRemaining = 60 * 60; // Default 60 minutes in seconds
        let isPomodoroActive = false;
        let pomodoroDistractionCount = 0;
        let currentPomodoroDurationSetting = 60; // Default duration in minutes

        // Notification State
        let browserNotificationsEnabled = false; // User setting (opt-in)
        let browserNotificationPermission = 'default'; // 'default', 'granted', 'denied'
        const NOTIFICATION_LEAD_TIME = 30 * 60 * 1000; // 30 minutes in milliseconds
        let sentNotificationTaskIds = new Set(); // Track notifications sent in this session
        let generalInterval; // For periodic checks

        let mysteryBoxCount = 0;
        let activePowerUps = { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, };
        const STREAK_SHIELD_COST = 800; const STREAK_SHIELD_DURATION = 7 * 24 * 60 * 60 * 1000;
        const DOUBLE_POINTS_COST = 800; const DOUBLE_POINTS_DURATION = 24 * 60 * 60 * 1000;
        const MYSTERY_BOX_STREAK_INTERVAL = 14;
        const POMODORO_DISTRACTION_PENALTY = 20; // Penalty per distraction
        const POMODORO_MAJOR_PENALTY_THRESHOLD = 5; // Distraction count for major penalty
        const POMODORO_MAJOR_PENALTY_AMOUNT = 400; // Major penalty amount
        const POMODORO_WARNING_THRESHOLD = 4; // Distraction count for warning
        const mysteryBoxRewards = [ { type: "points", value: () => Math.floor(Math.random() * 451) + 50, message: (val) => `+${val} XP` }, { type: "doublePoints", value: DOUBLE_POINTS_DURATION, message: () => "Double XP (24h)" }, { type: "streakShield", value: STREAK_SHIELD_DURATION, message: () => "Streak Shield (1w)" }, { type: "lofiTrack", message: () => "Unlock Lofi Track" }, ];
        const baseLofiSongs = [ "https://www.dropbox.com/scl/fi/7qrgbk6vpej7x0ih7vev2/1-6_XRwBX7NX-1.mp3?rlkey=m3gntnys7az2hoq0iokkajucj&st=bmrhzjy8&dl=1", "https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1", "https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1", ];
        let premiumLofiTracks = [ { id: "track1", name: "Celestial", url: "https://www.dropbox.com/scl/fi/3xkks3j4tcmnloz46o03m/Kyle-Dixon-Michael-Stei-Kids.mp3?rlkey=6w97eurecqph68b8f2r7zn5pf&st=epeucz72&dl=1", unlocked: false, cost: 150 }, { id: "track2", name: "Midnight", url: "https://www.dropbox.com/scl/fi/7vikjhsay7xayyab0tlvt/enchanted-metamorphosis-chronicles-264087.mp3?rlkey=mrdncvjr3g5bo8dksxywh9zxh&st=ui3kdsq5&dl=1", unlocked: false, cost: 150 }, { id: "track3", name: "Rainy", url: "https://www.dropbox.com/scl/fi/iaouozc1osse7h5ea9lon/thunder-chosic.com.mp3?rlkey=o7u0rarnh4kk657qhmcgyiolz&st=2r9f625j&dl=1", unlocked: false, cost: 200 }, { id: "track4", name: "Dark Academia âœ¨", url: "https://www.dropbox.com/scl/fi/6gbti0c7ka2e3lc1kj895/Toxic-Drunker-a-playlist-to-romanticize-studying-physics-dark-academia-playlist.mp3?rlkey=xfo51y00j6tbuozey81c5cfub&st=lvu3uvvp&dl=1", unlocked: false, cost: 1000 }, { id: "track5", name: "Aria Math", url: "https://www.dropbox.com/scl/fi/nqgmray2um9mjtm9stjk9/aria_math_credit_to_c4.mp3?rlkey=99e4kgsulvy1k738piy17iiye&st=uj9t230p&dl=1", unlocked: false, cost: 800 }, { id: "track6", name: "Apollo 11", url: "https://www.dropbox.com/scl/fi/6gl1bhdz9pe8ymjyh0jgd/RevenantEntertainment-kataruma-dont-worry-ill-always-be-here-for-you.mp3?rlkey=ntodkwanh7by2r2nyuw7cht1x&st=mbs2fozn&dl=1", unlocked: false, cost: 800 }, { id: "track7", name: "Aatma rama lofi", url: "https://www.dropbox.com/scl/fi/55vg6j03lwhlmi4eoqual/Aatma-Rama-_-Raghu-X-Stereo-India.mp3?rlkey=25klv8ao9wt63wq65ol33oub&st=w68o3ka6&dl=1", unlocked: false, cost: 500 }, { id: "track8", name: "The greatest song ever made ðŸ‘¾", url: "https://www.dropbox.com/scl/fi/hrbitky0j4l92zya0gvrg/If-You-re-A-Gamer-This-Song-FOUND-You-4.mp3?rlkey=4kevn083g6iz20bcmh5o6kizw&st=jp2zojra&dl=1", unlocked: false, cost: 1000 } , { id: "track9", name: "Minecraft Music", url: "https://www.dropbox.com/scl/fi/ux9xrruz6lm9a4v6gxwci/A-Minecraft-Movie-Soundtrack-_-Minecraft-from-A-Minecraft-Movie-Mark-Mothersbaugh-_-WaterTower-0.mp3?rlkey=g1xufj61oamoub6y97pzqjn9i&st=ke6mjj22&dl=1", unlocked: false, cost: 1000 } , { id: "track9", name: "Minecraft Music extended", url: "https://www.dropbox.com/scl/fi/buiewhxmbx9q19t2ir54q/Minecraft-Movie-Theme-_-EXTENDED-ORCHESTRAL-VERSION-_A-Minecraft-Movie_-Soundtrack-4.mp3?rlkey=p7melu9j1d9q0x4lh2116s8xz&st=s20iizbq&dl=1", unlocked: false, cost: 1000 } ];
        let availableLofiSongs = [...baseLofiSongs];
        const achievementLevels = [ { points: 0, level: "Mortal", color: "white" }, { points: 1000, level: "Soldier", color: "#4169E1" }, { points: 2000, level: "Knight", color: "#e0e0ff", glow: true }, { points: 3000, level: "KING", color: "#ff8c00", glow: true }, { points: 4000, level: "GIGACHAD", color: "#ff4500", glow: true }, { points: 5000, level: "Demigod", color: "gold", glow: true }, { points: 6000, level: "Titan", color: "gold", glow: true, box: true }, { points: 7000, level: "Immortal", color: "gold", glow: true, box: true, boxGlow: true }, { points: 8000, level: "Celestial", color: "#00BFFF", glow: true, box: true, boxGlow: true }, { points: 9000, level: "Divine", color: "rainbow" }, { points: 10000, level: "Omnipotent", color: "rainbow", glow: true }, ];
        const motivationalQuotes = [ "Focus is key.", "Step by step.", "Progress > perfection.", "You got this!", "Stay sharp.", "Embrace challenge." ];

        // --- Calendar State ---
        let dailyFocusData = {}; // Stores { 'YYYY-MM-DD': { focusTime: seconds, distractions: count } }
        let currentSessionFocusTime = 0; // Tracks focus time within the current YT or Pomodoro session
        let calendarCurrentDate = new Date(); // Tracks the month/year displayed in the calendar

        // --- DOM References ---
        let topNavBar, landingPage, signinForm, homePage, youtubeLecturePage, profilePage, focusStatsPage;
        let playerContainer, playerDiv, timerDisplay, timerText, progressBar, progressFill, pointsDisplay;
        let achievementLevelDiv, lofiPlayer, aiPopup, fireBox, videoSidebar, videoThumbnailList;
        let usernameInput, passwordInput, homeUsernameSpan, dateTimeDisplaySpan, focusStatusSpan;
        let playlistSelect, urlInputsContainer, playlistNameInput, youtubeInputContainer;
        let todoListPopup, tasksContainer;
        let confirmationDialog, streakShieldDialog, doublePointsDialog, deadlineDialog, sessionCompleteDialog, mysteryBoxPopup, audioTracksStore, pomodoroOverlay;
        let gameSidebar, sidebarTrigger;
        let navClockTime, navClockPeriod, navStreakDisplay, videoSidebarToggleBtn, navProfileBtn;
        let calendarGrid, calendarMonthYear, prevMonthBtn, nextMonthBtn; // Calendar elements
        let pomodoroTimerEl, pomodoroDurationInput, pomodoroStatusEl, pomodoroStartBtn, pomodoroResetBtn; // Pomodoro elements
        let todoBadgeEl; // <-- New Ref for To-Do badge
        let browserNotificationSettingCheckbox; // <-- New Ref for Notification setting
        let upcomingTaskDisplayEl; // <-- New Ref for Upcoming Task display
        
        // --- Core App Logic (functions like showView, startTimer, etc.) ---
        // Paste all the functions from the original script here, from showView down to the end...
        // ... (The large block of functions is omitted for brevity, but you should paste it here) ...
        function showView(viewId) {
            console.log("Show View:", viewId);
            if (!document.getElementById(viewId)) { console.error(`View "${viewId}" missing!`); viewId = 'landingPage'; }
            const protectedViews = ['homePage', 'youtubeLecturePage', 'profile', 'focusStats', 'pyqEmbedPage'];
            // Check Supabase session for auth
            const getUser = () => window.__sbUser || null;
            const u = getUser();
            if (u && !isSignedIn) { isSignedIn = true; currentUser = u.id; }
            if (protectedViews.includes(viewId) && !isSignedIn) { console.warn(`Access denied to "${viewId}".`); showView('signinForm'); return; }
                            document.querySelectorAll('.page-view').forEach(v => v.style.display = 'none');
                            const targetView = document.getElementById(viewId); targetView.style.display = 'flex'; currentView = viewId;
                            const showNav = isSignedIn && (viewId !== 'landingPage' && viewId !== 'signinForm');
                            const showShared = isSignedIn && (viewId === 'homePage' || viewId === 'youtubeLecturePage' || viewId === 'pyqEmbedPage');
                            if(topNavBar) topNavBar.style.display = showNav ? 'flex' : 'none';
                            if(pointsDisplay) pointsDisplay.style.display = showNav ? 'block' : 'none';
                            if(achievementLevelDiv) achievementLevelDiv.style.display = showNav ? 'block' : 'none';
                            if(lofiPlayer) lofiPlayer.style.display = showShared ? 'block' : 'none';
                            if(fireBox) fireBox.style.display = showShared ? 'flex' : 'none';
                            // Hide or show sidebar trigger/sidebar via CSS class on body
                            const bodyEl = document.body;
                            if (bodyEl) {
                                if (!isSignedIn || viewId === 'landingPage' || viewId === 'signinForm') {
                                    bodyEl.classList.add('hide-menu');
                                } else {
                                    bodyEl.classList.remove('hide-menu');
                                }
                            }

                            // YT Page UI Logic
                            if (viewId === 'youtubeLecturePage') {
                                const showInput = !isFocusModeActive; const showPlayerArea = isFocusModeActive; const showMultiVideoUI = showPlayerArea && videoIds.length > 1;
                                if(youtubeInputContainer) youtubeInputContainer.style.display = showInput ? 'block' : 'none';
                                if(playerContainer) playerContainer.style.display = showPlayerArea ? 'block' : 'none';
                                if(videoSidebar) videoSidebar.style.display = showMultiVideoUI ? 'block' : 'none';
                                if(videoSidebarToggleBtn) videoSidebarToggleBtn.style.display = showMultiVideoUI ? 'block' : 'none';
                                if(timerDisplay) timerDisplay.style.display = showPlayerArea ? 'block' : 'none';
                                const controls = document.getElementById('youtubeLecturePageControls'); if(controls) controls.style.display = showPlayerArea ? 'flex' : 'none';
                                if (showInput) { if (isSignedIn) { populatePlaylistSelect(); restoreUrlInputs(); } }
                                if (showPlayerArea) { highlightCurrentThumbnail(); } else { closeVideoSidebar(); }
                            } else if (viewId === 'pyqEmbedPage') {
                                // nothing extra for now
                            } else {
                                if(timerDisplay) timerDisplay.style.display = 'none'; if(videoSidebar) videoSidebar.style.display = 'none'; if(videoSidebarToggleBtn) videoSidebarToggleBtn.style.display = 'none'; const controls = document.getElementById('youtubeLecturePageControls'); if(controls) controls.style.display = 'none'; if(playerContainer) playerContainer.style.display = 'none'; closeVideoSidebar();
                                if (player && typeof player.pauseVideo === 'function' && player.getPlayerState && player.getPlayerState() === YT.PlayerState.PLAYING) { player.pauseVideo(); console.log("Paused video: view change."); }
                            }

                            // View Specific Updates
                            if (viewId === 'homePage') { updateHomePageInfo(); displayRandomMotivation(); updateUpcomingTaskDisplay(); /* Update task on home view */ }
                            else if (viewId === 'profile') { displayProfileInfo(); }
                            else if (viewId === 'focusStats') { displayFocusStatsInfo(); showCalendar(); /* Show calendar when view loads */ }

                            closeSidebar(); saveState();
                        }

        function updateHomePageInfo() { if (homeUsernameSpan) homeUsernameSpan.textContent = currentUser || "Hero"; updateDateTimeDisplay(); updateFocusStatus(); }
        function updateDateTimeDisplay() { const dateEl = dateTimeDisplaySpan; if (!dateEl) return; const now = new Date(); const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }; dateEl.textContent = `${now.toLocaleDateString(undefined, optionsDate)}`; }
        function updateFocusStatus() { if (!focusStatusSpan) return; const incompleteTasks = tasks.filter(task => !task.completed).length; if (isFocusModeActive) { focusStatusSpan.textContent = `Focusing on ${timerMode}...`; focusStatusSpan.style.color = 'var(--success)'; } else if (isPomodoroActive) { focusStatusSpan.textContent = `Pomodoro active!`; focusStatusSpan.style.color = 'var(--success)'; } else if (incompleteTasks > 0) { focusStatusSpan.textContent = `${incompleteTasks} quest${incompleteTasks > 1 ? 's' : ''} remaining!`; focusStatusSpan.style.color = 'var(--accent-alt)'; } else if (tasks.length > 0) { focusStatusSpan.textContent = "All quests complete!"; focusStatusSpan.style.color = 'var(--success)'; } else { focusStatusSpan.textContent = "Ready to add quests?"; focusStatusSpan.style.color = 'var(--text-dim)'; } }
        function displayRandomMotivation() { const quoteElement = document.getElementById('motivationQuote'); if (quoteElement) { const randomIndex = Math.floor(Math.random() * motivationalQuotes.length); quoteElement.textContent = `"${motivationalQuotes[randomIndex]}"`; } }

        function displayProfileInfo() {
            const usernameEl = document.getElementById('profileUsername'); const levelEl = document.getElementById('profileLevel'); const xpEl = document.getElementById('profileXP'); const streakEl = document.getElementById('profileStreak'); const iconEl = document.getElementById('profileIcon');
            const notificationCheckbox = document.getElementById('browserNotificationSetting'); // Get checkbox
            if (!usernameEl || !levelEl || !xpEl || !streakEl || !iconEl || !notificationCheckbox) { console.error("Profile elements missing!"); return; }
            usernameEl.textContent = currentUser || 'Guest';
            const levelInfo = getAchievementLevel(points);
            levelEl.textContent = levelInfo.level; levelEl.className = 'level'; levelEl.style.color = ''; if (levelInfo.color === 'rainbow') { levelEl.classList.add('rainbow'); } else { levelEl.style.color = levelInfo.color; } if (levelInfo.glow) levelEl.classList.add('level-glow');
            xpEl.textContent = points;
            streakEl.textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`;
            let iconClass = 'fa-user'; if (levelInfo.points >= 8000) iconClass = 'fa-gem'; else if (levelInfo.points >= 5000) iconClass = 'fa-crown'; else if (levelInfo.points >= 2000) iconClass = 'fa-user-shield'; iconEl.innerHTML = `<i class="fas ${iconClass}"></i>`;

            // Update notification setting checkbox
            notificationCheckbox.checked = browserNotificationsEnabled;
            // Optionally disable if permission is denied
                notificationCheckbox.disabled = browserNotificationPermission === 'denied';
        }

        function displayFocusStatsInfo() {
            const focusTimeEl = document.getElementById('statsTotalFocusTime'); const distractionsEl = document.getElementById('statsTotalDistractions'); const videosEl = document.getElementById('statsTotalVideosWatched'); const streakEl = document.getElementById('statsCurrentStreak');
            if (!focusTimeEl || !distractionsEl || !videosEl || !streakEl) { console.error("Stats elements missing!"); return; }
            const hours = Math.floor(totalFocusTime / 3600); const minutes = Math.floor((totalFocusTime % 3600) / 60); let focusTimeString = ""; if (hours > 0) focusTimeString += `${hours}h `; focusTimeString += `${minutes}m`; if(hours === 0 && minutes === 0) focusTimeString = "0m";
            focusTimeEl.textContent = focusTimeString;
            distractionsEl.textContent = totalDistractions; // This is total across all sessions
            videosEl.textContent = totalVideosWatched;
            streakEl.textContent = `${streakDays} day${streakDays === 1 ? '' : 's'}`;
            // Calendar is updated separately by showCalendar()
        }

        function initAudio() {
                lofiAudio = document.getElementById("lofiAudio");
                focusAudioElement = document.getElementById("focusAudio");
                updateAvailableLofiTracks();
                if (lofiAudio && availableLofiSongs.length > 0) {
                    currentLofiIndex = Math.floor(Math.random() * availableLofiSongs.length);
                    lofiAudio.src = availableLofiSongs[currentLofiIndex];
                    const playBtn = document.getElementById('lofiPlay');
                    const pauseBtn = document.getElementById('lofiPause');
                    if(playBtn) playBtn.style.display = 'inline-block';
                    if(pauseBtn) pauseBtn.style.display = 'none';
                    lofiAudio.load(); // Preload metadata
                } else {
                    console.warn("Lofi audio init failed.");
                    document.querySelectorAll('#lofiPlayer button').forEach(btn => btn.disabled = true);
                }
                if (focusAudioElement) {
                    focusAudioElement.loop = true; // Ensure loop is set
                    focusAudioElement.load(); /* Preload */
                }
                else { console.error("Focus audio element missing!"); }
        }

        function updateAvailableLofiTracks() { const unlockedPremiumUrls = premiumLofiTracks.filter(track => track.unlocked).map(track => track.url); availableLofiSongs = [...new Set([...baseLofiSongs, ...unlockedPremiumUrls])]; if (lofiAudio && !availableLofiSongs.includes(lofiAudio.src)) { currentLofiIndex = 0; if (availableLofiSongs.length > 0) { lofiAudio.src = availableLofiSongs[currentLofiIndex]; lofiAudio.load(); } else { lofiAudio.removeAttribute('src'); } } console.log("Available Lofi:", availableLofiSongs.length); document.querySelectorAll('#lofiPlayer button').forEach(btn => btn.disabled = availableLofiSongs.length === 0); }
        function getAchievementLevel(currentPoints) { let currentLevel = achievementLevels[0]; for (const level of achievementLevels) { if (currentPoints >= level.points) { currentLevel = level; } else { break; } } return currentLevel; }
        function updateAchievementLevel() { if (!achievementLevelDiv || !isSignedIn) return; const level = getAchievementLevel(points); achievementLevelDiv.textContent = level.level; achievementLevelDiv.className = 'level-default'; achievementLevelDiv.removeAttribute('style'); achievementLevelDiv.classList.remove('rainbow', 'level-glow', 'level-box-glow'); achievementLevelDiv.style.border = '2px solid var(--secondary)'; if (level.color === 'rainbow') { achievementLevelDiv.classList.add('rainbow'); } else { achievementLevelDiv.style.color = level.color; } if (level.glow) achievementLevelDiv.classList.add('level-glow'); if (level.box) achievementLevelDiv.style.border = '2px solid var(--gold)'; if (level.boxGlow) achievementLevelDiv.classList.add('level-box-glow'); if (currentView === 'profile') displayProfileInfo(); }
        function playSound(soundId) { const audio = document.getElementById(soundId); if (audio) { audio.currentTime = 0; audio.play().catch(err => console.warn(`Audio error (${soundId}):`, err.message)); } }
        // Guarded SFX that must never interfere with lofi state
        function playSfx(soundId) {
            const el = document.getElementById(soundId);
            if (!el) return;
            try { el.currentTime = 0; el.volume = 1.0; el.play().catch(e => console.warn(`SFX ${soundId} blocked:`, e?.message||e)); } catch(e){ console.warn('SFX error:', e?.message||e); }
        }
        function showAchievementOverlay(message) { const overlay = document.getElementById("achievementOverlay"); if (!overlay) return; overlay.textContent = message; overlay.style.display = "flex"; playSfx('levelUpAudio'); setTimeout(() => { overlay.style.display = "none"; }, 5000); }
        function updateClock() { if (!navClockTime || !navClockPeriod) return; const now = new Date(); let hours = now.getHours(); const minutes = now.getMinutes().toString().padStart(2, "0"); const seconds = now.getSeconds().toString().padStart(2, "0"); const period = hours >= 12 ? "PM" : "AM"; hours = hours % 12 || 12; hours = hours.toString().padStart(2, "0"); navClockTime.textContent = `${hours}:${minutes}:${seconds}`; navClockPeriod.textContent = period; if (currentView === 'homePage') { updateDateTimeDisplay(); } }

        // Lofi intent flag: only user click can start playback
        let lofiUserInitiated = false;

        function syncLofiUi() {
            const playBtn = document.getElementById('lofiPlay');
            const pauseBtn = document.getElementById('lofiPause');
            const isPlaying = !!lofiAudio && !lofiAudio.paused;
            if (playBtn) playBtn.style.display = isPlaying ? 'none' : 'inline-block';
            if (pauseBtn) pauseBtn.style.display = isPlaying ? 'inline-block' : 'none';
        }

        function playLofi(fromUserClick = false) {
            if (fromUserClick) lofiUserInitiated = true;
            if (!lofiUserInitiated) return; // block programmatic auto-starts
            if (!lofiAudio || availableLofiSongs.length === 0) return;
            // ensure src set
            if (!lofiAudio.src) {
                currentLofiIndex = Math.max(0, Math.min(currentLofiIndex, availableLofiSongs.length - 1));
                lofiAudio.src = availableLofiSongs[currentLofiIndex];
                lofiAudio.load();
            }
            lofiAudio.play().then(syncLofiUi).catch(err => console.error("Lofi play error:", err));
        }
        function pauseLofi() {
            if (!lofiAudio) return;
            try { lofiAudio.pause(); } catch {}
            syncLofiUi();
        }
        function nextLofi() {
            if (!lofiAudio || availableLofiSongs.length <= 1) return;
            currentLofiIndex = (currentLofiIndex + 1) % availableLofiSongs.length;
            lofiAudio.src = availableLofiSongs[currentLofiIndex];
            lofiAudio.load();
            playLofi(false); // honor intent; do not force-start if user hasn't initiated
        }
        function prevLofi() {
            if (!lofiAudio || availableLofiSongs.length <= 1) return;
            currentLofiIndex = (currentLofiIndex - 1 + availableLofiSongs.length) % availableLofiSongs.length;
            lofiAudio.src = availableLofiSongs[currentLofiIndex];
            lofiAudio.load();
            playLofi(false);
        }

        // --- Modified Streak Logic (REFINED) ---
        function updateStreak() {
            if (!isSignedIn) return;

            const today = new Date().toDateString(); // e.g., "Thu Aug 15 2024"
            console.log(`[Streak Check] START - User: ${currentUser}, Current Streak: ${streakDays}, Last Saved Focus Date: ${lastFocusDate}, Today is: ${today}`);

            let needsSave = false; // Flag to check if we need to save state later

            // --- Primary Logic: Check if this is the first focus session *today* ---
            if (lastFocusDate !== today) {
                // It's either the very first session ever, or the first session on a new day.
                console.log("[Streak Check] First check for today. Evaluating streak...");

                if (lastFocusDate) {
                    // User has focused before, check the gap.
                    const last = new Date(lastFocusDate);
                    const todayDate = new Date(today);
                    // Ensure we compare date parts only, ignoring time within the day
                    last.setHours(0, 0, 0, 0);
                    todayDate.setHours(0, 0, 0, 0);

                    const diffTime = todayDate - last;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Calculate difference in full days

                    console.log(`[Streak Check] Date diff calculated. DiffDays: ${diffDays}`);

                    if (diffDays === 1) {
                        // Consecutive day
                        streakDays++;
                        needsSave = true;
                        checkMysteryBoxMilestone();
                        console.log("[Streak Check] Streak incremented to:", streakDays);
                    } else if (diffDays > 1) {
                        // Missed one or more days
                        console.log("[Streak Check] Missed days detected (gap > 1).");
                        // Check shield BEFORE resetting
                        if (activePowerUps.streakShield.active && Date.now() < activePowerUps.streakShield.expiry && !activePowerUps.streakShield.used) {
                            // Use the shield - STREAK IS MAINTAINED
                            activePowerUps.streakShield.used = true;
                            needsSave = true; // Shield state changed
                            showConfirmation("Shield Used!", "Streak Shield protected your focus streak!", false);
                            console.log("[Streak Check] Streak Shield used. Streak maintained at:", streakDays);
                            // Streak count doesn't change here, only shield status
                        } else {
                            // NO SHIELD or shield expired/used - RESET STREAK
                            console.log("[Streak Check] No active/usable shield. Streak broken. Resetting to 1.");
                            streakDays = 1; // <--- RESET TO 1 DAY (start new streak)
                            if (activePowerUps.streakShield.active) activePowerUps.streakShield.used = false; // Reset shield status if it was active but expired/used
                            needsSave = true;
                        }
                    } else if (diffDays <= 0 && lastFocusDate !== today) {
                            // Handles edge cases: same day check after midnight OR date anomaly (lastFocusDate is today or future)
                            // If it's *not* the first session ever (lastFocusDate exists) but diffDays isn't 1 or >1,
                            // it implies either an issue or focusing again on the same calendar day after previously focusing.
                            // In the specific case where lastFocusDate !== today but diffDays is 0 (e.g., timezone issues), reset.
                            // If diffDays < 0 (anomaly), also reset.
                            // If diffDays is 0 AND lastFocusDate IS today, this whole outer 'if' block wouldn't run.
                            console.warn(`[Streak Check] Unusual date difference (diffDays: ${diffDays}). Resetting streak to 1.`);
                            streakDays = 1;
                            needsSave = true;
                    }
                    // Note: If diffDays is 0 and lastFocusDate *is* today, this block is skipped entirely, which is correct.

                } else {
                    // This is the very first focus session ever for this user.
                    streakDays = 1;
                    needsSave = true;
                    console.log("[Streak Check] First focus session ever, starting streak at 1.");
                }

                // IMPORTANT: Update lastFocusDate to today *because* it was the first check of the day and might have resulted in a streak change.
                console.log(`[Streak Check] Updating lastFocusDate to ${today}.`);
                lastFocusDate = today;
                needsSave = true; // Need to save the new date

            } else {
                // It's not the first session today. Streak/Date remains unchanged.
                console.log("[Streak Check] Already focused today. Streak/Date not modified.");
            }

            // --- Post-Check Actions ---

            // Always log the focus time accumulated *before* this new session started.
            // This ensures focus time from the *previous* session gets logged correctly.
            logDailyFocus();

            // Update the UI display for the streak if it might have changed
            updateStreakDisplay();

            // Save state ONLY if streak, shield status, or lastFocusDate was modified.
            if (needsSave) {
                console.log("[Streak Check] Saving state due to changes.");
                saveState();
            }

            console.log(`[Streak Check] END - User: ${currentUser}, Current Streak: ${streakDays}, Last Focus Date Updated To: ${lastFocusDate}`);
        }

        // --- New Function to Log Daily Focus Time ---
        function logDailyFocus() {
            if (!isSignedIn || currentSessionFocusTime <= 0) return;

            const today = new Date();
            const dateString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`; // YYYY-MM-DD format

            if (!dailyFocusData[dateString]) {
                dailyFocusData[dateString] = { focusTime: 0, distractions: 0 }; // Initialize if needed
            }

            dailyFocusData[dateString].focusTime += currentSessionFocusTime;
            // We could also add distractions logged during this session if tracked separately
            // dailyFocusData[dateString].distractions += currentSessionDistractions;

            console.log(`Logged ${currentSessionFocusTime}s focus for ${dateString}. Total today: ${dailyFocusData[dateString].focusTime}s`);

            currentSessionFocusTime = 0; // Reset session timer after logging
            // No need to call saveState() here, as it's called after updateStreak completes.
        }

        // Paste ALL other helper and logic functions from the original script here...
        // This includes updateStreakDisplay, checkMysteryBoxMilestone, showPomodoroOverlay, startTimer, endFocusSession, etc.
        // The final function in this block should be setupEventListeners.
        
        async function saveState() {
            // This function remains largely the same, but now it will successfully save to Supabase
            // because the tables and RLS policies exist.
            if (!isSignedIn || !currentUser) return; // Don't save if not logged in

            const stateToSave = {
                points, totalFocusTime, totalDistractions, totalVideosWatched,
                streakDays, lastFocusDate, mysteryBoxCount, activePowerUps,
                premiumLofiTracks: premiumLofiTracks.map(t => ({ id: t.id, unlocked: t.unlocked })),
                dailyFocusData,
                browserNotificationsEnabled,
                currentPomodoroDurationSetting,
                currentView
            };

            const taskDataToSave = tasks;
            const playlistDataToSave = playlists;

            try {
                // This now uses the Supabase client defined in the other script tag
                const { error: stateError } = await window.__sb.client
                    .from('app_state')
                    .upsert({ user_id: currentUser, ...stateToSave }, { onConflict: 'user_id' });
                if (stateError) console.error("Supabase state save error:", stateError);

                // For tasks and playlists, we'll replace them to ensure sync
                await window.__sb.replaceTasks(taskDataToSave);
                await window.__sb.upsertPlaylists(playlistDataToSave); // upsertPlaylists already handles replace logic
                
                console.log("State saved to Supabase for user:", currentUser);
            } catch (err) {
                console.error("Error saving state to Supabase:", err);
            }
        }

        async function loadState(user) {
            // This function will now load data from Supabase
            if (!user) return;
            isSignedIn = true;
            currentUser = user.id;

            try {
                const { data, error } = await window.__sb.client
                    .from('app_state')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();

                if (error && error.code !== 'PGRST116') { // Ignore 'PGRST116' (No rows found)
                    console.error("Supabase load error:", error);
                    return;
                }

                if (data) {
                    // Apply loaded state
                    points = data.points || 0;
                    previousPoints = points;
                    totalFocusTime = data.total_focus_time || 0;
                    totalDistractions = data.total_distractions || 0;
                    totalVideosWatched = data.total_videos_watched || 0;
                    streakDays = data.streak_days || 0;
                    lastFocusDate = data.last_focus_date || null;
                    mysteryBoxCount = data.mystery_box_count || 0;
                    activePowerUps = data.active_power_ups || { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null } };
                    dailyFocusData = data.daily_focus_data || {};
                    browserNotificationsEnabled = data.browser_notifications_enabled || false;
                    currentPomodoroDurationSetting = data.current_pomodoro_duration_setting || 60;
                    const savedTracks = data.premium_lofi_tracks || [];
                    premiumLofiTracks.forEach(track => {
                        const saved = savedTracks.find(st => st.id === track.id);
                        track.unlocked = saved ? saved.unlocked : false;
                    });
                    updateAvailableLofiTracks();
                }

                // Load tasks and playlists
                const { data: taskData } = await window.__sb.client.from('tasks').select('*').eq('user_id', user.id);
                tasks = taskData || [];

                const { data: playlistData } = await window.__sb.client.from('playlists').select('*').eq('user_id', user.id);
                playlists = playlistData || [];

                // Update UI
                if(pointsDisplay) pointsDisplay.innerHTML = `<span style="color: var(--secondary);">â­</span> XP: ${points}`;
                updateAchievementLevel();
                updateStreakDisplay();
                await restoreTasks();
                checkExpiredPowerups();
                sentNotificationTaskIds.clear();
                startPeriodicChecks();
                
                showView('homePage');

            } catch (err) {
                console.error("Error loading state from Supabase:", err);
            }
        }

        // --- App Initialization ---
        document.addEventListener("DOMContentLoaded", () => {
            console.log("DOM Loaded.");
            // Cache DOM elements
            topNavBar = document.getElementById('topNavBar'); landingPage = document.getElementById('landingPage'); signinForm = document.getElementById('signinForm'); homePage = document.getElementById('homePage'); youtubeLecturePage = document.getElementById('youtubeLecturePage'); profilePage = document.getElementById('profile'); focusStatsPage = document.getElementById('focusStats');
            playerContainer = document.getElementById('playerContainer'); playerDiv = document.getElementById('player'); timerDisplay = document.getElementById('timerDisplay'); timerText = document.getElementById('timerText'); progressBar = document.getElementById('progressBar'); progressFill = document.getElementById('progressFill'); pointsDisplay = document.getElementById('pointsDisplay'); achievementLevelDiv = document.getElementById('achievementLevel'); lofiPlayer = document.getElementById('lofiPlayer'); aiPopup = document.getElementById('aiPopup'); fireBox = document.getElementById('fireBox'); videoSidebar = document.getElementById('videoSidebar'); videoThumbnailList = document.getElementById('videoThumbnailList'); usernameInput = document.getElementById('username'); passwordInput = document.getElementById('password'); homeUsernameSpan = document.getElementById('homeUsername'); dateTimeDisplaySpan = document.getElementById('dateTimeDisplay'); focusStatusSpan = document.getElementById('focusStatus'); youtubeInputContainer = document.getElementById('youtubeInputContainer'); playlistSelect = document.getElementById('playlistSelect'); urlInputsContainer = document.getElementById('urlInputs'); playlistNameInput = document.getElementById('playlistName'); todoListPopup = document.getElementById('todoList'); tasksContainer = document.getElementById('tasks'); confirmationDialog = document.getElementById('confirmationDialog'); streakShieldDialog = document.getElementById('streakShieldDialog'); doublePointsDialog = document.getElementById('doublePointsDialog'); deadlineDialog = document.getElementById('deadlineDialog'); sessionCompleteDialog = document.getElementById('sessionCompleteDialog'); mysteryBoxPopup = document.getElementById('mysteryBoxPopup'); audioTracksStore = document.getElementById('audioTracksStore'); pomodoroOverlay = document.getElementById('pomodoroOverlay'); gameSidebar = document.querySelector('.game-sidebar'); sidebarTrigger = document.querySelector('.sidebar-trigger'); navClockTime = document.getElementById('navClockTime'); navClockPeriod = document.getElementById('navClockPeriod'); navStreakDisplay = document.getElementById('navStreakDisplay'); videoSidebarToggleBtn = document.getElementById('videoSidebarToggleBtn'); navProfileBtn = document.getElementById('navProfileBtn');
            focusAudioElement = document.getElementById('focusAudio');
            lofiAudio = document.getElementById("lofiAudio");
            calendarGrid = document.getElementById('calendarGrid'); calendarMonthYear = document.getElementById('calendarMonthYear'); prevMonthBtn = document.getElementById('prevMonthBtn'); nextMonthBtn = document.getElementById('nextMonthBtn');
            pomodoroTimerEl = document.getElementById('pomodoroTimer'); pomodoroDurationInput = document.getElementById('pomodoroDurationInput'); pomodoroStatusEl = document.getElementById('pomodoroStatus'); pomodoroStartBtn = document.getElementById('pomodoroStartBtn'); pomodoroResetBtn = document.getElementById('pomodoroResetBtn');
            todoBadgeEl = document.getElementById('todoBadge'); browserNotificationSettingCheckbox = document.getElementById('browserNotificationSetting'); upcomingTaskDisplayEl = document.getElementById('upcomingTaskDisplay');

            setupEventListeners();
            initAudio();
            setInterval(updateClock, 1000);
            updateClock();
            displayRandomMotivation();
            if(todoListPopup) todoListPopup.style.display = 'none';
            calendarCurrentDate = new Date();

            // NEW Auth Handling Logic
            window.__sb.client.auth.onAuthStateChange(async (_event, session) => {
                if (session && session.user) {
                    // User is signed in.
                    console.log("Auth state change: User is signed in.", session.user);
                    await loadState(session.user);
                } else {
                    // User is signed out.
                    console.log("Auth state change: User is signed out.");
                    isSignedIn = false;
                    currentUser = null;
                    showView('landingPage');
                }
            });

            console.log("Initialization complete.");
        });

    })();
</script>

                setInterval(updateClock, 1000);
                // Periodic checks are started *after* successful login/restore in loadSavedState()

                displayRandomMotivation();
                if(todoListPopup) todoListPopup.style.display = 'none'; // Ensure hidden initially
                calendarCurrentDate = new Date(); // Initialize calendar date

                console.log("Initialization complete.");
            });

        })();
    </script>
</body>

</html>

