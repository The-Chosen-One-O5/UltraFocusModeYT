<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Focus Mode</title>

    <!-- FIREBASE: Add the Firebase SDKs -->
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <!-- End Favicon Links -->

    <style>
        /* Your entire CSS block remains the same. It is very well written! */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4169e1; /* Royal Blue */
            --primary-dark: #1e3a8a; /* Darker Blue */
            --secondary: #8e2de2; /* Purple */
            --accent: #ff4500; /* OrangeRed */
            --accent-alt: #ff8c00; /* DarkOrange */
            --bg-dark: #0f0f1b; /* Very Dark Blue/Purple */
            --bg-medium: #1a1a2e; /* Dark Blue/Purple */
            --bg-light: #252538; /* Medium Dark Blue/Purple */
            --text: #e0e0ff; /* Light Lavender */
            --text-dim: #9090b0; /* Grayish Lavender */
            --gold: #ffd700;
            --success: #28a745; /* Green */
            --danger: #dc3545; /* Red */
            --info: #17a2b8; /* Teal */
            --warning: #ffc107; /* Yellow */
            --calendar-focus-low: rgba(65, 105, 225, 0.2);
            --calendar-focus-medium: rgba(65, 105, 225, 0.5);
            --calendar-focus-high: rgba(65, 105, 225, 0.8);
            --calendar-today-border: var(--accent);
            --timer-warning-color: var(--danger); /* Added for timer warning */
            --notification-badge-bg: var(--danger); /* Added for notification badge */
            --notification-badge-text: white; /* Added for notification badge text */
        }
        /* ... All your other CSS rules ... */
        html { scrollbar-width: thin; scrollbar-color: var(--secondary) var(--bg-medium); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-medium); }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 0; border: 2px solid var(--bg-medium); }
        body { background-color: var(--bg-dark); min-height: 100vh; font-family: 'Roboto Mono', monospace; color: var(--text); overflow-x: hidden; font-size: 16px; line-height: 1.6; }
        .game-container { width: 100%; min-height: 100vh; position: relative; overflow: hidden; background-image: radial-gradient(circle at 10% 20%, rgba(142, 45, 226, 0.1) 0%, transparent 25%), radial-gradient(circle at 90% 80%, rgba(65, 105, 225, 0.1) 0%, transparent 25%), linear-gradient(to bottom, var(--bg-dark) 0%, var(--bg-medium) 100%); display: flex; flex-direction: column; z-index: 1; }
        .game-container::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg width='8' height='8' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.04' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 5v1H5V0zm1 5v1H5v-1h1z'/%3E%3C/g%3E%3C/svg%3E"); pointer-events: none; z-index: 2; opacity: 0.5; }
        .page-view { width: 100%; flex-grow: 1; display: none; flex-direction: column; padding: 20px; position: relative; z-index: 10; overflow-y: auto; pointer-events: auto; }
        #landingPageContainer, #signinFormContainer { text-align: center; width: 100%; max-width: 700px; margin: auto; padding: 40px 30px; background-color: rgba(15, 15, 27, 0.85); border: 2px solid var(--secondary); border-radius: 12px; box-shadow: 0 0 25px rgba(142, 45, 226, 0.4); backdrop-filter: blur(4px); pointer-events: auto; }
        #landingPage, #signinForm { justify-content: center; align-items: center; }
        .title { font-family: 'Press Start 2P', cursive; font-size: 28px; font-weight: 400; color: var(--text); margin-bottom: 25px; text-shadow: 2px 2px 0px var(--primary-dark), 4px 4px 0px rgba(0,0,0,0.3); letter-spacing: 1px; line-height: 1.3; }
        .title span { color: var(--secondary); position: relative; display: inline-block; }
        .title span::after { content: ""; position: absolute; bottom: -6px; left: 5%; width: 90%; height: 3px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity: 0.8; }
        .subtitle { font-size: 18px; color: var(--text-dim); margin-bottom: 35px; font-family: 'Roboto Mono', monospace; }
        button { display: inline-block; padding: 10px 25px; font-size: 14px; font-family: 'Roboto Mono', monospace; font-weight: 600; background: var(--secondary); border: none; color: var(--text); border-radius: 4px; cursor: pointer; margin: 5px 8px 15px; transition: all 0.2s ease-in-out; position: relative; box-shadow: 3px 3px 0 var(--primary-dark); text-transform: uppercase; letter-spacing: 1px; z-index: 11; pointer-events: auto; outline: none; }
        button:hover:not(:disabled) { background: var(--primary); transform: translate(1px, 1px); box-shadow: 2px 2px 0 var(--primary-dark); }
        button:active:not(:disabled) { transform: translate(3px, 3px); box-shadow: none; }
        button:disabled { background: var(--bg-light); color: var(--text-dim); cursor: not-allowed; box-shadow: 2px 2px 0 var(--bg-medium); transform: none; opacity: 0.7; }
        .github-btn { background: var(--bg-light); box-shadow: 3px 3px 0 var(--bg-medium); }
        .github-btn:hover:not(:disabled) { background: var(--bg-medium); box-shadow: 2px 2px 0 var(--bg-medium); }
        .accent-btn { background: var(--accent); box-shadow: 3px 3px 0 #b33000; }
        .accent-btn:hover:not(:disabled) { background: var(--accent-alt); box-shadow: 2px 2px 0 #b33000; }
        .primary-btn { background: var(--primary); box-shadow: 3px 3px 0 var(--primary-dark); }
        .primary-btn:hover:not(:disabled) { background: var(--primary-dark); box-shadow: 2px 2px 0 var(--primary-dark); }
        #features { display: flex; justify-content: center; gap: 25px; margin-top: 40px; flex-wrap: wrap; z-index: 10; }
        .feature { background: var(--bg-light); padding: 20px; border-radius: 8px; width: 220px; box-shadow: 4px 4px 0 var(--bg-medium); border: 1px solid var(--primary); position: relative; overflow: hidden; z-index: 10; transition: transform 0.2s ease, box-shadow 0.2s ease; text-align: center; }
        .feature:hover { transform: translateY(-3px); box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.3); }
        .feature::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--primary), var(--secondary)); }
        .feature i { font-size: 28px; color: var(--secondary); margin-bottom: 12px; display: block; }
        .feature p { font-size: 15px; color: var(--text); text-align: center; }
        input[type="text"], input[type="password"], input[type="date"], input[type="time"], input[type="number"], select { display: block; width: 100%; margin: 15px auto; padding: 12px 15px; border-radius: 4px; font-size: 16px; font-family: 'Roboto Mono', monospace; background: var(--bg-light); border: 2px solid var(--primary); color: var(--text); outline: none; box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2); transition: border-color 0.3s, box-shadow 0.3s; z-index: 11; pointer-events: auto; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        input:focus, select:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(142, 45, 226, 0.3), inset 2px 2px 4px rgba(0, 0, 0, 0.2); }
        #topNavBar { width: 100%; height: 60px; background-color: rgba(15, 15, 27, 0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; padding: 0 25px; border-bottom: 1px solid rgba(65, 105, 225, 0.3); z-index: 200; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); pointer-events: auto; display: none; flex-shrink: 0; order: -1; }
        #navLogo { text-decoration: none; white-space: nowrap; display: flex; align-items: center; height: 100%; }
        #navLogo img { height: 50px; width: auto; object-fit: contain; filter: brightness(0.9) saturate(1.2); }
        #navClockContainer { font-family: 'Roboto Mono', monospace; font-size: 16px; color: var(--text-dim); text-align: center; flex-grow: 1; flex-shrink: 0; margin: 0 20px; white-space: nowrap; }
        #navClockTime { color: var(--primary); font-weight: 600; letter-spacing: 1px; }
        #navClockPeriod { color: var(--secondary); font-weight: 600; margin-left: 5px; }
        #navButtons { display: flex; align-items: center; gap: 20px; white-space: nowrap; }
        #navStreakDisplay { font-family: 'Roboto Mono', monospace; font-size: 15px; color: var(--accent); font-weight: 600; padding: 5px 10px; background-color: rgba(255, 69, 0, 0.1); border-radius: 4px; cursor: default; }
        #navStreakDisplay i { margin-right: 5px; font-style: normal; display: inline-block; }
        #navProfileBtn { background: none; border: none; color: var(--text-dim); font-size: 24px; cursor: pointer; padding: 5px; margin: 0; box-shadow: none; transition: color 0.2s ease, transform 0.2s ease; }
        #navProfileBtn:hover { color: var(--primary); transform: scale(1.1); box-shadow: none; }
        #homePage { justify-content: center; align-items: center; text-align: center; }
        #homePageContent { max-width: 600px; width: 90%; }
        #welcomeMessage { font-size: 24px; margin-bottom: 15px; color: var(--text); font-weight: 600; }
        #welcomeMessage span { font-weight: bold; color: var(--secondary); }
        #dateTimeDisplay { font-size: 18px; color: var(--text-dim); margin-bottom: 20px; }
        #upcomingTaskDisplay { font-size: 16px; color: var(--warning); margin-bottom: 25px; padding: 10px 15px; background-color: rgba(37, 37, 56, 0.7); border-radius: 6px; border-left: 4px solid var(--warning); min-height: 40px; display: inline-block; max-width: 90%; text-align: left; }
        #upcomingTaskDisplay i { margin-right: 8px; }
        #upcomingTaskDisplay.overdue { color: var(--danger); border-left-color: var(--danger); }
        #upcomingTaskDisplay.none { color: var(--text-dim); border-left-color: var(--text-dim); font-style: italic; }
        #focusStatus { font-size: 20px; color: var(--accent-alt); margin-bottom: 30px; font-weight: 600; min-height: 25px; padding: 10px; background-color: rgba(26, 26, 46, 0.5); border-radius: 6px; display: inline-block; }
        #motivationQuote { margin-top: 30px; font-size: 18px; color: var(--text-dim); font-style: italic; max-width: 500px; margin-left: auto; margin-right: auto; }
        #youtubeLecturePage { justify-content: flex-start; align-items: center; padding: 20px; gap: 20px; }
        #youtubeInputContainer { background-color: rgba(26, 26, 46, 0.7); padding: 20px 30px; border-radius: 10px; border: 1px solid var(--primary-dark); max-width: 800px; width: 95%; margin: 0 auto 20px auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); text-align: center; pointer-events: auto; display: block; }
        #youtubeInputContainer .subtitle { font-size: 18px; color: var(--text-dim); margin-bottom: 20px; font-family: 'Roboto Mono', monospace; }
        #urlInputs { margin: 0 auto 15px auto; max-width: 450px; width: 100%; pointer-events: auto; }
        .url-container { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .url-container input { margin: 0; flex-grow: 1; pointer-events: auto; max-width: none; }
        .url-container button { padding: 8px 12px; margin: 0; background: var(--danger); font-size: 12px; box-shadow: 2px 2px 0 rgba(167, 29, 42, 0.8); min-width: 35px; pointer-events: auto; flex-shrink: 0; }
        #youtubeInputContainer button[data-action="add-url"] { font-size: 12px; padding: 8px 15px; margin-bottom: 15px; pointer-events: auto; }
        #playlistManagement { display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 15px; flex-wrap: wrap; pointer-events: auto; }
        #playlistManagement select, #playlistManagement input { margin: 0; max-width: 180px; pointer-events: auto; }
        #playlistManagement button { margin: 0; padding: 10px 15px; font-size: 12px; pointer-events: auto; }
        #youtubeInputContainer button[data-action="start-playback"] { margin-top: 25px; padding: 12px 30px; display: block; margin-left: auto; margin-right: auto; pointer-events: auto; }
        #playerContainer { width: 100%; max-width: 1200px; aspect-ratio: 16 / 9; position: relative; margin: 0 auto; pointer-events: auto; display: none; }
        #player { width: 100%; height: 100%; border-radius: 0; overflow: hidden; background: #000; border: 4px solid var(--primary); box-shadow: 0 0 25px rgba(65, 105, 225, 0.6); z-index: 5; position: absolute; top: 0; left: 0; }
        #timerDisplay { position: fixed; top: 70px; left: 10px; color: var(--text); z-index: 101; cursor: move; padding: 10px 15px; background: rgba(26, 26, 46, 0.85); border: 1px solid var(--primary); border-radius: 4px; font-family: 'Roboto Mono', monospace; font-size: 16px; pointer-events: auto; box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); backdrop-filter: blur(5px); display: none; }
        #timerText { display: block; margin-bottom: 5px; }
        #progressBar { width: 180px; height: 8px; background: var(--bg-light); border: 1px solid var(--primary); border-radius: 2px; overflow: hidden; margin-top: 5px; z-index: 101; display: block; }
        #progressFill { height: 100%; width: 0; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: width 0.5s linear; border-radius: 1px; }
        #youtubeLecturePageControls { position: fixed; top: 70px; right: 10px; display: flex; flex-direction: column; gap: 10px; z-index: 103; display: none; pointer-events: auto; }
        #restartBtn { background: var(--danger); box-shadow: 3px 3px 0 #a71d2a; padding: 8px 15px; font-size: 12px; margin: 0; pointer-events: auto; }
        #restartBtn:hover:not(:disabled) { background: #c82333; box-shadow: 2px 2px 0 #a71d2a; }
        #videoSidebar { position: fixed; right: -320px; top: 60px; width: 300px; height: calc(100vh - 60px); background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(8px); transition: right 0.3s ease; padding: 20px; overflow-y: auto; z-index: 102; border-left: 3px solid var(--primary); pointer-events: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.3); display: none; }
        #videoSidebar.open { right: 0; }
        #videoSidebarToggleBtn { position: fixed; top: 130px; right: 10px; z-index: 103; background: var(--secondary); padding: 8px 10px; font-size: 18px; border-radius: 4px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); margin: 0; display: none; pointer-events: auto; }
        #videoSidebarToggleBtn:hover:not(:disabled) { background: var(--primary); }
        .thumbnail { width: 100%; margin-bottom: 15px; cursor: pointer; border: 2px solid transparent; border-radius: 4px; transition: all 0.2s ease; image-rendering: auto; pointer-events: auto; display: block; }
        .thumbnail:hover { border-color: var(--secondary); transform: scale(1.03); box-shadow: 0 0 10px rgba(142, 45, 226, 0.5); }
        .thumbnail.active { border-color: var(--accent); box-shadow: 0 0 10px rgba(255, 69, 0, 0.6); }
        #videoSidebar h3 { color: var(--secondary); margin-bottom: 15px; text-align: center; font-size: 16px; }
        #profile { justify-content: center; align-items: center; }
        #profileContainer { background-color: rgba(26, 26, 46, 0.8); padding: 40px; border-radius: 12px; border: 1px solid var(--primary); max-width: 500px; width: 90%; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); pointer-events: auto; }
        #profileIcon { font-size: 60px; color: var(--secondary); margin-bottom: 15px; display: inline-block; background: var(--bg-light); width: 100px; height: 100px; line-height: 100px; border-radius: 50%; border: 3px solid var(--primary); }
        #profileUsername { font-size: 24px; font-weight: bold; color: var(--text); margin-bottom: 10px; }
        .profile-stat { font-size: 18px; color: var(--text-dim); margin-bottom: 12px; border-bottom: 1px dashed var(--bg-light); padding-bottom: 8px; }
        .profile-stat span { font-weight: bold; color: var(--primary); margin-left: 8px; }
        .profile-stat .level { color: var(--gold); }
        .profile-stat .streak { color: var(--accent); }
        .profile-stat .xp { color: var(--secondary); }
        #profileSettings { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--primary-dark); text-align: left; }
        #profileSettings h4 { color: var(--secondary); font-size: 16px; margin-bottom: 15px; text-align: center; font-family: 'Roboto Mono', monospace; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 8px 0; }
        .setting-item label { font-size: 15px; color: var(--text-dim); flex-grow: 1; margin-right: 15px; }
        .setting-item input[type="checkbox"] { appearance: none; width: 40px; height: 20px; background: var(--bg-light); border-radius: 10px; position: relative; cursor: pointer; outline: none; transition: background-color 0.3s; border: 1px solid var(--primary); flex-shrink: 0; }
        .setting-item input[type="checkbox"]::before { content: ""; position: absolute; width: 16px; height: 16px; border-radius: 50%; background: var(--text-dim); top: 1px; left: 2px; transition: transform 0.3s, background-color 0.3s; }
        .setting-item input[type="checkbox"]:checked { background-color: var(--primary); }
        .setting-item input[type="checkbox"]:checked::before { background: white; transform: translateX(20px); }
        #profile button[data-action="show-view"] { margin-top: 20px; background: var(--bg-light); font-size: 12px; }
        #focusStats { justify-content: flex-start; align-items: center; }
        #focusStatsContainer { background-color: rgba(26, 26, 46, 0.8); padding: 30px; border-radius: 12px; border: 1px solid var(--primary); max-width: 800px; width: 90%; box-shadow: 0 5px 20px rgba(0,0,0,0.3); pointer-events: auto; }
        #focusStatsContainer h3 { text-align: center; font-family: 'Press Start 2P', cursive; font-size: 20px; color: var(--secondary); margin-bottom: 30px; }
        #statsDisplay { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-item { background: var(--bg-light); padding: 20px; border-radius: 6px; border: 1px solid var(--primary-dark); text-align: center; }
        .stat-item .label { font-size: 14px; color: var(--text-dim); margin-bottom: 10px; display: block; }
        .stat-item .value { font-size: 24px; font-weight: bold; color: var(--primary); }
        .stat-item .value.streak { color: var(--accent); }
        .stat-item .value.videos { color: var(--secondary); }
        .stat-item .value.distractions { color: var(--warning); }
        #focusCalendar { margin-top: 30px; background: var(--bg-light); padding: 20px; border-radius: 8px; border: 1px solid var(--primary-dark); }
        #calendarHeader { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #calendarHeader h4 { margin: 0; color: var(--text-dim); flex-grow: 1; text-align: center; font-size: 16px; }
        #calendarHeader button { background: var(--primary); box-shadow: 2px 2px 0 var(--primary-dark); padding: 5px 10px; font-size: 12px; margin: 0; min-width: 40px; }
        #calendarHeader button:hover:not(:disabled) { background: var(--secondary); box-shadow: 1px 1px 0 var(--primary-dark); }
        #calendarGrid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { aspect-ratio: 1 / 1; background-color: var(--bg-medium); border-radius: 3px; display: flex; justify-content: center; align-items: center; font-size: 12px; color: var(--text-dim); position: relative; border: 1px solid transparent; cursor: default; transition: background-color 0.2s; }
        .calendar-day.other-month { opacity: 0.4; pointer-events: none; }
        .calendar-day.has-focus { background-color: var(--calendar-focus-low); color: var(--text); }
        .calendar-day.focus-medium { background-color: var(--calendar-focus-medium); }
        .calendar-day.focus-high { background-color: var(--calendar-focus-high); }
        .calendar-day.today { border: 1px solid var(--calendar-today-border); }
        .calendar-day .tooltip { visibility: hidden; width: 120px; background-color: var(--bg-dark); color: var(--text); text-align: center; border-radius: 4px; padding: 5px 0; position: absolute; z-index: 1; bottom: 115%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; font-size: 11px; pointer-events: none; }
        .calendar-day:hover .tooltip { visibility: visible; opacity: 0.95; }
        #focusStats button[data-action="show-view"] { margin-top: 30px; background: var(--bg-light); font-size: 12px; display: block; margin-left: auto; margin-right: auto; }
        .sidebar-trigger { position: fixed; left: 0; top: 50%; transform: translateY(-50%); width: 25px; height: 100px; background: var(--primary); z-index: 199; border-radius: 0 8px 8px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text); font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; font-size: 14px; letter-spacing: 2px; pointer-events: auto; transition: background-color 0.2s ease, left 0.3s ease; box-shadow: 3px 0 8px rgba(0,0,0,0.3); }
        .sidebar-trigger:hover { background: var(--secondary); }
        .game-sidebar { position: fixed; left: -300px; top: 0; width: 280px; height: 100vh; background: rgba(26, 26, 46, 0.98); backdrop-filter: blur(5px); border-right: 3px solid var(--primary); z-index: 200; transition: left 0.3s ease; padding: 70px 0 20px 0; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.4); overflow-y: auto; pointer-events: auto; }
        .game-sidebar.open { left: 0; }
        .game-sidebar.open + .sidebar-trigger { left: 280px; }
        .sidebar-section { padding: 15px 20px; border-bottom: 1px solid var(--bg-light); }
        .sidebar-section:last-child { border-bottom: none; }
        .sidebar-section h3 { color: var(--secondary); font-size: 16px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1.5px; padding-bottom: 5px; border-bottom: 1px dashed var(--primary-dark); }
        .sidebar-section a, .sidebar-section button { position: relative; display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; margin: 8px 0; background: var(--bg-light); color: var(--text); border: 1px solid var(--primary); border-radius: 4px; text-align: left; font-size: 14px; font-family: 'Roboto Mono', monospace; cursor: pointer; transition: all 0.2s ease; pointer-events: auto; z-index: 201; text-transform: none; box-shadow: none; letter-spacing: 0.5px; }
        .sidebar-section button i, .sidebar-section a i { width: 18px; text-align: center; color: var(--primary); }
        .sidebar-section a:hover, .sidebar-section button:hover:not(:disabled) { background: var(--primary); color: white; transform: translateX(5px); border-color: var(--secondary); box-shadow: none; }
        .sidebar-section a:hover i, .sidebar-section button:hover:not(:disabled) i { color: white; }
        .sidebar-section a { text-decoration: none; }
        .todo-badge { position: absolute; top: 5px; right: 5px; background-color: var(--notification-badge-bg); color: var(--notification-badge-text); border-radius: 50%; width: 20px; height: 20px; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold; line-height: 1; box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); display: none; }
        .todo-badge.visible { display: flex; }
        #logoutBtn { background: var(--danger); border-color: #a71d2a; color: white; }
        #logoutBtn i { color: white; }
        #logoutBtn:hover:not(:disabled) { background: #c82333; border-color: #a71d2a; }
        #pointsDisplay { position: fixed; top: 70px; left: 10px; font-size: 16px; color: var(--text); font-family: 'Roboto Mono', monospace; font-weight: 600; z-index: 101; background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(5px); padding: 8px 12px; border: 1px solid var(--secondary); border-radius: 4px; box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); pointer-events: none; display: none; }
        #achievementLevel { position: fixed; top: 120px; left: 10px; font-size: 14px; font-weight: bold; z-index: 101; font-family: 'Press Start 2P', cursive; background: rgba(26, 26, 46, 0.85); backdrop-filter: blur(5px); padding: 6px 10px; border: 2px solid var(--secondary); box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.4); border-radius: 4px; pointer-events: none; text-transform: uppercase; letter-spacing: 1px; display: none; }
        .rainbow { background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 3s infinite linear; border-color: transparent !important; }
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .level-glow { text-shadow: 0 0 10px var(--text); }
        .level-box-glow { box-shadow: 0 0 10px var(--gold); }
        #lofiPlayer { position: fixed; bottom: 10px; right: 10px; z-index: 101; background: rgba(26, 26, 46, 0.9); backdrop-filter: blur(5px); padding: 12px; border: 1px solid var(--primary); border-radius: 6px; box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.3); pointer-events: auto; display: none; }
        #lofiPlayer .lofi-title { text-align: center; margin-bottom: 8px; font-size: 12px; color: var(--text-dim); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
        #lofiPlayer button { background: var(--secondary); border: none; color: var(--text); padding: 6px 12px; margin: 0 3px; cursor: pointer; font-size: 14px; border-radius: 4px; box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.3); font-family: 'Roboto Mono', monospace; z-index: 102; min-width: 35px; pointer-events: auto; }
        #lofiPlayer button:hover:not(:disabled) { background: var(--primary); }
        #lofiPlayer #lofiPause { display: none; }
        #fireBox { position: fixed; bottom: 10px; left: 10px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 26px; cursor: pointer; z-index: 100; box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.4); border: 2px solid var(--secondary); pointer-events: auto; transition: all 0.2s ease; display: none; }
        #fireBox:hover { background: var(--secondary); transform: translateY(-3px) scale(1.05); box-shadow: 4px 4px 15px rgba(0, 0, 0, 0.5); }
        #aiPopup { position: fixed; bottom: 70px; left: 10px; width: 320px; height: 450px; background: var(--bg-medium); border-radius: 8px; padding: 5px; display: none; z-index: 101; box-shadow: 5px 5px 20px rgba(0, 0, 0, 0.4); border: 3px solid var(--primary); pointer-events: auto; overflow: hidden; }
        #aiPopup iframe { width: 100%; height: 100%; border: none; border-radius: 5px; }
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(6px); display: flex; justify-content: center; align-items: center; z-index: 105; display: none; pointer-events: auto; padding: 15px; }
        .dialog-box { background: var(--bg-medium); padding: 25px 30px; border: 3px solid var(--accent); box-shadow: 0 0 30px rgba(255, 69, 0, 0.5); border-radius: 10px; text-align: center; pointer-events: auto; font-family: 'Roboto Mono', monospace; max-width: 450px; width: 90%; }
        .dialog-box.warning { border-color: var(--danger); box-shadow: 0 0 30px rgba(220, 53, 69, 0.6); }
        .dialog-box.warning h3 { color: var(--danger); }
        .dialog-box h3 { color: var(--accent); font-size: 20px; margin-bottom: 15px; font-family: 'Press Start 2P', cursive; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .dialog-box h3 i { font-size: 18px; }
        .dialog-box p { font-size: 16px; margin-bottom: 25px; color: var(--text); line-height: 1.5; }
        .dialog-box .dialog-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .dialog-box button { padding: 10px 25px; margin: 0; font-size: 14px; pointer-events: auto; z-index: 106; }
        #confirmBtn, #streakShieldConfirmBtn, #doublePointsConfirmBtn, #deadlineConfirmBtn, #sessionContinueBtn, #openMysteryBox { background: var(--accent); box-shadow: 3px 3px 0 #b33000; }
        #confirmBtn:hover:not(:disabled), #streakShieldConfirmBtn:hover:not(:disabled), #doublePointsConfirmBtn:hover:not(:disabled), #deadlineConfirmBtn:hover:not(:disabled), #sessionContinueBtn:hover:not(:disabled), #openMysteryBox:hover:not(:disabled) { background: var(--accent-alt); box-shadow: 2px 2px 0 #b33000; }
        #cancelBtn, #streakShieldCancelBtn, #doublePointsCancelBtn, #deadlineCancelBtn, #sessionEndBtn, #closeAudioStore, #closeMysteryBoxBtn { background: var(--bg-light); box-shadow: 3px 3px 0 var(--bg-medium); }
        #cancelBtn:hover:not(:disabled), #streakShieldCancelBtn:hover:not(:disabled), #doublePointsCancelBtn:hover:not(:disabled), #deadlineCancelBtn:hover:not(:disabled), #sessionEndBtn:hover:not(:disabled), #closeAudioStore:hover:not(:disabled), #closeMysteryBoxBtn:hover:not(:disabled) { background: var(--bg-medium); box-shadow: 2px 2px 0 var(--bg-medium); }
        #deadlineDialog input, #deadlineDialog select { margin: 15px auto; max-width: 300px; }
        #mysteryBoxPopup .dialog-box { border-color: var(--gold); box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); }
        #mysteryBoxPopup h3 { color: var(--gold); }
        #mysteryRewardText { font-weight: bold; color: var(--accent-alt); min-height: 40px;}
        #audioTracksStore .dialog-box { border-color: var(--secondary); box-shadow: 0 0 30px rgba(142, 45, 226, 0.5); max-width: 500px; max-height: 80vh; overflow-y: auto; }
        #audioTracksStore h3 { color: var(--secondary); }
        #audioTracksList { margin-top: 20px; }
        .audio-track-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; margin-bottom: 10px; background: var(--bg-light); border: 1px solid var(--primary); border-radius: 4px; transition: background-color 0.2s; pointer-events: auto; }
        .audio-track-item:hover { background-color: var(--bg-medium); }
        .audio-track-item .track-info { text-align: left; }
        .audio-track-item .track-name { font-weight: bold; }
        .audio-track-item.locked .track-name { color: var(--text-dim); }
        .audio-track-item.unlocked .track-name { color: var(--accent-alt); }
        .audio-track-item .track-cost { font-size: 12px; color: var(--text-dim); }
        .unlock-track-btn { padding: 6px 12px; background: var(--secondary); font-size: 12px; margin: 0; flex-shrink: 0; pointer-events: auto; }
        .unlock-track-btn:disabled { background: var(--bg-light); color: var(--text-dim); cursor: not-allowed; opacity: 0.7; }
        .unlock-track-btn.unlocked { background: var(--success); color: white; cursor: default; }
        .unlock-track-btn.unlocked:hover:not(:disabled) { background: var(--success); }
        #achievementOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(15, 15, 27, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; color: gold; font-size: 36px; font-weight: bold; z-index: 104; display: none; font-family: 'Press Start 2P', cursive; text-align: center; text-shadow: 3px 3px 0 var(--primary-dark), 5px 5px 10px rgba(0,0,0,0.5); background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23FFD700' fill-opacity='0.1' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E"); pointer-events: none; padding: 20px; line-height: 1.4; }
        #todoList { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 450px; max-height: 75vh; background: var(--bg-medium); padding: 20px; border: 2px solid var(--secondary); border-radius: 8px; display: none; z-index: 100; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4); pointer-events: auto; display: flex; flex-direction: column; }
        #todoList h3 { font-size: 18px; margin-bottom: 15px; color: var(--secondary); font-family: 'Roboto Mono', monospace; text-align: center; flex-shrink: 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #tasks { overflow-y: auto; margin-bottom: 15px; background: none; padding-right: 5px; flex-grow: 1; pointer-events: auto; }
        .task-line { display: flex; align-items: center; margin-bottom: 10px; background: var(--bg-light); padding: 8px 10px; border: 1px solid var(--primary-dark); border-radius: 4px; pointer-events: auto; transition: background-color 0.2s, opacity 0.2s; }
        .task-line:hover { background-color: rgba(37, 37, 56, 0.8); }
        .task-line input[type="checkbox"] { margin-right: 12px; width: 18px; height: 18px; appearance: none; border: 2px solid var(--primary); background: var(--bg-medium); position: relative; cursor: pointer; pointer-events: auto; z-index: 11; border-radius: 3px; transition: background-color 0.2s, border-color 0.2s; flex-shrink: 0; }
        .task-line input[type="checkbox"]:checked { background: var(--secondary); border-color: var(--secondary); }
        .task-line input[type="checkbox"]:checked::after { content: "✔"; position: absolute; color: var(--text); font-size: 14px; font-weight: bold; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .task-line input[type="checkbox"]:hover { border-color: var(--secondary); }
        .task-line input[type="text"] { flex-grow: 1; font-size: 15px; font-family: 'Roboto Mono', monospace; color: var(--text); background: transparent; border: none; border-bottom: 1px solid transparent; padding: 5px 0; outline: none; box-shadow: none; margin: 0; pointer-events: auto; z-index: 11; transition: border-color 0.2s; max-width: none; }
        .task-line input[type="text"]:focus { border-bottom: 1px solid var(--secondary); box-shadow: none; }
        .task-line input[type="text"][readonly] { text-decoration: line-through; color: var(--text-dim); }
        .task-line .task-buttons { display: flex; align-items: center; margin-left: 10px; flex-shrink: 0; pointer-events: auto; }
        .task-line .set-deadline, .task-line .remove-task { color: var(--text-dim); font-size: 16px; cursor: pointer; background: none; border: none; padding: 5px; line-height: 1; pointer-events: auto; z-index: 11; transition: color 0.2s; margin: 0 2px; }
        .task-line .set-deadline:hover:not(:disabled) { color: var(--primary); }
        .task-line .set-deadline:disabled { opacity: 0.5; cursor: not-allowed;}
        .task-line .remove-task:hover { color: var(--danger); }
        .task-line .deadline-info, .task-line .points-info { margin-left: 8px; font-size: 11px; padding: 2px 5px; border-radius: 3px; white-space: nowrap; pointer-events: none; }
        .task-line .deadline-info { color: var(--accent-alt); background-color: rgba(255, 140, 0, 0.1); }
        .task-line .points-info { color: var(--secondary); background-color: rgba(142, 45, 226, 0.1); }
        #todoList .dialog-buttons { margin-top: 15px; flex-shrink: 0; pointer-events: auto; }
        #todoList .dialog-buttons button { pointer-events: auto; }
        #pomodoroOverlay { background: rgba(15, 15, 27, 0.95); backdrop-filter: blur(12px); z-index: 1000; }
        #pomodoroContainer { width: 90%; max-width: 420px; background: transparent; padding: 30px; border: none; box-shadow: none; text-align: center; pointer-events: auto; }
        #pomodoroContainer h3 { font-family: 'Press Start 2P', cursive; font-size: 22px; color: var(--secondary); margin-bottom: 15px; text-shadow: 2px 2px 0px var(--primary-dark); display: flex; align-items: center; justify-content: center; gap: 10px; }
        #pomodoroContainer p { font-size: 16px; color: var(--text-dim); margin-bottom: 15px; }
        #pomodoroDurationSetting { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 25px; pointer-events: auto; }
        #pomodoroDurationSetting label { color: var(--text-dim); font-size: 14px; }
        #pomodoroDurationInput { width: 70px; padding: 8px 10px; font-size: 14px; text-align: center; margin: 0; pointer-events: auto; }
        #pomodoroDurationInput:disabled { background-color: var(--bg-medium); cursor: not-allowed; opacity: 0.6; }
        #pomodoroTimer { font-size: 90px; font-weight: bold; color: var(--text); margin: 20px 0; font-family: 'Press Start 2P', cursive; text-shadow: 0 0 15px rgba(65, 105, 225, 0.5), 0 0 25px rgba(142, 45, 226, 0.4); transition: color 0.3s ease; }
        #pomodoroTimer.timer-warning { color: var(--timer-warning-color); text-shadow: 0 0 15px rgba(220, 53, 69, 0.6); }
        #pomodoroTimer.timer-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #pomodoroStatus { font-size: 18px; color: var(--accent-alt); margin-top: 15px; min-height: 25px; font-weight: 600; }
        #pomodoroControls { display: flex; justify-content: center; gap: 25px; margin-top: 35px; pointer-events: auto; }
        #pomodoroControls button { padding: 12px 30px; font-size: 16px; pointer-events: auto; }
        #pomodoroStartBtn { background: var(--success); border: none; box-shadow: 3px 3px 0 #1c7430;}
        #pomodoroStartBtn:hover:not(:disabled) { background: #218838; box-shadow: 2px 2px 0 #1c7430;}
        #pomodoroResetBtn { background: var(--accent); box-shadow: 3px 3px 0 #b33000;}
        #pomodoroResetBtn:hover:not(:disabled) { background: var(--accent-alt); box-shadow: 2px 2px 0 #b33000;}
        #pomodoroCloseBtn { background: var(--bg-light); box-shadow: 3px 3px 0 var(--bg-medium);}
        #pomodoroCloseBtn:hover:not(:disabled) { background: var(--bg-medium); box-shadow: 2px 2px 0 var(--bg-medium);}
        /* FIREBASE: Style for the new Google Sign In button */
        #googleSignInBtn {
            background: #4285F4; /* Google Blue */
            display: inline-flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            text-transform: none; /* Google button doesn't use uppercase */
            box-shadow: 3px 3px 0 #2a56c6;
            font-family: 'Roboto', sans-serif; /* Google uses Roboto */
            letter-spacing: 0.5px;
        }
        #googleSignInBtn:hover:not(:disabled) {
            background: #357ae8;
            box-shadow: 2px 2px 0 #2a56c6;
        }
        @media (max-width: 800px) {
            /* ... all your other media query rules ... */
        }
        @media (max-width: 480px) {
            /* ... all your other media query rules ... */
        }

    </style>
    <!-- Include Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&family=Press+Start+2P&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <!-- Canvas Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

</head>
<body>

    <!-- Main Game Container -->
    <div class="game-container">
        <!-- ... Your top nav bar ... -->
        <nav id="topNavBar">
            <a href="#" id="navLogo" title="Quest for Focus" data-action="show-view" data-view="homePage">
                <img src="logo.png" alt="Quest for Focus Logo">
            </a>
            <div id="navClockContainer"> <span id="navClockTime">00:00:00</span> <span id="navClockPeriod">AM</span> </div>
            <div id="navButtons">
                <span id="navStreakDisplay"><i class="fas fa-fire"></i> 0 days focus</span>
                <button id="navProfileBtn" title="Profile" data-action="show-view" data-view="profile"> <i class="fas fa-user-circle"></i> </button>
            </div>
        </nav>

        <!-- == Page Views == -->
        <div id="landingPage" class="page-view" style="display: flex;">
            <div id="landingPageContainer">
                <div class="title">QUEST FOR <span>FOCUS</span></div>
                <div class="subtitle">Embark on your learning adventure! Conquer distractions, master knowledge.</div>
                <button data-action="show-view" data-view="signinForm" class="primary-btn">START QUEST</button>
                <button class="github-btn" data-action="github"><i class="fab fa-github"></i> GITHUB</button>
                <div id="features">
                    <div class="feature"> <i class="fas fa-ban"></i> <p>Ad-Free Zone<br>Focus!</p> </div>
                    <div class="feature"> <i class="fas fa-moon"></i> <p>Dark Mode<br>Easy on eyes</p> </div>
                    <div class="feature"> <i class="fas fa-gamepad"></i> <p>Gamified<br>Level up!</p> </div>
                </div>
            </div>
        </div>

        <!-- FIREBASE: Replaced the old sign in form -->
        <div id="signinForm" class="page-view">
            <div id="signinFormContainer">
                <div class="title">ENTER <span>REALM</span></div>
                <div class="subtitle">Sign in with Google to save your progress</div>
                <button id="googleSignInBtn" data-action="google-sign-in">
                    <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="24" height="24" viewBox="0 0 48 48" style="fill: #fff;">
                        <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.519-3.355-11.297-7.938l-6.522,5.023C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.022,35.258,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                    </svg>
                    <span>Sign In with Google</span>
                </button>
                <button data-action="show-view" data-view="landingPage" style="margin-top: 20px; background: var(--bg-light); font-size: 12px;">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>

        <!-- ... All your other page views and shared components HTML ... -->
        <div id="homePage" class="page-view"> <div id="homePageContent"> <div id="welcomeMessage">Welcome, <span id="homeUsername">Hero</span>!</div> <div id="dateTimeDisplay">Loading...</div> <div id="upcomingTaskDisplay" class="none"><i class="fas fa-star"></i> No urgent quests!</div> <div id="focusStatus">Ready to focus?</div> <div id="motivationQuote">"Loading motivation..."</div> </div> </div>
        <div id="youtubeLecturePage" class="page-view"> <div id="youtubeInputContainer"> <div class="subtitle">Prepare Focus Session</div> <select id="playlistSelect"> <option value="">Load Playlist</option> </select> <div id="urlInputs"> <div class="url-container"> <input type="text" class="youtube-url" placeholder="YouTube URL (Video or Playlist)" required /> </div> </div> <button data-action="add-url"><i class="fas fa-plus"></i> Add URL</button> <div id="playlistManagement"> <input type="text" id="playlistName" placeholder="Save As..." /> <button data-action="save-playlist" class="primary-btn"><i class="fas fa-save"></i> Save</button> <button data-action="remove-playlist" class="accent-btn" style="background: var(--danger); box-shadow: 3px 3px 0 #a71d2a;"><i class="fas fa-trash"></i> Delete</button> </div> <button data-action="start-playback" class="primary-btn"><i class="fas fa-play-circle"></i> BEGIN FOCUS</button> </div> <div id="playerContainer"> <div id="player"></div> </div> <button id="videoSidebarToggleBtn" title="Toggle List (T)"> <i class="fas fa-list"></i> </button> <div id="youtubeLecturePageControls"> <button id="restartBtn" title="Exit Session"><i class="fas fa-times-circle"></i> Exit</button> </div> <div id="videoSidebar"> <h3><i class="fas fa-video"></i> Playlist</h3> <div id="videoThumbnailList"></div> </div> </div>
        <div id="profile" class="page-view"> <div id="profileContainer"> <div id="profileIcon"><i class="fas fa-user-shield"></i></div> <div id="profileUsername">Hero Name</div> <div class="profile-stat">Level: <span id="profileLevel" class="level">Mortal</span></div> <div class="profile-stat">XP: <span id="profileXP" class="xp">0</span></div> <div class="profile-stat">Streak: <span id="profileStreak" class="streak">0 days</span></div> <div id="profileSettings"> <h4><i class="fas fa-cog"></i> Settings</h4> <div class="setting-item"> <label for="browserNotificationSetting">Enable Browser Notifications for Deadlines</label> <input type="checkbox" id="browserNotificationSetting"> </div> <small style="color: var(--text-dim); font-size: 12px; display: block; text-align: center; margin-top: -5px;">Requires browser permission.</small> </div> <button data-action="show-view" data-view="homePage" style="margin-top: 20px; background: var(--bg-light); font-size: 12px;"> <i class="fas fa-arrow-left"></i> Home</button> </div> </div>
        <div id="focusStats" class="page-view"> <div id="focusStatsContainer"> <h3><i class="fas fa-chart-line"></i> Hero <span>Stats</span></h3> <div id="statsDisplay"> <div class="stat-item"> <span class="label"><i class="fas fa-stopwatch"></i> Focus Time</span> <span id="statsTotalFocusTime" class="value">0m</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-eye-slash"></i> Distractions</span> <span id="statsTotalDistractions" class="value distractions">0</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-film"></i> Videos Done</span> <span id="statsTotalVideosWatched" class="value videos">0</span> </div> <div class="stat-item"> <span class="label"><i class="fas fa-fire"></i> Current Streak</span> <span id="statsCurrentStreak" class="value streak">0 days</span> </div> </div> <div id="focusCalendar"> <div id="calendarHeader"> <button id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button> <h4 id="calendarMonthYear"><i class="fas fa-calendar-alt"></i> Calendar</h4> <button id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button> </div> <div id="calendarGrid"></div> </div> <button data-action="show-view" data-view="homePage" style="margin-top: 30px; background: var(--bg-light); font-size: 12px; display: block; margin-left: auto; margin-right: auto;"> <i class="fas fa-arrow-left"></i> Home</button> </div> </div>
        <div class="sidebar-trigger" title="Open Menu">MENU</div>
        <div class="game-sidebar"> <div class="sidebar-section"> <h3>Navigation</h3> <button data-action="show-view" data-view="homePage"><i class="fas fa-home"></i> Home</button> <button data-action="show-view" data-view="youtubeLecturePage"><i class="fab fa-youtube"></i> Lectures</button> <button data-action="toggle-todo"><i class="fas fa-list-check"></i> To-Do<span id="todoBadge" class="todo-badge">0</span></button></div> <div class="sidebar-section"> <h3>Progress</h3> <button data-action="show-view" data-view="focusStats"><i class="fas fa-chart-line"></i> Stats</button> <a href="https://room.examgoal.com/" target="_blank" rel="noreferrer"><i class="fas fa-dumbbell"></i> PYQs</a> </div> <div class="sidebar-section"> <h3>Self Study</h3> <button id="quietPomodoroBtn"><i class="fas fa-brain"></i> Pomodoro</button> </div> <div class="sidebar-section"> <h3>Shops & Realms</h3> <button id="streakShieldBtn"><i class="fas fa-shield-alt"></i> Shield</button> <button id="doublePointsBtn"><i class="fas fa-bolt"></i> Double XP</button> <button id="audioStoreBtn"><i class="fas fa-music"></i> Audio</button> <a href="https://forestquest.vercel.app/" target="_blank" rel="noreferrer"><i class="fas fa-tree"></i> Forest</a> <a href="https://focuswithpomodoro.netlify.app/" target="_blank" rel="noreferrer"><i class="fas fa-clock"></i> Pomodoro Realm</a> <a href="https://the-chosen-one-o5.github.io/Daily-Schedule/" target="_blank" rel="noreferrer"><i class="fas fa-calendar-alt"></i> Planner</a> </div> <div class="sidebar-section"> <h3>Account</h3> <button data-action="show-view" data-view="profile"><i class="fas fa-user"></i> Profile</button> <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button> </div> </div>
        <div id="timerDisplay"> <span id="timerText">Focus: 00:00</span> <div id="progressBar"> <div id="progressFill"></div> </div> </div>
        <div id="pointsDisplay"><span style="color: var(--secondary);">⭐</span> XP: 0</div>
        <div id="achievementLevel">Mortal</div>
        <div id="todoList"> <h3><i class="fas fa-tasks"></i> Quests</h3> <div id="tasks"></div> <div class="dialog-buttons"> <button data-action="save-tasks" class="primary-btn"><i class="fas fa-save"></i> Save</button> <button data-action="add-task-line" style="background: var(--bg-light);"><i class="fas fa-plus"></i> Add</button> <button data-action="close-todo" class="accent-btn" style="background: var(--danger); box-shadow: 3px 3px 0 #a71d2a;"><i class="fas fa-times"></i> Close</button> </div> </div>
        <div id="lofiPlayer"> <div class="lofi-title">LOFI ♬</div> <button id="lofiPrev" title="Prev"><i class="fas fa-backward-step"></i></button> <button id="lofiPlay" title="Play"><i class="fas fa-play"></i></button> <button id="lofiPause" title="Pause"><i class="fas fa-pause"></i></button> <button id="lofiNext" title="Next"><i class="fas fa-forward-step"></i></button> </div>
        <div id="fireBox" title="AI Assistant"><i class="fas fa-robot"></i></div>
        <div id="aiPopup"> <iframe src="https://www.chatbase.co/chatbot-iframe/3dSdpryiYZlWipHUL8dNK" frameBorder="0"></iframe> </div>
        <div id="achievementOverlay">LEVEL UP!</div>
        <div id="confirmationDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-question-circle"></i> Confirm</h3> <p id="confirmationDialogText">Are you sure?</p> <div class="dialog-buttons"> <button id="confirmBtn">YES</button> <button id="cancelBtn">NO</button> </div> </div> </div>
        <div id="streakShieldDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-shield-alt"></i> Shield</h3> <p>Protect streak (1 week)? Costs 800 XP.</p> <div class="dialog-buttons"> <button id="streakShieldConfirmBtn">Buy</button> <button id="streakShieldCancelBtn">Cancel</button> </div> </div> </div>
        <div id="doublePointsDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-bolt"></i> Double XP</h3> <p>Activate Double XP (24h)? Costs 800 XP.</p> <div class="dialog-buttons"> <button id="doublePointsConfirmBtn">Activate</button> <button id="doublePointsCancelBtn">Cancel</button> </div> </div> </div>
        <div id="deadlineDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-calendar-check"></i> Deadline</h3> <p>Set deadline & difficulty for bonus XP!</p> <input type="date" id="deadlineDate" /> <input type="time" id="deadlineTime" /> <select id="taskDifficulty"> <option value="50">Easy (+50)</option> <option value="100">Medium (+100)</option> <option value="200">Hard (+200)</option> <option value="300">Very Hard (+300)</option> </select> <div class="dialog-buttons"> <button id="deadlineConfirmBtn">Set</button> <button id="deadlineCancelBtn">Cancel</button> </div> </div> </div>
        <div id="sessionCompleteDialog" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-check-circle"></i> Session Done!</h3> <p>Great focus!</p> <p>Continue for +100 XP bonus?</p> <div class="dialog-buttons"> <button id="sessionContinueBtn">Continue</button> <button id="sessionEndBtn">End</button> </div> </div> </div>
        <div id="mysteryBoxPopup" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-gift"></i> Mystery Box</h3> <p id="mysteryRewardText">Mystery box earned!</p> <div class="dialog-buttons"> <button id="openMysteryBox">Open</button> <button id="closeMysteryBoxBtn">Later</button> </div> </div> </div>
        <div id="audioTracksStore" class="dialog-overlay"> <div class="dialog-box"> <h3><i class="fas fa-store"></i> Audio Store</h3> <p>Unlock Lo-Fi tracks!</p> <div id="audioTracksList"></div> <div class="dialog-buttons" style="margin-top: 20px;"> <button id="closeAudioStore">Close</button> </div> </div> </div>
        <div id="pomodoroOverlay" class="dialog-overlay"> <div id="pomodoroContainer"> <h3><i class="fas fa-brain"></i> POMODORO</h3> <p>Focus deeply. Earn 1 XP per minute.</p> <div id="pomodoroDurationSetting"> <label for="pomodoroDurationInput">Duration (min):</label> <input type="number" id="pomodoroDurationInput" value="60" min="1" max="180"> </div> <div id="pomodoroTimer">60:00</div> <div id="pomodoroStatus">Ready</div> <div id="pomodoroControls"> <button id="pomodoroStartBtn"><i class="fas fa-play"></i> START</button> <button id="pomodoroResetBtn"><i class="fas fa-redo"></i> RESET</button> <button id="pomodoroCloseBtn"><i class="fas fa-times"></i> CLOSE</button> </div> </div> </div>
        <audio id="focusAudio" preload="metadata" src="https://the-chosen-one-o5.github.io/UltraFocusModeYT/focus.mp3" loop></audio>
        <audio id="lofiAudio" preload="metadata" loop></audio>
        <audio id="pomodoroCompleteAudio" preload="none" src="https://www.dropbox.com/scl/fi/ihrcv1s3o4m4abhn6oa5z/level-up-4-243762.mp3?rlkey=qkaf4zrhipxtxpu51an0do45r&st=boipxpb5&dl=1"></audio>
        <audio id="levelUpAudio" preload="none" src="https://www.dropbox.com/scl/fi/ykeun00q1t03kzpeow819/music-to-make-your-brain-shut-up-a-dark-academia-playlist-4.mp3?rlkey=3hnw2vk2ck0yjnr9oekk2xqld&st=hh77z1k0&dl=1"></audio>
        <audio id="achievementAudio" preload="none" src="https://www.dropbox.com/scl/fi/pe09xx1c680gzymsa2gdf/NEOTIC-Calm-Your-Anxiety.mp3?rlkey=2hp7su9j541mpcdkw4ccavx58&st=yles17dd&dl=1"></audio>

    </div> <!-- End Game Container -->

   <script>
    // Wrap entire script in an IIFE (Immediately Invoked Function Expression)
    // to avoid polluting the global scope.
    (() => {
        
        // FIREBASE: Initialize Firebase with your provided configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyDS6ZuQcViCFgolCcmAqBPp_9pndCB8F8Q",
            authDomain: "ultrafocusmode-18ae4.firebaseapp.com",
            projectId: "ultrafocusmode-18ae4",
            storageBucket: "ultrafocusmode-18ae4.firebasestorage.app",
            messagingSenderId: "998572603670",
            appId: "1:998572603670:web:f14dff88199d964b0c3837",
            measurementId: "G-04LSN8085M"
        };

        // Initialize Firebase and its services
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

            // --- State Variables ---
            // This object holds the entire state of the application for the current user.
            let appState = {
                currentView: 'landingPage',
                player: null,
                videoIds: [],
                currentVideoIndex: 0,
                isFocusModeActive: false,
                focusCountdownInterval: null,
                points: 0, // Now called XP
                isLoggedIn: false,
                currentUser: null, // This will be the Firebase user object
                focusDuration: 50 * 60 * 1000,
                timerMode: "Focus Time",
                timerRemaining: 50 * 60,
                completedVideos: new Set(),
                allVideosCompleted: false,
                totalFocusTime: 0, // in seconds
                totalDistractions: 0,
                totalVideosWatched: 0,
                playlists: [],
                tasks: [],
                previousPoints: 0,
                streakDays: 0,
                lastFocusDate: null,
                isYouTubeAPILoaded: false,
                currentLofiIndex: 0,
                isSidebarOpen: false,
                isVideoSidebarOpen: false,
                pomodoroInterval: null,
                pomodoroTimeRemaining: 60 * 60,
                isPomodoroActive: false,
                pomodoroDistractionCount: 0,
                currentPomodoroDurationSetting: 60,
                browserNotificationsEnabled: false,
                browserNotificationPermission: 'default',
                sentNotificationTaskIds: new Set(),
                generalInterval: null,
                mysteryBoxCount: 0,
                activePowerUps: {
                    doublePoints: { active: false, expiry: null },
                    streakShield: { active: false, used: false, expiry: null },
                },
                premiumLofiTracks: [],
                dailyFocusData: {},
                calendarCurrentDate: new Date(),
                YOUTUBE_API_KEY: 'AIzaSyA16li1kPmHxCkcIw87ThOHmpBB1fuBPFY', // Be careful with this key!
            };
            
            // --- Constants (Shop items, levels, etc.) ---
            const STREAK_SHIELD_COST = 800; const STREAK_SHIELD_DURATION = 7 * 24 * 60 * 60 * 1000;
            const DOUBLE_POINTS_COST = 800; const DOUBLE_POINTS_DURATION = 24 * 60 * 60 * 1000;
            const MYSTERY_BOX_STREAK_INTERVAL = 14;
            // ... other constants from your old code ...

            // --- DOM References (Cached for performance) ---
            const dom = {};
            function cacheDOMElements() {
                const ids = [
                    'topNavBar', 'landingPage', 'signinForm', 'homePage', 'youtubeLecturePage', 'profile', 'focusStats', 'navLogo',
                    'navClockContainer', 'navButtons', 'navStreakDisplay', 'navProfileBtn', 'welcomeMessage', 'dateTimeDisplay',
                    'upcomingTaskDisplay', 'focusStatus', 'motivationQuote', 'youtubeInputContainer', 'playlistSelect', 'urlInputs',
                    'playlistName', 'playerContainer', 'player', 'videoSidebarToggleBtn', 'youtubeLecturePageControls', 'restartBtn',
                    'videoSidebar', 'videoThumbnailList', 'profileContainer', 'profileIcon', 'profileUsername', 'profileLevel',
                    'profileXP', 'profileStreak', 'profileSettings', 'browserNotificationSetting', 'focusStatsContainer',
                    'statsDisplay', 'statsTotalFocusTime', 'statsTotalDistractions', 'statsTotalVideosWatched', 'statsCurrentStreak',
                    'focusCalendar', 'calendarHeader', 'prevMonthBtn', 'calendarMonthYear', 'nextMonthBtn', 'calendarGrid',
                    'timerDisplay', 'timerText', 'progressBar', 'progressFill', 'pointsDisplay', 'achievementLevel', 'todoList',
                    'tasks', 'todoBadge', 'lofiPlayer', 'lofiPrev', 'lofiPlay', 'lofiPause', 'lofiNext', 'fireBox', 'aiPopup',
                    'achievementOverlay', 'confirmationDialog', 'confirmationDialogText', 'confirmBtn', 'cancelBtn',
                    'streakShieldDialog', 'streakShieldConfirmBtn', 'streakShieldCancelBtn', 'doublePointsDialog',
                    'doublePointsConfirmBtn', 'doublePointsCancelBtn', 'deadlineDialog', 'deadlineDate', 'deadlineTime',
                    'taskDifficulty', 'deadlineConfirmBtn', 'deadlineCancelBtn', 'sessionCompleteDialog', 'sessionContinueBtn',
                    'sessionEndBtn', 'mysteryBoxPopup', 'mysteryRewardText', 'openMysteryBox', 'closeMysteryBoxBtn',
                    'audioTracksStore', 'audioTracksList', 'closeAudioStore', 'pomodoroOverlay', 'pomodoroContainer',
                    'pomodoroDurationSetting', 'pomodoroDurationInput', 'pomodoroTimer', 'pomodoroStatus',
                    'pomodoroControls', 'pomodoroStartBtn', 'pomodoroResetBtn', 'pomodoroCloseBtn', 'logoutBtn'
                ];
                ids.forEach(id => dom[id] = document.getElementById(id));
                dom.gameContainer = document.querySelector('.game-container');
                dom.sidebarTrigger = document.querySelector('.sidebar-trigger');
                dom.gameSidebar = document.querySelector('.game-sidebar');
                dom.audio = {
                    focus: document.getElementById('focusAudio'),
                    lofi: document.getElementById('lofiAudio'),
                    pomodoroComplete: document.getElementById('pomodoroCompleteAudio'),
                    levelUp: document.getElementById('levelUpAudio'),
                    achievement: document.getElementById('achievementAudio'),
                };
            }

            // ===================================================================
            //  CORE FIREBASE & AUTHENTICATION LOGIC
            // ===================================================================

            /**
             * This is the main listener that reacts to user sign-in or sign-out events.
             * It's the central point of the entire application's state management.
             */
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in.
                    console.log("Auth state changed: User is signed in.", user.uid);
                    appState.isLoggedIn = true;
                    appState.currentUser = user;
                    await loadUserData(user); // Load data from Firestore
                    showView('homePage'); // Show the main app view
                    startPeriodicChecks(); // Start background checks for notifications, etc.
                } else {
                    // User is signed out.
                    console.log("Auth state changed: User is signed out.");
                    appState.isLoggedIn = false;
                    appState.currentUser = null;
                    resetLocalState(); // Clear all user data from the app
                    showView('landingPage'); // Show the initial login page
                    stopPeriodicChecks(); // Stop background checks
                }
            });

            /**
             * Handles the Google Sign-In process.
             */
            function signInWithGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider).catch(error => {
                    console.error("Google Sign-In Error:", error);
                    showConfirmation("Sign-In Failed", `Error: ${error.message}`, false);
                });
            }

            /**
             * Handles the sign-out process.
             */
            function logout() {
                showConfirmation("Logout?", "Are you sure you want to logout?", true, () => {
                    auth.signOut().catch(error => {
                        console.error("Sign Out Error:", error);
                        showConfirmation("Logout Error", `Error: ${error.message}`, false);
                    });
                });
            }

            /**
             * Loads all user data from the Firestore database.
             * If the user is new, it creates a default document for them.
             */
            async function loadUserData(user) {
                const userDocRef = db.collection('users').doc(user.uid);
                try {
                    const doc = await userDocRef.get();
                    if (!doc.exists) {
                        console.log("New user detected. Creating default profile in Firestore.");
                        await createDefaultUserDocument(userDocRef, user);
                    } else {
                        console.log("Existing user found. Loading data from Firestore.");
                        const data = doc.data();
                        // This function populates the appState object with Firestore data.
                        loadStateFromFirestore(data);
                    }
                    // This is for tracking when the user was last active.
                    await userDocRef.update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
                } catch (error) {
                    console.error("Error loading user data:", error);
                    showConfirmation("Load Error", "Could not load your profile. Please refresh.", false);
                }
                 // After loading, update all relevant UI elements.
                updateAllUI();
            }

            /**
             * Creates the initial database entry for a new user.
             */
            async function createDefaultUserDocument(docRef, user) {
                const newUser_data = {
                    displayName: user.displayName,
                    email: user.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    points: 0,
                    totalFocusTime: 0,
                    totalDistractions: 0,
                    totalVideosWatched: 0,
                    streakDays: 0,
                    lastFocusDate: null,
                    mysteryBoxCount: 0,
                    activePowerUps: { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null } },
                    tasks: [],
                    playlists: [],
                    dailyFocusData: {},
                    browserNotificationsEnabled: false,
                    premiumLofiTracks: appState.premiumLofiTracks.map(t => ({ id: t.id, unlocked: false })),
                };
                await docRef.set(newUser_data);
                loadStateFromFirestore(newUser_data); // Load the default state into the app
            }
            
            /**
             * Saves the current application state to Firestore for the logged-in user.
             * This function is now the single source of truth for saving data.
             */
            async function saveState() {
                if (!appState.isLoggedIn || !appState.currentUser) return;
                
                const userDocRef = db.collection('users').doc(appState.currentUser.uid);

                // Convert timestamps and other non-serializable data before saving
                const lastFocusDateForDB = appState.lastFocusDate ? new Date(appState.lastFocusDate) : null;
                const powerUpsForDB = {
                    doublePoints: {
                        active: appState.activePowerUps.doublePoints.active,
                        expiry: appState.activePowerUps.doublePoints.expiry ? new Date(appState.activePowerUps.doublePoints.expiry) : null
                    },
                    streakShield: {
                        active: appState.activePowerUps.streakShield.active,
                        used: appState.activePowerUps.streakShield.used,
                        expiry: appState.activePowerUps.streakShield.expiry ? new Date(appState.activePowerUps.streakShield.expiry) : null
                    }
                };

                const dataToSave = {
                    points: appState.points,
                    totalFocusTime: appState.totalFocusTime,
                    totalDistractions: appState.totalDistractions,
                    totalVideosWatched: appState.totalVideosWatched,
                    streakDays: appState.streakDays,
                    lastFocusDate: lastFocusDateForDB,
                    mysteryBoxCount: appState.mysteryBoxCount,
                    activePowerUps: powerUpsForDB,
                    tasks: appState.tasks,
                    playlists: appState.playlists,
                    dailyFocusData: appState.dailyFocusData,
                    browserNotificationsEnabled: appState.browserNotificationsEnabled,
                    premiumLofiTracks: appState.premiumLofiTracks.map(t => ({ id: t.id, unlocked: t.unlocked })),
                };

                try {
                    // Using set with merge:true is like an "update or create" operation.
                    // It won't overwrite fields like "createdAt", "email", etc.
                    await userDocRef.set(dataToSave, { merge: true });
                    console.log("State successfully saved to Firestore.");
                } catch (error) {
                    console.error("Error saving state to Firestore:", error);
                }
            }
            
            /**
             * Populates the local appState object from data retrieved from Firestore.
             */
            function loadStateFromFirestore(data) {
                appState.points = data.points || 0;
                appState.previousPoints = data.points || 0;
                appState.totalFocusTime = data.totalFocusTime || 0;
                appState.totalDistractions = data.totalDistractions || 0;
                appState.totalVideosWatched = data.totalVideosWatched || 0;
                appState.streakDays = data.streakDays || 0;
                // Firestore timestamps need to be converted back to a string/number format
                appState.lastFocusDate = data.lastFocusDate ? new Date(data.lastFocusDate.seconds * 1000).toDateString() : null;
                appState.mysteryBoxCount = data.mysteryBoxCount || 0;
                appState.playlists = data.playlists || [];
                appState.tasks = data.tasks || [];
                appState.dailyFocusData = data.dailyFocusData || {};
                appState.browserNotificationsEnabled = data.browserNotificationsEnabled || false;
                
                // Load power-ups safely
                if (data.activePowerUps) {
                    appState.activePowerUps.doublePoints = {
                        active: data.activePowerUps.doublePoints?.active || false,
                        expiry: data.activePowerUps.doublePoints?.expiry ? new Date(data.activePowerUps.doublePoints.expiry.seconds * 1000).getTime() : null,
                    };
                    appState.activePowerUps.streakShield = {
                        active: data.activePowerUps.streakShield?.active || false,
                        used: data.activePowerUps.streakShield?.used || false,
                        expiry: data.activePowerUps.streakShield?.expiry ? new Date(data.activePowerUps.streakShield.expiry.seconds * 1000).getTime() : null,
                    };
                }

                // Load Lofi track ownership
                const savedTracks = data.premiumLofiTracks || [];
                appState.premiumLofiTracks.forEach(track => {
                    const saved = savedTracks.find(st => st.id === track.id);
                    track.unlocked = saved ? saved.unlocked : false;
                });
            }

            /**
             * Resets the local state when a user logs out.
             */
            function resetLocalState() {
                // Reset all state variables to their default values
                Object.assign(appState, {
                    currentView: 'landingPage', player: null, videoIds: [], currentVideoIndex: 0, isFocusModeActive: false, focusCountdownInterval: null,
                    points: 0, isLoggedIn: false, currentUser: null, timerMode: "Focus Time", timerRemaining: 50 * 60, completedVideos: new Set(),
                    allVideosCompleted: false, totalFocusTime: 0, totalDistractions: 0, totalVideosWatched: 0, playlists: [],
                    tasks: [], previousPoints: 0, streakDays: 0, lastFocusDate: null, isYouTubeAPILoaded: false, currentLofiIndex: 0,
                    isSidebarOpen: false, isVideoSidebarOpen: false, pomodoroInterval: null, pomodoroTimeRemaining: 60 * 60,
                    isPomodoroActive: false, pomodoroDistractionCount: 0, currentPomodoroDurationSetting: 60, browserNotificationsEnabled: false,
                    browserNotificationPermission: 'default', sentNotificationTaskIds: new Set(), generalInterval: null, mysteryBoxCount: 0,
                    activePowerUps: { doublePoints: { active: false, expiry: null }, streakShield: { active: false, used: false, expiry: null }, },
                    dailyFocusData: {}, calendarCurrentDate: new Date(),
                });
                updateAllUI(); // Update UI to reflect cleared state
            }
            
            // ===================================================================
            //  UI & EVENT HANDLING
            // ===================================================================

            function showView(viewId) {
                // ... This function remains largely the same as your well-structured version ...
                // It correctly handles showing/hiding different pages and components.
                // It is called by the handleAction function below.
            }

            function updateAllUI() {
                if (!appState.isLoggedIn) {
                    dom.pointsDisplay.innerHTML = `<span style="color: var(--secondary);">⭐</span> XP: 0`;
                    dom.navStreakDisplay.innerHTML = `<i class="fas fa-fire"></i> 0 days focus`;
                    return;
                }
                dom.pointsDisplay.innerHTML = `<span style="color: var(--secondary);">⭐</span> XP: ${appState.points}`;
                updateAchievementLevel();
                updateStreakDisplay();
                updateHomePageInfo();
                updateFocusStatus();
                updateTodoBadge();
                updateUpcomingTaskDisplay();
                if (appState.currentView === 'profile') displayProfileInfo();
                if (appState.currentView === 'focusStats') displayFocusStatsInfo();
            }

            /**
             * Central event handler for the entire application.
             * It uses event delegation to listen for clicks on elements with a `data-action` attribute.
             */
            function handleAction(action, element) {
                switch (action) {
                    case 'show-view':
                        showView(element.dataset.view);
                        break;
                    case 'github':
                        window.open("https://github.com/The-Chosen-One-o5/UltraFocusModeYT", "_blank");
                        break;
                    case 'google-sign-in':
                        signInWithGoogle();
                        break;
                    case 'logout':
                        logout();
                        break;
                    // Add all your other actions here
                    case 'add-url': addUrlInput(); break;
                    case 'save-playlist': savePlaylist(); break;
                    case 'remove-playlist': removePlaylist(); break;
                    case 'start-playback': prepareAndStartPlayback(); break;
                    // ... etc.
                }
            }

            function setupEventListeners() {
                document.body.addEventListener('click', (e) => {
                    const actionTarget = e.target.closest('[data-action]');
                    if (actionTarget) {
                        e.preventDefault();
                        handleAction(actionTarget.dataset.action, actionTarget);
                    }
                });
                
                // Add any other specific listeners that don't fit the data-action pattern
                if (dom.sidebarTrigger) dom.sidebarTrigger.addEventListener('click', toggleSidebar);
                // ... etc.
            }
            
            // ... All your other game logic and UI functions go here ...
            // IMPORTANT: Make sure any function that used to save to localStorage
            // now calls `await saveState();` instead. For example:
            
            async function saveTasks() {
                // ... your logic to get tasks from the DOM ...
                appState.tasks = newListOfTasks;
                await saveState(); // This now saves to Firestore.
                console.log("Tasks saved to Firestore.");
                updateTodoBadge();
                updateUpcomingTaskDisplay();
            }

            async function onPlayerStateChange(event) {
                if (event.data === YT.PlayerState.ENDED) {
                    // ... your logic for awarding points ...
                    appState.points += 50;
                    appState.totalVideosWatched++;
                    updateAllUI();
                    await saveState(); // Save the new points to Firestore
                    // ... rest of your logic ...
                }
            }

            // --- Initialization ---
            document.addEventListener("DOMContentLoaded", () => {
                console.log("DOM Loaded. Initializing app...");
                cacheDOMElements(); // Find all the HTML elements once
                setupEventListeners(); // Set up the main event handler
                // The auth.onAuthStateChanged listener will take over from here,
                // automatically showing the correct view (landing or home)
                // and loading data if necessary.
            });

        })();
    </script>
</body>
</html>
